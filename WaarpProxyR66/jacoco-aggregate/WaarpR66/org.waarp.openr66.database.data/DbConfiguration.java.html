<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>DbConfiguration.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Waarp Proxy in R66 protocol</a> &gt; <a href="../index.html" class="el_bundle">WaarpR66</a> &gt; <a href="index.source.html" class="el_package">org.waarp.openr66.database.data</a> &gt; <span class="el_source">DbConfiguration.java</span></div><h1>DbConfiguration.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.openr66.database.data;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.node.ObjectNode;
import org.waarp.common.database.DbPreparedStatement;
import org.waarp.common.database.DbSession;
import org.waarp.common.database.exception.WaarpDatabaseException;
import org.waarp.common.database.exception.WaarpDatabaseNoConnectionException;
import org.waarp.common.database.exception.WaarpDatabaseSqlException;
import org.waarp.common.utility.ParametersChecker;
import org.waarp.openr66.dao.AbstractDAO;
import org.waarp.openr66.dao.DAOFactory;
import org.waarp.openr66.dao.Filter;
import org.waarp.openr66.dao.LimitDAO;
import org.waarp.openr66.dao.database.DBLimitDAO;
import org.waarp.openr66.dao.database.StatementExecutor;
import org.waarp.openr66.dao.exception.DAOConnectionException;
import org.waarp.openr66.dao.exception.DAONoDataException;
import org.waarp.openr66.pojo.Limit;
import org.waarp.openr66.protocol.configuration.Configuration;

import java.sql.SQLException;
import java.sql.Types;
import java.util.ArrayList;
import java.util.List;

/**
 * Configuration Table object
 */
public class DbConfiguration extends AbstractDbDataDao&lt;Limit&gt; {

<span class="fc" id="L51">  public enum Columns {</span>
<span class="fc" id="L52">    READGLOBALLIMIT, WRITEGLOBALLIMIT, READSESSIONLIMIT, WRITESESSIONLIMIT,</span>
<span class="fc" id="L53">    DELAYLIMIT, UPDATEDINFO, HOSTID</span>
  }

<span class="fc" id="L56">  public static final int[] dbTypes = {</span>
      Types.BIGINT, Types.BIGINT, Types.BIGINT, Types.BIGINT, Types.BIGINT,
      Types.INTEGER, Types.NVARCHAR
  };

  public static final String table = &quot; CONFIGURATION &quot;;

<span class="fc" id="L63">  protected static final String selectAllFields =</span>
<span class="fc" id="L64">      Columns.READGLOBALLIMIT.name() + ',' + Columns.WRITEGLOBALLIMIT.name() +</span>
<span class="fc" id="L65">      ',' + Columns.READSESSIONLIMIT.name() + ',' +</span>
<span class="fc" id="L66">      Columns.WRITESESSIONLIMIT.name() + ',' + Columns.DELAYLIMIT.name() + ',' +</span>
<span class="fc" id="L67">      Columns.UPDATEDINFO.name() + ',' + Columns.HOSTID.name();</span>

<span class="fc" id="L69">  public static final Columns[] indexes = {</span>
      Columns.HOSTID, Columns.UPDATEDINFO
  };

  @Override
  protected final String getTable() {
<span class="nc" id="L75">    return table;</span>
  }

  @Override
  protected final AbstractDAO&lt;Limit&gt; getDao(final boolean isCacheable)
      throws DAOConnectionException {
<span class="fc" id="L81">    return DAOFactory.getInstance().getLimitDAO(isCacheable);</span>
  }

  @Override
  protected final String getPrimaryKey() {
<span class="nc bnc" id="L86" title="All 2 branches missed.">    if (pojo != null) {</span>
<span class="nc" id="L87">      return pojo.getHostid();</span>
    }
<span class="nc" id="L89">    throw new IllegalArgumentException(&quot;pojo is null&quot;);</span>
  }

  @Override
  protected final String getPrimaryField() {
<span class="fc" id="L94">    return Columns.HOSTID.name();</span>
  }


  /**
   * @param hostid
   * @param rg Read Global Limit
   * @param wg Write Global Limit
   * @param rs Read Session Limit
   * @param ws Write Session Limit
   * @param del Delay Limit
   */
  public DbConfiguration(final String hostid, final long rg, final long wg,
                         final long rs, final long ws, final long del)
<span class="fc" id="L108">      throws WaarpDatabaseSqlException {</span>
<span class="fc" id="L109">    pojo = new Limit(hostid, rg, wg, rs, ws, del);</span>
<span class="fc" id="L110">  }</span>

<span class="fc" id="L112">  public DbConfiguration(final Limit limit) {</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">    if (limit == null) {</span>
<span class="nc" id="L114">      throw new IllegalArgumentException(</span>
          &quot;Argument in constructor cannot be null&quot;);
    }
<span class="fc" id="L117">    this.pojo = limit;</span>
<span class="fc" id="L118">  }</span>

  /**
   * Constructor from Json
   *
   * @param source
   *
   * @throws WaarpDatabaseSqlException
   */
  public DbConfiguration(final ObjectNode source)
<span class="fc" id="L128">      throws WaarpDatabaseSqlException {</span>
<span class="fc" id="L129">    pojo = new Limit();</span>
<span class="fc" id="L130">    setFromJson(source, false);</span>
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">    if (ParametersChecker.isEmpty(pojo.getHostid())) {</span>
<span class="nc" id="L132">      throw new WaarpDatabaseSqlException(</span>
          &quot;Not enough argument to create the object&quot;);
    }
<span class="fc" id="L135">  }</span>

  @Override
  protected final void checkValues() throws WaarpDatabaseSqlException {
<span class="fc" id="L139">    pojo.checkValues();</span>
<span class="fc" id="L140">  }</span>

  /**
   * Read json object into Array then setFromArray
   *
   * @param node
   * @param ignorePrimaryKey
   *
   * @throws WaarpDatabaseSqlException
   */
  @Override
  public final void setFromJson(final ObjectNode node,
                                final boolean ignorePrimaryKey)
      throws WaarpDatabaseSqlException {
<span class="fc" id="L154">    super.setFromJson(node, ignorePrimaryKey);</span>
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">    if (ParametersChecker.isEmpty(pojo.getHostid())) {</span>
<span class="nc" id="L156">      throw new WaarpDatabaseSqlException(</span>
          &quot;Not enough argument to create the object&quot;);
    }
<span class="fc" id="L159">  }</span>

  /**
   * @param hostid
   *
   * @throws WaarpDatabaseException
   */
<span class="fc" id="L166">  public DbConfiguration(final String hostid) throws WaarpDatabaseException {</span>
<span class="fc" id="L167">    LimitDAO limitAccess = null;</span>
    try {
<span class="fc" id="L169">      limitAccess = DAOFactory.getInstance().getLimitDAO(true);</span>
<span class="fc" id="L170">      pojo = limitAccess.select(hostid);</span>
<span class="nc" id="L171">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L172">      throw new WaarpDatabaseException(e);</span>
<span class="fc" id="L173">    } catch (final DAONoDataException e) {</span>
<span class="fc" id="L174">      pojo = new Limit(hostid, 0L);</span>
    } finally {
<span class="fc" id="L176">      DAOFactory.closeDAO(limitAccess);</span>
    }
<span class="fc" id="L178">  }</span>

  /**
   * Private constructor for Commander only
   */
<span class="nc" id="L183">  private DbConfiguration() {</span>
<span class="nc" id="L184">    pojo = new Limit();</span>
<span class="nc" id="L185">  }</span>

  @Override
  protected final void setFromJson(final String field, final JsonNode value) {
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L190">      return;</span>
    }
<span class="fc bfc" id="L192" title="All 2 branches covered.">    for (final Columns column : Columns.values()) {</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">      if (column.name().equalsIgnoreCase(field)) {</span>
<span class="pc bpc" id="L194" title="2 of 8 branches missed.">        switch (column) {</span>
          case READGLOBALLIMIT:
<span class="fc" id="L196">            pojo.setReadGlobalLimit(value.asLong());</span>
<span class="fc" id="L197">            break;</span>
          case WRITEGLOBALLIMIT:
<span class="fc" id="L199">            pojo.setWriteGlobalLimit(value.asLong());</span>
<span class="fc" id="L200">            break;</span>
          case READSESSIONLIMIT:
<span class="fc" id="L202">            pojo.setReadSessionLimit(value.asLong());</span>
<span class="fc" id="L203">            break;</span>
          case WRITESESSIONLIMIT:
<span class="fc" id="L205">            pojo.setWriteSessionLimit(value.asLong());</span>
<span class="fc" id="L206">            break;</span>
          case DELAYLIMIT:
<span class="fc" id="L208">            pojo.setDelayLimit(value.asLong());</span>
<span class="fc" id="L209">            break;</span>
          case UPDATEDINFO:
<span class="nc" id="L211">            pojo.setUpdatedInfo(</span>
<span class="nc" id="L212">                org.waarp.openr66.pojo.UpdatedInfo.valueOf(value.asInt()));</span>
<span class="nc" id="L213">            break;</span>
          case HOSTID:
<span class="fc" id="L215">            pojo.setHostid(value.asText());</span>
            break;
        }
      }
    }
<span class="fc" id="L220">  }</span>

  /**
   * @return the array of DbConfiguration from Updated status
   *
   * @throws WaarpDatabaseNoConnectionException
   */
  public static DbConfiguration[] getUpdatedPrepareStament()
      throws WaarpDatabaseNoConnectionException {
<span class="fc" id="L229">    final List&lt;Filter&gt; filters = new ArrayList&lt;Filter&gt;();</span>
<span class="fc" id="L230">    filters.add(new Filter(DBLimitDAO.HOSTID_FIELD, &quot;=&quot;,</span>
<span class="fc" id="L231">                           Configuration.configuration.getHostId()));</span>
<span class="fc" id="L232">    filters.add(new Filter(DBLimitDAO.UPDATED_INFO_FIELD, &quot;=&quot;,</span>
<span class="fc" id="L233">                           UpdatedInfo.TOSUBMIT.ordinal()));</span>

<span class="fc" id="L235">    LimitDAO limitAccess = null;</span>
    List&lt;Limit&gt; limits;
    try {
<span class="fc" id="L238">      limitAccess = DAOFactory.getInstance().getLimitDAO(false);</span>
<span class="fc" id="L239">      limits = limitAccess.find(filters);</span>
<span class="nc" id="L240">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L241">      throw new WaarpDatabaseNoConnectionException(e);</span>
    } finally {
<span class="fc" id="L243">      DAOFactory.closeDAO(limitAccess);</span>
    }
<span class="fc" id="L245">    final DbConfiguration[] res = new DbConfiguration[limits.size()];</span>
<span class="fc" id="L246">    int i = 0;</span>
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">    for (final Limit limit : limits) {</span>
<span class="nc" id="L248">      res[i] = new DbConfiguration(limit);</span>
<span class="nc" id="L249">      i++;</span>
<span class="nc" id="L250">    }</span>
<span class="fc" id="L251">    return res;</span>
  }

  /**
   * @param session
   * @param hostid
   * @param limitBandwith 0 for no limit, &gt; 0 for one limit, &lt; 0 for
   *     no
   *     filter
   *
   * @return the preparedStatement with the filter
   *
   * @throws WaarpDatabaseNoConnectionException
   * @throws WaarpDatabaseSqlException
   */
  public static DbPreparedStatement getFilterPrepareStament(
      final DbSession session, final String hostid, final long limitBandwith)
      throws WaarpDatabaseNoConnectionException, WaarpDatabaseSqlException {
<span class="fc" id="L269">    final DbPreparedStatement preparedStatement =</span>
        new DbPreparedStatement(session);
<span class="fc" id="L271">    final String request = &quot;SELECT &quot; + selectAllFields + &quot; FROM &quot; + table;</span>
<span class="fc" id="L272">    String condition = null;</span>
<span class="pc bpc" id="L273" title="1 of 2 branches missed.">    if (ParametersChecker.isNotEmpty(hostid)) {</span>
<span class="nc" id="L274">      condition = &quot; WHERE &quot; + Columns.HOSTID.name() + &quot; = '&quot; + hostid + &quot;' &quot;;</span>
    }
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">    if (limitBandwith &gt;= 0) {</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">      if (condition == null) {</span>
<span class="nc" id="L278">        condition = &quot; WHERE &quot;;</span>
      } else {
<span class="nc" id="L280">        condition += &quot; AND &quot;;</span>
      }
<span class="nc bnc" id="L282" title="All 2 branches missed.">      if (limitBandwith == 0) {</span>
<span class="nc" id="L283">        condition += &quot;(&quot; + Columns.READGLOBALLIMIT + &quot; == 0 AND &quot; +</span>
                     Columns.READSESSIONLIMIT + &quot; == 0 AND &quot; +
                     Columns.WRITEGLOBALLIMIT + &quot; == 0 AND &quot; +
                     Columns.WRITESESSIONLIMIT + &quot; == 0)&quot;;
      } else {
<span class="nc" id="L288">        condition +=</span>
            &quot;(&quot; + Columns.READGLOBALLIMIT + &quot; &gt; &quot; + limitBandwith + &quot; OR &quot; +
            Columns.READSESSIONLIMIT + &quot; &gt; &quot; + limitBandwith + &quot; OR &quot; +
            Columns.WRITEGLOBALLIMIT + &quot; &gt; &quot; + limitBandwith + &quot; OR &quot; +
            Columns.WRITESESSIONLIMIT + &quot; &gt; &quot; + limitBandwith + ')';
      }
    }
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">    if (condition != null) {</span>
<span class="nc" id="L296">      preparedStatement.createPrepareStatement(</span>
<span class="nc" id="L297">          request + condition + &quot; ORDER BY &quot; + Columns.HOSTID.name());</span>
    } else {
<span class="fc" id="L299">      preparedStatement.createPrepareStatement(</span>
<span class="fc" id="L300">          request + &quot; ORDER BY &quot; + Columns.HOSTID.name());</span>
    }
<span class="fc" id="L302">    return preparedStatement;</span>
  }

  public static DbConfiguration getFromStatement(
      final DbPreparedStatement statement)
      throws WaarpDatabaseNoConnectionException, WaarpDatabaseSqlException {
<span class="nc" id="L308">    final DbConfiguration dbConfiguration = new DbConfiguration();</span>
<span class="nc" id="L309">    AbstractDAO&lt;Limit&gt; limitDAO = null;</span>
    try {
<span class="nc" id="L311">      limitDAO = dbConfiguration.getDao(false);</span>
<span class="nc" id="L312">      dbConfiguration.pojo =</span>
<span class="nc" id="L313">          ((StatementExecutor&lt;Limit&gt;) limitDAO).getFromResultSet(</span>
<span class="nc" id="L314">              statement.getResultSet());</span>
<span class="nc" id="L315">      return dbConfiguration;</span>
<span class="nc" id="L316">    } catch (final SQLException e) {</span>
<span class="nc" id="L317">      DbSession.error(e);</span>
<span class="nc" id="L318">      throw new WaarpDatabaseSqlException(&quot;Getting values in error&quot;, e);</span>
<span class="nc" id="L319">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L320">      throw new WaarpDatabaseSqlException(&quot;Getting values in error&quot;, e);</span>
    } finally {
<span class="nc" id="L322">      DAOFactory.closeDAO(limitDAO);</span>
    }
  }

  @Override
  public final void changeUpdatedInfo(final UpdatedInfo info) {
<span class="fc" id="L328">    isSaved = false;</span>
<span class="fc" id="L329">    pojo.setUpdatedInfo(org.waarp.openr66.pojo.UpdatedInfo.fromLegacy(info));</span>
<span class="fc" id="L330">  }</span>

  /**
   * Update configuration according to new value of limits
   */
  public final void updateConfiguration() {
<span class="fc" id="L336">    Configuration.configuration.changeNetworkLimit(pojo.getWriteGlobalLimit(),</span>
<span class="fc" id="L337">                                                   pojo.getReadGlobalLimit(),</span>
<span class="fc" id="L338">                                                   pojo.getWriteSessionLimit(),</span>
<span class="fc" id="L339">                                                   pojo.getReadSessionLimit(),</span>
<span class="fc" id="L340">                                                   pojo.getDelayLimit());</span>
<span class="fc" id="L341">  }</span>

  /**
   * @return True if this Configuration refers to the current host
   */
  public final boolean isOwnConfiguration() {
<span class="fc" id="L347">    return pojo.getHostid().equals(Configuration.configuration.getHostId());</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>