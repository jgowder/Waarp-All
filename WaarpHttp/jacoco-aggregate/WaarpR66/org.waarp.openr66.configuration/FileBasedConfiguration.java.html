<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>FileBasedConfiguration.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Waarp Http</a> &gt; <a href="../index.html" class="el_bundle">WaarpR66</a> &gt; <a href="index.source.html" class="el_package">org.waarp.openr66.configuration</a> &gt; <span class="el_source">FileBasedConfiguration.java</span></div><h1>FileBasedConfiguration.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.openr66.configuration;

import io.netty.handler.traffic.AbstractTrafficShapingHandler;
import org.dom4j.Document;
import org.dom4j.DocumentException;
import org.waarp.common.cpu.WaarpConstraintLimitHandler;
import org.waarp.common.crypto.Des;
import org.waarp.common.crypto.ssl.WaarpSecureKeyStore;
import org.waarp.common.crypto.ssl.WaarpSslContextFactory;
import org.waarp.common.database.ConnectionFactory;
import org.waarp.common.database.DbAdmin;
import org.waarp.common.database.DbRequest;
import org.waarp.common.database.data.AbstractDbData.UpdatedInfo;
import org.waarp.common.database.exception.WaarpDatabaseException;
import org.waarp.common.database.exception.WaarpDatabaseNoConnectionException;
import org.waarp.common.database.exception.WaarpDatabaseSqlException;
import org.waarp.common.database.model.DbType;
import org.waarp.common.digest.FilesystemBasedDigest.DigestAlgo;
import org.waarp.common.exception.CryptoException;
import org.waarp.common.exception.InvalidArgumentException;
import org.waarp.common.file.AbstractDir;
import org.waarp.common.file.DirInterface;
import org.waarp.common.file.FileUtils;
import org.waarp.common.file.filesystembased.FilesystemBasedFileParameterImpl;
import org.waarp.common.logging.SysErrLogger;
import org.waarp.common.logging.WaarpLogger;
import org.waarp.common.logging.WaarpLoggerFactory;
import org.waarp.common.role.RoleDefault;
import org.waarp.common.role.RoleDefault.ROLE;
import org.waarp.common.utility.ParametersChecker;
import org.waarp.common.utility.SystemPropertyUtil;
import org.waarp.common.utility.WaarpSystemUtil;
import org.waarp.common.xml.XmlHash;
import org.waarp.common.xml.XmlRootHash;
import org.waarp.common.xml.XmlUtil;
import org.waarp.common.xml.XmlValue;
import org.waarp.gateway.kernel.rest.RestConfiguration;
import org.waarp.openr66.context.R66BusinessFactoryInterface;
import org.waarp.openr66.context.authentication.R66Auth;
import org.waarp.openr66.context.task.localexec.LocalExecClient;
import org.waarp.openr66.dao.DAOFactory;
import org.waarp.openr66.database.data.DbConfiguration;
import org.waarp.openr66.database.data.DbHostAuth;
import org.waarp.openr66.database.data.DbHostConfiguration;
import org.waarp.openr66.database.model.DbModelFactoryR66;
import org.waarp.openr66.pojo.Business;
import org.waarp.openr66.protocol.configuration.Configuration;
import org.waarp.openr66.protocol.configuration.Messages;
import org.waarp.openr66.protocol.configuration.PartnerConfiguration;
import org.waarp.openr66.protocol.configuration.R66SystemProperties;
import org.waarp.openr66.protocol.exception.OpenR66ProtocolSystemException;
import org.waarp.openr66.protocol.http.adminssl.HttpResponsiveSslHandler;
import org.waarp.openr66.protocol.http.rest.HttpRestR66Handler.RESTHANDLERS;
import org.waarp.openr66.protocol.monitoring.MonitorExporterTransfers;
import org.waarp.openr66.protocol.networkhandler.R66ConstraintLimitHandler;
import org.waarp.openr66.protocol.networkhandler.ssl.NetworkSslServerInitializer;
import org.waarp.openr66.server.ServerInitDatabase;
import org.waarp.snmp.SnmpConfiguration;

import java.io.File;
import java.io.IOException;
import java.net.InetAddress;
import java.net.InetSocketAddress;
import java.net.UnknownHostException;
import java.sql.SQLException;
import java.util.Arrays;
import java.util.List;
import java.util.Locale;

import static org.waarp.common.database.DbConstant.*;
import static org.waarp.openr66.configuration.FileBasedElements.*;

/**
 * File Based Configuration
 */
public class FileBasedConfiguration {
  private static final String CANNOT_FIND_SSL_AUTHENTICATION_FOR_CURRENT_HOST =
      &quot;Cannot find SSL Authentication for current host&quot;;

  private static final String CANNOT_FIND_AUTHENTICATION_FOR_CURRENT_HOST =
      &quot;Cannot find Authentication for current host&quot;;

  private static final String IS_DEPRECATED_IN_SYSTEM_PROPERTIES_USE_INSTEAD =
      &quot;{} is deprecated in system properties use {} instead&quot;;

  private static final String CANNOT_LOAD_AUTHENTICATION_CONFIGURATION =
      &quot;Cannot load Authentication configuration&quot;;

  private static final String CANNOT_LOAD_LIMIT_CONFIGURATION =
      &quot;Cannot load Limit configuration&quot;;

  private static final String CANNOT_LOAD_DIRECTORY_CONFIGURATION =
      &quot;Cannot load Directory configuration&quot;;

  private static final String CANNOT_LOAD_DATABASE_CONFIGURATION =
      &quot;Cannot load Database configuration&quot;;

  private static final String CANNOT_LOAD_IDENTITY = &quot;Cannot load Identity&quot;;

  private static final String FILE_BASED_CONFIGURATION_CANNOT_READ_XML =
      &quot;FileBasedConfiguration.CannotReadXml&quot;;

  private static final String FILE_BASED_CONFIGURATION_NO_SET_CONFIG =
      &quot;FileBasedConfiguration.NoSetConfig&quot;;
  private static final String FILE_BASED_CONFIGURATION_INVALID_CONFIG =
      &quot;FileBasedConfiguration.NotValidConfig&quot;;
  private static final String FILE_BASED_CONFIGURATION_NOT_FOUND_CONFIG =
      &quot;FileBasedConfiguration.NotFoundConfig&quot;;

  /**
   * Internal Logger
   */
<span class="fc" id="L132">  private static final WaarpLogger logger =</span>
<span class="fc" id="L133">      WaarpLoggerFactory.getLogger(FileBasedConfiguration.class);</span>
  protected static final String REGEX_SEPARATOR = &quot;\\s|\\|&quot;;

  private static XmlValue[] configuration;

  private static XmlRootHash hashRootConfig;

<span class="nc" id="L140">  protected FileBasedConfiguration() {</span>
<span class="nc" id="L141">  }</span>

  public static void setXmlRootHash(final XmlRootHash xmlRootHash) {
<span class="nc" id="L144">    hashRootConfig = xmlRootHash;</span>
<span class="nc" id="L145">  }</span>

  /**
   * Load the locale from configuration file
   *
   * @param hashConfig
   */
  private static void loadLocale(final XmlHash hashConfig) {
<span class="fc" id="L153">    final XmlValue value = hashConfig.get(XML_LOCALE);</span>
<span class="pc bpc" id="L154" title="2 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="nc" id="L155">      final String locale = value.getString();</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">      if (ParametersChecker.isEmpty(locale)) {</span>
<span class="nc" id="L157">        return;</span>
      }
<span class="nc" id="L159">      Messages.init(new Locale(locale));</span>
    }
<span class="fc" id="L161">  }</span>

  /**
   * @param config
   * @param hashRootConfig
   *
   * @return True if the identity of the server is correctly loaded
   */
  public static boolean loadIdentity(final Configuration config,
                                     final XmlRootHash hashRootConfig) {
<span class="fc" id="L171">    XmlHash hashConfig = new XmlHash(hashRootConfig.get(XML_IDENTITY));</span>
    try {
<span class="fc" id="L173">      loadLocale(hashConfig);</span>
<span class="fc" id="L174">      XmlValue value = hashConfig.get(XML_SERVER_HOSTID);</span>
<span class="pc bpc" id="L175" title="2 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L176">        config.setHostId(value.getString());</span>
      } else {
<span class="nc" id="L178">        logger.error(</span>
<span class="nc" id="L179">            Messages.getString(FILE_BASED_CONFIGURATION_NOT_FOUND_CONFIG) +</span>
            &quot;Host ID&quot;); //$NON-NLS-1$
<span class="nc" id="L181">        return false;</span>
      }
<span class="fc" id="L183">      value = hashConfig.get(XML_SERVER_SSLHOSTID);</span>
<span class="pc bpc" id="L184" title="2 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L185">        config.setHostSslId(value.getString());</span>
      } else {
<span class="nc" id="L187">        logger.warn(Messages.getString(</span>
            &quot;FileBasedConfiguration.SSLIDNotFound&quot;)); //$NON-NLS-1$
<span class="nc" id="L189">        config.setUseSSL(false);</span>
<span class="nc" id="L190">        config.setHostSslId(null);</span>
      }
<span class="fc" id="L192">      value = hashConfig.get(XML_AUTHENTIFICATION_FILE);</span>
<span class="pc bpc" id="L193" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L194">        config.setAuthFile(value.getString());</span>
      }
<span class="fc" id="L196">      return setCryptoKey(config, hashConfig);</span>
    } finally {
<span class="fc" id="L198">      hashConfig.clear();</span>
<span class="fc" id="L199">      hashConfig = null;</span>
    }
  }

  private static boolean isDbInactive(final Configuration configuration) {
<span class="pc bpc" id="L204" title="1 of 4 branches missed.">    return admin == null || admin.getTypeDriver() == DbType.none ||</span>
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">           configuration.isSaveTaskRunnerWithNoDb();</span>
  }

  /**
   * @param config
   *
   * @return True if the authentication of partners is correctly loaded
   */
  private static boolean loadAuthentication(final Configuration config) {
<span class="fc" id="L214">    XmlHash hashConfig = new XmlHash(hashRootConfig.get(XML_IDENTITY));</span>
    try {
<span class="pc bpc" id="L216" title="1 of 2 branches missed.">      if (isDbInactive(config)) {</span>
        // if no database, must load authentication from file
<span class="fc" id="L218">        final XmlValue value = hashConfig.get(XML_AUTHENTIFICATION_FILE);</span>
<span class="pc bpc" id="L219" title="2 of 4 branches missed.">        if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L220">          final String fileauthent = value.getString();</span>
<span class="fc" id="L221">          return AuthenticationFileBasedConfiguration.loadAuthentication(config,</span>
                                                                         fileauthent);
        } else {
<span class="nc" id="L224">          logger.warn(</span>
<span class="nc" id="L225">              Messages.getString(FILE_BASED_CONFIGURATION_NOT_FOUND_CONFIG) +</span>
              &quot;Authentication file&quot;); //$NON-NLS-1$
<span class="nc" id="L227">          return false;</span>
        }
      }
<span class="nc" id="L230">      return true;</span>
    } finally {
<span class="fc" id="L232">      hashConfig.clear();</span>
<span class="fc" id="L233">      hashConfig = null;</span>
    }
  }

  private static boolean loadPushMonitorParam(final Configuration config) {
<span class="fc" id="L238">    final XmlHash hashConfig =</span>
<span class="fc" id="L239">        new XmlHash(hashRootConfig.get(XML_PUSH_MONITOR));</span>
    try {
      XmlValue value;
      // Common part API REST and Elasticsearch
<span class="fc" id="L243">      value = hashConfig.get(XML_PUSH_MONITOR_URL);</span>
<span class="pc bpc" id="L244" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
        try {
<span class="fc" id="L246">          ParametersChecker.checkSanityString(value.getString());</span>
<span class="nc" id="L247">        } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L248">          logger.error(&quot;Bad Push Monitor URL: {}&quot;, e.getMessage());</span>
<span class="nc" id="L249">          return false;</span>
<span class="fc" id="L250">        }</span>
<span class="fc" id="L251">        final String url = value.getString();</span>
        // Default value
<span class="fc" id="L253">        int delay = 1000;</span>
<span class="fc" id="L254">        value = hashConfig.get(XML_PUSH_MONITOR_DELAY);</span>
<span class="pc bpc" id="L255" title="2 of 4 branches missed.">        if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L256">          delay = value.getInteger();</span>
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">          if (delay &lt; 0) {</span>
<span class="nc" id="L258">            delay = 1000;</span>
          }
<span class="pc bpc" id="L260" title="1 of 2 branches missed.">          if (delay &lt; 500) {</span>
<span class="nc" id="L261">            delay = 500;</span>
          }
        }
        // Default value
<span class="fc" id="L265">        boolean intervalIncluded =</span>
            MonitorExporterTransfers.MONITOR_INTERVAL_INCLUDED_DEFAULT;
<span class="fc" id="L267">        value = hashConfig.get(XML_PUSH_MONITOR_INTERVAL_INCLUDED);</span>
<span class="pc bpc" id="L268" title="2 of 4 branches missed.">        if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="nc" id="L269">          intervalIncluded = value.getBoolean();</span>
        }
        // Default value
<span class="fc" id="L272">        boolean longAsString =</span>
            MonitorExporterTransfers.MONITOR_LONG_AS_STRING_DEFAULT;
<span class="fc" id="L274">        value = hashConfig.get(XML_PUSH_MONITOR_TRANSFORM_LONG_AS_STRING);</span>
<span class="pc bpc" id="L275" title="2 of 4 branches missed.">        if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="nc" id="L276">          longAsString = value.getBoolean();</span>
        }
        // Determine API REST or Elasticsearch through INDEX presence
        // Elasticsearch Specific
<span class="fc" id="L280">        String index = null;</span>
<span class="fc" id="L281">        value = hashConfig.get(XML_PUSH_MONITOR_ES_INDEX);</span>
<span class="pc bpc" id="L282" title="2 of 4 branches missed.">        if (value != null &amp;&amp; !value.isEmpty()) {</span>
          try {
<span class="nc" id="L284">            ParametersChecker.checkSanityString(value.getString());</span>
<span class="nc" id="L285">          } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L286">            logger.error(&quot;Bad Push Monitor Index: {}&quot;, e.getMessage());</span>
<span class="nc" id="L287">            return false;</span>
<span class="nc" id="L288">          }</span>
<span class="nc" id="L289">          index = value.getString();</span>
        }
        // API REST Specific
        // Default value
<span class="fc" id="L293">        String endpoint = &quot;/&quot;;</span>
<span class="fc" id="L294">        value = hashConfig.get(XML_PUSH_MONITOR_ENDPOINT);</span>
<span class="pc bpc" id="L295" title="2 of 4 branches missed.">        if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">          if (index != null) {</span>
<span class="nc" id="L297">            logger.error(&quot;Bad Push Monitor: both Index for Elasticsearch and &quot; +</span>
                         &quot;EndPoint for REST API are specified, while only one&quot; +
                         &quot; can be specified&quot;);
<span class="nc" id="L300">            return false;</span>
          }
          try {
<span class="fc" id="L303">            ParametersChecker.checkSanityString(value.getString());</span>
<span class="nc" id="L304">          } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L305">            logger.error(&quot;Bad Push Monitor EndPoint: {}&quot;, e.getMessage());</span>
<span class="nc" id="L306">            return false;</span>
<span class="fc" id="L307">          }</span>
<span class="fc" id="L308">          endpoint = value.getString();</span>
        }
<span class="fc" id="L310">        String token = null;</span>
<span class="fc" id="L311">        value = hashConfig.get(XML_PUSH_MONITOR_TOKEN);</span>
<span class="pc bpc" id="L312" title="2 of 4 branches missed.">        if (value != null &amp;&amp; !value.isEmpty()) {</span>
          try {
<span class="nc" id="L314">            ParametersChecker.checkSanityString(value.getString());</span>
<span class="nc" id="L315">          } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L316">            logger.error(&quot;Bad Push Monitor Token: {}&quot;, e.getMessage());</span>
<span class="nc" id="L317">            return false;</span>
<span class="nc" id="L318">          }</span>
<span class="nc" id="L319">          token = value.getString();</span>
        }
<span class="fc" id="L321">        String apikey = null;</span>
<span class="fc" id="L322">        value = hashConfig.get(XML_PUSH_MONITOR_APIKEY);</span>
<span class="pc bpc" id="L323" title="2 of 4 branches missed.">        if (value != null &amp;&amp; !value.isEmpty()) {</span>
          try {
<span class="nc" id="L325">            ParametersChecker.checkSanityString(value.getString());</span>
<span class="nc" id="L326">          } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L327">            logger.error(&quot;Bad Push Monitor ApiKey: {}&quot;, e.getMessage());</span>
<span class="nc" id="L328">            return false;</span>
<span class="nc" id="L329">          }</span>
<span class="nc" id="L330">          apikey = value.getString();</span>
        }
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">        if (index == null) {</span>
          // API REST Specific continue
<span class="fc" id="L334">          String basicAuthent = null;</span>
<span class="fc" id="L335">          value = hashConfig.get(XML_PUSH_MONITOR_BASIC_AUTHENT);</span>
<span class="pc bpc" id="L336" title="2 of 4 branches missed.">          if (value != null &amp;&amp; !value.isEmpty()) {</span>
            try {
<span class="nc" id="L338">              ParametersChecker.checkSanityString(value.getString());</span>
<span class="nc" id="L339">            } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L340">              logger.error(&quot;Bad Push Monitor Basic Authent: {}&quot;,</span>
<span class="nc" id="L341">                           e.getMessage());</span>
<span class="nc" id="L342">              return false;</span>
<span class="nc" id="L343">            }</span>
<span class="nc" id="L344">            basicAuthent = value.getString();</span>
          }
          // Default value
<span class="fc" id="L347">          boolean keep =</span>
              MonitorExporterTransfers.MONITOR_KEEP_CONNECTION_DEFAULT;
<span class="fc" id="L349">          value = hashConfig.get(XML_PUSH_MONITOR_KEEP_CONNECTION);</span>
<span class="pc bpc" id="L350" title="2 of 4 branches missed.">          if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L351">            keep = value.getBoolean();</span>
          }
<span class="fc" id="L353">          config.setMonitorExporterTransfers(url, basicAuthent, token, apikey,</span>
                                             endpoint, delay, keep,
                                             intervalIncluded, longAsString);
<span class="fc" id="L356">        } else {</span>
          // Elasticsearch Specific continue
<span class="nc" id="L358">          String prefix = null;</span>
<span class="nc" id="L359">          value = hashConfig.get(XML_PUSH_MONITOR_ES_PREFIX);</span>
<span class="nc bnc" id="L360" title="All 4 branches missed.">          if (value != null &amp;&amp; !value.isEmpty()) {</span>
            try {
<span class="nc" id="L362">              ParametersChecker.checkSanityString(value.getString());</span>
<span class="nc" id="L363">            } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L364">              logger.error(&quot;Bad Push Monitor Prefix: {}&quot;, e.getMessage());</span>
<span class="nc" id="L365">              return false;</span>
<span class="nc" id="L366">            }</span>
<span class="nc" id="L367">            prefix = value.getString();</span>
          }
<span class="nc" id="L369">          String username = null;</span>
<span class="nc" id="L370">          value = hashConfig.get(XML_PUSH_MONITOR_ES_USERNAME);</span>
<span class="nc bnc" id="L371" title="All 4 branches missed.">          if (value != null &amp;&amp; !value.isEmpty()) {</span>
            try {
<span class="nc" id="L373">              ParametersChecker.checkSanityString(value.getString());</span>
<span class="nc" id="L374">            } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L375">              logger.error(&quot;Bad Push Monitor Username: {}&quot;, e.getMessage());</span>
<span class="nc" id="L376">              return false;</span>
<span class="nc" id="L377">            }</span>
<span class="nc" id="L378">            username = value.getString();</span>
          }
<span class="nc" id="L380">          String pwd = null;</span>
<span class="nc" id="L381">          value = hashConfig.get(XML_PUSH_MONITOR_ES_PWD);</span>
<span class="nc bnc" id="L382" title="All 4 branches missed.">          if (value != null &amp;&amp; !value.isEmpty()) {</span>
            try {
<span class="nc" id="L384">              ParametersChecker.checkSanityString(value.getString());</span>
<span class="nc" id="L385">            } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L386">              logger.error(&quot;Bad Push Monitor Password: {}&quot;, e.getMessage());</span>
<span class="nc" id="L387">              return false;</span>
<span class="nc" id="L388">            }</span>
<span class="nc" id="L389">            pwd = value.getString();</span>
          }
<span class="nc bnc" id="L391" title="All 8 branches missed.">          if ((username != null &amp;&amp; pwd == null) ||</span>
              (pwd != null &amp;&amp; username == null)) {
<span class="nc" id="L393">            logger.error(&quot;Username and Password must be both specified&quot;);</span>
<span class="nc" id="L394">            return false;</span>
          }
<span class="nc" id="L396">          boolean compression = true;</span>
<span class="nc" id="L397">          value = hashConfig.get(XML_PUSH_MONITOR_ES_COMPRESSION);</span>
<span class="nc bnc" id="L398" title="All 4 branches missed.">          if (value != null &amp;&amp; !value.isEmpty()) {</span>
            try {
<span class="nc" id="L400">              ParametersChecker.checkSanityString(value.getString());</span>
<span class="nc" id="L401">            } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L402">              logger.error(&quot;Bad Push Monitor Compression: {}&quot;, e.getMessage());</span>
<span class="nc" id="L403">              return false;</span>
<span class="nc" id="L404">            }</span>
<span class="nc" id="L405">            compression = value.getBoolean();</span>
          }
<span class="nc bnc" id="L407" title="All 2 branches missed.">          if (config.setMonitorExporterTransfers(url, username, pwd, token,</span>
                                                 apikey, prefix, index,
                                                 intervalIncluded, longAsString,
                                                 compression, delay)) {
<span class="nc" id="L411">            logger.error(&quot;Elasticsearch Factory not available&quot;);</span>
<span class="nc" id="L412">            return false;</span>
          }
        }
      }
<span class="fc" id="L416">      return true;</span>
    } finally {
<span class="fc" id="L418">      hashConfig.clear();</span>
    }
  }

  /**
   * @param config
   *
   * @return True if the server parameters are correctly loaded
   */
  private static boolean loadServerParam(final Configuration config) {
<span class="fc" id="L428">    XmlHash hashConfig = new XmlHash(hashRootConfig.get(XML_SERVER));</span>
    try {
<span class="fc bfc" id="L430" title="All 2 branches covered.">      if (!loadServerConfig(config, hashConfig)) {</span>
<span class="fc" id="L431">        return false;</span>
      }
      XmlValue value;
<span class="fc" id="L434">      value = hashConfig.get(XML_USELOCALEXEC);</span>
<span class="pc bpc" id="L435" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L436">        config.setUseLocalExec(value.getBoolean());</span>
<span class="pc bpc" id="L437" title="1 of 2 branches missed.">        if (config.isUseLocalExec()) {</span>
<span class="nc" id="L438">          value = hashConfig.get(XML_LEXECADDR);</span>
          final String saddr;
          final InetAddress addr;
<span class="nc bnc" id="L441" title="All 4 branches missed.">          if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="nc" id="L442">            saddr = value.getString();</span>
            try {
<span class="nc" id="L444">              addr = InetAddress.getByName(saddr);</span>
<span class="nc" id="L445">            } catch (final UnknownHostException e) {</span>
<span class="nc" id="L446">              logger.error(Messages.getString(</span>
                  FILE_BASED_CONFIGURATION_NOT_FOUND_CONFIG) +
                           &quot;LocalExec Address&quot;); //$NON-NLS-1$
<span class="nc" id="L449">              return false;</span>
<span class="nc" id="L450">            }</span>
          } else {
<span class="nc" id="L452">            logger.warn(</span>
<span class="nc" id="L453">                Messages.getString(FILE_BASED_CONFIGURATION_NOT_FOUND_CONFIG) +</span>
                &quot;LocalExec Address&quot;); //$NON-NLS-1$
            try {
<span class="nc" id="L456">              addr = InetAddress.getByAddress(new byte[] { 127, 0, 0, 1 });</span>
<span class="nc" id="L457">            } catch (final UnknownHostException e) {</span>
<span class="nc" id="L458">              logger.error(Messages.getString(</span>
                  FILE_BASED_CONFIGURATION_NOT_FOUND_CONFIG) +
                           &quot;LocalExec Address&quot;); //$NON-NLS-1$
<span class="nc" id="L461">              return false;</span>
<span class="nc" id="L462">            }</span>
          }
<span class="nc" id="L464">          value = hashConfig.get(XML_LEXECPORT);</span>
          final int port;
<span class="nc bnc" id="L466" title="All 4 branches missed.">          if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="nc" id="L467">            port = value.getInteger();</span>
          } else {
<span class="nc" id="L469">            port = 9999;</span>
          }
<span class="nc" id="L471">          LocalExecClient.address = new InetSocketAddress(addr, port);</span>
        }
      }
<span class="fc" id="L474">      value = hashConfig.get(XML_CHECK_ADDRESS);</span>
<span class="pc bpc" id="L475" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L476">        config.setCheckRemoteAddress(value.getBoolean());</span>
      }
<span class="fc" id="L478">      value = hashConfig.get(XML_CHECK_CLIENTADDRESS);</span>
<span class="pc bpc" id="L479" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L480">        config.setCheckClientAddress(value.getBoolean());</span>
      }
<span class="fc" id="L482">      value = hashConfig.get(XML_MULTIPLE_MONITORS);</span>
<span class="pc bpc" id="L483" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L484">        config.setMultipleMonitors(value.getInteger());</span>
<span class="pc bpc" id="L485" title="1 of 2 branches missed.">        if (config.getMultipleMonitors() &gt; 1) {</span>
<span class="nc" id="L486">          logger.warn(Messages.getString(&quot;FileBasedConfiguration.MMOn&quot;)</span>
                      //$NON-NLS-1$
<span class="nc" id="L488">                      + config.getMultipleMonitors() + Messages.getString(</span>
              &quot;FileBasedConfiguration.MMOn2&quot;)); //$NON-NLS-1$
        } else {
<span class="fc" id="L491">          config.setMultipleMonitors(1);</span>
<span class="pc bpc" id="L492" title="1 of 2 branches missed.">          if (config.isWarnOnStartup()) {</span>
<span class="fc" id="L493">            logger.warn(Messages.getString(</span>
                &quot;FileBasedConfiguration.MMOff&quot;)); //$NON-NLS-1$
          } else {
<span class="nc" id="L496">            logger.info(Messages.getString(</span>
                &quot;FileBasedConfiguration.MMOff&quot;)); //$NON-NLS-1$
          }
        }
      } else {
<span class="fc" id="L501">        config.setMultipleMonitors(1);</span>
<span class="pc bpc" id="L502" title="1 of 2 branches missed.">        if (config.isWarnOnStartup()) {</span>
<span class="fc" id="L503">          logger.warn(</span>
<span class="fc" id="L504">              Messages.getString(&quot;FileBasedConfiguration.MMOff&quot;)); //$NON-NLS-1$</span>
        } else {
<span class="nc" id="L506">          logger.info(</span>
<span class="nc" id="L507">              Messages.getString(&quot;FileBasedConfiguration.MMOff&quot;)); //$NON-NLS-1$</span>
        }
      }
<span class="fc" id="L510">      value = hashConfig.get(XML_BUSINESS_FACTORY);</span>
<span class="pc bpc" id="L511" title="2 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
        try {
<span class="nc" id="L513">          ParametersChecker.checkSanityString(value.getString());</span>
<span class="nc" id="L514">        } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L515">          logger.error(&quot;Bad Business Factory class: {}&quot;, e.getMessage());</span>
<span class="nc" id="L516">          return false;</span>
<span class="nc" id="L517">        }</span>
        try {
<span class="nc" id="L519">          config.setR66BusinessFactory(</span>
<span class="nc" id="L520">              (R66BusinessFactoryInterface) WaarpSystemUtil.newInstance(</span>
<span class="nc" id="L521">                  value.getString()));//NOSONAR</span>
<span class="nc" id="L522">        } catch (final Exception e) {</span>
<span class="nc" id="L523">          logger.error(&quot;Bad Business Factory class: {}&quot;, e.getMessage());</span>
<span class="nc" id="L524">          return false;</span>
<span class="nc" id="L525">        }</span>
      }
<span class="fc" id="L527">      return true;</span>
    } finally {
<span class="fc" id="L529">      hashConfig.clear();</span>
<span class="fc" id="L530">      hashConfig = null;</span>
    }
  }

  public static boolean loadServerConfig(final Configuration config,
                                         final XmlHash hashConfig) {
<span class="fc" id="L536">    XmlValue value = hashConfig.get(XML_USESSL);</span>
<span class="pc bpc" id="L537" title="2 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L538">      config.setUseSSL(value.getBoolean());</span>
    }
<span class="fc" id="L540">    value = hashConfig.get(XML_USENOSSL);</span>
<span class="pc bpc" id="L541" title="2 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L542">      config.setUseNOSSL(value.getBoolean());</span>
    }
<span class="fc" id="L544">    value = hashConfig.get(XML_USEHTTPCOMP);</span>
<span class="pc bpc" id="L545" title="1 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L546">      config.setUseHttpCompression(value.getBoolean());</span>
    }
<span class="fc" id="L548">    value = hashConfig.get(XML_SERVER_ADMIN);</span>
<span class="pc bpc" id="L549" title="2 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L550">      config.setAdminName(value.getString());</span>
    } else {
<span class="nc" id="L552">      logger.error(</span>
<span class="nc" id="L553">          Messages.getString(FILE_BASED_CONFIGURATION_NOT_FOUND_CONFIG) +</span>
          &quot;Administrator name&quot;); //$NON-NLS-1$
<span class="nc" id="L555">      return false;</span>
    }
<span class="pc bpc" id="L557" title="1 of 2 branches missed.">    if (config.getCryptoKey() == null) {</span>
<span class="nc" id="L558">      XmlHash hashConfig2 = new XmlHash(hashRootConfig.get(XML_IDENTITY));</span>
      try {
<span class="nc bnc" id="L560" title="All 2 branches missed.">        if (!setCryptoKey(config, hashConfig2)) {</span>
<span class="nc" id="L561">          logger.error(</span>
<span class="nc" id="L562">              Messages.getString(FILE_BASED_CONFIGURATION_NOT_FOUND_CONFIG) +</span>
              &quot;Crypto Key&quot;); //$NON-NLS-1$
<span class="nc" id="L564">          return false;</span>
        }
      } finally {
<span class="nc" id="L567">        hashConfig2.clear();</span>
<span class="nc" id="L568">        hashConfig2 = null;</span>
      }
    }
    final byte[] decodedByteKeys;
<span class="fc" id="L572">    value = hashConfig.get(XML_SERVER_PASSWD_FILE);</span>
<span class="pc bpc" id="L573" title="2 of 4 branches missed.">    if (value == null || value.isEmpty()) {</span>
      final String passwd;
<span class="fc" id="L575">      value = hashConfig.get(XML_SERVER_PASSWD);</span>
<span class="pc bpc" id="L576" title="2 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L577">        passwd = value.getString();</span>
      } else {
<span class="nc" id="L579">        logger.error(</span>
<span class="nc" id="L580">            Messages.getString(FILE_BASED_CONFIGURATION_NOT_FOUND_CONFIG) +</span>
            &quot;Password&quot;); //$NON-NLS-1$
<span class="nc" id="L582">        return false;</span>
      }
      try {
<span class="fc" id="L585">        decodedByteKeys = config.getCryptoKey().decryptHexInBytes(passwd);</span>
<span class="nc" id="L586">      } catch (final Exception e) {</span>
<span class="nc" id="L587">        logger.error(</span>
            &quot;Unable to Decrypt Server Password in Config file from: &quot; + passwd +
<span class="nc" id="L589">            &quot;: {}&quot;, e.getMessage());</span>
<span class="nc" id="L590">        return false;</span>
<span class="fc" id="L591">      }</span>
<span class="fc" id="L592">    } else {</span>
<span class="nc" id="L593">      final String skey = value.getString();</span>
      // load key from file
<span class="nc" id="L595">      config.setServerKeyFile(skey);</span>
<span class="nc" id="L596">      final File key = new File(skey);</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">      if (!key.canRead()) {</span>
<span class="nc" id="L598">        logger.error(&quot;Unable to read Password in Config file from &quot; + skey);</span>
<span class="nc" id="L599">        return false;</span>
      }
      try {
<span class="nc" id="L602">        decodedByteKeys = config.getCryptoKey().decryptHexFile(key);</span>
<span class="nc" id="L603">      } catch (final Exception e2) {</span>
<span class="nc" id="L604">        logger.error(</span>
            &quot;Unable to Decrypt Server Password in Config file from: &quot; + skey +
<span class="nc" id="L606">            &quot;: {}&quot;, e2.getMessage());</span>
<span class="nc" id="L607">        return false;</span>
<span class="nc" id="L608">      }</span>
    }
<span class="fc" id="L610">    config.setSERVERKEY(decodedByteKeys);</span>
<span class="fc" id="L611">    value = hashConfig.get(XML_HTTPADMINPATH);</span>
<span class="pc bpc" id="L612" title="2 of 4 branches missed.">    if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L613">      logger.error(</span>
<span class="nc" id="L614">          Messages.getString(FILE_BASED_CONFIGURATION_NOT_FOUND_CONFIG) +</span>
          &quot;Http Admin Base&quot;); //$NON-NLS-1$
<span class="nc" id="L616">      return false;</span>
    }
<span class="fc" id="L618">    final String path = value.getString();</span>
<span class="pc bpc" id="L619" title="1 of 2 branches missed.">    if (ParametersChecker.isEmpty(path)) {</span>
<span class="nc" id="L620">      logger.error(Messages.getString(FILE_BASED_CONFIGURATION_NO_SET_CONFIG) +</span>
                   &quot;Http Admin Base&quot;); //$NON-NLS-1$
<span class="nc" id="L622">      return false;</span>
    }
<span class="fc" id="L624">    final File file = new File(path);</span>
<span class="fc bfc" id="L625" title="All 2 branches covered.">    if (!file.isDirectory()) {</span>
<span class="fc" id="L626">      logger.error(Messages.getString(&quot;FileBasedConfiguration.NotDirectory&quot;) +</span>
<span class="fc" id="L627">                   &quot;Http Admin Base {}&quot;, file.getAbsolutePath()); //$NON-NLS-1$</span>
<span class="fc" id="L628">      return false;</span>
    }
    try {
<span class="fc" id="L631">      config.setHttpBasePath(</span>
<span class="fc" id="L632">          AbstractDir.normalizePath(file.getCanonicalPath()) +</span>
          DirInterface.SEPARATOR);
<span class="nc" id="L634">    } catch (final IOException e1) {</span>
<span class="nc" id="L635">      logger.error(Messages.getString(FILE_BASED_CONFIGURATION_NO_SET_CONFIG) +</span>
                   &quot;Http Admin Path&quot;); //$NON-NLS-1$
<span class="nc" id="L637">      return false;</span>
<span class="fc" id="L638">    }</span>
<span class="fc" id="L639">    value = hashConfig.get(XML_HTTPADMINMODEL);</span>
    // 0 = standard, 1 = responsive (preferred default)
<span class="fc" id="L641">    int model =</span>
<span class="fc bfc" id="L642" title="All 2 branches covered.">        !new File(file, HttpResponsiveSslHandler.LISTING_PAGE).isFile()? 0 : 1;</span>
<span class="pc bpc" id="L643" title="2 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="nc" id="L644">      model = value.getInteger();</span>
    }
<span class="fc" id="L646">    config.setHttpModel(model);</span>

    // Key for HTTPS
<span class="fc" id="L649">    value = hashConfig.get(XML_PATH_ADMIN_KEYPATH);</span>
<span class="pc bpc" id="L650" title="2 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L651">      final String keypath = value.getString();</span>
<span class="pc bpc" id="L652" title="1 of 2 branches missed.">      if (ParametersChecker.isEmpty(keypath)) {</span>
<span class="nc" id="L653">        logger.error(&quot;Bad Key Path&quot;);</span>
<span class="nc" id="L654">        return false;</span>
      }
<span class="fc" id="L656">      value = hashConfig.get(XML_PATH_ADMIN_KEYSTOREPASS);</span>
<span class="pc bpc" id="L657" title="2 of 4 branches missed.">      if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L658">        logger.error(&quot;Unable to find: &quot; + &quot;KeyStore Passwd&quot;);</span>
<span class="nc" id="L659">        return false;</span>
      }
<span class="fc" id="L661">      final String keystorepass = value.getString();</span>
<span class="pc bpc" id="L662" title="1 of 2 branches missed.">      if (ParametersChecker.isEmpty(keystorepass)) {</span>
<span class="nc" id="L663">        logger.error(&quot;Bad KeyStore Passwd&quot;);</span>
<span class="nc" id="L664">        return false;</span>
      }
<span class="fc" id="L666">      value = hashConfig.get(XML_PATH_ADMIN_KEYPASS);</span>
<span class="pc bpc" id="L667" title="2 of 4 branches missed.">      if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L668">        logger.error(&quot;Unable to find :&quot; + &quot;Key Passwd&quot;);</span>
<span class="nc" id="L669">        return false;</span>
      }
<span class="fc" id="L671">      final String keypass = value.getString();</span>
<span class="pc bpc" id="L672" title="1 of 2 branches missed.">      if (ParametersChecker.isEmpty(keypass)) {</span>
<span class="nc" id="L673">        logger.error(&quot;Bad Key Passwd&quot;);</span>
<span class="nc" id="L674">        return false;</span>
      }
      try {
<span class="fc" id="L677">        Configuration.setWaarpSecureKeyStore(</span>
            new WaarpSecureKeyStore(keypath, keystorepass, keypass));
<span class="nc" id="L679">      } catch (final CryptoException e) {</span>
<span class="nc" id="L680">        logger.error(&quot;Bad SecureKeyStore construction for AdminSsl&quot;);</span>
<span class="nc" id="L681">        return false;</span>
<span class="fc" id="L682">      }</span>
      // No client authentication
<span class="fc" id="L684">      Configuration.getWaarpSecureKeyStore().initEmptyTrustStore();</span>
<span class="fc" id="L685">      Configuration.setWaarpSslContextFactory(</span>
<span class="fc" id="L686">          new WaarpSslContextFactory(Configuration.getWaarpSecureKeyStore(),</span>
                                     true));
    }
<span class="fc" id="L689">    value = hashConfig.get(XML_MONITOR_PASTLIMIT);</span>
<span class="pc bpc" id="L690" title="1 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L691">      config.setPastLimit((value.getLong() / 10) * 10);</span>
    }
<span class="fc" id="L693">    value = hashConfig.get(XML_MONITOR_MINIMALDELAY);</span>
<span class="pc bpc" id="L694" title="1 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L695">      config.setMinimalDelay((value.getLong() / 10) * 10);</span>
    }
<span class="fc" id="L697">    value = hashConfig.get(XML_MONITOR_SNMP_CONFIG);</span>
<span class="pc bpc" id="L698" title="2 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="nc" id="L699">      config.setSnmpConfig(value.getString());</span>
<span class="nc" id="L700">      final File snmpfile = new File(config.getSnmpConfig());</span>
<span class="nc bnc" id="L701" title="All 2 branches missed.">      if (snmpfile.canRead()) {</span>
<span class="nc bnc" id="L702" title="All 2 branches missed.">        if (!SnmpConfiguration.setConfigurationFromXml(snmpfile)) {</span>
<span class="nc" id="L703">          config.setSnmpConfig(null);</span>
        }
      } else {
<span class="nc" id="L706">        config.setSnmpConfig(null);</span>
      }
    }
<span class="fc" id="L709">    return true;</span>
  }

  /**
   * @param config
   *
   * @return True if the client parameters are correctly loaded
   */
  private static boolean loadClientParam(final Configuration config) {
<span class="fc" id="L718">    final XmlHash hashConfig = new XmlHash(hashRootConfig.get(XML_CLIENT));</span>
    try {
<span class="fc" id="L720">      XmlValue value = hashConfig.get(XML_SAVE_TASKRUNNERNODB);</span>
<span class="pc bpc" id="L721" title="1 of 4 branches missed.">      if (admin == null || admin.getTypeDriver() == DbType.none) {</span>
<span class="pc bpc" id="L722" title="2 of 4 branches missed.">        if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="nc" id="L723">          config.setSaveTaskRunnerWithNoDb(value.getBoolean());</span>
<span class="nc" id="L724">          logger.info(</span>
<span class="nc" id="L725">              Messages.getString(&quot;FileBasedConfiguration.NoDB&quot;)); //$NON-NLS-1$</span>
<span class="nc bnc" id="L726" title="All 2 branches missed.">          if (admin == null) {</span>
<span class="nc" id="L727">            admin = new DbAdmin(); // no database support</span>
<span class="nc" id="L728">            noCommitAdmin = admin;</span>
          }
        }
      }
<span class="fc" id="L732">      value = hashConfig.get(XML_BUSINESS_FACTORY);</span>
<span class="pc bpc" id="L733" title="2 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
        try {
<span class="nc" id="L735">          ParametersChecker.checkSanityString(value.getString());</span>
<span class="nc" id="L736">        } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L737">          logger.error(&quot;Bad Business Factory class: {}&quot;, e.getMessage());</span>
<span class="nc" id="L738">          return false;</span>
<span class="nc" id="L739">        }</span>
        try {
<span class="nc" id="L741">          config.setR66BusinessFactory(</span>
<span class="nc" id="L742">              (R66BusinessFactoryInterface) WaarpSystemUtil.newInstance(</span>
<span class="nc" id="L743">                  value.getString()));//NOSONAR</span>
<span class="nc" id="L744">        } catch (final Exception e) {</span>
<span class="nc" id="L745">          logger.error(&quot;Bad Business Factory class: {}&quot;, e.getMessage());</span>
<span class="nc" id="L746">          return false;</span>
<span class="nc" id="L747">        }</span>
      }
<span class="fc" id="L749">      return true;</span>
    } finally {
<span class="fc" id="L751">      hashConfig.clear();</span>
    }
  }

  /**
   * @param config
   *
   * @return True if the directory parameters are correctly loaded
   */
  private static boolean loadDirectory(final Configuration config) {
<span class="fc" id="L761">    XmlHash hashConfig = new XmlHash(hashRootConfig.get(XML_DIRECTORY));</span>
    try {
<span class="fc bfc" id="L763" title="All 2 branches covered.">      if (loadMinimalDirectory(config, hashConfig)) {</span>
<span class="fc" id="L764">        return false;</span>
      }
      try {
<span class="fc" id="L767">        config.setInPath(</span>
<span class="fc" id="L768">            AbstractDir.normalizePath(getSubPath(config, XML_INPATH)));</span>
<span class="nc" id="L769">      } catch (final OpenR66ProtocolSystemException e2) {</span>
<span class="nc" id="L770">        logger.error(</span>
<span class="nc" id="L771">            Messages.getString(FILE_BASED_CONFIGURATION_NO_SET_CONFIG) +</span>
            &quot;In&quot;); //$NON-NLS-1$
<span class="nc" id="L773">        return false;</span>
<span class="nc" id="L774">      } catch (final BadConfigurationException e2) {</span>
<span class="nc" id="L775">        logger.error(</span>
<span class="nc" id="L776">            Messages.getString(FILE_BASED_CONFIGURATION_INVALID_CONFIG) +</span>
<span class="nc" id="L777">            &quot;In ({})&quot;, e2.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L778">        return false;</span>
<span class="fc" id="L779">      }</span>
      try {
<span class="fc" id="L781">        config.setOutPath(</span>
<span class="fc" id="L782">            AbstractDir.normalizePath(getSubPath(config, XML_OUTPATH)));</span>
<span class="nc" id="L783">      } catch (final OpenR66ProtocolSystemException e2) {</span>
<span class="nc" id="L784">        logger.error(</span>
<span class="nc" id="L785">            Messages.getString(FILE_BASED_CONFIGURATION_NO_SET_CONFIG) +</span>
            &quot;Out&quot;); //$NON-NLS-1$
<span class="nc" id="L787">        return false;</span>
<span class="nc" id="L788">      } catch (final BadConfigurationException e2) {</span>
<span class="nc" id="L789">        logger.error(</span>
<span class="nc" id="L790">            Messages.getString(FILE_BASED_CONFIGURATION_INVALID_CONFIG) +</span>
<span class="nc" id="L791">            &quot;Out ({})&quot;, e2.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L792">        return false;</span>
<span class="fc" id="L793">      }</span>
      try {
<span class="fc" id="L795">        config.setWorkingPath(</span>
<span class="fc" id="L796">            AbstractDir.normalizePath(getSubPath(config, XML_WORKINGPATH)));</span>
<span class="nc" id="L797">      } catch (final OpenR66ProtocolSystemException e2) {</span>
<span class="nc" id="L798">        logger.error(</span>
<span class="nc" id="L799">            Messages.getString(FILE_BASED_CONFIGURATION_NO_SET_CONFIG) +</span>
            &quot;Working&quot;); //$NON-NLS-1$
<span class="nc" id="L801">        return false;</span>
<span class="nc" id="L802">      } catch (final BadConfigurationException e2) {</span>
<span class="nc" id="L803">        logger.error(</span>
<span class="nc" id="L804">            Messages.getString(FILE_BASED_CONFIGURATION_INVALID_CONFIG) +</span>
<span class="nc" id="L805">            &quot;Working ({})&quot;, e2.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L806">        return false;</span>
<span class="fc" id="L807">      }</span>
<span class="fc" id="L808">      loadExtendTaskFactory(config);</span>
<span class="fc" id="L809">      return true;</span>
    } finally {
<span class="fc" id="L811">      hashConfig.clear();</span>
<span class="fc" id="L812">      hashConfig = null;</span>
    }
  }

  private static boolean loadExtendTaskFactory(final Configuration config) {
<span class="fc" id="L817">    final XmlHash hashConfig =</span>
<span class="fc" id="L818">        new XmlHash(hashRootConfig.get(XML_EXTEND_TASK_FACTORY));</span>
    try {
<span class="fc" id="L820">      final XmlValue xfactories = hashConfig.get(XML_EXTENDED_TASK_FACTORIES);</span>
<span class="pc bpc" id="L821" title="2 of 4 branches missed.">      if (xfactories != null &amp;&amp; !xfactories.isEmpty()) {</span>
<span class="nc" id="L822">        final String sextendedFactoryClassList = xfactories.getString();</span>
        // Initiate Extended Task Factory
<span class="nc" id="L824">        final String[] extendedFactories = sextendedFactoryClassList.split(&quot;,&quot;);</span>
<span class="nc bnc" id="L825" title="All 2 branches missed.">        for (final String extendedFactory : extendedFactories) {</span>
          try {
<span class="nc" id="L827">            WaarpSystemUtil.newInstance(extendedFactory);</span>
<span class="nc" id="L828">            logger.warn(&quot;Added ExtendedTaskFactory: {}&quot;, extendedFactory);</span>
<span class="nc" id="L829">          } catch (final Exception e) {</span>
<span class="nc" id="L830">            logger.error(Messages.getString(</span>
                &quot;ServerInitDatabase.ExtendedTaskFactory.error&quot;) +
<span class="nc" id="L832">                         extendedFactory + &quot; = &quot; + e.getMessage());</span>
<span class="nc" id="L833">          }</span>
        }
      }
<span class="fc" id="L836">      return true;</span>
    } finally {
<span class="fc" id="L838">      hashConfig.clear();</span>
    }
  }

  public static boolean loadMinimalDirectory(final Configuration config,
                                             final XmlHash hashConfig) {
<span class="fc" id="L844">    final XmlValue value = hashConfig.get(XML_SERVER_HOME);</span>
<span class="pc bpc" id="L845" title="2 of 4 branches missed.">    if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L846">      logger.error(</span>
<span class="nc" id="L847">          Messages.getString(FILE_BASED_CONFIGURATION_NOT_FOUND_CONFIG) +</span>
          &quot;Home&quot;); //$NON-NLS-1$
<span class="nc" id="L849">      return true;</span>
    }
<span class="fc" id="L851">    final String path = value.getString();</span>
<span class="fc" id="L852">    final File file = new File(path);</span>
<span class="pc bpc" id="L853" title="1 of 2 branches missed.">    if (!file.isDirectory()) {</span>
<span class="nc" id="L854">      logger.error(Messages.getString(&quot;FileBasedConfiguration.NotDirectory&quot;) +</span>
                   &quot;Home&quot;); //$NON-NLS-1$
<span class="nc" id="L856">      return true;</span>
    }
    try {
<span class="fc" id="L859">      config.setBaseDirectory(</span>
<span class="fc" id="L860">          AbstractDir.normalizePath(file.getCanonicalPath()));</span>
<span class="nc" id="L861">    } catch (final IOException e1) {</span>
<span class="nc" id="L862">      logger.error(Messages.getString(FILE_BASED_CONFIGURATION_NO_SET_CONFIG) +</span>
                   &quot;Home&quot;); //$NON-NLS-1$
<span class="nc" id="L864">      return true;</span>
<span class="fc" id="L865">    }</span>
    try {
<span class="fc" id="L867">      config.setConfigPath(</span>
<span class="fc" id="L868">          AbstractDir.normalizePath(getSubPath(config, XML_CONFIGPATH)));</span>
<span class="nc" id="L869">    } catch (final OpenR66ProtocolSystemException e2) {</span>
<span class="nc" id="L870">      logger.error(Messages.getString(FILE_BASED_CONFIGURATION_NO_SET_CONFIG) +</span>
                   &quot;Config&quot;); //$NON-NLS-1$
<span class="nc" id="L872">      return true;</span>
<span class="fc" id="L873">    } catch (final BadConfigurationException e2) {</span>
<span class="fc" id="L874">      logger.error(Messages.getString(FILE_BASED_CONFIGURATION_INVALID_CONFIG) +</span>
<span class="fc" id="L875">                   &quot;Config ({})&quot;, e2.getMessage()); //$NON-NLS-1$</span>
<span class="fc" id="L876">      return true;</span>
<span class="fc" id="L877">    }</span>
    try {
<span class="fc" id="L879">      config.setArchivePath(</span>
<span class="fc" id="L880">          AbstractDir.normalizePath(getSubPath(config, XML_ARCHIVEPATH)));</span>
<span class="nc" id="L881">    } catch (final OpenR66ProtocolSystemException e2) {</span>
<span class="nc" id="L882">      logger.error(Messages.getString(FILE_BASED_CONFIGURATION_NO_SET_CONFIG) +</span>
                   &quot;Archive&quot;); //$NON-NLS-1$
<span class="nc" id="L884">      return true;</span>
<span class="nc" id="L885">    } catch (final BadConfigurationException e2) {</span>
<span class="nc" id="L886">      logger.error(Messages.getString(FILE_BASED_CONFIGURATION_INVALID_CONFIG) +</span>
<span class="nc" id="L887">                   &quot;Archive ({})&quot;, e2.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L888">      return true;</span>
<span class="fc" id="L889">    }</span>
<span class="fc" id="L890">    return false;</span>
  }

  private static boolean alreadySetLimit;

  /**
   * Mainly for Junit
   */
  public static void resetAlreadySetLimit() {
<span class="fc" id="L899">    alreadySetLimit = false;</span>
    // Clear Partner
<span class="fc" id="L901">    Configuration.configuration.getVersions().clear();</span>
<span class="fc" id="L902">  }</span>

  /**
   * @param config
   * @param updateLimit
   *
   * @return True if the limit configuration is correctly loaded
   */
  private static boolean loadLimit(final Configuration config,
                                   final boolean updateLimit) {
<span class="fc bfc" id="L912" title="All 2 branches covered.">    if (alreadySetLimit) {</span>
<span class="fc" id="L913">      return true;</span>
    }
<span class="fc" id="L915">    XmlHash hashConfig = new XmlHash(hashRootConfig.get(XML_LIMIT));</span>
    try {
<span class="fc" id="L917">      loadCommonLimit(config, hashConfig, updateLimit);</span>
      XmlValue value;
<span class="fc" id="L919">      value = hashConfig.get(XML_LIMITRUNNING);</span>
<span class="pc bpc" id="L920" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L921">        config.setRunnerThread(value.getInteger());</span>
      }
<span class="fc" id="L923">      logger.info(&quot;Limit of Runner: {}&quot;, config.getRunnerThread());</span>
<span class="fc" id="L924">      value = hashConfig.get(XML_DELAYCOMMANDER);</span>
<span class="pc bpc" id="L925" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L926">        config.setDelayCommander((value.getLong() / 10) * 10);</span>
<span class="pc bpc" id="L927" title="1 of 2 branches missed.">        if (config.getDelayCommander() &lt;= 100) {</span>
<span class="nc" id="L928">          config.setDelayCommander(100);</span>
        }
<span class="fc" id="L930">        logger.info(&quot;Delay Commander: {}&quot;, config.getDelayCommander());</span>
      }
<span class="fc" id="L932">      value = hashConfig.get(XML_DIGEST);</span>
<span class="pc bpc" id="L933" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
        try {
<span class="fc" id="L935">          int val = value.getInteger();</span>
<span class="pc bpc" id="L936" title="2 of 4 branches missed.">          if (val &lt; 0 || val &gt;= DigestAlgo.values().length) {</span>
<span class="nc" id="L937">            val = 0;</span>
          }
<span class="fc" id="L939">          config.setDigest(DigestAlgo.values()[val]);</span>
<span class="nc" id="L940">        } catch (final IllegalArgumentException e) {</span>
          // might be String
<span class="nc" id="L942">          final String val = value.getString();</span>
<span class="nc" id="L943">          config.setDigest(PartnerConfiguration.getDigestAlgo(val));</span>
<span class="fc" id="L944">        }</span>
      }
<span class="fc" id="L946">      logger.info(&quot;DigestAlgo used: {}&quot;, config.getDigest());</span>
<span class="fc" id="L947">      value = hashConfig.get(XML_GAPRESTART);</span>
<span class="pc bpc" id="L948" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L949">        Configuration.setRankRestart(value.getInteger());</span>
<span class="pc bpc" id="L950" title="1 of 2 branches missed.">        if (Configuration.getRankRestart() &lt;= 0) {</span>
<span class="nc" id="L951">          Configuration.setRankRestart(1);</span>
        }
      }
<span class="fc" id="L954">      value = hashConfig.get(XML_BLOCKSIZE);</span>
<span class="pc bpc" id="L955" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L956">        config.setBlockSize(value.getInteger());</span>
      }
<span class="fc" id="L958">      value = hashConfig.get(XML_USETHRIFT);</span>
<span class="pc bpc" id="L959" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L960">        config.setThriftport(value.getInteger());</span>
      }
<span class="fc" id="L962">      value = hashConfig.get(XML_CHECKVERSION);</span>
<span class="pc bpc" id="L963" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L964">        config.setExtendedProtocol(value.getBoolean());</span>
<span class="fc" id="L965">        logger.info(&quot;ExtendedProtocol= &quot; + config.isExtendedProtocol());</span>
      }
<span class="fc" id="L967">      value = hashConfig.get(XML_GLOBALDIGEST);</span>
<span class="pc bpc" id="L968" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L969">        config.setGlobalDigest(value.getBoolean());</span>
      }
<span class="fc" id="L971">      value = hashConfig.get(XML_LOCALDIGEST);</span>
<span class="pc bpc" id="L972" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L973">        config.setLocalDigest(value.getBoolean());</span>
      }
<span class="fc" id="L975">      value = hashConfig.get(XML_COMPRESSION);</span>
<span class="pc bpc" id="L976" title="2 of 6 branches missed.">      logger.info(&quot;Compression {} {}&quot;, value != null &amp;&amp; !value.isEmpty(),</span>
<span class="fc bfc" id="L977" title="All 2 branches covered.">                  value != null &amp;&amp; !value.isEmpty()? value.getBoolean() :</span>
                      false);
<span class="pc bpc" id="L979" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L980">        config.setCompressionAvailable(value.getBoolean());</span>
      }
<span class="fc" id="L982">      alreadySetLimit = true;</span>
<span class="fc" id="L983">      return true;</span>
    } finally {
<span class="fc" id="L985">      hashConfig.clear();</span>
<span class="fc" id="L986">      hashConfig = null;</span>
    }
  }

  public static void loadCommonLimit(final Configuration config,
                                     final XmlHash hashConfig,
                                     final boolean updateLimit) {
<span class="fc" id="L993">    XmlValue value = hashConfig.get(XML_LIMITGLOBAL);</span>
<span class="pc bpc" id="L994" title="1 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L995">      config.setServerGlobalReadLimit(value.getLong());</span>
<span class="fc bfc" id="L996" title="All 2 branches covered.">      if (config.getServerGlobalReadLimit() &lt;= 0) {</span>
<span class="fc" id="L997">        config.setServerGlobalReadLimit(0);</span>
      }
<span class="fc" id="L999">      config.setServerGlobalWriteLimit(config.getServerGlobalReadLimit());</span>
<span class="fc" id="L1000">      logger.info(&quot;Global Limit: {}&quot;, config.getServerGlobalReadLimit());</span>
    }
<span class="fc" id="L1002">    value = hashConfig.get(XML_LIMITSESSION);</span>
<span class="pc bpc" id="L1003" title="1 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1004">      config.setServerChannelReadLimit(value.getLong());</span>
<span class="fc bfc" id="L1005" title="All 2 branches covered.">      if (config.getServerChannelReadLimit() &lt;= 0) {</span>
<span class="fc" id="L1006">        config.setServerChannelReadLimit(0);</span>
      }
<span class="fc" id="L1008">      config.setServerChannelWriteLimit(config.getServerChannelReadLimit());</span>
<span class="fc" id="L1009">      logger.info(&quot;SessionInterface Limit: {}&quot;,</span>
<span class="fc" id="L1010">                  config.getServerChannelReadLimit());</span>
    }
<span class="fc" id="L1012">    config.setDelayLimit(AbstractTrafficShapingHandler.DEFAULT_CHECK_INTERVAL);</span>
<span class="fc" id="L1013">    value = hashConfig.get(XML_LIMITDELAY);</span>
<span class="pc bpc" id="L1014" title="1 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1015">      config.setDelayLimit((value.getLong() / 10) * 10);</span>
<span class="pc bpc" id="L1016" title="1 of 2 branches missed.">      if (config.getDelayLimit() &lt;= 0) {</span>
<span class="nc" id="L1017">        config.setDelayLimit(0);</span>
      }
<span class="fc" id="L1019">      logger.info(&quot;Delay Limit: {}&quot;, config.getDelayLimit());</span>
    }
<span class="fc" id="L1021">    value = hashConfig.get(XML_DELAYRETRY);</span>
<span class="pc bpc" id="L1022" title="2 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1023">      config.setDelayRetry((value.getLong() / 10) * 10);</span>
<span class="fc bfc" id="L1024" title="All 2 branches covered.">      if (config.getDelayRetry() &lt;= 1000) {</span>
<span class="fc" id="L1025">        config.setDelayRetry(1000);</span>
      }
<span class="fc" id="L1027">      logger.info(&quot;Delay Retry: {}&quot;, config.getDelayRetry());</span>
    }
<span class="fc bfc" id="L1029" title="All 2 branches covered.">    if (updateLimit) {</span>
<span class="fc" id="L1030">      value = hashConfig.get(XML_SERVER_HOSTID);</span>
<span class="pc bpc" id="L1031" title="3 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="nc" id="L1032">        config.setHostId(value.getString());</span>
        try {
<span class="nc" id="L1034">          final DbConfiguration configuration =</span>
<span class="nc" id="L1035">              new DbConfiguration(config.getHostId(),</span>
<span class="nc" id="L1036">                                  config.getServerGlobalReadLimit(),</span>
<span class="nc" id="L1037">                                  config.getServerGlobalWriteLimit(),</span>
<span class="nc" id="L1038">                                  config.getServerChannelReadLimit(),</span>
<span class="nc" id="L1039">                                  config.getServerChannelWriteLimit(),</span>
<span class="nc" id="L1040">                                  config.getDelayLimit());</span>
<span class="nc" id="L1041">          configuration.changeUpdatedInfo(UpdatedInfo.TOSUBMIT);</span>
<span class="nc bnc" id="L1042" title="All 2 branches missed.">          if (configuration.exist()) {</span>
<span class="nc" id="L1043">            configuration.update();</span>
          } else {
<span class="nc" id="L1045">            configuration.insert();</span>
          }
<span class="nc" id="L1047">        } catch (final WaarpDatabaseException ignored) {</span>
          // nothing
<span class="nc" id="L1049">        }</span>
      }
    }
<span class="fc" id="L1052">    boolean useCpuLimit = false;</span>
<span class="fc" id="L1053">    boolean useCpuLimitJDK = false;</span>
<span class="fc" id="L1054">    double cpulimit = 1.0;</span>
<span class="fc" id="L1055">    value = hashConfig.get(XML_CSTRT_USECPULIMIT);</span>
<span class="pc bpc" id="L1056" title="1 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1057">      useCpuLimit = value.getBoolean();</span>
<span class="fc" id="L1058">      value = hashConfig.get(XML_CSTRT_USECPUJDKLIMIT);</span>
<span class="pc bpc" id="L1059" title="2 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1060">        useCpuLimitJDK = value.getBoolean();</span>
      }
<span class="fc" id="L1062">      value = hashConfig.get(XML_CSTRT_CPULIMIT);</span>
<span class="pc bpc" id="L1063" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1064">        cpulimit = value.getDouble();</span>
<span class="pc bpc" id="L1065" title="1 of 2 branches missed.">        if (cpulimit &gt; 0.99) {</span>
<span class="nc" id="L1066">          cpulimit = 1.0;</span>
        }
      }
    }
<span class="fc" id="L1070">    int connlimit = 0;</span>
<span class="fc" id="L1071">    value = hashConfig.get(XML_CSTRT_CONNLIMIT);</span>
<span class="pc bpc" id="L1072" title="1 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1073">      connlimit = value.getInteger();</span>
<span class="pc bpc" id="L1074" title="1 of 2 branches missed.">      if (connlimit &lt; 100) {</span>
<span class="fc" id="L1075">        connlimit = 0;</span>
      }
    }
<span class="fc" id="L1078">    double lowcpuLimit = 0.0;</span>
<span class="fc" id="L1079">    double highcpuLimit = 0.0;</span>
<span class="fc" id="L1080">    double percentageDecrease = 0;</span>
<span class="fc" id="L1081">    long delay = 1000000;</span>
<span class="fc" id="L1082">    long limitLowBandwidth = WaarpConstraintLimitHandler.LOWBANDWIDTH_DEFAULT;</span>
<span class="fc" id="L1083">    value = hashConfig.get(XML_CSTRT_LOWCPULIMIT);</span>
<span class="pc bpc" id="L1084" title="1 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1085">      lowcpuLimit = value.getDouble();</span>
    }
<span class="fc" id="L1087">    value = hashConfig.get(XML_CSTRT_HIGHCPULIMIT);</span>
<span class="pc bpc" id="L1088" title="1 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1089">      highcpuLimit = value.getDouble();</span>
<span class="pc bpc" id="L1090" title="1 of 2 branches missed.">      if (highcpuLimit &lt; 0.1) {</span>
<span class="nc" id="L1091">        highcpuLimit = 0.0;</span>
      }
    }
<span class="fc" id="L1094">    value = hashConfig.get(XML_CSTRT_PERCENTDECREASE);</span>
<span class="pc bpc" id="L1095" title="1 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1096">      percentageDecrease = value.getDouble();</span>
    }
<span class="fc" id="L1098">    value = hashConfig.get(XML_CSTRT_DELAYTHROTTLE);</span>
<span class="pc bpc" id="L1099" title="1 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1100">      delay = (value.getLong() / 10) * 10;</span>
<span class="pc bpc" id="L1101" title="1 of 2 branches missed.">      if (delay &lt; 100) {</span>
<span class="nc" id="L1102">        delay = 100;</span>
      }
    }
<span class="fc" id="L1105">    value = hashConfig.get(XML_CSTRT_LIMITLOWBANDWIDTH);</span>
<span class="pc bpc" id="L1106" title="1 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1107">      limitLowBandwidth = value.getLong();</span>
    }
<span class="pc bpc" id="L1109" title="1 of 2 branches missed.">    if (config.getConstraintLimitHandler() != null) {</span>
<span class="fc" id="L1110">      config.getConstraintLimitHandler().release();</span>
    }
<span class="pc bpc" id="L1112" title="1 of 4 branches missed.">    if (useCpuLimit || highcpuLimit &gt; 0) {</span>
<span class="pc bpc" id="L1113" title="1 of 2 branches missed.">      if (highcpuLimit &gt; 0) {</span>
<span class="fc" id="L1114">        logger.debug(&quot;full setup of ContraintLimitHandler&quot;);</span>
<span class="fc" id="L1115">        config.setConstraintLimitHandler(</span>
            new R66ConstraintLimitHandler(useCpuLimit, useCpuLimitJDK, cpulimit,
                                          connlimit, lowcpuLimit, highcpuLimit,
                                          percentageDecrease, null, delay,
                                          limitLowBandwidth));
      } else {
<span class="nc" id="L1121">        logger.debug(&quot;partial setup of ContraintLimitHandler&quot;);</span>
<span class="nc" id="L1122">        config.setConstraintLimitHandler(</span>
            new R66ConstraintLimitHandler(useCpuLimit, useCpuLimitJDK, cpulimit,
                                          connlimit));
      }
    } else {
<span class="fc" id="L1127">      logger.debug(&quot;No setup of ContraintLimitHandler&quot;);</span>
<span class="fc" id="L1128">      config.setConstraintLimitHandler(</span>
          new R66ConstraintLimitHandler(false, false, 1.0, connlimit));
    }
<span class="fc" id="L1131">    value = hashConfig.get(XML_SERVER_THREAD);</span>
<span class="pc bpc" id="L1132" title="1 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1133">      config.setServerThread(value.getInteger());</span>
    }
<span class="fc" id="L1135">    value = hashConfig.get(XML_CLIENT_THREAD);</span>
<span class="pc bpc" id="L1136" title="1 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1137">      config.setClientThread(value.getInteger());</span>
    }
<span class="fc" id="L1139">    value = hashConfig.get(XML_MEMORY_LIMIT);</span>
<span class="pc bpc" id="L1140" title="1 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1141">      long lvalue = value.getLong();</span>
<span class="fc bfc" id="L1142" title="All 2 branches covered.">      if (lvalue &gt; Integer.MAX_VALUE) {</span>
<span class="fc" id="L1143">        lvalue = Integer.MAX_VALUE;</span>
      }
<span class="fc" id="L1145">      config.setMaxGlobalMemory((int) lvalue);</span>
    }
<span class="fc" id="L1147">    Configuration.getFileParameter().deleteOnAbort = false;</span>
<span class="fc" id="L1148">    value = hashConfig.get(XML_USENIO);</span>
<span class="pc bpc" id="L1149" title="1 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1150">      FilesystemBasedFileParameterImpl.useNio = value.getBoolean();</span>
    }
<span class="fc" id="L1152">    value = hashConfig.get(XML_TIMEOUTCON);</span>
<span class="pc bpc" id="L1153" title="2 of 4 branches missed.">    if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1154">      config.setTimeoutCon((value.getLong() / 10) * 10);</span>
<span class="fc" id="L1155">      config.getShutdownConfiguration().timeout = config.getTimeoutCon();</span>
    }
<span class="fc" id="L1157">  }</span>

  /**
   * @param config
   * @param hashRootConfig
   *
   * @return True if the SSL configuration is correctly loaded
   */
  public static boolean loadSsl(final Configuration config,
                                final XmlRootHash hashRootConfig) {
<span class="fc" id="L1167">    XmlHash hashConfig = new XmlHash(hashRootConfig.get(XML_SSL));</span>
    try {
      // StoreKey for Server
<span class="fc" id="L1170">      XmlValue value = hashConfig.get(XML_PATH_KEYPATH);</span>
<span class="pc bpc" id="L1171" title="2 of 4 branches missed.">      if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L1172">        logger.info(&quot;Unable to find Key Path&quot;);</span>
        try {
<span class="nc" id="L1174">          NetworkSslServerInitializer.setWaarpSecureKeyStore(</span>
              new WaarpSecureKeyStore(&quot;secret&quot;, &quot;secret&quot;));//NOSONAR
<span class="nc" id="L1176">        } catch (final CryptoException e) {</span>
<span class="nc" id="L1177">          logger.error(&quot;Bad SecureKeyStore construction&quot;);</span>
<span class="nc" id="L1178">          return false;</span>
<span class="nc" id="L1179">        }</span>
      } else {
<span class="fc" id="L1181">        final String keypath = value.getString();</span>
<span class="pc bpc" id="L1182" title="1 of 2 branches missed.">        if (ParametersChecker.isEmpty(keypath)) {</span>
<span class="nc" id="L1183">          logger.error(&quot;Bad Key Path&quot;);</span>
<span class="nc" id="L1184">          return false;</span>
        }
<span class="fc" id="L1186">        value = hashConfig.get(XML_PATH_KEYSTOREPASS);</span>
<span class="pc bpc" id="L1187" title="2 of 4 branches missed.">        if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L1188">          logger.error(&quot;Unable to find KeyStore Passwd&quot;);</span>
<span class="nc" id="L1189">          return false;</span>
        }
<span class="fc" id="L1191">        final String keystorepass = value.getString();</span>
<span class="pc bpc" id="L1192" title="1 of 2 branches missed.">        if (ParametersChecker.isEmpty(keystorepass)) {</span>
<span class="nc" id="L1193">          logger.error(&quot;Bad KeyStore Passwd&quot;);</span>
<span class="nc" id="L1194">          return false;</span>
        }
<span class="fc" id="L1196">        value = hashConfig.get(XML_PATH_KEYPASS);</span>
<span class="pc bpc" id="L1197" title="2 of 4 branches missed.">        if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L1198">          logger.error(&quot;Unable to find Key Passwd&quot;);</span>
<span class="nc" id="L1199">          return false;</span>
        }
<span class="fc" id="L1201">        final String keypass = value.getString();</span>
<span class="pc bpc" id="L1202" title="1 of 2 branches missed.">        if (ParametersChecker.isEmpty(keypass)) {</span>
<span class="nc" id="L1203">          logger.error(&quot;Bad Key Passwd&quot;);</span>
<span class="nc" id="L1204">          return false;</span>
        }
        try {
<span class="fc" id="L1207">          NetworkSslServerInitializer.setWaarpSecureKeyStore(</span>
              new WaarpSecureKeyStore(keypath, keystorepass, keypass));
<span class="nc" id="L1209">        } catch (final CryptoException e) {</span>
<span class="nc" id="L1210">          logger.error(&quot;Bad SecureKeyStore construction&quot;);</span>
<span class="nc" id="L1211">          return false;</span>
<span class="fc" id="L1212">        }</span>
      }
      // TrustedKey for OpenR66 server
<span class="fc" id="L1215">      value = hashConfig.get(XML_PATH_TRUSTKEYPATH);</span>
<span class="pc bpc" id="L1216" title="2 of 4 branches missed.">      if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L1217">        logger.info(&quot;Unable to find TRUST Key Path&quot;);</span>
<span class="nc" id="L1218">        NetworkSslServerInitializer.getWaarpSecureKeyStore()</span>
<span class="nc" id="L1219">                                   .initEmptyTrustStore();</span>
      } else {
<span class="fc" id="L1221">        final String keypath = value.getString();</span>
<span class="pc bpc" id="L1222" title="1 of 2 branches missed.">        if (ParametersChecker.isEmpty(keypath)) {</span>
<span class="nc" id="L1223">          logger.error(&quot;Bad TRUST Key Path&quot;);</span>
<span class="nc" id="L1224">          return false;</span>
        }
<span class="fc" id="L1226">        value = hashConfig.get(XML_PATH_TRUSTKEYSTOREPASS);</span>
<span class="pc bpc" id="L1227" title="2 of 4 branches missed.">        if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L1228">          logger.error(&quot;Unable to find TRUST KeyStore Passwd&quot;);</span>
<span class="nc" id="L1229">          return false;</span>
        }
<span class="fc" id="L1231">        final String keystorepass = value.getString();</span>
<span class="pc bpc" id="L1232" title="1 of 2 branches missed.">        if (ParametersChecker.isEmpty(keystorepass)) {</span>
<span class="nc" id="L1233">          logger.error(&quot;Bad TRUST KeyStore Passwd&quot;);</span>
<span class="nc" id="L1234">          return false;</span>
        }
<span class="fc" id="L1236">        boolean useClientAuthent = false;</span>
<span class="fc" id="L1237">        value = hashConfig.get(XML_USECLIENT_AUTHENT);</span>
<span class="pc bpc" id="L1238" title="2 of 4 branches missed.">        if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1239">          useClientAuthent = value.getBoolean();</span>
        }
        try {
<span class="fc" id="L1242">          NetworkSslServerInitializer.getWaarpSecureKeyStore()</span>
<span class="fc" id="L1243">                                     .initTrustStore(keypath, keystorepass,</span>
                                                     useClientAuthent);
<span class="nc" id="L1245">        } catch (final CryptoException e) {</span>
<span class="nc" id="L1246">          logger.error(&quot;Bad TrustKeyStore construction&quot;);</span>
<span class="nc" id="L1247">          return false;</span>
<span class="fc" id="L1248">        }</span>
      }
<span class="fc" id="L1250">      NetworkSslServerInitializer.setWaarpSslContextFactory(</span>
          new WaarpSslContextFactory(
<span class="fc" id="L1252">              NetworkSslServerInitializer.getWaarpSecureKeyStore()));</span>
<span class="fc" id="L1253">      return true;</span>
    } finally {
<span class="fc" id="L1255">      hashConfig.clear();</span>
<span class="fc" id="L1256">      hashConfig = null;</span>
    }
  }

  /**
   * @param config
   *
   * @return True if the network configuration is correctly loaded
   */
  private static boolean loadNetworkServer(final Configuration config) {
<span class="fc" id="L1266">    XmlHash hashConfig = new XmlHash(hashRootConfig.get(XML_NETWORK));</span>
    try {
<span class="fc" id="L1268">      XmlValue value = hashConfig.get(XML_SERVER_PORT);</span>
<span class="fc" id="L1269">      int port = 6666;</span>
<span class="pc bpc" id="L1270" title="2 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1271">        port = value.getInteger();</span>
      }
<span class="fc" id="L1273">      config.setServerPort(port);</span>
<span class="fc" id="L1274">      value = hashConfig.get(XML_SERVER_ADDRESSES);</span>
<span class="fc" id="L1275">      String[] ips = null;</span>
<span class="pc bpc" id="L1276" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1277">        final String temp = value.getString();</span>
<span class="fc" id="L1278">        ips = temp.split(&quot;,&quot;);</span>
      }
<span class="fc" id="L1280">      config.setServerAddresses(ips);</span>
<span class="fc" id="L1281">      value = hashConfig.get(XML_SERVER_SSLPORT);</span>
<span class="fc" id="L1282">      int sslport = 6667;</span>
<span class="pc bpc" id="L1283" title="2 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1284">        sslport = value.getInteger();</span>
      }
<span class="fc" id="L1286">      config.setServerSslPort(sslport);</span>
<span class="fc" id="L1287">      value = hashConfig.get(XML_SERVER_SSL_ADDRESSES);</span>
<span class="fc" id="L1288">      String[] ipsTls = null;</span>
<span class="pc bpc" id="L1289" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1290">        final String temp = value.getString();</span>
<span class="fc" id="L1291">        ipsTls = temp.split(&quot;,&quot;);</span>
      }
<span class="fc" id="L1293">      config.setServerSslAddresses(ipsTls);</span>
<span class="fc" id="L1294">      value = hashConfig.get(XML_SERVER_HTTPPORT);</span>
<span class="fc" id="L1295">      int httpport = 8066;</span>
<span class="pc bpc" id="L1296" title="2 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1297">        httpport = value.getInteger();</span>
      }
<span class="fc" id="L1299">      config.setServerHttpport(httpport);</span>
<span class="fc" id="L1300">      value = hashConfig.get(XML_SERVER_HTTP_ADDRESSES);</span>
<span class="fc" id="L1301">      String[] ipsHttp = null;</span>
<span class="pc bpc" id="L1302" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1303">        final String temp = value.getString();</span>
<span class="fc" id="L1304">        ipsHttp = temp.split(&quot;,&quot;);</span>
      }
<span class="fc" id="L1306">      config.setServerHttpAddresses(ipsHttp);</span>
<span class="fc" id="L1307">      value = hashConfig.get(XML_SERVER_HTTPSPORT);</span>
<span class="fc" id="L1308">      int httpsport = 8067;</span>
<span class="pc bpc" id="L1309" title="2 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1310">        httpsport = value.getInteger();</span>
      }
<span class="fc" id="L1312">      config.setServerHttpsPort(httpsport);</span>
<span class="fc" id="L1313">      value = hashConfig.get(XML_SERVER_HTTPS_ADDRESSES);</span>
<span class="fc" id="L1314">      String[] ipsHttpTls = null;</span>
<span class="pc bpc" id="L1315" title="1 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1316">        final String temp = value.getString();</span>
<span class="fc" id="L1317">        ipsHttpTls = temp.split(&quot;,&quot;);</span>
      }
<span class="fc" id="L1319">      config.setServerHttpsAddresses(ipsHttpTls);</span>
<span class="fc" id="L1320">      return true;</span>
    } finally {
<span class="fc" id="L1322">      hashConfig.clear();</span>
<span class="fc" id="L1323">      hashConfig = null;</span>
    }
  }

  /**
   * @param configuration
   *
   * @return True if the REST configuration is correctly loaded
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private static boolean loadRest(final Configuration configuration) {
<span class="fc" id="L1334">    XmlHash hashConfig = new XmlHash(hashRootConfig.get(XML_REST));</span>
    try {
<span class="fc" id="L1336">      final XmlValue valueRest = hashConfig.get(XML_REST);</span>
<span class="pc bpc" id="L1337" title="2 of 4 branches missed.">      if (valueRest != null &amp;&amp; valueRest.getList() != null) {</span>
<span class="fc bfc" id="L1338" title="All 2 branches covered.">        for (final XmlValue[] xml : (Iterable&lt;XmlValue[]&gt;) valueRest.getList()) {</span>
<span class="fc" id="L1339">          final RestConfiguration config = new RestConfiguration();</span>
<span class="fc" id="L1340">          final XmlHash subHash = new XmlHash(xml);</span>
<span class="fc" id="L1341">          XmlValue value = subHash.get(XML_SERVER_REST_PORT);</span>
<span class="fc" id="L1342">          int restPort = -1;</span>
<span class="pc bpc" id="L1343" title="2 of 4 branches missed.">          if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1344">            restPort = value.getInteger();</span>
          }
<span class="fc" id="L1346">          config.setRestPort(restPort);</span>
<span class="pc bpc" id="L1347" title="1 of 2 branches missed.">          if (config.getRestPort() &gt; 0) {</span>
<span class="fc" id="L1348">            value = subHash.get(XML_REST_ADDRESS);</span>
<span class="fc" id="L1349">            String restAddress = null;</span>
<span class="pc bpc" id="L1350" title="2 of 4 branches missed.">            if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1351">              restAddress = value.getString();</span>
            }
<span class="fc" id="L1353">            config.setRestAddress(restAddress);</span>
<span class="fc" id="L1354">            value = subHash.get(XML_REST_SSL);</span>
<span class="fc" id="L1355">            boolean restSsl = false;</span>
<span class="pc bpc" id="L1356" title="2 of 4 branches missed.">            if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1357">              restSsl = value.getBoolean();</span>
            }
<span class="fc" id="L1359">            config.setRestSsl(restSsl);</span>
<span class="fc" id="L1360">            value = subHash.get(XML_REST_AUTHENTICATED);</span>
<span class="fc" id="L1361">            boolean restAuthent = false;</span>
<span class="pc bpc" id="L1362" title="2 of 4 branches missed.">            if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1363">              restAuthent = value.getBoolean();</span>
            }
<span class="fc" id="L1365">            config.setRestAuthenticated(restAuthent);</span>
<span class="fc" id="L1366">            value = subHash.get(XML_REST_SIGNATURE);</span>
<span class="fc" id="L1367">            boolean restSignature = true;</span>
<span class="pc bpc" id="L1368" title="2 of 4 branches missed.">            if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1369">              restSignature = value.getBoolean();</span>
            }
<span class="fc" id="L1371">            config.setRestSignature(restSignature);</span>
<span class="fc bfc" id="L1372" title="All 4 branches covered.">            if (config.isRestSignature() || config.isRestAuthenticated()) {</span>
<span class="fc" id="L1373">              final XmlValue valueKey = subHash.get(XML_REST_AUTH_KEY);</span>
<span class="pc bpc" id="L1374" title="2 of 4 branches missed.">              if (valueKey != null &amp;&amp; !valueKey.isEmpty()) {</span>
<span class="fc" id="L1375">                String fileKey = valueKey.getString();</span>
<span class="fc" id="L1376">                File file = new File(fileKey);</span>
<span class="pc bpc" id="L1377" title="1 of 2 branches missed.">                if (!file.canRead()) {</span>
<span class="nc" id="L1378">                  file = new File(</span>
<span class="nc" id="L1379">                      configuration.getConfigPath() + DirInterface.SEPARATOR +</span>
                      fileKey);
<span class="nc bnc" id="L1381" title="All 2 branches missed.">                  if (!file.canRead()) {</span>
<span class="nc" id="L1382">                    logger.error(&quot;Unable to find REST Key in Config file&quot;);</span>
<span class="nc" id="L1383">                    return false;</span>
                  }
<span class="nc" id="L1385">                  fileKey =</span>
<span class="nc" id="L1386">                      configuration.getConfigPath() + DirInterface.SEPARATOR +</span>
                      fileKey;
                }
                try {
<span class="fc" id="L1390">                  config.initializeKey(file);</span>
<span class="nc" id="L1391">                } catch (final CryptoException e) {</span>
<span class="nc" id="L1392">                  logger.error(</span>
                      &quot;Unable to load REST Key from Config file: &quot; + fileKey +
<span class="nc" id="L1394">                      &quot;: {}&quot;, e.getMessage());</span>
<span class="nc" id="L1395">                  return false;</span>
<span class="nc" id="L1396">                } catch (final IOException e) {</span>
<span class="nc" id="L1397">                  logger.error(</span>
                      &quot;Unable to load REST Key from Config file: &quot; + fileKey +
<span class="nc" id="L1399">                      &quot;: {}&quot;, e.getMessage());</span>
<span class="nc" id="L1400">                  return false;</span>
<span class="fc" id="L1401">                }</span>
              }
            }
<span class="fc" id="L1404">            value = subHash.get(XML_REST_TIME_LIMIT);</span>
<span class="fc" id="L1405">            long restTimeLimit = -1;</span>
<span class="pc bpc" id="L1406" title="2 of 4 branches missed.">            if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1407">              restTimeLimit = value.getLong();</span>
            }
<span class="fc" id="L1409">            config.setRestTimeLimit(restTimeLimit);</span>

<span class="fc" id="L1411">            final XmlValue valueMethod = subHash.get(XML_REST_METHOD);</span>
<span class="pc bpc" id="L1412" title="2 of 4 branches missed.">            if (valueMethod != null &amp;&amp; valueMethod.getList() != null) {</span>
<span class="fc" id="L1413">              boolean found = false;</span>
<span class="fc" id="L1414">              config.setResthandlersCrud(</span>
<span class="fc" id="L1415">                  new byte[RESTHANDLERS.values().length]);</span>
<span class="pc bpc" id="L1416" title="1 of 2 branches missed.">              for (final XmlValue[] xmlmethod : (Iterable&lt;XmlValue[]&gt;) valueMethod.getList()) {</span>
<span class="fc" id="L1417">                final XmlHash subHashMethod = new XmlHash(xmlmethod);</span>
<span class="fc" id="L1418">                value = subHashMethod.get(XML_REST_METHOD_NAME);</span>
                final String name;
<span class="pc bpc" id="L1420" title="2 of 4 branches missed.">                if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1421">                  name = value.getString();</span>
                } else {
<span class="nc" id="L1423">                  logger.warn(&quot;Restmethod entry ignore since name is empty&quot;);</span>
<span class="nc" id="L1424">                  continue;</span>
                }
<span class="fc" id="L1426">                value = subHashMethod.get(XML_REST_CRUD);</span>
                final String crud;
<span class="pc bpc" id="L1428" title="2 of 4 branches missed.">                if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1429">                  crud = value.getString().toUpperCase();</span>
                } else {
<span class="nc" id="L1431">                  logger.warn(</span>
                      &quot;Restmethod entry ignore since crud field is empty&quot;);
<span class="nc" id="L1433">                  continue;</span>
                }
<span class="fc" id="L1435">                found = true;</span>
<span class="fc" id="L1436">                byte def = 0x0;</span>
<span class="fc" id="L1437">                def |=</span>
<span class="pc bpc" id="L1438" title="1 of 2 branches missed.">                    crud.contains(&quot;C&quot;)? RestConfiguration.CRUD.CREATE.mask : 0;</span>
<span class="pc bpc" id="L1439" title="1 of 2 branches missed.">                def |= crud.contains(&quot;R&quot;)? RestConfiguration.CRUD.READ.mask : 0;</span>
<span class="fc" id="L1440">                def |=</span>
<span class="pc bpc" id="L1441" title="1 of 2 branches missed.">                    crud.contains(&quot;U&quot;)? RestConfiguration.CRUD.UPDATE.mask : 0;</span>
<span class="fc" id="L1442">                def |=</span>
<span class="pc bpc" id="L1443" title="1 of 2 branches missed.">                    crud.contains(&quot;D&quot;)? RestConfiguration.CRUD.DELETE.mask : 0;</span>
<span class="pc bpc" id="L1444" title="1 of 2 branches missed.">                if (&quot;all&quot;.equalsIgnoreCase(name)) {</span>
<span class="fc" id="L1445">                  Arrays.fill(config.getResthandlersCrud(), def);</span>
                  // No more restmethod since ALL was selected
<span class="fc" id="L1447">                  break;</span>
                } else {
<span class="nc" id="L1449">                  final String[] handlers = name.split(REGEX_SEPARATOR);</span>
<span class="nc bnc" id="L1450" title="All 2 branches missed.">                  for (final String string : handlers) {</span>
<span class="nc" id="L1451">                    final RESTHANDLERS handler = RESTHANDLERS.valueOf(string);</span>
<span class="nc" id="L1452">                    config.getResthandlersCrud()[handler.ordinal()] = def;</span>
                  }
                }
<span class="nc" id="L1455">              }</span>
<span class="pc bpc" id="L1456" title="1 of 2 branches missed.">              if (!found) {</span>
                // no METHOD !!!
<span class="nc" id="L1458">                logger.error(</span>
                    &quot;No active METHOD defined for REST in Config file: &quot; +
                    config);
<span class="nc" id="L1461">                return false;</span>
              }
<span class="fc" id="L1463">            } else {</span>
              // no METHOD !!!
<span class="nc" id="L1465">              logger.error(&quot;No METHOD defined for REST in Config file&quot;);</span>
<span class="nc" id="L1466">              return false;</span>
            }
<span class="fc" id="L1468">            Configuration.configuration.getRestConfigurations().add(config);</span>
<span class="fc" id="L1469">            logger.info(&quot;{}&quot;, config);</span>
          }
<span class="fc" id="L1471">        }</span>
      }
<span class="fc" id="L1473">      return true;</span>
    } finally {
<span class="fc" id="L1475">      hashConfig.clear();</span>
<span class="fc" id="L1476">      hashConfig = null;</span>
    }
  }

  /**
   * Set the Crypto Key from the Document
   *
   * @param config
   *
   * @return True if OK
   */
  private static boolean setCryptoKey(final Configuration config,
                                      final XmlHash hashConfig) {
<span class="fc" id="L1489">    final XmlValue value = hashConfig.get(XML_PATH_CRYPTOKEY);</span>
<span class="pc bpc" id="L1490" title="2 of 4 branches missed.">    if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L1491">      logger.error(&quot;Unable to find CryptoKey in Config file&quot;);</span>
<span class="nc" id="L1492">      return false;</span>
    }
<span class="fc" id="L1494">    final String filename = value.getString();</span>
<span class="fc" id="L1495">    config.setCryptoFile(filename);</span>
<span class="fc" id="L1496">    final File key = new File(filename);</span>
<span class="fc" id="L1497">    final Des des = new Des();</span>
    try {
<span class="fc" id="L1499">      des.setSecretKey(key);</span>
<span class="nc" id="L1500">    } catch (final CryptoException e) {</span>
<span class="nc" id="L1501">      logger.error(&quot;Unable to load CryptoKey from Config file {}&quot;, filename);</span>
<span class="nc" id="L1502">      return false;</span>
<span class="nc" id="L1503">    } catch (final IOException e) {</span>
<span class="nc" id="L1504">      logger.error(&quot;Unable to load CryptoKey from Config file&quot;);</span>
<span class="nc" id="L1505">      return false;</span>
<span class="fc" id="L1506">    }</span>
<span class="fc" id="L1507">    config.setCryptoKey(des);</span>
<span class="fc" id="L1508">    return true;</span>
  }

  /**
   * Load data from database or from files if not connected
   *
   * @param config
   *
   * @return True if OK
   */
  private static boolean loadFromDatabase(final Configuration config) {
<span class="fc bfc" id="L1519" title="All 2 branches covered.">    if (!isDbInactive(config)) {</span>
      // load from database the limit to apply
      try {
<span class="fc" id="L1522">        final DbConfiguration configuration =</span>
<span class="fc" id="L1523">            new DbConfiguration(config.getHostId());</span>
<span class="fc" id="L1524">        configuration.updateConfiguration();</span>
<span class="nc" id="L1525">      } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1526">        logger.info(Messages.getString(&quot;FileBasedConfiguration.NoBandwidth&quot;) +</span>
<span class="nc" id="L1527">                    e.getMessage()); //$NON-NLS-1$</span>
<span class="pc" id="L1528">      }</span>
    } else {
<span class="pc bpc" id="L1530" title="2 of 4 branches missed.">      if (config.getBaseDirectory() != null &amp;&amp; config.getConfigPath() != null) {</span>
        // load Rules from files
<span class="fc" id="L1532">        final File dirConfig =</span>
<span class="fc" id="L1533">            new File(config.getBaseDirectory() + config.getConfigPath());</span>
<span class="pc bpc" id="L1534" title="1 of 2 branches missed.">        if (dirConfig.isDirectory()) {</span>
          try {
<span class="fc" id="L1536">            RuleFileBasedConfiguration.importRules(dirConfig);</span>
<span class="nc" id="L1537">          } catch (final OpenR66ProtocolSystemException e) {</span>
<span class="nc" id="L1538">            logger.error(Messages.getString(&quot;FileBasedConfiguration.NoRule&quot;),</span>
                         e); //$NON-NLS-1$
<span class="nc" id="L1540">            return false;</span>
<span class="nc" id="L1541">          } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1542">            logger.error(</span>
<span class="nc" id="L1543">                Messages.getString(&quot;FileBasedConfiguration.NoRule&quot;) + &quot;: {}&quot;,</span>
<span class="nc" id="L1544">                e.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L1545">            return false;</span>
<span class="fc" id="L1546">          }</span>
        } else {
<span class="nc" id="L1548">          logger.error(&quot;Config Directory is not a directory: &quot; +</span>
<span class="nc" id="L1549">                       config.getBaseDirectory() + config.getConfigPath());</span>
<span class="nc" id="L1550">          return false;</span>
        }
      }
      // load if possible the limit to apply
<span class="fc" id="L1554">      loadLimit(config, false);</span>
    }
<span class="fc" id="L1556">    return true;</span>
  }

  public static boolean autoupgrade;

  /**
   * Load database parameter
   *
   * @param config
   * @param initdb
   *
   * @return True if OK
   */
  private static boolean loadDatabase(final Configuration config,
                                      final boolean initdb) {
<span class="fc" id="L1571">    XmlHash hashConfig = new XmlHash(hashRootConfig.get(XML_DB));</span>
    try {
<span class="fc" id="L1573">      XmlValue value = hashConfig.get(XML_SAVE_TASKRUNNERNODB);</span>
<span class="pc bpc" id="L1574" title="4 of 6 branches missed.">      if (value != null &amp;&amp; !value.isEmpty() &amp;&amp; value.getBoolean()) {</span>
<span class="nc" id="L1575">        config.setSaveTaskRunnerWithNoDb(value.getBoolean());</span>
<span class="nc" id="L1576">        logger.info(</span>
<span class="nc" id="L1577">            Messages.getString(&quot;FileBasedConfiguration.NoDB&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1578">        admin = new DbAdmin(); // no database support</span>
<span class="nc" id="L1579">        noCommitAdmin = admin;</span>
<span class="nc" id="L1580">        DAOFactory.initialize();</span>
<span class="nc" id="L1581">        return true;</span>
      }
<span class="fc" id="L1583">      value = hashConfig.get(XML_DBDRIVER);</span>
<span class="pc bpc" id="L1584" title="1 of 4 branches missed.">      if (value == null || value.isEmpty()) {</span>
<span class="pc bpc" id="L1585" title="1 of 2 branches missed.">        if (config.isWarnOnStartup()) {</span>
<span class="fc" id="L1586">          logger.warn(Messages.getString(&quot;FileBasedConfiguration.NoDB&quot;));</span>
          //$NON-NLS-1$
        } else {
<span class="nc" id="L1589">          logger.info(</span>
<span class="nc" id="L1590">              Messages.getString(&quot;FileBasedConfiguration.NoDB&quot;)); //$NON-NLS-1$</span>
        }
<span class="fc" id="L1592">        admin = new DbAdmin(); // no database support</span>
<span class="fc" id="L1593">        noCommitAdmin = admin;</span>
<span class="fc" id="L1594">        DAOFactory.initialize();</span>
      } else {
<span class="fc" id="L1596">        final String dbdriver = value.getString();</span>
<span class="fc" id="L1597">        value = hashConfig.get(XML_DBSERVER);</span>
<span class="pc bpc" id="L1598" title="2 of 4 branches missed.">        if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L1599">          logger.error(</span>
<span class="nc" id="L1600">              Messages.getString(FILE_BASED_CONFIGURATION_NOT_FOUND_CONFIG) +</span>
              &quot;DBServer&quot;); //$NON-NLS-1$
<span class="nc" id="L1602">          return false;</span>
        }
<span class="fc" id="L1604">        final String dbserver = value.getString();</span>
<span class="fc" id="L1605">        value = hashConfig.get(XML_DBUSER);</span>
<span class="pc bpc" id="L1606" title="2 of 4 branches missed.">        if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L1607">          logger.error(</span>
<span class="nc" id="L1608">              Messages.getString(FILE_BASED_CONFIGURATION_NOT_FOUND_CONFIG) +</span>
              &quot;DBUser&quot;); //$NON-NLS-1$
<span class="nc" id="L1610">          return false;</span>
        }
<span class="fc" id="L1612">        final String dbuser = value.getString();</span>
<span class="fc" id="L1613">        value = hashConfig.get(XML_DBPASSWD);</span>
<span class="pc bpc" id="L1614" title="2 of 4 branches missed.">        if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L1615">          logger.error(</span>
<span class="nc" id="L1616">              Messages.getString(FILE_BASED_CONFIGURATION_NOT_FOUND_CONFIG) +</span>
              &quot;DBPassword&quot;); //$NON-NLS-1$
<span class="nc" id="L1618">          return false;</span>
        }
<span class="fc" id="L1620">        final String dbpasswd = value.getString();</span>
<span class="pc bpc" id="L1621" title="1 of 2 branches missed.">        if (ParametersChecker.isEmpty(dbdriver) ||</span>
<span class="pc bpc" id="L1622" title="1 of 2 branches missed.">            ParametersChecker.isEmpty(dbserver) ||</span>
<span class="pc bpc" id="L1623" title="1 of 2 branches missed.">            ParametersChecker.isEmpty(dbuser) ||</span>
<span class="pc bpc" id="L1624" title="1 of 2 branches missed.">            ParametersChecker.isEmpty(dbpasswd)) {</span>
<span class="nc" id="L1625">          logger.error(</span>
<span class="nc" id="L1626">              Messages.getString(FILE_BASED_CONFIGURATION_NOT_FOUND_CONFIG) +</span>
              &quot;Correct DB data&quot;); //$NON-NLS-1$
<span class="nc" id="L1628">          return false;</span>
        }
        try {
<span class="fc" id="L1631">          admin =</span>
<span class="fc" id="L1632">              DbModelFactoryR66.initialize(dbdriver, dbserver, dbuser, dbpasswd,</span>
                                           true);
          // New way of initializing database services
          try {
<span class="fc" id="L1636">            ConnectionFactory.initialize(dbserver, dbuser, dbpasswd);</span>
<span class="nc" id="L1637">          } catch (final UnsupportedOperationException e) {</span>
<span class="nc" id="L1638">            logger.error(e.getMessage());</span>
<span class="nc" id="L1639">            return false;</span>
<span class="nc" id="L1640">          } catch (final SQLException e) {</span>
<span class="nc" id="L1641">            logger.error(&quot;Cannot create ConnectionFactory: {}&quot;, e.getMessage());</span>
<span class="nc" id="L1642">            return false;</span>
<span class="fc" id="L1643">          }</span>
<span class="fc" id="L1644">          DAOFactory.initialize(ConnectionFactory.getInstance());</span>

<span class="pc bpc" id="L1646" title="1 of 2 branches missed.">          if (config.getMultipleMonitors() &gt; 1) {</span>
<span class="nc" id="L1647">            noCommitAdmin =</span>
<span class="nc" id="L1648">                DbModelFactoryR66.initialize(dbdriver, dbserver, dbuser,</span>
                                             dbpasswd, true);
<span class="nc" id="L1650">            Configuration.setNbDbSession(Configuration.getNbDbSession() + 1);</span>
<span class="nc" id="L1651">            noCommitAdmin.getSession().setAutoCommit(false);</span>
          } else {
<span class="fc" id="L1653">            noCommitAdmin = admin;</span>
          }
<span class="pc bpc" id="L1655" title="1 of 2 branches missed.">          if (logger.isInfoEnabled()) {</span>
<span class="nc bnc" id="L1656" title="All 2 branches missed.">            logger.info(&quot;Database connection: Admin: {}  NoCommitAdmin: {}&quot;,</span>
<span class="nc bnc" id="L1657" title="All 2 branches missed.">                        (admin != null), (noCommitAdmin != null));</span>

            try {
<span class="nc" id="L1660">              logger.info(&quot;DefaultTransactionIsolation: &quot; +</span>
<span class="nc" id="L1661">                          admin.getSession().getConn().getMetaData()</span>
<span class="nc" id="L1662">                               .getDefaultTransactionIsolation() +</span>
                          &quot; MaxConnections: &quot; +
<span class="nc" id="L1664">                          admin.getSession().getConn().getMetaData()</span>
<span class="nc" id="L1665">                               .getMaxConnections() + &quot; MaxStatements: &quot; +</span>
<span class="nc" id="L1666">                          admin.getSession().getConn().getMetaData()</span>
<span class="nc" id="L1667">                               .getMaxStatements());</span>
<span class="nc" id="L1668">            } catch (final SQLException e) {</span>
<span class="nc" id="L1669">              SysErrLogger.FAKE_LOGGER.syserr(e);</span>
<span class="nc" id="L1670">            }</span>
          }
<span class="nc" id="L1672">        } catch (final WaarpDatabaseNoConnectionException e2) {</span>
<span class="nc" id="L1673">          logger.error(Messages.getString(&quot;Database.CannotConnect&quot;),</span>
                       e2); //$NON-NLS-1$
<span class="nc" id="L1675">          return false;</span>
<span class="fc" id="L1676">        }</span>
        // Check if the database is ready (initdb already done before)
        final DbRequest request;
<span class="fc bfc" id="L1679" title="All 2 branches covered.">        if (!initdb) {</span>
          try {
<span class="fc" id="L1681">            request = new DbRequest(admin.getSession());</span>
            try {
<span class="fc" id="L1683">              request.select(&quot;SELECT * FROM &quot; + DbConfiguration.table);</span>
<span class="nc" id="L1684">            } catch (final WaarpDatabaseSqlException e) {</span>
<span class="nc" id="L1685">              logger.warn(</span>
<span class="nc" id="L1686">                  Messages.getString(&quot;Database.DbNotInitiated&quot;) + &quot; : {}&quot;,</span>
<span class="nc" id="L1687">                  e.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L1688">              return true;</span>
            } finally {
<span class="fc" id="L1690">              request.close();</span>
            }
<span class="nc" id="L1692">          } catch (final WaarpDatabaseNoConnectionException e1) {</span>
            // ignore
            /*
             * TODO: Why Ignore? throwing bad configuration seems better
             */
<span class="fc" id="L1697">          }</span>
        }
        // TODO to remove when &lt;dbcheck&gt; is drop from config file
<span class="fc" id="L1700">        value = hashConfig.get(XML_DBCHECK);</span>
<span class="pc bpc" id="L1701" title="1 of 4 branches missed.">        if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L1702">          logger.warn(</span>
              &quot;&lt;{}&gt; is deprecated in configuration file &quot; + &quot;use &lt;{}&gt; instead&quot;,
              XML_DBCHECK, XML_DBAUTOUPGRADE);
<span class="fc" id="L1705">          autoupgrade = value.getBoolean();</span>
        } else {
          // Keep this part
<span class="fc" id="L1708">          value = hashConfig.get(XML_DBAUTOUPGRADE);</span>
<span class="pc bpc" id="L1709" title="2 of 4 branches missed.">          if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="nc" id="L1710">            autoupgrade = value.getBoolean();</span>
          }
        }
<span class="pc bpc" id="L1713" title="3 of 4 branches missed.">        if (autoupgrade &amp;&amp; !initdb) {</span>
          // Check if the database is up to date
<span class="nc bnc" id="L1715" title="All 2 branches missed.">          if (!ServerInitDatabase.upgradedb()) {</span>
<span class="nc" id="L1716">            return false;</span>
          }
        }
      }
<span class="fc" id="L1720">      return true;</span>
    } finally {
<span class="fc" id="L1722">      hashConfig.clear();</span>
<span class="fc" id="L1723">      hashConfig = null;</span>
    }
  }

  /**
   * Load white list for Business if any
   *
   * @param config
   */
  private static void loadBusinessWhiteList(final Configuration config) {
<span class="fc" id="L1733">    XmlHash hashConfig =</span>
<span class="fc" id="L1734">        new XmlHash(hashRootConfig.get(DbHostConfiguration.XML_BUSINESS));</span>
    try {
<span class="fc" id="L1736">      final XmlValue value = hashConfig.get(DbHostConfiguration.XML_BUSINESS);</span>
<span class="pc bpc" id="L1737" title="1 of 4 branches missed.">      if (value != null &amp;&amp; value.getList() != null) {</span>
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L1739">        List&lt;String&gt; ids = (List&lt;String&gt;) value.getList();</span>
<span class="pc bpc" id="L1740" title="1 of 2 branches missed.">        if (ids != null) {</span>
<span class="fc bfc" id="L1741" title="All 2 branches covered.">          for (final String sval : ids) {</span>
<span class="pc bpc" id="L1742" title="1 of 2 branches missed.">            if (sval.isEmpty()) {</span>
<span class="nc" id="L1743">              continue;</span>
            }
<span class="fc" id="L1745">            logger.info(&quot;Business Allow: {}&quot;, sval);</span>
<span class="fc" id="L1746">            config.getBusinessWhiteSet().add(sval.trim());</span>
<span class="fc" id="L1747">          }</span>
<span class="fc" id="L1748">          ids.clear();</span>
<span class="fc" id="L1749">          ids = null;</span>
        }
      }
<span class="fc" id="L1752">      loadAliases(config);</span>
<span class="fc" id="L1753">      setSelfVersion(config);</span>
    } finally {
<span class="fc" id="L1755">      hashConfig.clear();</span>
<span class="fc" id="L1756">      hashConfig = null;</span>
    }
<span class="fc" id="L1758">  }</span>

  /**
   * Load the aliases configuration
   *
   * @param config
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private static void loadAliases(final Configuration config) {
<span class="fc" id="L1767">    XmlHash hashConfig =</span>
<span class="fc" id="L1768">        new XmlHash(hashRootConfig.get(DbHostConfiguration.XML_ALIASES));</span>
    try {
<span class="fc" id="L1770">      XmlValue value = hashConfig.get(DbHostConfiguration.XML_ALIASES);</span>
<span class="pc bpc" id="L1771" title="2 of 4 branches missed.">      if (value != null &amp;&amp; value.getList() != null) {</span>
<span class="fc bfc" id="L1772" title="All 2 branches covered.">        for (final XmlValue[] xml : (Iterable&lt;XmlValue[]&gt;) value.getList()) {</span>
<span class="fc" id="L1773">          final XmlHash subHash = new XmlHash(xml);</span>
<span class="fc" id="L1774">          value = subHash.get(DbHostConfiguration.XML_REALID);</span>
<span class="pc bpc" id="L1775" title="2 of 4 branches missed.">          if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L1776">            continue;</span>
          }
<span class="fc" id="L1778">          final String refHostId = value.getString();</span>
<span class="fc" id="L1779">          value = subHash.get(DbHostConfiguration.XML_ALIASID);</span>
<span class="pc bpc" id="L1780" title="2 of 4 branches missed.">          if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L1781">            continue;</span>
          }
<span class="fc" id="L1783">          final String aliasset = value.getString();</span>
<span class="fc" id="L1784">          final String[] alias = aliasset.split(REGEX_SEPARATOR);</span>
<span class="fc bfc" id="L1785" title="All 2 branches covered.">          for (final String namealias : alias) {</span>
<span class="fc" id="L1786">            config.getAliases().put(namealias, refHostId);</span>
          }
<span class="fc" id="L1788">          config.getReverseAliases().put(refHostId, alias);</span>
<span class="fc" id="L1789">          logger.info(&quot;Aliases for: {} = {}&quot;, refHostId, aliasset);</span>
<span class="fc" id="L1790">        }</span>
      }
    } finally {
<span class="fc" id="L1793">      hashConfig.clear();</span>
<span class="fc" id="L1794">      hashConfig = null;</span>
    }
<span class="fc" id="L1796">  }</span>

  /**
   * Add the local host in Versions
   *
   * @param config
   */
  private static void setSelfVersion(final Configuration config) {
<span class="pc bpc" id="L1804" title="1 of 2 branches missed.">    if (config.getHostId() != null) {</span>
<span class="fc" id="L1805">      config.getVersions().putIfAbsent(config.getHostId(),</span>
                                       new PartnerConfiguration(
<span class="fc" id="L1807">                                           config.getHostId()));</span>
    }
<span class="pc bpc" id="L1809" title="1 of 2 branches missed.">    if (config.getHostSslId() != null) {</span>
<span class="fc" id="L1810">      config.getVersions().putIfAbsent(config.getHostSslId(),</span>
                                       new PartnerConfiguration(
<span class="fc" id="L1812">                                           config.getHostSslId()));</span>
    }
<span class="fc" id="L1814">    logger.debug(&quot;Partners: {}&quot;, config.getVersions());</span>
<span class="fc" id="L1815">  }</span>

  /**
   * Load Role list if any
   *
   * @param config
   */
  @SuppressWarnings(&quot;unchecked&quot;)
  private static void loadRolesList(final Configuration config) {
<span class="fc" id="L1824">    XmlHash hashConfig =</span>
<span class="fc" id="L1825">        new XmlHash(hashRootConfig.get(DbHostConfiguration.XML_ROLES));</span>
    try {
<span class="fc" id="L1827">      XmlValue value = hashConfig.get(DbHostConfiguration.XML_ROLES);</span>
<span class="pc bpc" id="L1828" title="2 of 4 branches missed.">      if (value != null &amp;&amp; value.getList() != null) {</span>
<span class="fc bfc" id="L1829" title="All 2 branches covered.">        for (final XmlValue[] xml : (Iterable&lt;XmlValue[]&gt;) value.getList()) {</span>
<span class="fc" id="L1830">          final XmlHash subHash = new XmlHash(xml);</span>
<span class="fc" id="L1831">          value = subHash.get(DbHostConfiguration.XML_ROLEID);</span>
<span class="pc bpc" id="L1832" title="2 of 4 branches missed.">          if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L1833">            continue;</span>
          }
<span class="fc" id="L1835">          final String refHostId = value.getString();</span>
<span class="fc" id="L1836">          value = subHash.get(DbHostConfiguration.XML_ROLESET);</span>
<span class="pc bpc" id="L1837" title="2 of 4 branches missed.">          if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L1838">            continue;</span>
          }
<span class="fc" id="L1840">          final String roleset = value.getString();</span>
<span class="fc" id="L1841">          final String[] roles = roleset.split(REGEX_SEPARATOR);</span>
<span class="fc" id="L1842">          final RoleDefault newrole = new RoleDefault();</span>
<span class="fc bfc" id="L1843" title="All 2 branches covered.">          for (final String role : roles) {</span>
            try {
<span class="fc" id="L1845">              final RoleDefault.ROLE roletype =</span>
<span class="fc" id="L1846">                  RoleDefault.ROLE.valueOf(role.toUpperCase());</span>
<span class="pc bpc" id="L1847" title="1 of 2 branches missed.">              if (roletype == ROLE.NOACCESS) {</span>
                // reset
<span class="nc" id="L1849">                newrole.setRole(roletype);</span>
              } else {
<span class="fc" id="L1851">                newrole.addRole(roletype);</span>
              }
<span class="nc" id="L1853">            } catch (final IllegalArgumentException e) {</span>
              // ignore
<span class="fc" id="L1855">            }</span>
          }
<span class="fc" id="L1857">          logger.info(&quot;New Role: {}:{}&quot;, refHostId, newrole);</span>
<span class="fc" id="L1858">          config.getRoles().put(refHostId, newrole);</span>
<span class="fc" id="L1859">        }</span>
      }
    } finally {
<span class="fc" id="L1862">      hashConfig.clear();</span>
<span class="fc" id="L1863">      hashConfig = null;</span>
    }
<span class="fc" id="L1865">  }</span>

  /**
   * Finalize configuration for Server on DbHostConfiguration
   *
   * @param config
   */
  private static void finalizeDbHostConfiguration(final Configuration config) {
    // now check in DB
<span class="pc bpc" id="L1874" title="1 of 2 branches missed.">    if (admin != null) {</span>
<span class="fc" id="L1875">      DbHostConfiguration hostconfiguration = null;</span>
      try {
<span class="fc" id="L1877">        hostconfiguration = new DbHostConfiguration(config.getHostId());</span>
<span class="nc" id="L1878">      } catch (final WaarpDatabaseException e) {</span>
        // ignore
<span class="nc" id="L1880">        final Business business = new Business();</span>
<span class="nc" id="L1881">        business.setHostid(config.getHostId());</span>
<span class="nc" id="L1882">        hostconfiguration = new DbHostConfiguration(business);</span>
<span class="fc" id="L1883">      }</span>
<span class="pc bpc" id="L1884" title="1 of 2 branches missed.">      if (hostconfiguration != null) {</span>
<span class="fc" id="L1885">        hostconfiguration.updateFromConfiguration(config);</span>
      }
    }

<span class="fc" id="L1889">  }</span>

  /**
   * @param config
   * @param fromXML
   *
   * @return the new subpath
   *
   * @throws OpenR66ProtocolSystemException
   */
  private static String getSubPath(final Configuration config,
                                   final String fromXML)
      throws OpenR66ProtocolSystemException, BadConfigurationException {
<span class="fc" id="L1902">    XmlHash hashConfig = new XmlHash(hashRootConfig.get(XML_DIRECTORY));</span>
    try {
<span class="fc" id="L1904">      final XmlValue value = hashConfig.get(fromXML);</span>
<span class="pc bpc" id="L1905" title="2 of 4 branches missed.">      if (value == null || value.isEmpty()) {</span>
<span class="nc" id="L1906">        logger.error(Messages.getString(&quot;FileBasedConfiguration.NoXmlPath&quot;) +</span>
                     fromXML); //$NON-NLS-1$
<span class="nc" id="L1908">        throw new OpenR66ProtocolSystemException(</span>
<span class="nc" id="L1909">            Messages.getString(&quot;FileBasedConfiguration.NoXmlPath&quot;) +</span>
            fromXML); //$NON-NLS-1$
      }

<span class="fc" id="L1913">      String path = value.getString();</span>
<span class="pc bpc" id="L1914" title="1 of 2 branches missed.">      if (ParametersChecker.isEmpty(path)) {</span>
<span class="nc" id="L1915">        throw new OpenR66ProtocolSystemException(</span>
<span class="nc" id="L1916">            Messages.getString(&quot;FileBasedConfiguration.NotCorrectPath&quot;) +</span>
            fromXML); //$NON-NLS-1$
      }
<span class="fc" id="L1919">      path = checkNotAbsolutePathNotUnderBase(config, path);</span>
<span class="fc" id="L1920">      path = DirInterface.SEPARATOR + path;</span>
<span class="fc" id="L1921">      final String newpath = config.getBaseDirectory() + path;</span>
<span class="fc" id="L1922">      final File file = new File(newpath);</span>
<span class="pc bpc" id="L1923" title="1 of 2 branches missed.">      if (!file.isDirectory()) {</span>
<span class="nc" id="L1924">        FileUtils.createDir(file);</span>
      }
<span class="fc" id="L1926">      return path;</span>
    } finally {
<span class="fc" id="L1928">      hashConfig.clear();</span>
<span class="fc" id="L1929">      hashConfig = null;</span>
    }
  }

  /**
   * Check if path is really under Base directory (if defined)
   *
   * @param config
   * @param path
   *
   * @return new path (truncated if necessary)
   *
   * @throws BadConfigurationException
   */
  public static String checkNotAbsolutePathNotUnderBase(
      final Configuration config, final String path)
      throws BadConfigurationException {
<span class="fc" id="L1946">    File tempPath = new File(path);</span>
<span class="fc bfc" id="L1947" title="All 4 branches covered.">    if (config.getBaseDirectory() != null &amp;&amp; tempPath.isAbsolute() &amp;&amp;</span>
<span class="fc bfc" id="L1948" title="All 2 branches covered.">        tempPath.isDirectory()) {</span>
<span class="fc bfc" id="L1949" title="All 2 branches covered.">      if (!FileUtils.isInSubdirectory(new File(config.getBaseDirectory()),</span>
                                      tempPath)) {
<span class="fc" id="L1951">        throw new BadConfigurationException(</span>
            &quot;Directory given is absolute and exists but must be below Base &quot; +
            &quot;directory&quot;);
      }
      // Check if path must be truncated
<span class="fc" id="L1956">      return path.replace(config.getBaseDirectory(), &quot;&quot;);</span>
    }
<span class="fc" id="L1958">    return path;</span>
  }

  /**
   * Load minimalistic Limit configuration
   *
   * @param config
   * @param filename
   *
   * @return True if OK
   */
  public static boolean setConfigurationLoadLimitFromXml(
      final Configuration config, final String filename) {
    final Document document;
<span class="fc" id="L1972">    alreadySetLimit = false;</span>
    // Open config file
    try {
<span class="fc" id="L1975">      document = XmlUtil.getNewSaxReader().read(filename);</span>
<span class="nc" id="L1976">    } catch (final DocumentException e) {</span>
<span class="nc" id="L1977">      logger.error(</span>
<span class="nc" id="L1978">          Messages.getString(FILE_BASED_CONFIGURATION_CANNOT_READ_XML) +</span>
<span class="nc" id="L1979">          filename + &quot;: {}&quot;, e.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L1980">      return false;</span>
<span class="fc" id="L1981">    }</span>
<span class="pc bpc" id="L1982" title="1 of 2 branches missed.">    if (document == null) {</span>
<span class="nc" id="L1983">      logger.error(</span>
<span class="nc" id="L1984">          Messages.getString(FILE_BASED_CONFIGURATION_CANNOT_READ_XML) +</span>
          filename); //$NON-NLS-1$
<span class="nc" id="L1986">      return false;</span>
    }
<span class="fc" id="L1988">    configuration = XmlUtil.read(document, configServer);</span>
<span class="fc" id="L1989">    hashRootConfig = new XmlRootHash(configuration);</span>
<span class="fc" id="L1990">    XmlHash hashConfig = new XmlHash(hashRootConfig.get(XML_IDENTITY));</span>
    try {
<span class="fc" id="L1992">      loadLocale(hashConfig);</span>
    } finally {
<span class="fc" id="L1994">      hashConfig.clear();</span>
<span class="fc" id="L1995">      hashConfig = null;</span>
    }
<span class="pc bpc" id="L1997" title="1 of 2 branches missed.">    if (!loadLimit(config, true)) {</span>
<span class="nc" id="L1998">      logger.error(Messages.getString(&quot;FileBasedConfiguration.NoLimit&quot;) +</span>
                   filename); //$NON-NLS-1$
<span class="nc" id="L2000">      return false;</span>
    }
<span class="fc" id="L2002">    hashRootConfig.clear();</span>
<span class="fc" id="L2003">    hashRootConfig = null;</span>
<span class="fc" id="L2004">    configuration = null;</span>
<span class="fc" id="L2005">    return true;</span>
  }

  /**
   * Load configuration for init database
   *
   * @param config
   * @param filename
   *
   * @return True if OK
   */
  public static boolean setConfigurationInitDatabase(final Configuration config,
                                                     final String filename,
                                                     final boolean initdb) {
    final Document document;
    // Open config file
    try {
<span class="fc" id="L2022">      document = XmlUtil.getNewSaxReader().read(filename);</span>
<span class="nc" id="L2023">    } catch (final DocumentException e) {</span>
<span class="nc" id="L2024">      logger.error(</span>
<span class="nc" id="L2025">          Messages.getString(FILE_BASED_CONFIGURATION_CANNOT_READ_XML) +</span>
<span class="nc" id="L2026">          filename + &quot;: {}&quot;, e.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L2027">      return false;</span>
<span class="fc" id="L2028">    }</span>
<span class="pc bpc" id="L2029" title="1 of 2 branches missed.">    if (document == null) {</span>
<span class="nc" id="L2030">      logger.error(</span>
<span class="nc" id="L2031">          Messages.getString(FILE_BASED_CONFIGURATION_CANNOT_READ_XML) +</span>
          filename); //$NON-NLS-1$
<span class="nc" id="L2033">      return false;</span>
    }
<span class="fc" id="L2035">    configuration = XmlUtil.read(document, configServer);</span>
<span class="fc" id="L2036">    hashRootConfig = new XmlRootHash(configuration);</span>
<span class="pc bpc" id="L2037" title="1 of 2 branches missed.">    if (!loadIdentity(config, hashRootConfig)) {</span>
<span class="nc" id="L2038">      logger.error(CANNOT_LOAD_IDENTITY);</span>
<span class="nc" id="L2039">      return false;</span>
    }
<span class="pc bpc" id="L2041" title="1 of 2 branches missed.">    if (!loadDatabase(config, initdb)) {</span>
<span class="nc" id="L2042">      logger.error(CANNOT_LOAD_DATABASE_CONFIGURATION);</span>
<span class="nc" id="L2043">      return false;</span>
    }
<span class="pc bpc" id="L2045" title="1 of 2 branches missed.">    if (!loadDirectory(config)) {</span>
<span class="nc" id="L2046">      logger.error(CANNOT_LOAD_DIRECTORY_CONFIGURATION);</span>
<span class="nc" id="L2047">      return false;</span>
    }
<span class="pc bpc" id="L2049" title="1 of 2 branches missed.">    if (!loadLimit(config, false)) {</span>
<span class="nc" id="L2050">      logger.error(CANNOT_LOAD_LIMIT_CONFIGURATION);</span>
<span class="nc" id="L2051">      return false;</span>
    }
<span class="pc bpc" id="L2053" title="1 of 2 branches missed.">    if (config.isSaveTaskRunnerWithNoDb()) {</span>
      // if no database, must load authentication from file
<span class="nc bnc" id="L2055" title="All 2 branches missed.">      if (!loadAuthentication(config)) {</span>
<span class="nc" id="L2056">        logger.error(CANNOT_LOAD_AUTHENTICATION_CONFIGURATION);</span>
<span class="nc" id="L2057">        return false;</span>
      }
    }
<span class="fc" id="L2060">    hashRootConfig.clear();</span>
<span class="fc" id="L2061">    hashRootConfig = null;</span>
<span class="fc" id="L2062">    configuration = null;</span>
<span class="fc" id="L2063">    return true;</span>
  }

  /**
   * Load minimalistic configuration
   *
   * @param config
   * @param filename
   *
   * @return True if OK
   */
  public static boolean setConfigurationServerMinimalFromXml(
      final Configuration config, final String filename) {
<span class="nc" id="L2076">    if (!SystemPropertyUtil.get(</span>
<span class="nc bnc" id="L2077" title="All 2 branches missed.">        R66SystemProperties.OPENR66_STARTUP_DATABASE_CHECK, &quot;&quot;).isEmpty()) {</span>
<span class="nc" id="L2078">      logger.warn(IS_DEPRECATED_IN_SYSTEM_PROPERTIES_USE_INSTEAD,</span>
                  R66SystemProperties.OPENR66_STARTUP_DATABASE_CHECK,
                  R66SystemProperties.OPENR66_STARTUP_DATABASE_AUTOUPGRADE);
<span class="nc" id="L2081">      autoupgrade = SystemPropertyUtil.getBoolean(</span>
          R66SystemProperties.OPENR66_STARTUP_DATABASE_CHECK, false);
    } else {
<span class="nc" id="L2084">      autoupgrade = SystemPropertyUtil.getBoolean(</span>
          R66SystemProperties.OPENR66_STARTUP_DATABASE_AUTOUPGRADE, false);
    }

    final Document document;
    // Open config file
    try {
<span class="nc" id="L2091">      document = XmlUtil.getNewSaxReader().read(filename);</span>
<span class="nc" id="L2092">    } catch (final DocumentException e) {</span>
<span class="nc" id="L2093">      logger.error(</span>
<span class="nc" id="L2094">          Messages.getString(FILE_BASED_CONFIGURATION_CANNOT_READ_XML) +</span>
<span class="nc" id="L2095">          filename + &quot;: {}&quot;, e.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L2096">      return false;</span>
<span class="nc" id="L2097">    }</span>
<span class="nc bnc" id="L2098" title="All 2 branches missed.">    if (document == null) {</span>
<span class="nc" id="L2099">      logger.error(</span>
<span class="nc" id="L2100">          Messages.getString(FILE_BASED_CONFIGURATION_CANNOT_READ_XML) +</span>
          filename); //$NON-NLS-1$
<span class="nc" id="L2102">      return false;</span>
    }
<span class="nc" id="L2104">    configuration = XmlUtil.read(document, configServer);</span>
<span class="nc" id="L2105">    hashRootConfig = new XmlRootHash(configuration);</span>
<span class="nc bnc" id="L2106" title="All 2 branches missed.">    if (!loadIdentity(config, hashRootConfig)) {</span>
<span class="nc" id="L2107">      logger.error(CANNOT_LOAD_IDENTITY);</span>
<span class="nc" id="L2108">      return false;</span>
    }
<span class="nc bnc" id="L2110" title="All 2 branches missed.">    if (!loadDatabase(config, false)) {</span>
<span class="nc" id="L2111">      logger.error(CANNOT_LOAD_DATABASE_CONFIGURATION);</span>
<span class="nc" id="L2112">      return false;</span>
    }
<span class="nc bnc" id="L2114" title="All 2 branches missed.">    if (!loadDirectory(config)) {</span>
<span class="nc" id="L2115">      logger.error(CANNOT_LOAD_DIRECTORY_CONFIGURATION);</span>
<span class="nc" id="L2116">      return false;</span>
    }
<span class="nc bnc" id="L2118" title="All 2 branches missed.">    if (!loadLimit(config, false)) {</span>
<span class="nc" id="L2119">      logger.error(CANNOT_LOAD_LIMIT_CONFIGURATION);</span>
<span class="nc" id="L2120">      return false;</span>
    }
<span class="nc bnc" id="L2122" title="All 2 branches missed.">    if (config.isSaveTaskRunnerWithNoDb()) {</span>
      // if no database, must load authentication from file
<span class="nc bnc" id="L2124" title="All 2 branches missed.">      if (!loadAuthentication(config)) {</span>
<span class="nc" id="L2125">        logger.error(CANNOT_LOAD_AUTHENTICATION_CONFIGURATION);</span>
<span class="nc" id="L2126">        return false;</span>
      }
    }
<span class="nc" id="L2129">    config.setHostAuth(R66Auth.getServerAuth(config.getHostId()));</span>
<span class="nc bnc" id="L2130" title="All 4 branches missed.">    if (config.getHostAuth() == null &amp;&amp; config.isUseNOSSL()) {</span>
<span class="nc" id="L2131">      logger.error(CANNOT_FIND_AUTHENTICATION_FOR_CURRENT_HOST);</span>
<span class="nc" id="L2132">      return false;</span>
    }
<span class="nc bnc" id="L2134" title="All 2 branches missed.">    if (config.getHostSslId() != null) {</span>
<span class="nc" id="L2135">      config.setHostSslAuth(R66Auth.getServerAuth(config.getHostSslId()));</span>
<span class="nc bnc" id="L2136" title="All 4 branches missed.">      if (config.getHostSslAuth() == null &amp;&amp; config.isUseSSL()) {</span>
<span class="nc" id="L2137">        logger.error(CANNOT_FIND_SSL_AUTHENTICATION_FOR_CURRENT_HOST);</span>
<span class="nc" id="L2138">        return false;</span>
      }
    }
<span class="nc" id="L2141">    hashRootConfig.clear();</span>
<span class="nc" id="L2142">    hashRootConfig = null;</span>
<span class="nc" id="L2143">    configuration = null;</span>
<span class="nc" id="L2144">    return true;</span>
  }

  /**
   * Initiate the configuration from the xml file for server shutdown
   *
   * @param config
   * @param filename
   *
   * @return True if OK
   */
  public static boolean setConfigurationServerShutdownFromXml(
      final Configuration config, final String filename) {
<span class="nc" id="L2157">    if (!SystemPropertyUtil.get(</span>
<span class="nc bnc" id="L2158" title="All 2 branches missed.">        R66SystemProperties.OPENR66_STARTUP_DATABASE_CHECK, &quot;&quot;).isEmpty()) {</span>
<span class="nc" id="L2159">      logger.warn(IS_DEPRECATED_IN_SYSTEM_PROPERTIES_USE_INSTEAD,</span>
                  R66SystemProperties.OPENR66_STARTUP_DATABASE_CHECK,
                  R66SystemProperties.OPENR66_STARTUP_DATABASE_AUTOUPGRADE);
<span class="nc" id="L2162">      autoupgrade = SystemPropertyUtil.getBoolean(</span>
          R66SystemProperties.OPENR66_STARTUP_DATABASE_CHECK, false);
    } else {
<span class="nc" id="L2165">      autoupgrade = SystemPropertyUtil.getBoolean(</span>
          R66SystemProperties.OPENR66_STARTUP_DATABASE_AUTOUPGRADE, false);
    }

    final Document document;
    // Open config file
    try {
<span class="nc" id="L2172">      document = XmlUtil.getNewSaxReader().read(filename);</span>
<span class="nc" id="L2173">    } catch (final DocumentException e) {</span>
<span class="nc" id="L2174">      logger.error(</span>
<span class="nc" id="L2175">          Messages.getString(FILE_BASED_CONFIGURATION_CANNOT_READ_XML) +</span>
<span class="nc" id="L2176">          filename + &quot;: {}&quot;, e.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L2177">      return false;</span>
<span class="nc" id="L2178">    }</span>
<span class="nc bnc" id="L2179" title="All 2 branches missed.">    if (document == null) {</span>
<span class="nc" id="L2180">      logger.error(</span>
<span class="nc" id="L2181">          Messages.getString(FILE_BASED_CONFIGURATION_CANNOT_READ_XML) +</span>
          filename); //$NON-NLS-1$
<span class="nc" id="L2183">      return false;</span>
    }
<span class="nc" id="L2185">    configuration = XmlUtil.read(document, configServer);</span>
<span class="nc" id="L2186">    hashRootConfig = new XmlRootHash(configuration);</span>
    // Now read the configuration
<span class="nc bnc" id="L2188" title="All 2 branches missed.">    if (!loadIdentity(config, hashRootConfig)) {</span>
<span class="nc" id="L2189">      logger.error(CANNOT_LOAD_IDENTITY);</span>
<span class="nc" id="L2190">      return false;</span>
    }
<span class="nc bnc" id="L2192" title="All 2 branches missed.">    if (!loadDatabase(config, false)) {</span>
<span class="nc" id="L2193">      logger.error(CANNOT_LOAD_DATABASE_CONFIGURATION);</span>
<span class="nc" id="L2194">      return false;</span>
    }
<span class="nc bnc" id="L2196" title="All 2 branches missed.">    if (!loadServerParam(config)) {</span>
<span class="nc" id="L2197">      logger.error(&quot;Cannot load Server Parameters&quot;);</span>
<span class="nc" id="L2198">      return false;</span>
    }
<span class="nc bnc" id="L2200" title="All 2 branches missed.">    if (!loadDirectory(config)) {</span>
<span class="nc" id="L2201">      logger.error(CANNOT_LOAD_DIRECTORY_CONFIGURATION);</span>
<span class="nc" id="L2202">      return false;</span>
    }
<span class="nc bnc" id="L2204" title="All 2 branches missed.">    if (!loadLimit(config, false)) {</span>
<span class="nc" id="L2205">      logger.error(CANNOT_LOAD_LIMIT_CONFIGURATION);</span>
<span class="nc" id="L2206">      return false;</span>
    }
<span class="nc bnc" id="L2208" title="All 4 branches missed.">    if (config.isUseSSL() &amp;&amp; !loadSsl(config, hashRootConfig)) {</span>
<span class="nc" id="L2209">      logger.error(&quot;Cannot load SSL configuration&quot;);</span>
<span class="nc" id="L2210">      return false;</span>
    }
<span class="nc bnc" id="L2212" title="All 2 branches missed.">    if (!loadNetworkServer(config)) {</span>
<span class="nc" id="L2213">      logger.error(&quot;Cannot load Network configuration&quot;);</span>
<span class="nc" id="L2214">      return false;</span>
    }
<span class="nc bnc" id="L2216" title="All 2 branches missed.">    if (config.isSaveTaskRunnerWithNoDb()) {</span>
      // if no database, must load authentication from file
<span class="nc bnc" id="L2218" title="All 2 branches missed.">      if (!loadAuthentication(config)) {</span>
<span class="nc" id="L2219">        logger.error(CANNOT_LOAD_AUTHENTICATION_CONFIGURATION);</span>
<span class="nc" id="L2220">        return false;</span>
      }
    }
<span class="nc" id="L2223">    config.setHostAuth(R66Auth.getServerAuth(config.getHostId()));</span>
<span class="nc bnc" id="L2224" title="All 4 branches missed.">    if (config.getHostAuth() == null &amp;&amp; config.isUseNOSSL()) {</span>
<span class="nc" id="L2225">      logger.error(CANNOT_FIND_AUTHENTICATION_FOR_CURRENT_HOST);</span>
<span class="nc" id="L2226">      return false;</span>
    }
<span class="nc bnc" id="L2228" title="All 2 branches missed.">    if (config.getHostSslId() != null) {</span>
<span class="nc" id="L2229">      config.setHostSslAuth(R66Auth.getServerAuth(config.getHostSslId()));</span>
<span class="nc bnc" id="L2230" title="All 4 branches missed.">      if (config.getHostSslAuth() == null &amp;&amp; config.isUseSSL()) {</span>
<span class="nc" id="L2231">        logger.error(CANNOT_FIND_SSL_AUTHENTICATION_FOR_CURRENT_HOST);</span>
<span class="nc" id="L2232">        return false;</span>
      }
    }
<span class="nc" id="L2235">    loadBusinessWhiteList(config);</span>
<span class="nc" id="L2236">    hashRootConfig.clear();</span>
<span class="nc" id="L2237">    hashRootConfig = null;</span>
<span class="nc" id="L2238">    configuration = null;</span>
<span class="nc" id="L2239">    return true;</span>
  }

  /**
   * Initiate the configuration from the xml file for server
   *
   * @param config
   * @param filename
   * @param isStartupServer If True, will also load configuration for startup
   *     of server, else only what is necessary for instance for Initialize database
   *
   * @return True if OK
   */
  public static boolean setConfigurationServerFromXml(
      final Configuration config, final String filename,
      final boolean isStartupServer) {
    final Document document;
    // Open config file
    try {
<span class="fc" id="L2258">      document = XmlUtil.getNewSaxReader().read(filename);</span>
<span class="nc" id="L2259">    } catch (final DocumentException e) {</span>
<span class="nc" id="L2260">      logger.error(</span>
<span class="nc" id="L2261">          Messages.getString(FILE_BASED_CONFIGURATION_CANNOT_READ_XML) +</span>
<span class="nc" id="L2262">          filename + &quot;: {}&quot;, e.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L2263">      return false;</span>
<span class="fc" id="L2264">    }</span>
<span class="pc bpc" id="L2265" title="1 of 2 branches missed.">    if (document == null) {</span>
<span class="nc" id="L2266">      logger.error(</span>
<span class="nc" id="L2267">          Messages.getString(FILE_BASED_CONFIGURATION_CANNOT_READ_XML) +</span>
          filename); //$NON-NLS-1$
<span class="nc" id="L2269">      return false;</span>
    }
<span class="fc" id="L2271">    configuration = XmlUtil.read(document, configServer);</span>
<span class="fc" id="L2272">    hashRootConfig = new XmlRootHash(configuration);</span>
    // Now read the configuration
<span class="pc bpc" id="L2274" title="1 of 2 branches missed.">    if (!loadIdentity(config, hashRootConfig)) {</span>
<span class="nc" id="L2275">      logger.error(CANNOT_LOAD_IDENTITY);</span>
<span class="nc" id="L2276">      return false;</span>
    }
<span class="pc bpc" id="L2278" title="1 of 2 branches missed.">    if (!loadDatabase(config, false)) {</span>
<span class="nc" id="L2279">      logger.error(CANNOT_LOAD_DATABASE_CONFIGURATION);</span>
<span class="nc" id="L2280">      return false;</span>
    }
<span class="fc bfc" id="L2282" title="All 2 branches covered.">    if (!loadServerParam(config)) {</span>
<span class="fc" id="L2283">      logger.error(&quot;Cannot load Server Parameters&quot;);</span>
<span class="fc" id="L2284">      return false;</span>
    }
<span class="fc bfc" id="L2286" title="All 2 branches covered.">    if (isStartupServer) {</span>
<span class="pc bpc" id="L2287" title="1 of 2 branches missed.">      if (!loadPushMonitorParam(config)) {</span>
<span class="nc" id="L2288">        logger.error(&quot;Cannot load Server Push Monitor Parameters&quot;);</span>
<span class="nc" id="L2289">        return false;</span>
      }
    }
<span class="fc bfc" id="L2292" title="All 2 branches covered.">    if (!loadDirectory(config)) {</span>
<span class="fc" id="L2293">      logger.error(CANNOT_LOAD_DIRECTORY_CONFIGURATION);</span>
<span class="fc" id="L2294">      return false;</span>
    }
<span class="pc bpc" id="L2296" title="1 of 2 branches missed.">    if (!loadLimit(config, false)) {</span>
<span class="nc" id="L2297">      logger.error(CANNOT_LOAD_LIMIT_CONFIGURATION);</span>
<span class="nc" id="L2298">      return false;</span>
    }
<span class="pc bpc" id="L2300" title="2 of 4 branches missed.">    if (config.isUseSSL() &amp;&amp; !loadSsl(config, hashRootConfig)) {</span>
<span class="nc" id="L2301">      logger.error(&quot;Cannot load SSL configuration&quot;);</span>
<span class="nc" id="L2302">      return false;</span>
    }
<span class="pc bpc" id="L2304" title="1 of 2 branches missed.">    if (!loadNetworkServer(config)) {</span>
<span class="nc" id="L2305">      logger.error(&quot;Cannot load Network configuration&quot;);</span>
<span class="nc" id="L2306">      return false;</span>
    }
<span class="fc bfc" id="L2308" title="All 2 branches covered.">    if (isStartupServer) {</span>
<span class="pc bpc" id="L2309" title="1 of 2 branches missed.">      if (!loadRest(config)) {</span>
<span class="nc" id="L2310">        logger.error(&quot;Cannot load REST configuration&quot;);</span>
<span class="nc" id="L2311">        return false;</span>
      }
    }
<span class="pc bpc" id="L2314" title="1 of 2 branches missed.">    if (!loadFromDatabase(config)) {</span>
<span class="nc" id="L2315">      logger.error(&quot;Cannot load configuration from Database&quot;);</span>
<span class="nc" id="L2316">      return false;</span>
    }
<span class="pc bpc" id="L2318" title="1 of 2 branches missed.">    if (config.isSaveTaskRunnerWithNoDb()) {</span>
      // if no database, must load authentication from file
<span class="nc bnc" id="L2320" title="All 2 branches missed.">      if (!loadAuthentication(config)) {</span>
<span class="nc" id="L2321">        logger.error(CANNOT_LOAD_AUTHENTICATION_CONFIGURATION);</span>
<span class="nc" id="L2322">        return false;</span>
      }
    }
<span class="fc" id="L2325">    config.setHostAuth(R66Auth.getServerAuth(config.getHostId()));</span>
<span class="pc bpc" id="L2326" title="1 of 4 branches missed.">    if (config.getHostAuth() == null &amp;&amp; config.isUseNOSSL()) {</span>
<span class="fc" id="L2327">      logger.error(CANNOT_FIND_AUTHENTICATION_FOR_CURRENT_HOST);</span>
<span class="fc" id="L2328">      return false;</span>
    }
<span class="pc bpc" id="L2330" title="1 of 2 branches missed.">    if (config.getHostSslId() != null) {</span>
<span class="fc" id="L2331">      config.setHostSslAuth(R66Auth.getServerAuth(config.getHostSslId()));</span>
<span class="pc bpc" id="L2332" title="3 of 4 branches missed.">      if (config.getHostSslAuth() == null &amp;&amp; config.isUseSSL()) {</span>
<span class="nc" id="L2333">        logger.error(CANNOT_FIND_SSL_AUTHENTICATION_FOR_CURRENT_HOST);</span>
<span class="nc" id="L2334">        return false;</span>
      }
    }
<span class="fc" id="L2337">    loadBusinessWhiteList(config);</span>
<span class="fc" id="L2338">    loadRolesList(config);</span>
<span class="fc" id="L2339">    finalizeDbHostConfiguration(config);</span>
<span class="fc" id="L2340">    hashRootConfig.clear();</span>
<span class="fc" id="L2341">    hashRootConfig = null;</span>
<span class="fc" id="L2342">    configuration = null;</span>
<span class="fc" id="L2343">    return true;</span>
  }

  /**
   * Initiate the configuration from the xml file for database client
   *
   * @param config
   * @param filename
   *
   * @return True if OK
   */
  public static boolean setClientConfigurationFromXml(
      final Configuration config, final String filename) {
<span class="fc" id="L2356">    if (!SystemPropertyUtil.get(</span>
<span class="pc bpc" id="L2357" title="1 of 2 branches missed.">        R66SystemProperties.OPENR66_STARTUP_DATABASE_CHECK, &quot;&quot;).isEmpty()) {</span>
<span class="nc" id="L2358">      logger.warn(IS_DEPRECATED_IN_SYSTEM_PROPERTIES_USE_INSTEAD,</span>
                  R66SystemProperties.OPENR66_STARTUP_DATABASE_CHECK,
                  R66SystemProperties.OPENR66_STARTUP_DATABASE_AUTOUPGRADE);
<span class="nc" id="L2361">      autoupgrade = SystemPropertyUtil.getBoolean(</span>
          R66SystemProperties.OPENR66_STARTUP_DATABASE_CHECK, false);
    } else {
<span class="fc" id="L2364">      autoupgrade = SystemPropertyUtil.getBoolean(</span>
          R66SystemProperties.OPENR66_STARTUP_DATABASE_AUTOUPGRADE, false);
    }

    final Document document;
    // Open config file
    try {
<span class="fc" id="L2371">      document = XmlUtil.getNewSaxReader().read(filename);</span>
<span class="nc" id="L2372">    } catch (final DocumentException e) {</span>
<span class="nc" id="L2373">      logger.error(</span>
<span class="nc" id="L2374">          Messages.getString(FILE_BASED_CONFIGURATION_CANNOT_READ_XML) +</span>
<span class="nc" id="L2375">          filename + &quot;: {}&quot;, e.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L2376">      return false;</span>
<span class="fc" id="L2377">    }</span>
<span class="pc bpc" id="L2378" title="1 of 2 branches missed.">    if (document == null) {</span>
<span class="nc" id="L2379">      logger.error(</span>
<span class="nc" id="L2380">          Messages.getString(FILE_BASED_CONFIGURATION_CANNOT_READ_XML) +</span>
          filename); //$NON-NLS-1$
<span class="nc" id="L2382">      return false;</span>
    }
<span class="fc" id="L2384">    configuration = XmlUtil.read(document, configClient);</span>
<span class="fc" id="L2385">    hashRootConfig = new XmlRootHash(configuration);</span>
    // Client enables SSL by default but could be reverted later on
<span class="fc" id="L2387">    config.setUseSSL(true);</span>
<span class="pc bpc" id="L2388" title="1 of 2 branches missed.">    if (!loadIdentity(config, hashRootConfig)) {</span>
<span class="nc" id="L2389">      logger.error(CANNOT_LOAD_IDENTITY);</span>
<span class="nc" id="L2390">      return false;</span>
    }
<span class="pc bpc" id="L2392" title="1 of 2 branches missed.">    if (!loadDirectory(config)) {</span>
<span class="nc" id="L2393">      logger.error(CANNOT_LOAD_DIRECTORY_CONFIGURATION);</span>
<span class="nc" id="L2394">      return false;</span>
    }
<span class="pc bpc" id="L2396" title="1 of 2 branches missed.">    if (!loadDatabase(config, false)) {</span>
<span class="nc" id="L2397">      logger.error(CANNOT_LOAD_DATABASE_CONFIGURATION);</span>
<span class="nc" id="L2398">      return false;</span>
    }
<span class="pc bpc" id="L2400" title="1 of 2 branches missed.">    if (!loadClientParam(config)) {</span>
<span class="nc" id="L2401">      logger.error(&quot;Cannot load Client Parameters&quot;);</span>
<span class="nc" id="L2402">      return false;</span>
    }
<span class="pc bpc" id="L2404" title="1 of 2 branches missed.">    if (!loadLimit(config, false)) {</span>
<span class="nc" id="L2405">      logger.error(CANNOT_LOAD_LIMIT_CONFIGURATION);</span>
<span class="nc" id="L2406">      return false;</span>
    }
<span class="pc bpc" id="L2408" title="2 of 4 branches missed.">    if (config.isUseSSL() &amp;&amp; !loadSsl(config, hashRootConfig)) {</span>
<span class="nc" id="L2409">      logger.error(&quot;Cannot load SSL configuration&quot;);</span>
<span class="nc" id="L2410">      return false;</span>
    }
<span class="pc bpc" id="L2412" title="1 of 2 branches missed.">    if (!loadFromDatabase(config)) {</span>
<span class="nc" id="L2413">      logger.error(&quot;Cannot load configuration from Database&quot;);</span>
<span class="nc" id="L2414">      return false;</span>
    }
<span class="fc bfc" id="L2416" title="All 2 branches covered.">    if (isDbInactive(config)) {</span>
      // if no database, must load authentication from file
<span class="pc bpc" id="L2418" title="1 of 2 branches missed.">      if (!loadAuthentication(config)) {</span>
<span class="nc" id="L2419">        logger.error(CANNOT_LOAD_AUTHENTICATION_CONFIGURATION);</span>
<span class="nc" id="L2420">        return false;</span>
      }
    }
    try {
<span class="fc" id="L2424">      config.setHostAuth(new DbHostAuth(config.getHostId()));</span>
<span class="nc" id="L2425">    } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L2426">      logger.error(&quot;Current Host is {}&quot;, config.getHostId());</span>
<span class="nc" id="L2427">      logger.error(CANNOT_FIND_AUTHENTICATION_FOR_CURRENT_HOST + &quot;: {}&quot;,</span>
<span class="nc" id="L2428">                   e.getMessage());</span>
<span class="nc" id="L2429">      return false;</span>
<span class="fc" id="L2430">    }</span>
<span class="pc bpc" id="L2431" title="1 of 2 branches missed.">    if (config.getHostAuth() == null) {</span>
<span class="nc" id="L2432">      logger.error(CANNOT_FIND_AUTHENTICATION_FOR_CURRENT_HOST);</span>
<span class="nc" id="L2433">      return false;</span>
    }
<span class="pc bpc" id="L2435" title="1 of 2 branches missed.">    if (config.getHostSslId() != null) {</span>
<span class="fc" id="L2436">      config.setHostSslAuth(R66Auth.getServerAuth(config.getHostSslId()));</span>
<span class="pc bpc" id="L2437" title="1 of 2 branches missed.">      if (config.getHostSslAuth() == null) {</span>
<span class="nc" id="L2438">        logger.error(CANNOT_FIND_SSL_AUTHENTICATION_FOR_CURRENT_HOST);</span>
<span class="nc" id="L2439">        return false;</span>
      }
    }
<span class="fc" id="L2442">    loadBusinessWhiteList(config);</span>
<span class="fc" id="L2443">    hashRootConfig.clear();</span>
<span class="fc" id="L2444">    hashRootConfig = null;</span>
<span class="fc" id="L2445">    configuration = null;</span>
<span class="fc" id="L2446">    return true;</span>
  }

  /**
   * Initiate the configuration from the xml file for submit database client
   *
   * @param config
   * @param filename
   *
   * @return True if OK
   */
  public static boolean setSubmitClientConfigurationFromXml(
      final Configuration config, final String filename) {
<span class="fc" id="L2459">    if (!SystemPropertyUtil.get(</span>
<span class="pc bpc" id="L2460" title="1 of 2 branches missed.">        R66SystemProperties.OPENR66_STARTUP_DATABASE_CHECK, &quot;&quot;).isEmpty()) {</span>
<span class="nc" id="L2461">      logger.warn(IS_DEPRECATED_IN_SYSTEM_PROPERTIES_USE_INSTEAD,</span>
                  R66SystemProperties.OPENR66_STARTUP_DATABASE_CHECK,
                  R66SystemProperties.OPENR66_STARTUP_DATABASE_AUTOUPGRADE);
<span class="nc" id="L2464">      autoupgrade = SystemPropertyUtil.getBoolean(</span>
          R66SystemProperties.OPENR66_STARTUP_DATABASE_CHECK, false);
    } else {
<span class="fc" id="L2467">      autoupgrade = SystemPropertyUtil.getBoolean(</span>
          R66SystemProperties.OPENR66_STARTUP_DATABASE_AUTOUPGRADE, false);
    }

    final Document document;
    // Open config file
    try {
<span class="fc" id="L2474">      document = XmlUtil.getNewSaxReader().read(filename);</span>
<span class="nc" id="L2475">    } catch (final DocumentException e) {</span>
<span class="nc" id="L2476">      logger.error(</span>
<span class="nc" id="L2477">          Messages.getString(FILE_BASED_CONFIGURATION_CANNOT_READ_XML) +</span>
<span class="nc" id="L2478">          filename + &quot;: {}&quot;, e.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L2479">      return false;</span>
<span class="fc" id="L2480">    }</span>
<span class="pc bpc" id="L2481" title="1 of 2 branches missed.">    if (document == null) {</span>
<span class="nc" id="L2482">      logger.error(</span>
<span class="nc" id="L2483">          Messages.getString(FILE_BASED_CONFIGURATION_CANNOT_READ_XML) +</span>
          filename); //$NON-NLS-1$
<span class="nc" id="L2485">      return false;</span>
    }
<span class="fc" id="L2487">    configuration = XmlUtil.read(document, configSubmitClient);</span>
<span class="fc" id="L2488">    hashRootConfig = new XmlRootHash(configuration);</span>
    // Client enables SSL by default but could be reverted later on
<span class="fc" id="L2490">    config.setUseSSL(true);</span>
<span class="pc bpc" id="L2491" title="1 of 2 branches missed.">    if (!loadIdentity(config, hashRootConfig)) {</span>
<span class="nc" id="L2492">      logger.error(CANNOT_LOAD_IDENTITY);</span>
<span class="nc" id="L2493">      return false;</span>
    }
<span class="pc bpc" id="L2495" title="1 of 2 branches missed.">    if (!loadDatabase(config, false)) {</span>
<span class="nc" id="L2496">      logger.error(CANNOT_LOAD_DATABASE_CONFIGURATION);</span>
<span class="nc" id="L2497">      return false;</span>
    }
<span class="pc bpc" id="L2499" title="1 of 2 branches missed.">    if (!loadDirectory(config)) {</span>
<span class="nc" id="L2500">      logger.error(CANNOT_LOAD_DIRECTORY_CONFIGURATION);</span>
<span class="nc" id="L2501">      return false;</span>
    }
<span class="fc" id="L2503">    XmlHash hashConfig = new XmlHash(hashRootConfig.get(XML_LIMIT));</span>
    try {
<span class="fc" id="L2505">      final XmlValue value = hashConfig.get(XML_BLOCKSIZE);</span>
<span class="pc bpc" id="L2506" title="2 of 4 branches missed.">      if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="fc" id="L2507">        config.setBlockSize(value.getInteger());</span>
      }
    } finally {
<span class="fc" id="L2510">      hashConfig.clear();</span>
<span class="fc" id="L2511">      hashConfig = null;</span>
    }
<span class="fc" id="L2513">    config.setHostAuth(R66Auth.getServerAuth(config.getHostId()));</span>
<span class="pc bpc" id="L2514" title="1 of 2 branches missed.">    if (config.getHostAuth() == null) {</span>
<span class="nc" id="L2515">      logger.error(CANNOT_FIND_AUTHENTICATION_FOR_CURRENT_HOST);</span>
<span class="nc" id="L2516">      return false;</span>
    }
<span class="pc bpc" id="L2518" title="1 of 2 branches missed.">    if (config.getHostSslId() != null) {</span>
<span class="fc" id="L2519">      config.setHostSslAuth(R66Auth.getServerAuth(config.getHostSslId()));</span>
<span class="pc bpc" id="L2520" title="1 of 2 branches missed.">      if (config.getHostSslAuth() == null) {</span>
<span class="nc" id="L2521">        logger.error(CANNOT_FIND_SSL_AUTHENTICATION_FOR_CURRENT_HOST);</span>
<span class="nc" id="L2522">        return false;</span>
      }
    }
<span class="fc" id="L2525">    loadBusinessWhiteList(config);</span>
<span class="fc" id="L2526">    hashRootConfig.clear();</span>
<span class="fc" id="L2527">    hashRootConfig = null;</span>
<span class="fc" id="L2528">    configuration = null;</span>
<span class="fc" id="L2529">    return true;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>