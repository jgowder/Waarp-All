<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>HttpSslHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Waarp Http</a> &gt; <a href="../index.html" class="el_bundle">WaarpR66</a> &gt; <a href="index.source.html" class="el_package">org.waarp.openr66.protocol.http.adminssl</a> &gt; <span class="el_source">HttpSslHandler.java</span></div><h1>HttpSslHandler.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.openr66.protocol.http.adminssl;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.Channel;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.SimpleChannelInboundHandler;
import io.netty.handler.codec.http.DefaultFullHttpResponse;
import io.netty.handler.codec.http.FullHttpRequest;
import io.netty.handler.codec.http.FullHttpResponse;
import io.netty.handler.codec.http.HttpHeaderNames;
import io.netty.handler.codec.http.HttpHeaderValues;
import io.netty.handler.codec.http.HttpMethod;
import io.netty.handler.codec.http.HttpResponse;
import io.netty.handler.codec.http.HttpResponseStatus;
import io.netty.handler.codec.http.HttpUtil;
import io.netty.handler.codec.http.HttpVersion;
import io.netty.handler.codec.http.QueryStringDecoder;
import io.netty.handler.codec.http.cookie.Cookie;
import io.netty.handler.codec.http.cookie.DefaultCookie;
import io.netty.handler.codec.http.cookie.ServerCookieDecoder;
import io.netty.handler.codec.http.cookie.ServerCookieEncoder;
import io.netty.handler.traffic.TrafficCounter;
import org.waarp.common.command.exception.Reply421Exception;
import org.waarp.common.command.exception.Reply530Exception;
import org.waarp.common.crypto.ssl.WaarpSslUtility;
import org.waarp.common.database.DbAdmin;
import org.waarp.common.database.DbPreparedStatement;
import org.waarp.common.database.DbSession;
import org.waarp.common.database.exception.WaarpDatabaseException;
import org.waarp.common.database.exception.WaarpDatabaseNoConnectionException;
import org.waarp.common.database.exception.WaarpDatabaseSqlException;
import org.waarp.common.digest.FilesystemBasedDigest;
import org.waarp.common.exception.FileTransferException;
import org.waarp.common.exception.InvalidArgumentException;
import org.waarp.common.file.DirInterface;
import org.waarp.common.logging.WaarpLogLevel;
import org.waarp.common.logging.WaarpLogger;
import org.waarp.common.logging.WaarpLoggerFactory;
import org.waarp.common.role.RoleDefault.ROLE;
import org.waarp.common.utility.ParametersChecker;
import org.waarp.common.utility.ThreadLocalRandom;
import org.waarp.common.utility.Version;
import org.waarp.common.utility.WaarpShutdownHook;
import org.waarp.common.utility.WaarpStringUtils;
import org.waarp.gateway.kernel.http.HttpWriteCacheEnable;
import org.waarp.openr66.client.Message;
import org.waarp.openr66.context.ErrorCode;
import org.waarp.openr66.context.R66FiniteDualStates;
import org.waarp.openr66.context.R66Result;
import org.waarp.openr66.context.R66Session;
import org.waarp.openr66.context.task.SpooledInformTask;
import org.waarp.openr66.database.DbConstantR66;
import org.waarp.openr66.database.data.DbHostAuth;
import org.waarp.openr66.database.data.DbHostConfiguration;
import org.waarp.openr66.database.data.DbRule;
import org.waarp.openr66.database.data.DbTaskRunner;
import org.waarp.openr66.protocol.configuration.Configuration;
import org.waarp.openr66.protocol.configuration.Messages;
import org.waarp.openr66.protocol.exception.OpenR66Exception;
import org.waarp.openr66.protocol.exception.OpenR66ExceptionTrappedFactory;
import org.waarp.openr66.protocol.exception.OpenR66ProtocolBusinessException;
import org.waarp.openr66.protocol.exception.OpenR66ProtocolBusinessNoWriteBackException;
import org.waarp.openr66.protocol.localhandler.LocalChannelReference;
import org.waarp.openr66.protocol.localhandler.LocalServerHandler;
import org.waarp.openr66.protocol.localhandler.ServerActions;
import org.waarp.openr66.protocol.localhandler.packet.ErrorPacket;
import org.waarp.openr66.protocol.localhandler.packet.RequestPacket;
import org.waarp.openr66.protocol.localhandler.packet.RequestPacket.TRANSFERMODE;
import org.waarp.openr66.protocol.localhandler.packet.TestPacket;
import org.waarp.openr66.protocol.networkhandler.NetworkTransaction;
import org.waarp.openr66.protocol.utils.ChannelUtils;
import org.waarp.openr66.protocol.utils.NbAndSpecialId;
import org.waarp.openr66.protocol.utils.R66Future;
import org.waarp.openr66.protocol.utils.TransferUtils;

import java.io.IOException;
import java.sql.Timestamp;
import java.util.Arrays;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;
import java.util.concurrent.ConcurrentHashMap;

/**
 *
 */
<span class="fc" id="L110">public class HttpSslHandler</span>
    extends SimpleChannelInboundHandler&lt;FullHttpRequest&gt; {
  private static final String XXXLEVEL4XXX = &quot;XXXLEVEL4XXX&quot;;
  private static final String XXXLEVEL3XXX = &quot;XXXLEVEL3XXX&quot;;
  private static final String XXXLEVEL2XXX = &quot;XXXLEVEL2XXX&quot;;
  private static final String XXXLEVEL1XXX = &quot;XXXLEVEL1XXX&quot;;
  private static final String OPEN_R66_WEB_ERROR = &quot;OpenR66 Web Error {}&quot;;
  private static final String HTTP_SSL_HANDLER_MOPS = &quot;HttpSslHandler.MOPS&quot;;
  private static final String HTTP_SSL_HANDLER_LANG_IS =
      &quot;HttpSslHandler.LangIs&quot;;
  private static final String HTTP_SSL_HANDLER_17 = &quot;HttpSslHandler.17&quot;;
  private static final String EXPORT_ERROR = &quot;Export error: {}&quot;;
  private static final String CHECKED = &quot;checked&quot;;
  private static final String HTTP_SSL_HANDLER_NOT_ACTIVE =
      &quot;HttpSslHandler.NotActive&quot;;
  private static final String HTTP_SSL_HANDLER_ACTIVE = &quot;HttpSslHandler.Active&quot;;
  private static final String AN_ERROR_OCCURS_WHILE_ACCESSING_A_RUNNER =
      &quot;An error occurs while accessing a Runner: {}&quot;;
  private static final String ADDRESS = &quot;address&quot;;
  private static final String CREATE = &quot;Create&quot;;
  private static final String ERROR2 = &quot;error&quot;;
  private static final String TRANSFER2 = &quot;transfer&quot;;
  private static final String PENDING2 = &quot;pending&quot;;
  private static final String START2 = &quot;start&quot;;
  private static final String STOPID2 = &quot;stopid&quot;;
  private static final String STARTID2 = &quot;startid&quot;;
  private static final String FILTER = &quot;Filter&quot;;
  private static final String ACTION = &quot;ACTION&quot;;
  private static final String HTTP_SSL_HANDLER_3 = &quot;HttpSslHandler.3&quot;;
  private static final String BR_B = &quot;&lt;br&gt;&lt;b&gt;&quot;;
  private static final String B_CENTER_P = &quot;&lt;/b&gt;&lt;/center&gt;&lt;/p&gt;&quot;;
  /**
   * Internal Logger
   */
<span class="fc" id="L144">  private static final WaarpLogger logger =</span>
<span class="fc" id="L145">      WaarpLoggerFactory.getLogger(HttpSslHandler.class);</span>
  /**
   * Session Management
   */
<span class="fc" id="L149">  protected static final ConcurrentHashMap&lt;String, R66Session&gt; sessions =</span>
      new ConcurrentHashMap&lt;String, R66Session&gt;();
<span class="fc" id="L151">  protected static final ThreadLocalRandom RANDOM = ThreadLocalRandom.current();</span>

<span class="fc" id="L153">  protected R66Session authentHttp = new R66Session();</span>

  protected FullHttpRequest request;
  protected boolean newSession;
  protected volatile Cookie admin;
<span class="fc" id="L158">  protected final StringBuilder responseContent = new StringBuilder();</span>
  protected String uriRequest;
  protected Map&lt;String, List&lt;String&gt;&gt; params;
<span class="fc" id="L161">  protected String lang = Messages.getSlocale();</span>
  protected boolean forceClose;
  protected boolean shutdown;

  protected static final String R66SESSION = &quot;R66SESSION&quot;;
  protected static final String I18NEXT = &quot;i18next&quot;;

<span class="fc" id="L168">  private enum REQUEST {</span>
<span class="fc" id="L169">    Logon(&quot;Logon.html&quot;), Logout(&quot;Logon.html&quot;), index(&quot;index.html&quot;),</span>
<span class="fc" id="L170">    error(&quot;error.html&quot;), unallowed(&quot;NotAllowed.html&quot;),</span>
<span class="fc" id="L171">    Transfers(&quot;Transfers.html&quot;),</span>
<span class="fc" id="L172">    Listing(&quot;Listing_head.html&quot;, &quot;Listing_body0.html&quot;, &quot;Listing_body.html&quot;,</span>
            &quot;Listing_body1.html&quot;, &quot;Listing_end.html&quot;),
<span class="fc" id="L174">    CancelRestart(&quot;CancelRestart_head.html&quot;, &quot;CancelRestart_body0.html&quot;,</span>
                  &quot;CancelRestart_body.html&quot;, &quot;CancelRestart_body1.html&quot;,
<span class="fc" id="L176">                  &quot;CancelRestart_end.html&quot;), Export(&quot;Export.html&quot;),</span>
<span class="fc" id="L177">    Hosts(&quot;Hosts_head.html&quot;, &quot;Hosts_body0.html&quot;, &quot;Hosts_body.html&quot;,</span>
          &quot;Hosts_body1.html&quot;, &quot;Hosts_end.html&quot;),
<span class="fc" id="L179">    Rules(&quot;Rules_head.html&quot;, &quot;Rules_body0.html&quot;, &quot;Rules_body.html&quot;,</span>
<span class="fc" id="L180">          &quot;Rules_body1.html&quot;, &quot;Rules_end.html&quot;), System(&quot;System.html&quot;),</span>
<span class="fc" id="L181">    SystemLimited(&quot;SystemLimited.html&quot;), Spooled(&quot;Spooled.html&quot;),</span>
<span class="fc" id="L182">    SpooledDetailed(&quot;Spooled.html&quot;);</span>

    private final String header;
    private final String headerBody;
    private final String body;
    private final String endBody;
    private final String end;

    /**
     * Constructor for a unique file
     *
     * @param uniquefile
     */
<span class="fc" id="L195">    REQUEST(final String uniquefile) {</span>
<span class="fc" id="L196">      header = uniquefile;</span>
<span class="fc" id="L197">      headerBody = null;</span>
<span class="fc" id="L198">      body = null;</span>
<span class="fc" id="L199">      endBody = null;</span>
<span class="fc" id="L200">      end = null;</span>
<span class="fc" id="L201">    }</span>

    /**
     * @param header
     * @param headerBody
     * @param body
     * @param endBody
     * @param end
     */
    REQUEST(final String header, final String headerBody, final String body,
<span class="fc" id="L211">            final String endBody, final String end) {</span>
<span class="fc" id="L212">      this.header = header;</span>
<span class="fc" id="L213">      this.headerBody = headerBody;</span>
<span class="fc" id="L214">      this.body = body;</span>
<span class="fc" id="L215">      this.endBody = endBody;</span>
<span class="fc" id="L216">      this.end = end;</span>
<span class="fc" id="L217">    }</span>

    /**
     * Reader for a unique file
     *
     * @return the content of the unique file
     */
    public String readFileUnique(final HttpSslHandler handler) {
<span class="fc" id="L225">      return handler.readFileHeader(</span>
<span class="fc" id="L226">          Configuration.configuration.getHttpBasePath() + header);</span>
    }

    public String readHeader(final HttpSslHandler handler) {
<span class="fc" id="L230">      return handler.readFileHeader(</span>
<span class="fc" id="L231">          Configuration.configuration.getHttpBasePath() + header);</span>
    }

    public String readBodyHeader() {
<span class="fc" id="L235">      return WaarpStringUtils</span>
<span class="fc" id="L236">          .readFile(Configuration.configuration.getHttpBasePath() + headerBody);</span>
    }

    public String readBody() {
<span class="fc" id="L240">      return WaarpStringUtils</span>
<span class="fc" id="L241">          .readFile(Configuration.configuration.getHttpBasePath() + body);</span>
    }

    public String readBodyEnd() {
<span class="fc" id="L245">      return WaarpStringUtils</span>
<span class="fc" id="L246">          .readFile(Configuration.configuration.getHttpBasePath() + endBody);</span>
    }

    public String readEnd() {
<span class="fc" id="L250">      return WaarpStringUtils</span>
<span class="fc" id="L251">          .readFile(Configuration.configuration.getHttpBasePath() + end);</span>
    }
  }

<span class="fc" id="L255">  protected enum REPLACEMENT {</span>
<span class="fc" id="L256">    XXXHOSTIDXXX, XXXADMINXXX, XXXVERSIONXXX, XXXBANDWIDTHXXX,</span>
<span class="fc" id="L257">    XXXBANDWIDTHINXXX, XXXBANDWIDTHOUTXXX, XXXXSESSIONLIMITRXXX,</span>
<span class="fc" id="L258">    XXXXSESSIONLIMITWXXX, XXXXCHANNELLIMITRXXX, XXXXCHANNELLIMITWXXX,</span>
<span class="fc" id="L259">    XXXXDELAYCOMMDXXX, XXXXDELAYRETRYXXX, XXXXDELATRAFFICXXX, XXXLOCALXXX,</span>
<span class="fc" id="L260">    XXXNETWORKXXX, XXXNBTRANSFERSXXX, XXXERRORMESGXXX, XXXXBUSINESSXXX,</span>
<span class="fc" id="L261">    XXXXROLESXXX, XXXXALIASESXXX, XXXXOTHERXXX, XXXLIMITROWXXX, XXXREFRESHXXX,</span>
<span class="fc" id="L262">    XXXLANGXXX, XXXCURLANGENXXX, XXXCURLANGFRXXX, XXXCURSYSLANGENXXX,</span>
<span class="fc" id="L263">    XXXCURSYSLANGFRXXX</span>
  }

  public static final String sLIMITROW = &quot;LIMITROW&quot;;
  static final String XXXRESULTXXX = &quot;XXXRESULTXXX&quot;;

<span class="fc" id="L269">  private int limitRow = 48; // better if it can</span>
  // be divided by 4
  private int refresh;

  /**
   * The Database connection attached to this NetworkChannelReference shared
   * among all associated LocalChannels
   * in the session
   */
  DbSession dbSession;

  public static String hashStatus() {
<span class="nc" id="L281">    return &quot;HttpSslHandler: [sessions: &quot; + sessions.size() + &quot;] &quot;;</span>
  }

  String readFileHeader(final String filename) {
    final String value;
    try {
<span class="fc" id="L287">      value = WaarpStringUtils.readFileException(filename);</span>
<span class="nc" id="L288">    } catch (final FileTransferException e) {</span>
<span class="nc" id="L289">      logger.error(&quot;Error while trying to read: &quot; + filename, e);</span>
<span class="nc" id="L290">      return &quot;&quot;;</span>
<span class="fc" id="L291">    }</span>
<span class="fc" id="L292">    final StringBuilder builder = new StringBuilder(value);</span>
<span class="fc" id="L293">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXLOCALXXX.toString(),</span>
<span class="fc" id="L294">                             Configuration.configuration.getLocalTransaction()</span>
<span class="fc" id="L295">                                                        .getNumberLocalChannel() +</span>
<span class="fc" id="L296">                             &quot; Thread(&quot; + Thread.activeCount() + ')');</span>
<span class="fc" id="L297">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXNETWORKXXX.toString(),</span>
<span class="fc" id="L298">                             Integer.toString(DbAdmin.getNbConnection() -</span>
<span class="fc" id="L299">                                              Configuration.getNbDbSession()));</span>
<span class="fc" id="L300">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXNBTRANSFERSXXX.toString(),</span>
<span class="fc" id="L301">                             Long.toString(Configuration.configuration</span>
<span class="fc" id="L302">                                               .getMonitoring().nbCountAllRunningStep));</span>
<span class="fc" id="L303">    WaarpStringUtils.replaceAll(builder, REPLACEMENT.XXXHOSTIDXXX.toString(),</span>
<span class="fc" id="L304">                                Configuration.configuration.getHostId());</span>
<span class="fc bfc" id="L305" title="All 2 branches covered.">    if (authentHttp.isAuthenticated()) {</span>
<span class="fc" id="L306">      WaarpStringUtils.replace(builder, REPLACEMENT.XXXADMINXXX.toString(),</span>
<span class="fc" id="L307">                               Messages.getString(</span>
                                   &quot;HttpSslHandler.1&quot;)); //$NON-NLS-1$
    } else {
<span class="fc" id="L310">      WaarpStringUtils.replace(builder, REPLACEMENT.XXXADMINXXX.toString(),</span>
<span class="fc" id="L311">                               Messages.getString(</span>
                                   &quot;HttpSslHandler.0&quot;)); //$NON-NLS-1$
    }
<span class="fc" id="L314">    final TrafficCounter trafficCounter =</span>
<span class="fc" id="L315">        Configuration.configuration.getGlobalTrafficShapingHandler()</span>
<span class="fc" id="L316">                                   .trafficCounter();</span>
<span class="fc" id="L317">    final long read = trafficCounter.lastReadThroughput();</span>
<span class="fc" id="L318">    final long write = trafficCounter.lastWriteThroughput();</span>
<span class="fc" id="L319">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXBANDWIDTHXXX.toString(),</span>
<span class="fc" id="L320">                             Messages.getString(&quot;HttpSslHandler.IN&quot;) +</span>
                             (read &gt;&gt; 20) + //$NON-NLS-1$
<span class="fc" id="L322">                             Messages.getString(HTTP_SSL_HANDLER_MOPS) +</span>
                             //$NON-NLS-1$
<span class="fc" id="L324">                             Messages.getString(&quot;HttpSslHandler.OUT&quot;) +</span>
                             //$NON-NLS-1$
<span class="fc" id="L326">                             (write &gt;&gt; 20) + Messages.getString(</span>
                                 HTTP_SSL_HANDLER_MOPS)); //$NON-NLS-1$
<span class="fc" id="L328">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXBANDWIDTHINXXX.toString(),</span>
<span class="fc" id="L329">                             (read &gt;&gt; 20) + Messages.getString(</span>
                                 HTTP_SSL_HANDLER_MOPS)); //$NON-NLS-1$
<span class="fc" id="L331">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXBANDWIDTHOUTXXX.toString(),</span>
<span class="fc" id="L332">                             (write &gt;&gt; 20) + Messages.getString(</span>
                                 HTTP_SSL_HANDLER_MOPS)); //$NON-NLS-1$
<span class="fc" id="L334">    WaarpStringUtils.replaceAll(builder, REPLACEMENT.XXXLIMITROWXXX.toString(),</span>
<span class="fc" id="L335">                                String.valueOf(getLimitRow()));</span>
<span class="fc" id="L336">    WaarpStringUtils.replaceAll(builder, REPLACEMENT.XXXREFRESHXXX.toString(),</span>
<span class="fc" id="L337">                                String.valueOf(getRefresh() / 1000));</span>
<span class="fc" id="L338">    WaarpStringUtils</span>
<span class="fc" id="L339">        .replaceAll(builder, REPLACEMENT.XXXLANGXXX.toString(), lang);</span>
<span class="fc" id="L340">    return builder.toString();</span>
  }

  protected String getTrimValue(final String varname) {
<span class="fc" id="L344">    final List&lt;String&gt; varlist = params.get(varname);</span>
<span class="pc bpc" id="L345" title="1 of 4 branches missed.">    if (varlist != null &amp;&amp; !varlist.isEmpty()) {</span>
<span class="fc" id="L346">      String value = params.get(varname).get(0).trim();</span>
<span class="fc bfc" id="L347" title="All 2 branches covered.">      if (value.isEmpty()) {</span>
<span class="fc" id="L348">        value = null;</span>
      }
<span class="fc" id="L350">      return value;</span>
    }
<span class="fc" id="L352">    return null;</span>
  }

  String getValue(final String varname) {
<span class="fc" id="L356">    return params.get(varname).get(0);</span>
  }

  private String index() {
<span class="fc" id="L360">    final String index = REQUEST.index.readFileUnique(this);</span>
<span class="fc" id="L361">    final StringBuilder builder = new StringBuilder(index);</span>
<span class="fc" id="L362">    WaarpStringUtils.replaceAll(builder, REPLACEMENT.XXXHOSTIDXXX.toString(),</span>
<span class="fc" id="L363">                                Configuration.configuration.getHostId());</span>
<span class="fc" id="L364">    WaarpStringUtils.replaceAll(builder, REPLACEMENT.XXXADMINXXX.toString(),</span>
<span class="fc" id="L365">                                Messages.getString(</span>
                                    &quot;HttpSslHandler.2&quot;)); //$NON-NLS-1$
<span class="fc" id="L367">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXVERSIONXXX.toString(),</span>
<span class="fc" id="L368">                             Version.fullIdentifier());</span>
<span class="fc" id="L369">    return builder.toString();</span>
  }

  protected String error(final String mesg) {
<span class="fc" id="L373">    final String index = REQUEST.error.readFileUnique(this);</span>
<span class="fc" id="L374">    return index.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(), mesg);</span>
  }

  private String unallowed(final String mesg) {
<span class="fc" id="L378">    final String index = REQUEST.unallowed.readFileUnique(this);</span>
<span class="pc bpc" id="L379" title="2 of 4 branches missed.">    if (index == null || index.isEmpty()) {</span>
<span class="nc" id="L380">      return error(mesg);</span>
    }
<span class="fc" id="L382">    return index.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(), mesg);</span>
  }

  protected String logon() {
<span class="fc" id="L386">    return REQUEST.Logon.readFileUnique(this);</span>
  }

  private String transfers() {
<span class="fc" id="L390">    return REQUEST.Transfers.readFileUnique(this);</span>
  }

  String resetOptionTransfer(final String header, final String startid,
                             final String stopid, final String start,
                             final String stop, final String rule,
                             final String req, final boolean pending,
                             final boolean transfer, final boolean error,
                             final boolean done, final boolean all) {
<span class="fc" id="L399">    final StringBuilder builder = new StringBuilder(header);</span>
<span class="fc" id="L400">    WaarpStringUtils.replace(builder, &quot;XXXSTARTIDXXX&quot;, startid);</span>
<span class="fc" id="L401">    WaarpStringUtils.replace(builder, &quot;XXXSTOPIDXXX&quot;, stopid);</span>
<span class="fc" id="L402">    WaarpStringUtils.replace(builder, &quot;XXXSTARTXXX&quot;, start);</span>
<span class="fc" id="L403">    WaarpStringUtils.replace(builder, &quot;XXXSTOPXXX&quot;, stop);</span>
<span class="fc" id="L404">    WaarpStringUtils.replace(builder, &quot;XXXRULEXXX&quot;, rule);</span>
<span class="fc" id="L405">    WaarpStringUtils.replace(builder, &quot;XXXREQXXX&quot;, req);</span>
<span class="fc bfc" id="L406" title="All 2 branches covered.">    WaarpStringUtils.replace(builder, &quot;XXXPENDXXX&quot;, pending? CHECKED : &quot;&quot;);</span>
<span class="fc bfc" id="L407" title="All 2 branches covered.">    WaarpStringUtils.replace(builder, &quot;XXXTRANSXXX&quot;, transfer? CHECKED : &quot;&quot;);</span>
<span class="fc bfc" id="L408" title="All 2 branches covered.">    WaarpStringUtils.replace(builder, &quot;XXXERRXXX&quot;, error? CHECKED : &quot;&quot;);</span>
<span class="fc bfc" id="L409" title="All 2 branches covered.">    WaarpStringUtils.replace(builder, &quot;XXXDONEXXX&quot;, done? CHECKED : &quot;&quot;);</span>
<span class="fc bfc" id="L410" title="All 2 branches covered.">    WaarpStringUtils.replace(builder, &quot;XXXALLXXX&quot;, all? CHECKED : &quot;&quot;);</span>
<span class="fc" id="L411">    return builder.toString();</span>
  }

  String checkAuthorizedToSeeAll() {
<span class="fc" id="L415">    boolean seeAll = false;</span>
<span class="pc bpc" id="L416" title="1 of 2 branches missed.">    if (authentHttp.getAuth().isValidRole(ROLE.CONFIGADMIN)) {</span>
      final DbHostConfiguration dbhc;
      try {
<span class="fc" id="L419">        dbhc = new DbHostConfiguration(Configuration.configuration.getHostId());</span>
<span class="nc" id="L420">      } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L421">        return null;</span>
<span class="fc" id="L422">      }</span>
<span class="pc bpc" id="L423" title="2 of 4 branches missed.">      seeAll = dbhc != null &amp;&amp; dbhc.isSeeAllId(authentHttp.getAuth().getUser());</span>
    }
<span class="pc bpc" id="L425" title="1 of 2 branches missed.">    if (seeAll) {</span>
<span class="nc" id="L426">      return &quot;*&quot;;</span>
    }
<span class="fc" id="L428">    return null;</span>
  }

  private String listing0() {
<span class="fc" id="L432">    getParams();</span>
<span class="fc bfc" id="L433" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L434">      String head = REQUEST.Listing.readHeader(this);</span>
<span class="fc" id="L435">      head =</span>
<span class="fc" id="L436">          resetOptionTransfer(head, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false, false,</span>
                              false, true);
<span class="fc" id="L438">      final String end = REQUEST.Listing.readEnd().replace(XXXRESULTXXX, &quot;&quot;);</span>
<span class="fc" id="L439">      return head + end;</span>
    }
<span class="fc" id="L441">    String head = REQUEST.Listing.readHeader(this);</span>
    String body0;
    String body;
    String body1;
<span class="fc" id="L445">    body0 = body1 = body = &quot;&quot;;</span>
<span class="fc" id="L446">    final StringBuilder endText = new StringBuilder();</span>
<span class="fc" id="L447">    final List&lt;String&gt; parms = params.get(ACTION);</span>
<span class="pc bpc" id="L448" title="1 of 2 branches missed.">    if (parms != null) {</span>
<span class="fc" id="L449">      body0 = REQUEST.Listing.readBodyHeader();</span>
<span class="fc" id="L450">      final String parm = parms.get(0);</span>
<span class="fc bfc" id="L451" title="All 2 branches covered.">      final boolean isNotReload = !&quot;Reload&quot;.equalsIgnoreCase(parm);</span>
<span class="pc bpc" id="L452" title="1 of 4 branches missed.">      if (FILTER.equalsIgnoreCase(parm) || !isNotReload) {</span>
<span class="fc" id="L453">        String startid = getTrimValue(STARTID2);</span>
<span class="fc" id="L454">        String stopid = getTrimValue(STOPID2);</span>
<span class="pc bpc" id="L455" title="3 of 6 branches missed.">        if (isNotReload &amp;&amp; startid != null &amp;&amp; stopid == null) {</span>
<span class="nc" id="L456">          stopid = Long.MAX_VALUE + &quot;&quot;;</span>
        }
<span class="pc bpc" id="L458" title="3 of 6 branches missed.">        if (isNotReload &amp;&amp; stopid != null &amp;&amp; startid == null) {</span>
<span class="nc" id="L459">          startid = (DbConstantR66.ILLEGALVALUE + 1) + &quot;&quot;;</span>
        }
<span class="fc" id="L461">        String start = getValue(START2);</span>
<span class="fc" id="L462">        String stop = getValue(&quot;stop&quot;);</span>
<span class="fc" id="L463">        final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="fc" id="L464">        final String req = getTrimValue(&quot;req&quot;);</span>
        final boolean pending;
        final boolean transfer;
        final boolean error;
        final boolean done;
        boolean all;
<span class="fc" id="L470">        pending = params.containsKey(PENDING2);</span>
<span class="fc" id="L471">        transfer = params.containsKey(TRANSFER2);</span>
<span class="fc" id="L472">        error = params.containsKey(ERROR2);</span>
<span class="fc" id="L473">        done = params.containsKey(&quot;done&quot;);</span>
<span class="fc" id="L474">        all = params.containsKey(&quot;all&quot;);</span>
<span class="pc bpc" id="L475" title="7 of 8 branches missed.">        if (pending &amp;&amp; transfer &amp;&amp; error &amp;&amp; done) {</span>
<span class="nc" id="L476">          all = true;</span>
<span class="pc bpc" id="L477" title="4 of 8 branches missed.">        } else if (!(pending || transfer || error || done)) {</span>
<span class="fc" id="L478">          all = true;</span>
        }
<span class="fc" id="L480">        final Timestamp tstart = WaarpStringUtils.fixDate(start);</span>
<span class="pc bpc" id="L481" title="1 of 2 branches missed.">        if (tstart != null) {</span>
<span class="nc" id="L482">          start = tstart.toString();</span>
        }
<span class="fc" id="L484">        final Timestamp tstop = WaarpStringUtils.fixDate(stop, tstart);</span>
<span class="pc bpc" id="L485" title="1 of 2 branches missed.">        if (tstop != null) {</span>
<span class="nc" id="L486">          stop = tstop.toString();</span>
        }
<span class="fc" id="L488">        Long idstart = null;</span>
<span class="fc" id="L489">        body = REQUEST.Listing.readBody();</span>
<span class="fc" id="L490">        final String seeAll = checkAuthorizedToSeeAll();</span>
<span class="fc" id="L491">        DbPreparedStatement preparedStatement = null;</span>
        try {
<span class="fc" id="L493">          preparedStatement = DbTaskRunner</span>
<span class="fc" id="L494">              .getFilterPrepareStatement(dbSession, getLimitRow(), false,</span>
                                         startid, stopid, tstart, tstop, rule,
                                         req, pending, transfer, error, done,
                                         all, seeAll);
<span class="fc" id="L498">          preparedStatement.executeQuery();</span>
<span class="fc" id="L499">          final StringBuilder builder = new StringBuilder();</span>
<span class="fc" id="L500">          int i = 0;</span>
<span class="pc bpc" id="L501" title="1 of 2 branches missed.">          while (preparedStatement.getNext()) {</span>
            try {
<span class="nc" id="L503">              i++;</span>
<span class="nc" id="L504">              final DbTaskRunner taskRunner =</span>
<span class="nc" id="L505">                  DbTaskRunner.getFromStatementNoRule(preparedStatement);</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">              if (isNotReload) {</span>
<span class="nc" id="L507">                final long specid = taskRunner.getSpecialId();</span>
<span class="nc bnc" id="L508" title="All 4 branches missed.">                if (idstart == null || idstart &gt; specid) {</span>
<span class="nc" id="L509">                  idstart = specid;</span>
                }
              }
<span class="nc" id="L512">              final LocalChannelReference lcr =</span>
<span class="nc" id="L513">                  Configuration.configuration.getLocalTransaction()</span>
<span class="nc" id="L514">                                             .getFromRequest(</span>
<span class="nc" id="L515">                                                 taskRunner.getKey());</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">              builder.append(taskRunner.toSpecializedHtml(authentHttp, body,</span>
                                                          lcr != null? Messages
<span class="nc" id="L518">                                                              .getString(</span>
                                                                  HTTP_SSL_HANDLER_ACTIVE) :
                                                              Messages
<span class="nc" id="L521">                                                                  .getString(</span>
                                                                      HTTP_SSL_HANDLER_NOT_ACTIVE)));
<span class="nc bnc" id="L523" title="All 2 branches missed.">              if (i &gt; getLimitRow()) {</span>
<span class="nc" id="L524">                break;</span>
              }
<span class="nc" id="L526">            } catch (final WaarpDatabaseException e) {</span>
              // try to continue if possible
<span class="nc" id="L528">              logger.warn(AN_ERROR_OCCURS_WHILE_ACCESSING_A_RUNNER,</span>
<span class="nc" id="L529">                          e.getMessage());</span>
<span class="nc" id="L530">              endText.append(e.getMessage()).append(&quot;&lt;/BR&gt;&quot;);</span>
<span class="nc" id="L531">            }</span>
          }
<span class="fc" id="L533">          preparedStatement.realClose();</span>
<span class="fc" id="L534">          body = builder.toString();</span>
<span class="nc" id="L535">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">          if (preparedStatement != null) {</span>
<span class="nc" id="L537">            preparedStatement.realClose();</span>
          }
<span class="nc" id="L539">          logger.warn(OPEN_R66_WEB_ERROR, e.getMessage());</span>
<span class="fc" id="L540">        }</span>
<span class="pc bpc" id="L541" title="2 of 4 branches missed.">        head = resetOptionTransfer(head, startid == null?</span>
<span class="pc bpc" id="L542" title="3 of 6 branches missed.">                                       idstart != null? idstart.toString() : &quot;&quot; : startid,</span>
                                   stopid == null? &quot;&quot; : stopid, start, stop,
                                   rule == null? &quot;&quot; : rule,
                                   req == null? &quot;&quot; : req, pending, transfer,
                                   error, done, all);
<span class="fc" id="L547">      } else {</span>
<span class="nc" id="L548">        head = resetOptionTransfer(head, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false,</span>
                                   false, false, true);
      }
<span class="fc" id="L551">      body1 = REQUEST.Listing.readBodyEnd();</span>
<span class="fc" id="L552">    } else {</span>
<span class="nc" id="L553">      head =</span>
<span class="nc" id="L554">          resetOptionTransfer(head, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false, false,</span>
                              false, true);
    }
<span class="fc" id="L557">    final String end =</span>
<span class="fc" id="L558">        REQUEST.Listing.readEnd().replace(XXXRESULTXXX, endText.toString());</span>
<span class="fc" id="L559">    return head + body0 + body + body1 + end;</span>
  }

  private String cancelRestart0() {
<span class="fc" id="L563">    getParams();</span>
<span class="fc bfc" id="L564" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L565">      String head = REQUEST.CancelRestart.readHeader(this);</span>
<span class="fc" id="L566">      head =</span>
<span class="fc" id="L567">          resetOptionTransfer(head, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false, false,</span>
                              false, true);
      final String end;
<span class="fc" id="L570">      end = REQUEST.CancelRestart.readEnd();</span>
<span class="fc" id="L571">      return head + end;</span>
    }
<span class="fc" id="L573">    String head = REQUEST.CancelRestart.readHeader(this);</span>
    String body0;
    String body;
    String body1;
<span class="fc" id="L577">    body0 = body1 = body = &quot;&quot;;</span>
<span class="fc" id="L578">    final List&lt;String&gt; parms = params.get(ACTION);</span>
<span class="fc" id="L579">    final String seeAll = checkAuthorizedToSeeAll();</span>
<span class="pc bpc" id="L580" title="1 of 2 branches missed.">    if (parms != null) {</span>
<span class="fc" id="L581">      body0 = REQUEST.CancelRestart.readBodyHeader();</span>
<span class="fc" id="L582">      final String parm = parms.get(0);</span>
<span class="fc bfc" id="L583" title="All 2 branches covered.">      final boolean isNotReload = !&quot;Reload&quot;.equalsIgnoreCase(parm);</span>
<span class="fc bfc" id="L584" title="All 4 branches covered.">      if (FILTER.equalsIgnoreCase(parm) || !isNotReload) {</span>
<span class="fc" id="L585">        String startid = getTrimValue(STARTID2);</span>
<span class="fc" id="L586">        String stopid = getTrimValue(STOPID2);</span>
<span class="pc bpc" id="L587" title="3 of 6 branches missed.">        if (isNotReload &amp;&amp; startid != null &amp;&amp; stopid == null) {</span>
<span class="nc" id="L588">          stopid = Long.MAX_VALUE + &quot;&quot;;</span>
        }
<span class="pc bpc" id="L590" title="3 of 6 branches missed.">        if (isNotReload &amp;&amp; stopid != null &amp;&amp; startid == null) {</span>
<span class="nc" id="L591">          startid = (DbConstantR66.ILLEGALVALUE + 1) + &quot;&quot;;</span>
        }
<span class="fc" id="L593">        String start = getValue(START2);</span>
<span class="fc" id="L594">        String stop = getValue(&quot;stop&quot;);</span>
<span class="fc" id="L595">        final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="fc" id="L596">        final String req = getTrimValue(&quot;req&quot;);</span>
        final boolean pending;
        final boolean transfer;
        final boolean error;
        final boolean done;
        boolean all;
<span class="fc" id="L602">        pending = params.containsKey(PENDING2);</span>
<span class="fc" id="L603">        transfer = params.containsKey(TRANSFER2);</span>
<span class="fc" id="L604">        error = params.containsKey(ERROR2);</span>
<span class="fc" id="L605">        done = params.containsKey(&quot;done&quot;);</span>
<span class="fc" id="L606">        all = params.containsKey(&quot;all&quot;);</span>
<span class="pc bpc" id="L607" title="7 of 8 branches missed.">        if (pending &amp;&amp; transfer &amp;&amp; error &amp;&amp; done) {</span>
<span class="nc" id="L608">          all = true;</span>
<span class="pc bpc" id="L609" title="4 of 8 branches missed.">        } else if (!(pending || transfer || error || done)) {</span>
<span class="fc" id="L610">          all = true;</span>
        }
<span class="fc" id="L612">        final Timestamp tstart = WaarpStringUtils.fixDate(start);</span>
<span class="pc bpc" id="L613" title="1 of 2 branches missed.">        if (tstart != null) {</span>
<span class="nc" id="L614">          start = tstart.toString();</span>
        }
<span class="fc" id="L616">        final Timestamp tstop = WaarpStringUtils.fixDate(stop, tstart);</span>
<span class="pc bpc" id="L617" title="1 of 2 branches missed.">        if (tstop != null) {</span>
<span class="nc" id="L618">          stop = tstop.toString();</span>
        }
<span class="fc" id="L620">        body = REQUEST.CancelRestart.readBody();</span>
<span class="fc" id="L621">        Long idstart = null;</span>
<span class="fc" id="L622">        DbPreparedStatement preparedStatement = null;</span>
        try {
<span class="fc" id="L624">          preparedStatement = DbTaskRunner</span>
<span class="fc" id="L625">              .getFilterPrepareStatement(dbSession, getLimitRow(), false,</span>
                                         startid, stopid, tstart, tstop, rule,
                                         req, pending, transfer, error, done,
                                         all, seeAll);
<span class="fc" id="L629">          preparedStatement.executeQuery();</span>
<span class="fc" id="L630">          final StringBuilder builder = new StringBuilder();</span>
<span class="fc" id="L631">          int i = 0;</span>
<span class="pc bpc" id="L632" title="1 of 2 branches missed.">          while (preparedStatement.getNext()) {</span>
            try {
<span class="nc" id="L634">              i++;</span>
<span class="nc" id="L635">              final DbTaskRunner taskRunner =</span>
<span class="nc" id="L636">                  DbTaskRunner.getFromStatementNoRule(preparedStatement);</span>
<span class="nc bnc" id="L637" title="All 2 branches missed.">              if (isNotReload) {</span>
<span class="nc" id="L638">                final long specid = taskRunner.getSpecialId();</span>
<span class="nc bnc" id="L639" title="All 4 branches missed.">                if (idstart == null || idstart &gt; specid) {</span>
<span class="nc" id="L640">                  idstart = specid;</span>
                }
              }
<span class="nc" id="L643">              final LocalChannelReference lcr =</span>
<span class="nc" id="L644">                  Configuration.configuration.getLocalTransaction()</span>
<span class="nc" id="L645">                                             .getFromRequest(</span>
<span class="nc" id="L646">                                                 taskRunner.getKey());</span>
<span class="nc bnc" id="L647" title="All 2 branches missed.">              builder.append(taskRunner.toSpecializedHtml(authentHttp, body,</span>
                                                          lcr != null? Messages
<span class="nc" id="L649">                                                              .getString(</span>
                                                                  HTTP_SSL_HANDLER_ACTIVE) :
                                                              Messages
<span class="nc" id="L652">                                                                  .getString(</span>
                                                                      HTTP_SSL_HANDLER_NOT_ACTIVE)));
<span class="nc bnc" id="L654" title="All 2 branches missed.">              if (i &gt; getLimitRow()) {</span>
<span class="nc" id="L655">                break;</span>
              }
<span class="nc" id="L657">            } catch (final WaarpDatabaseException e) {</span>
              // try to continue if possible
<span class="nc" id="L659">              logger.warn(AN_ERROR_OCCURS_WHILE_ACCESSING_A_RUNNER,</span>
<span class="nc" id="L660">                          e.getMessage());</span>
<span class="nc" id="L661">            }</span>
          }
<span class="fc" id="L663">          preparedStatement.realClose();</span>
<span class="fc" id="L664">          body = builder.toString();</span>
<span class="nc" id="L665">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc bnc" id="L666" title="All 2 branches missed.">          if (preparedStatement != null) {</span>
<span class="nc" id="L667">            preparedStatement.realClose();</span>
          }
<span class="nc" id="L669">          logger.warn(OPEN_R66_WEB_ERROR, e.getMessage());</span>
<span class="fc" id="L670">        }</span>
<span class="pc bpc" id="L671" title="2 of 4 branches missed.">        head = resetOptionTransfer(head, startid == null?</span>
<span class="pc bpc" id="L672" title="3 of 6 branches missed.">                                       idstart != null? idstart.toString() : &quot;&quot; : startid,</span>
                                   stopid == null? &quot;&quot; : stopid, start, stop,
                                   rule == null? &quot;&quot; : rule,
                                   req == null? &quot;&quot; : req, pending, transfer,
                                   error, done, all);
<span class="fc" id="L677">        body1 = REQUEST.CancelRestart.readBodyEnd();</span>
<span class="fc bfc" id="L678" title="All 2 branches covered.">      } else if (&quot;RestartAll&quot;.equalsIgnoreCase(parm) ||</span>
<span class="pc bpc" id="L679" title="1 of 2 branches missed.">                 &quot;StopAll&quot;.equalsIgnoreCase(parm) ||</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">                 &quot;StopCleanAll&quot;.equalsIgnoreCase(parm)) {</span>
<span class="fc bfc" id="L681" title="All 2 branches covered.">        final boolean stopcommand = &quot;StopAll&quot;.equalsIgnoreCase(parm) ||</span>
<span class="pc bpc" id="L682" title="1 of 2 branches missed.">                                    &quot;StopCleanAll&quot;.equalsIgnoreCase(parm);</span>
<span class="fc" id="L683">        final String startid = getTrimValue(STARTID2);</span>
<span class="fc" id="L684">        final String stopid = getTrimValue(STOPID2);</span>
<span class="fc" id="L685">        String start = getValue(START2);</span>
<span class="fc" id="L686">        String stop = getValue(&quot;stop&quot;);</span>
<span class="fc" id="L687">        final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="fc" id="L688">        final String req = getTrimValue(&quot;req&quot;);</span>
        boolean pending;
        boolean transfer;
        boolean error;
        final boolean done;
        boolean all;
<span class="fc" id="L694">        pending = params.containsKey(PENDING2);</span>
<span class="fc" id="L695">        transfer = params.containsKey(TRANSFER2);</span>
<span class="fc" id="L696">        error = params.containsKey(ERROR2);</span>
<span class="fc" id="L697">        done = false;</span>
<span class="fc" id="L698">        all = false;</span>
<span class="pc bpc" id="L699" title="2 of 6 branches missed.">        if (!(pending || transfer || error)) {</span>
<span class="fc" id="L700">          all = true;</span>
<span class="fc" id="L701">          pending = true;</span>
<span class="fc" id="L702">          transfer = true;</span>
<span class="fc" id="L703">          error = true;</span>
        }
<span class="fc" id="L705">        final Timestamp tstart = WaarpStringUtils.fixDate(start);</span>
<span class="pc bpc" id="L706" title="1 of 2 branches missed.">        if (tstart != null) {</span>
<span class="nc" id="L707">          start = tstart.toString();</span>
        }
<span class="fc" id="L709">        final Timestamp tstop = WaarpStringUtils.fixDate(stop, tstart);</span>
<span class="pc bpc" id="L710" title="1 of 2 branches missed.">        if (tstop != null) {</span>
<span class="nc" id="L711">          stop = tstop.toString();</span>
        }
<span class="pc bpc" id="L713" title="4 of 8 branches missed.">        head = resetOptionTransfer(head, startid == null? &quot;&quot; : startid,</span>
                                   stopid == null? &quot;&quot; : stopid, start, stop,
                                   rule == null? &quot;&quot; : rule,
                                   req == null? &quot;&quot; : req, pending, transfer,
                                   error, false, all);
<span class="fc" id="L718">        body = REQUEST.CancelRestart.readBody();</span>
<span class="fc" id="L719">        final StringBuilder builder = new StringBuilder();</span>
<span class="fc bfc" id="L720" title="All 2 branches covered.">        if (stopcommand) {</span>
<span class="pc bpc" id="L721" title="1 of 2 branches missed.">          if (&quot;StopCleanAll&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L722">            TransferUtils</span>
<span class="nc" id="L723">                .cleanSelectedTransfers(dbSession, 0, builder, authentHttp,</span>
                                        body, startid, stopid, tstart, tstop,
                                        rule, req, pending, transfer, error,
                                        seeAll);
          } else {
<span class="fc" id="L728">            TransferUtils</span>
<span class="fc" id="L729">                .stopSelectedTransfers(dbSession, 0, builder, authentHttp, body,</span>
                                       startid, stopid, tstart, tstop, rule,
                                       req, pending, transfer, error, seeAll);
          }
        } else {
<span class="fc" id="L734">          DbPreparedStatement preparedStatement = null;</span>
          try {
<span class="fc" id="L736">            preparedStatement = DbTaskRunner</span>
<span class="fc" id="L737">                .getFilterPrepareStatement(dbSession, 0, false, startid, stopid,</span>
                                           tstart, tstop, rule, req, pending,
                                           transfer, error, false, all, seeAll);
<span class="fc" id="L740">            preparedStatement.executeQuery();</span>
<span class="pc bpc" id="L741" title="1 of 2 branches missed.">            while (preparedStatement.getNext()) {</span>
              try {
<span class="nc" id="L743">                final DbTaskRunner taskRunner =</span>
<span class="nc" id="L744">                    DbTaskRunner.getFromStatement(preparedStatement);</span>
<span class="nc" id="L745">                final LocalChannelReference lcr =</span>
<span class="nc" id="L746">                    Configuration.configuration.getLocalTransaction()</span>
<span class="nc" id="L747">                                               .getFromRequest(</span>
<span class="nc" id="L748">                                                   taskRunner.getKey());</span>
<span class="nc" id="L749">                final R66Result finalResult =</span>
<span class="nc" id="L750">                    TransferUtils.restartTransfer(taskRunner, lcr);</span>
<span class="nc" id="L751">                final ErrorCode result = finalResult.getCode();</span>
<span class="nc" id="L752">                final ErrorCode last = taskRunner.getErrorInfo();</span>
<span class="nc" id="L753">                taskRunner.setErrorExecutionStatus(result);</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">                builder.append(taskRunner.toSpecializedHtml(authentHttp, body,</span>
                                                            lcr != null?
                                                                Messages
<span class="nc" id="L757">                                                                    .getString(</span>
                                                                        HTTP_SSL_HANDLER_ACTIVE) :
                                                                Messages
<span class="nc" id="L760">                                                                    .getString(</span>
                                                                        HTTP_SSL_HANDLER_NOT_ACTIVE)));
<span class="nc" id="L762">                taskRunner.setErrorExecutionStatus(last);</span>
<span class="nc" id="L763">              } catch (final WaarpDatabaseException e) {</span>
                // try to continue if possible
<span class="nc" id="L765">                logger.warn(AN_ERROR_OCCURS_WHILE_ACCESSING_A_RUNNER,</span>
<span class="nc" id="L766">                            e.getMessage());</span>
<span class="nc" id="L767">              }</span>
            }
<span class="fc" id="L769">            preparedStatement.realClose();</span>
<span class="nc" id="L770">          } catch (final WaarpDatabaseException e) {</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">            if (preparedStatement != null) {</span>
<span class="nc" id="L772">              preparedStatement.realClose();</span>
            }
<span class="nc" id="L774">            logger.warn(OPEN_R66_WEB_ERROR, e.getMessage());</span>
<span class="fc" id="L775">          }</span>
        }
<span class="pc bpc" id="L777" title="1 of 2 branches missed.">        if (builder != null) {</span>
<span class="fc" id="L778">          body = builder.toString();</span>
        }
<span class="fc" id="L780">        body1 = REQUEST.CancelRestart.readBodyEnd();</span>
<span class="pc bnc" id="L781" title="All 2 branches missed.">      } else if (&quot;Cancel&quot;.equalsIgnoreCase(parm) ||</span>
<span class="nc bnc" id="L782" title="All 2 branches missed.">                 &quot;CancelClean&quot;.equalsIgnoreCase(parm) ||</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">                 &quot;Stop&quot;.equalsIgnoreCase(parm)) {</span>
        // Cancel or Stop
<span class="nc" id="L785">        final boolean stop = &quot;Stop&quot;.equalsIgnoreCase(parm);</span>
<span class="nc" id="L786">        final String specid = getValue(&quot;specid&quot;);</span>
<span class="nc" id="L787">        final String reqd = getValue(&quot;reqd&quot;);</span>
<span class="nc" id="L788">        final String reqr = getValue(&quot;reqr&quot;);</span>
<span class="nc" id="L789">        final LocalChannelReference lcr =</span>
<span class="nc" id="L790">            Configuration.configuration.getLocalTransaction().getFromRequest(</span>
                reqd + ' ' + reqr + ' ' + specid);
        // stop the current transfer
        ErrorCode result;
        final long lspecid;
        try {
<span class="nc" id="L796">          lspecid = Long.parseLong(specid);</span>
<span class="nc" id="L797">        } catch (final NumberFormatException e) {</span>
<span class="nc" id="L798">          body = &quot;&quot;;</span>
<span class="nc" id="L799">          body1 = REQUEST.CancelRestart.readBodyEnd();</span>
<span class="nc" id="L800">          body1 += BR_B + parm +</span>
<span class="nc" id="L801">                   Messages.getString(HTTP_SSL_HANDLER_3); //$NON-NLS-2$</span>
          final String end;
<span class="nc" id="L803">          end = REQUEST.CancelRestart.readEnd();</span>
<span class="nc" id="L804">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L805">        }</span>
<span class="nc" id="L806">        DbTaskRunner taskRunner = null;</span>
        try {
<span class="nc" id="L808">          taskRunner = new DbTaskRunner(authentHttp, null, lspecid, reqr, reqd);</span>
<span class="nc" id="L809">        } catch (final WaarpDatabaseException ignored) {</span>
          // nothing
<span class="nc" id="L811">        }</span>
<span class="nc bnc" id="L812" title="All 2 branches missed.">        if (taskRunner == null) {</span>
<span class="nc" id="L813">          body = &quot;&quot;;</span>
<span class="nc" id="L814">          body1 = REQUEST.CancelRestart.readBodyEnd();</span>
<span class="nc" id="L815">          body1 += BR_B + parm +</span>
<span class="nc" id="L816">                   Messages.getString(HTTP_SSL_HANDLER_3); //$NON-NLS-2$</span>
          final String end;
<span class="nc" id="L818">          end = REQUEST.CancelRestart.readEnd();</span>
<span class="nc" id="L819">          return head + body0 + body + body1 + end;</span>
        }
<span class="nc bnc" id="L821" title="All 2 branches missed.">        final ErrorCode code =</span>
            stop? ErrorCode.StoppedTransfer : ErrorCode.CanceledTransfer;
<span class="nc bnc" id="L823" title="All 2 branches missed.">        if (lcr != null) {</span>
<span class="nc" id="L824">          final int rank = taskRunner.getRank();</span>
<span class="nc" id="L825">          lcr.sessionNewState(R66FiniteDualStates.ERROR);</span>
<span class="nc" id="L826">          final ErrorPacket error =</span>
<span class="nc" id="L827">              new ErrorPacket(&quot;Transfer &quot; + parm + ' ' + rank, code.getCode(),</span>
                              ErrorPacket.FORWARDCLOSECODE);
          try {
            // inform local instead of remote
<span class="nc" id="L831">            LocalServerHandler.channelRead0(lcr, error);</span>
<span class="nc" id="L832">          } catch (final Exception ignored) {</span>
            // nothing
<span class="nc" id="L834">          }</span>
<span class="nc" id="L835">          result = ErrorCode.CompleteOk;</span>
<span class="nc" id="L836">        } else {</span>
          // Transfer is not running
          // But is the database saying the contrary
<span class="nc" id="L839">          result = ErrorCode.TransferOk;</span>
<span class="nc bnc" id="L840" title="All 2 branches missed.">          if (taskRunner.stopOrCancelRunner(code)) {</span>
<span class="nc" id="L841">            result = ErrorCode.CompleteOk;</span>
          }
        }
<span class="nc bnc" id="L844" title="All 2 branches missed.">        if (&quot;CancelClean&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L845">          TransferUtils.cleanOneTransfer(taskRunner, null, authentHttp, null);</span>
        }
<span class="nc" id="L847">        body = REQUEST.CancelRestart.readBody();</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">        body = taskRunner.toSpecializedHtml(authentHttp, body, lcr != null?</span>
<span class="nc" id="L849">            Messages.getString(HTTP_SSL_HANDLER_ACTIVE)</span>
            //$NON-NLS-1$
<span class="nc" id="L851">            : Messages.getString(HTTP_SSL_HANDLER_NOT_ACTIVE)); //$NON-NLS-1$</span>
<span class="nc" id="L852">        final String tstart = taskRunner.getStart().toString();</span>
<span class="nc" id="L853">        final String tstop = taskRunner.getStop().toString();</span>
<span class="nc" id="L854">        head = resetOptionTransfer(head, String</span>
<span class="nc" id="L855">                                       .valueOf(taskRunner.getSpecialId() - 1), String</span>
<span class="nc" id="L856">                                       .valueOf(taskRunner.getSpecialId() + 1),</span>
<span class="nc" id="L857">                                   tstart, tstop, taskRunner.getRuleId(),</span>
<span class="nc" id="L858">                                   taskRunner.getRequested(), false, false,</span>
                                   false, false, true);
<span class="nc" id="L860">        body1 = REQUEST.CancelRestart.readBodyEnd();</span>
<span class="nc bnc" id="L861" title="All 2 branches missed.">        body1 += BR_B + (result == ErrorCode.CompleteOk?</span>
<span class="nc" id="L862">            parm + Messages.getString(&quot;HttpSslHandler.5&quot;) :</span>
            //$NON-NLS-2$
<span class="nc" id="L864">            parm + Messages.getString(&quot;HttpSslHandler.4&quot;)) +</span>
                 &quot;&lt;/b&gt;&quot;; //$NON-NLS-1$
<span class="nc bnc" id="L866" title="All 2 branches missed.">      } else if (&quot;Restart&quot;.equalsIgnoreCase(parm)) {</span>
        // Restart
<span class="nc" id="L868">        final String specid = getValue(&quot;specid&quot;);</span>
<span class="nc" id="L869">        final String reqd = getValue(&quot;reqd&quot;);</span>
<span class="nc" id="L870">        final String reqr = getValue(&quot;reqr&quot;);</span>
        final long lspecid;
        try {
<span class="nc" id="L873">          lspecid = Long.parseLong(specid);</span>
<span class="nc" id="L874">        } catch (final NumberFormatException e) {</span>
<span class="nc" id="L875">          body = &quot;&quot;;</span>
<span class="nc" id="L876">          body1 = REQUEST.CancelRestart.readBodyEnd();</span>
<span class="nc" id="L877">          body1 += BR_B + parm +</span>
<span class="nc" id="L878">                   Messages.getString(HTTP_SSL_HANDLER_3); //$NON-NLS-2$</span>
          final String end;
<span class="nc" id="L880">          end = REQUEST.CancelRestart.readEnd();</span>
<span class="nc" id="L881">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L882">        }</span>
        final DbTaskRunner taskRunner;
        String comment;
        try {
<span class="nc" id="L886">          taskRunner = new DbTaskRunner(authentHttp, null, lspecid, reqr, reqd);</span>
<span class="nc" id="L887">          final LocalChannelReference lcr =</span>
<span class="nc" id="L888">              Configuration.configuration.getLocalTransaction()</span>
<span class="nc" id="L889">                                         .getFromRequest(taskRunner.getKey());</span>
<span class="nc" id="L890">          final R66Result finalResult =</span>
<span class="nc" id="L891">              TransferUtils.restartTransfer(taskRunner, lcr);</span>
<span class="nc" id="L892">          comment = (String) finalResult.getOther();</span>
<span class="nc" id="L893">          body = REQUEST.CancelRestart.readBody();</span>
<span class="nc bnc" id="L894" title="All 2 branches missed.">          body = taskRunner.toSpecializedHtml(authentHttp, body, lcr != null?</span>
<span class="nc" id="L895">              Messages.getString(HTTP_SSL_HANDLER_ACTIVE)</span>
              //$NON-NLS-1$
<span class="nc" id="L897">              : Messages.getString(HTTP_SSL_HANDLER_NOT_ACTIVE)); //$NON-NLS-1$</span>
<span class="nc" id="L898">          final String tstart = taskRunner.getStart().toString();</span>
<span class="nc" id="L899">          final String tstop = taskRunner.getStop().toString();</span>
<span class="nc" id="L900">          head = resetOptionTransfer(head, String</span>
<span class="nc" id="L901">                                         .valueOf(taskRunner.getSpecialId() - 1), String.valueOf(</span>
<span class="nc" id="L902">              taskRunner.getSpecialId() + 1), tstart, tstop,</span>
<span class="nc" id="L903">                                     taskRunner.getRuleId(),</span>
<span class="nc" id="L904">                                     taskRunner.getRequested(), false, false,</span>
                                     false, false, true);
<span class="nc" id="L906">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L907">          body = &quot;&quot;;</span>
<span class="nc" id="L908">          comment = Messages.getString(&quot;ErrorCode.17&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L909">        }</span>
<span class="nc" id="L910">        body1 = REQUEST.CancelRestart.readBodyEnd();</span>
<span class="nc" id="L911">        body1 += BR_B + comment + &quot;&lt;/b&gt;&quot;;</span>
<span class="nc" id="L912">      } else {</span>
<span class="nc" id="L913">        head = resetOptionTransfer(head, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false,</span>
                                   false, false, true);
      }
<span class="fc" id="L916">    } else {</span>
<span class="nc" id="L917">      head =</span>
<span class="nc" id="L918">          resetOptionTransfer(head, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false, false,</span>
                              false, true);
    }
    final String end;
<span class="fc" id="L922">    end = REQUEST.CancelRestart.readEnd();</span>
<span class="fc" id="L923">    return head + body0 + body + body1 + end;</span>
  }

  private String export0() {
<span class="fc" id="L927">    getParams();</span>
<span class="fc bfc" id="L928" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L929">      String body = REQUEST.Export.readFileUnique(this);</span>
<span class="fc" id="L930">      body =</span>
<span class="fc" id="L931">          resetOptionTransfer(body, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false, false,</span>
                              true, false);
<span class="fc" id="L933">      return body.replace(XXXRESULTXXX, &quot;&quot;);</span>
    }
<span class="fc" id="L935">    String body = REQUEST.Export.readFileUnique(this);</span>
<span class="fc" id="L936">    String start = getValue(START2);</span>
<span class="fc" id="L937">    String stop = getValue(&quot;stop&quot;);</span>
<span class="fc" id="L938">    final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="fc" id="L939">    final String req = getTrimValue(&quot;req&quot;);</span>
    final boolean pending;
    boolean transfer;
    final boolean error;
    final boolean done;
    boolean all;
<span class="fc" id="L945">    pending = params.containsKey(PENDING2);</span>
<span class="fc" id="L946">    transfer = params.containsKey(TRANSFER2);</span>
<span class="fc" id="L947">    error = params.containsKey(ERROR2);</span>
<span class="fc" id="L948">    done = params.containsKey(&quot;done&quot;);</span>
<span class="fc" id="L949">    all = params.containsKey(&quot;all&quot;);</span>
<span class="fc" id="L950">    boolean toPurge = params.containsKey(&quot;purge&quot;);</span>
<span class="pc bpc" id="L951" title="1 of 2 branches missed.">    if (toPurge) {</span>
<span class="nc" id="L952">      transfer = false;</span>
    }
<span class="pc bpc" id="L954" title="7 of 8 branches missed.">    if (pending &amp;&amp; transfer &amp;&amp; error &amp;&amp; done) {</span>
<span class="nc" id="L955">      all = true;</span>
<span class="pc bpc" id="L956" title="4 of 8 branches missed.">    } else if (!(pending || transfer || error || done)) {</span>
<span class="nc" id="L957">      all = true;</span>
    }
<span class="fc" id="L959">    final Timestamp tstart = WaarpStringUtils.fixDate(start);</span>
<span class="pc bpc" id="L960" title="1 of 2 branches missed.">    if (tstart != null) {</span>
<span class="nc" id="L961">      start = tstart.toString();</span>
    }
<span class="fc" id="L963">    final Timestamp tstop = WaarpStringUtils.fixDate(stop, tstart);</span>
<span class="pc bpc" id="L964" title="1 of 2 branches missed.">    if (tstop != null) {</span>
<span class="nc" id="L965">      stop = tstop.toString();</span>
    }
<span class="pc bpc" id="L967" title="2 of 4 branches missed.">    body =</span>
<span class="fc" id="L968">        resetOptionTransfer(body, &quot;&quot;, &quot;&quot;, start, stop, rule == null? &quot;&quot; : rule,</span>
                            req == null? &quot;&quot; : req, pending, transfer, error,
                            done, all);
<span class="fc" id="L971">    boolean isexported = true;</span>
    // clean a bit the database before exporting
    try {
<span class="fc" id="L974">      DbTaskRunner.changeFinishedToDone();</span>
<span class="nc" id="L975">    } catch (final WaarpDatabaseNoConnectionException e2) {</span>
      // should not be
<span class="fc" id="L977">    }</span>
    // create export of log and optionally purge them from database
<span class="fc" id="L979">    DbPreparedStatement getValid = null;</span>
<span class="fc" id="L980">    NbAndSpecialId nbAndSpecialId = null;</span>
<span class="fc" id="L981">    final String filename = Configuration.configuration.getBaseDirectory() +</span>
<span class="fc" id="L982">                            Configuration.configuration.getArchivePath() +</span>
                            DirInterface.SEPARATOR +
<span class="fc" id="L984">                            Configuration.configuration.getHostId() + '_' +</span>
<span class="fc" id="L985">                            System.currentTimeMillis() + &quot;_runners.xml&quot;;</span>
<span class="fc" id="L986">    String errorMsg = &quot;&quot;;</span>
<span class="fc" id="L987">    final String seeAll = checkAuthorizedToSeeAll();</span>
    try {
<span class="fc" id="L989">      getValid = DbTaskRunner</span>
<span class="fc" id="L990">          .getFilterPrepareStatement(dbSession, 0, // 0 means no limit</span>
                                     true, null, null, tstart, tstop, rule, req,
                                     pending, transfer, error, done, all,
                                     seeAll);
<span class="fc" id="L994">      nbAndSpecialId = DbTaskRunner.writeXMLWriter(getValid, filename);</span>
<span class="nc" id="L995">    } catch (final WaarpDatabaseNoConnectionException e1) {</span>
<span class="nc" id="L996">      isexported = false;</span>
<span class="nc" id="L997">      toPurge = false;</span>
<span class="nc" id="L998">      logger.warn(EXPORT_ERROR, e1.getMessage());</span>
<span class="nc" id="L999">      errorMsg = e1.getMessage();</span>
<span class="nc" id="L1000">    } catch (final WaarpDatabaseSqlException e1) {</span>
<span class="nc" id="L1001">      isexported = false;</span>
<span class="nc" id="L1002">      toPurge = false;</span>
<span class="nc" id="L1003">      logger.warn(EXPORT_ERROR, e1.getMessage());</span>
<span class="nc" id="L1004">      errorMsg = e1.getMessage();</span>
<span class="nc" id="L1005">    } catch (final OpenR66ProtocolBusinessException e) {</span>
<span class="nc" id="L1006">      isexported = false;</span>
<span class="nc" id="L1007">      toPurge = false;</span>
<span class="nc" id="L1008">      logger.warn(EXPORT_ERROR, e.getMessage());</span>
<span class="nc" id="L1009">      errorMsg = e.getMessage();</span>
    } finally {
<span class="pc bpc" id="L1011" title="1 of 2 branches missed.">      if (getValid != null) {</span>
<span class="fc" id="L1012">        getValid.realClose();</span>
      }
    }
<span class="fc" id="L1015">    int purge = 0;</span>
<span class="pc bpc" id="L1016" title="2 of 4 branches missed.">    if (isexported &amp;&amp; nbAndSpecialId != null) {</span>
<span class="pc bpc" id="L1017" title="1 of 2 branches missed.">      if (nbAndSpecialId.nb &lt;= 0) {</span>
<span class="fc" id="L1018">        return body.replace(XXXRESULTXXX, Messages</span>
<span class="fc" id="L1019">            .getString(&quot;HttpSslHandler.7&quot;)); //$NON-NLS-1$</span>
      }
      // in case of purge
<span class="nc bnc" id="L1022" title="All 2 branches missed.">      if (toPurge) {</span>
        // purge with same filter all runners where globallasttep
        // is ALLDONE or ERROR
        // but getting the higher Special first
<span class="nc" id="L1026">        final String stopId = Long.toString(nbAndSpecialId.higherSpecialId);</span>
        try {
<span class="nc" id="L1028">          purge = DbTaskRunner</span>
<span class="nc" id="L1029">              .purgeLogPrepareStatement(dbSession, null, stopId, tstart, tstop,</span>
                                        rule, req, pending, transfer, error,
                                        done, all);
<span class="nc" id="L1032">        } catch (final WaarpDatabaseNoConnectionException ignored) {</span>
          // nothing
<span class="nc" id="L1034">        } catch (final WaarpDatabaseSqlException e) {</span>
<span class="nc" id="L1035">          logger.warn(&quot;Purge error: {}&quot;, e.getMessage());</span>
<span class="nc" id="L1036">        }</span>
      }
    }
<span class="nc bnc" id="L1039" title="All 2 branches missed.">    return body.replace(XXXRESULTXXX, &quot;Export &quot; + (isexported?</span>
<span class="nc" id="L1040">        &quot;&lt;B&gt;&quot; + Messages.getString(&quot;HttpSslHandler.8&quot;) + //$NON-NLS-2$</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">        filename + Messages.getString(&quot;HttpSslHandler.9&quot;) +</span>
        (nbAndSpecialId != null? nbAndSpecialId.nb : 0) +
<span class="nc" id="L1043">        Messages.getString(&quot;HttpSslHandler.10&quot;)</span>
        //$NON-NLS-1$ //$NON-NLS-2$
<span class="nc" id="L1045">        + purge + Messages.getString(&quot;HttpSslHandler.11&quot;) + &quot;&lt;/B&gt;&quot; :</span>
        //$NON-NLS-1$
<span class="nc" id="L1047">        &quot;&lt;B&gt;&quot; + Messages.getString(&quot;HttpSslHandler.12&quot;))) + &quot;&lt;/B&gt;&quot; +</span>
           errorMsg; //$NON-NLS-1$
  }

  String resetOptionHosts(final String header, final String host,
                          final String addr, final boolean ssl,
                          final boolean active) {
<span class="fc" id="L1054">    final StringBuilder builder = new StringBuilder(header);</span>
<span class="fc" id="L1055">    WaarpStringUtils.replace(builder, &quot;XXXFHOSTXXX&quot;, host);</span>
<span class="fc" id="L1056">    WaarpStringUtils.replace(builder, &quot;XXXFADDRXXX&quot;, addr);</span>
<span class="pc bpc" id="L1057" title="1 of 2 branches missed.">    WaarpStringUtils.replace(builder, &quot;XXXFSSLXXX&quot;, ssl? CHECKED : &quot;&quot;);</span>
<span class="pc bpc" id="L1058" title="1 of 2 branches missed.">    WaarpStringUtils.replace(builder, &quot;XXXFACTIVXXX&quot;, active? CHECKED : &quot;&quot;);</span>
<span class="fc" id="L1059">    return builder.toString();</span>
  }

  private String hosts0() {
<span class="fc" id="L1063">    getParams();</span>
<span class="fc" id="L1064">    String head = REQUEST.Hosts.readHeader(this);</span>
    final String end;
<span class="fc" id="L1066">    end = REQUEST.Hosts.readEnd();</span>
<span class="fc bfc" id="L1067" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L1068">      head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="fc" id="L1069">      return head + end;</span>
    }
    String body0;
    String body;
    String body1;
<span class="fc" id="L1074">    body0 = body1 = body = &quot;&quot;;</span>
<span class="fc" id="L1075">    final List&lt;String&gt; parms = params.get(ACTION);</span>
<span class="pc bpc" id="L1076" title="1 of 2 branches missed.">    if (parms != null) {</span>
<span class="fc" id="L1077">      body0 = REQUEST.Hosts.readBodyHeader();</span>
<span class="fc" id="L1078">      final String parm = parms.get(0);</span>
<span class="fc bfc" id="L1079" title="All 2 branches covered.">      if (CREATE.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L1080">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="fc" id="L1081">        final String addr = getTrimValue(ADDRESS);</span>
<span class="fc" id="L1082">        final String port = getTrimValue(&quot;port&quot;);</span>
<span class="fc" id="L1083">        final String key = getTrimValue(&quot;hostkey&quot;);</span>
        final boolean ssl;
        final boolean adminArg;
        final boolean isclient;
        final boolean isactive;
        final boolean isproxified;
<span class="fc" id="L1089">        ssl = params.containsKey(&quot;ssl&quot;);</span>
<span class="fc" id="L1090">        adminArg = params.containsKey(&quot;admin&quot;);</span>
<span class="fc" id="L1091">        isclient = params.containsKey(&quot;isclient&quot;);</span>
<span class="fc" id="L1092">        isactive = params.containsKey(&quot;isactive&quot;);</span>
<span class="fc" id="L1093">        isproxified = params.containsKey(&quot;isproxified&quot;);</span>
<span class="pc bpc" id="L1094" title="4 of 8 branches missed.">        if (host == null || addr == null || port == null || key == null) {</span>
<span class="nc" id="L1095">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1096">          body = Messages.getString(&quot;HttpSslHandler.13&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1097">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L1098">          return head + body0 + body + body1 + end;</span>
        }
        final int iport;
        try {
<span class="fc" id="L1102">          iport = Integer.parseInt(port);</span>
<span class="nc" id="L1103">        } catch (final NumberFormatException e1) {</span>
<span class="nc" id="L1104">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1105">          body = Messages.getString(&quot;HttpSslHandler.14&quot;) + e1.getMessage() +</span>
                 B_CENTER_P; //$NON-NLS-1$
<span class="nc" id="L1107">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L1108">          return head + body0 + body + body1 + end;</span>
<span class="fc" id="L1109">        }</span>
<span class="fc" id="L1110">        final DbHostAuth dbhost = new DbHostAuth(host, addr, iport, ssl,</span>
<span class="fc" id="L1111">                                                 key.getBytes(</span>
                                                     WaarpStringUtils.UTF8),
                                                 adminArg, isclient);
<span class="fc" id="L1114">        dbhost.setActive(isactive);</span>
<span class="fc" id="L1115">        dbhost.setProxified(isproxified);</span>
        try {
<span class="fc" id="L1117">          dbhost.insert();</span>
<span class="nc" id="L1118">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1119">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1120">          body = Messages.getString(&quot;HttpSslHandler.14&quot;) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1123">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L1124">          return head + body0 + body + body1 + end;</span>
<span class="fc" id="L1125">        }</span>
<span class="fc" id="L1126">        head = resetOptionHosts(head, host, addr, ssl, isactive);</span>
<span class="fc" id="L1127">        body = REQUEST.Hosts.readBody();</span>
<span class="fc" id="L1128">        body = dbhost.toSpecializedHtml(authentHttp, body, false);</span>
<span class="fc bfc" id="L1129" title="All 2 branches covered.">      } else if (FILTER.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L1130">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="fc" id="L1131">        final String addr = getTrimValue(ADDRESS);</span>
<span class="fc" id="L1132">        final boolean ssl = params.containsKey(&quot;ssl&quot;);</span>
<span class="fc" id="L1133">        final boolean isactive = params.containsKey(&quot;active&quot;);</span>
<span class="pc bpc" id="L1134" title="2 of 4 branches missed.">        head = resetOptionHosts(head, host == null? &quot;&quot; : host,</span>
                                addr == null? &quot;&quot; : addr, ssl, isactive);
<span class="fc" id="L1136">        body = REQUEST.Hosts.readBody();</span>
<span class="fc" id="L1137">        DbPreparedStatement preparedStatement = null;</span>
        try {
<span class="fc" id="L1139">          preparedStatement = DbHostAuth</span>
<span class="fc" id="L1140">              .getFilterPrepareStament(dbSession, host, addr, ssl, isactive);</span>
<span class="fc" id="L1141">          preparedStatement.executeQuery();</span>
<span class="fc" id="L1142">          final StringBuilder builder = new StringBuilder();</span>
<span class="fc" id="L1143">          int i = 0;</span>
<span class="fc bfc" id="L1144" title="All 2 branches covered.">          while (preparedStatement.getNext()) {</span>
<span class="fc" id="L1145">            i++;</span>
<span class="fc" id="L1146">            final DbHostAuth dbhost =</span>
<span class="fc" id="L1147">                DbHostAuth.getFromStatement(preparedStatement);</span>
<span class="fc" id="L1148">            builder.append(dbhost.toSpecializedHtml(authentHttp, body, false));</span>
<span class="pc bpc" id="L1149" title="1 of 2 branches missed.">            if (i &gt; getLimitRow()) {</span>
<span class="nc" id="L1150">              break;</span>
            }
<span class="fc" id="L1152">          }</span>
<span class="fc" id="L1153">          preparedStatement.realClose();</span>
<span class="fc" id="L1154">          body = builder.toString();</span>
<span class="nc" id="L1155">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc bnc" id="L1156" title="All 2 branches missed.">          if (preparedStatement != null) {</span>
<span class="nc" id="L1157">            preparedStatement.realClose();</span>
          }
<span class="nc" id="L1159">          logger.warn(OPEN_R66_WEB_ERROR, e.getMessage());</span>
<span class="fc" id="L1160">        }</span>
<span class="fc" id="L1161">        body1 = REQUEST.Hosts.readBodyEnd();</span>
<span class="fc bfc" id="L1162" title="All 2 branches covered.">      } else if (&quot;Update&quot;.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L1163">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="fc" id="L1164">        final String addr = getTrimValue(ADDRESS);</span>
<span class="fc" id="L1165">        final String port = getTrimValue(&quot;port&quot;);</span>
<span class="fc" id="L1166">        final String key = getTrimValue(&quot;hostkey&quot;);</span>
        final boolean ssl;
        final boolean adminArg;
        final boolean isclient;
        final boolean isactive;
        final boolean isproxified;
<span class="fc" id="L1172">        ssl = params.containsKey(&quot;ssl&quot;);</span>
<span class="fc" id="L1173">        adminArg = params.containsKey(&quot;admin&quot;);</span>
<span class="fc" id="L1174">        isclient = params.containsKey(&quot;isclient&quot;);</span>
<span class="fc" id="L1175">        isactive = params.containsKey(&quot;isactive&quot;);</span>
<span class="fc" id="L1176">        isproxified = params.containsKey(&quot;isproxified&quot;);</span>
<span class="pc bpc" id="L1177" title="4 of 8 branches missed.">        if (host == null || addr == null || port == null || key == null) {</span>
<span class="nc" id="L1178">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1179">          body = Messages.getString(&quot;HttpSslHandler.15&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1180">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L1181">          return head + body0 + body + body1 + end;</span>
        }
        final int iport;
        try {
<span class="fc" id="L1185">          iport = Integer.parseInt(port);</span>
<span class="nc" id="L1186">        } catch (final NumberFormatException e1) {</span>
<span class="nc" id="L1187">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1188">          body = Messages.getString(&quot;HttpSslHandler.16&quot;) + e1.getMessage() +</span>
                 B_CENTER_P; //$NON-NLS-1$
<span class="nc" id="L1190">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L1191">          return head + body0 + body + body1 + end;</span>
<span class="fc" id="L1192">        }</span>
<span class="fc" id="L1193">        final DbHostAuth dbhost = new DbHostAuth(host, addr, iport, ssl,</span>
<span class="fc" id="L1194">                                                 key.getBytes(</span>
                                                     WaarpStringUtils.UTF8),
                                                 adminArg, isclient);
<span class="fc" id="L1197">        dbhost.setActive(isactive);</span>
<span class="fc" id="L1198">        dbhost.setProxified(isproxified);</span>
        try {
<span class="pc bpc" id="L1200" title="1 of 2 branches missed.">          if (dbhost.exist()) {</span>
<span class="fc" id="L1201">            dbhost.update();</span>
          } else {
<span class="nc" id="L1203">            dbhost.insert();</span>
          }
<span class="nc" id="L1205">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1206">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1207">          body = Messages.getString(&quot;HttpSslHandler.16&quot;) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1210">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L1211">          return head + body0 + body + body1 + end;</span>
<span class="fc" id="L1212">        }</span>
<span class="fc" id="L1213">        head = resetOptionHosts(head, host, addr, ssl, isactive);</span>
<span class="fc" id="L1214">        body = REQUEST.Hosts.readBody();</span>
<span class="fc" id="L1215">        body = dbhost.toSpecializedHtml(authentHttp, body, false);</span>
<span class="pc bpc" id="L1216" title="1 of 2 branches missed.">      } else if (&quot;TestConn&quot;.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L1217">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="pc bpc" id="L1218" title="2 of 4 branches missed.">        if (host == null || host.isEmpty()) {</span>
<span class="nc" id="L1219">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1220">          body = Messages.getString(HTTP_SSL_HANDLER_17); //$NON-NLS-1$</span>
<span class="nc" id="L1221">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1222">          return head + body0 + body + body1 + end;</span>
        }
        final DbHostAuth dbhost;
        try {
<span class="fc" id="L1226">          dbhost = new DbHostAuth(host);</span>
<span class="nc" id="L1227">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1228">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1229">          body = Messages.getString(HTTP_SSL_HANDLER_17) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1232">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1233">          return head + body0 + body + body1 + end;</span>
<span class="fc" id="L1234">        }</span>
<span class="fc" id="L1235">        final R66Future result = new R66Future(true);</span>
<span class="fc" id="L1236">        final TestPacket packet = new TestPacket(&quot;MSG&quot;, &quot;CheckConnection&quot;, 100);</span>
<span class="fc" id="L1237">        final Message transaction = new Message(</span>
<span class="fc" id="L1238">            Configuration.configuration.getInternalRunner()</span>
<span class="fc" id="L1239">                                       .getNetworkTransaction(), result, dbhost,</span>
            packet);
<span class="fc" id="L1241">        transaction.run();</span>
<span class="fc" id="L1242">        result.awaitOrInterruptible();</span>
<span class="fc" id="L1243">        head =</span>
<span class="fc" id="L1244">            resetOptionHosts(head, &quot;&quot;, &quot;&quot;, dbhost.isSsl(), dbhost.isActive());</span>
<span class="fc" id="L1245">        body = REQUEST.Hosts.readBody();</span>
<span class="pc bpc" id="L1246" title="1 of 2 branches missed.">        if (result.isSuccess()) {</span>
<span class="fc" id="L1247">          body = dbhost.toSpecializedHtml(authentHttp, body, false);</span>
<span class="fc" id="L1248">          body += Messages.getString(&quot;HttpSslHandler.18&quot;); //$NON-NLS-1$</span>
        } else {
<span class="nc" id="L1250">          body = dbhost.toSpecializedHtml(authentHttp, body, false);</span>
<span class="nc" id="L1251">          body += Messages.getString(&quot;HttpSslHandler.19&quot;)//$NON-NLS-1$</span>
<span class="nc" id="L1252">                  + result.getResult().getCode().getMesg() + B_CENTER_P;</span>
        }
<span class="pc bnc" id="L1254" title="All 2 branches missed.">      } else if (&quot;CloseConn&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L1255">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="nc bnc" id="L1256" title="All 4 branches missed.">        if (host == null || host.isEmpty()) {</span>
<span class="nc" id="L1257">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1258">          body = Messages.getString(HTTP_SSL_HANDLER_17); //$NON-NLS-1$</span>
<span class="nc" id="L1259">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1260">          return head + body0 + body + body1 + end;</span>
        }
        final DbHostAuth dbhost;
        try {
<span class="nc" id="L1264">          dbhost = new DbHostAuth(host);</span>
<span class="nc" id="L1265">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1266">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1267">          body = Messages.getString(HTTP_SSL_HANDLER_17) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1270">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1271">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L1272">        }</span>
<span class="nc" id="L1273">        body = REQUEST.Hosts.readBody();</span>
<span class="nc" id="L1274">        final boolean resultShutDown = NetworkTransaction</span>
<span class="nc" id="L1275">            .shuttingdownNetworkChannelsPerHostID(dbhost.getHostid());</span>
<span class="nc" id="L1276">        head =</span>
<span class="nc" id="L1277">            resetOptionHosts(head, &quot;&quot;, &quot;&quot;, dbhost.isSsl(), dbhost.isActive());</span>
<span class="nc bnc" id="L1278" title="All 2 branches missed.">        if (resultShutDown) {</span>
<span class="nc" id="L1279">          body = dbhost.toSpecializedHtml(authentHttp, body, false);</span>
<span class="nc" id="L1280">          body += Messages.getString(&quot;HttpSslHandler.21&quot;); //$NON-NLS-1$</span>
        } else {
<span class="nc" id="L1282">          body = dbhost.toSpecializedHtml(authentHttp, body, false);</span>
<span class="nc" id="L1283">          body += Messages.getString(&quot;HttpSslHandler.22&quot;); //$NON-NLS-1$</span>
        }
<span class="nc bnc" id="L1285" title="All 2 branches missed.">      } else if (&quot;Delete&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L1286">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="nc bnc" id="L1287" title="All 4 branches missed.">        if (host == null || host.isEmpty()) {</span>
<span class="nc" id="L1288">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1289">          body = Messages.getString(&quot;HttpSslHandler.23&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1290">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1291">          return head + body0 + body + body1 + end;</span>
        }
        final DbHostAuth dbhost;
        try {
<span class="nc" id="L1295">          dbhost = new DbHostAuth(host);</span>
<span class="nc" id="L1296">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1297">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1298">          body = Messages.getString(&quot;HttpSslHandler.24&quot;) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1301">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1302">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L1303">        }</span>
        try {
<span class="nc" id="L1305">          dbhost.delete();</span>
<span class="nc" id="L1306">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1307">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1308">          body = Messages.getString(&quot;HttpSslHandler.24&quot;) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1311">          head =</span>
<span class="nc" id="L1312">              resetOptionHosts(head, &quot;&quot;, &quot;&quot;, dbhost.isSsl(), dbhost.isActive());</span>
<span class="nc" id="L1313">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L1314">        }</span>
<span class="nc" id="L1315">        body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1316">        body = Messages.getString(&quot;HttpSslHandler.25&quot;) + host +</span>
               B_CENTER_P; //$NON-NLS-1$
<span class="nc" id="L1318">        head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, dbhost.isActive());</span>
<span class="nc" id="L1319">        return head + body0 + body + body1 + end;</span>
      } else {
<span class="nc" id="L1321">        head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
      }
<span class="fc" id="L1323">      body1 = REQUEST.Hosts.readBodyEnd();</span>
<span class="fc" id="L1324">    } else {</span>
<span class="nc" id="L1325">      head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
    }
<span class="fc" id="L1327">    return head + body0 + body + body1 + end;</span>
  }

  private void createExport(final String body, final StringBuilder builder,
                            final String rule, final int mode, final int limit,
                            final int start) {
<span class="fc" id="L1333">    DbPreparedStatement preparedStatement = null;</span>
    try {
<span class="fc" id="L1335">      preparedStatement = DbRule.getFilterPrepareStament(dbSession, rule, mode);</span>
<span class="fc" id="L1336">      preparedStatement.executeQuery();</span>
<span class="fc" id="L1337">      int i = 0;</span>
<span class="fc bfc" id="L1338" title="All 2 branches covered.">      while (preparedStatement.getNext()) {</span>
<span class="fc" id="L1339">        final DbRule dbrule = DbRule.getFromStatement(preparedStatement);</span>
<span class="fc" id="L1340">        String temp = dbrule.toSpecializedHtml(authentHttp, body);</span>
<span class="fc" id="L1341">        temp = temp.replace(&quot;XXXRANKXXX&quot;, String.valueOf(start + i));</span>
<span class="fc" id="L1342">        builder.append(temp);</span>
<span class="fc" id="L1343">        i++;</span>
<span class="pc bpc" id="L1344" title="1 of 2 branches missed.">        if (i &gt; limit) {</span>
<span class="nc" id="L1345">          break;</span>
        }
<span class="fc" id="L1347">      }</span>
<span class="fc" id="L1348">      preparedStatement.realClose();</span>
<span class="nc" id="L1349">    } catch (final WaarpDatabaseException e) {</span>
<span class="nc bnc" id="L1350" title="All 2 branches missed.">      if (preparedStatement != null) {</span>
<span class="nc" id="L1351">        preparedStatement.realClose();</span>
      }
<span class="nc" id="L1353">      logger.warn(OPEN_R66_WEB_ERROR, e.getMessage());</span>
<span class="fc" id="L1354">    }</span>
<span class="fc" id="L1355">  }</span>

  String resetOptionRules(final String header, final String rule,
                          final RequestPacket.TRANSFERMODE mode,
                          final int gmode) {
<span class="fc" id="L1360">    final StringBuilder builder = new StringBuilder(header);</span>
<span class="fc" id="L1361">    WaarpStringUtils.replace(builder, &quot;XXXRULEXXX&quot;, rule);</span>
<span class="fc bfc" id="L1362" title="All 2 branches covered.">    if (mode != null) {</span>
<span class="pc bpc" id="L1363" title="7 of 9 branches missed.">      switch (mode) {</span>
        case RECVMODE:
<span class="nc" id="L1365">          WaarpStringUtils.replace(builder, &quot;XXXRECVXXX&quot;, CHECKED);</span>
<span class="nc" id="L1366">          break;</span>
        case SENDMODE:
<span class="fc" id="L1368">          WaarpStringUtils.replace(builder, &quot;XXXSENDXXX&quot;, CHECKED);</span>
<span class="fc" id="L1369">          break;</span>
        case RECVMD5MODE:
<span class="nc" id="L1371">          WaarpStringUtils.replace(builder, &quot;XXXRECVMXXX&quot;, CHECKED);</span>
<span class="nc" id="L1372">          break;</span>
        case SENDMD5MODE:
<span class="fc" id="L1374">          WaarpStringUtils.replace(builder, &quot;XXXSENDMXXX&quot;, CHECKED);</span>
<span class="fc" id="L1375">          break;</span>
        case RECVTHROUGHMODE:
<span class="nc" id="L1377">          WaarpStringUtils.replace(builder, &quot;XXXRECVTXXX&quot;, CHECKED);</span>
<span class="nc" id="L1378">          break;</span>
        case SENDTHROUGHMODE:
<span class="nc" id="L1380">          WaarpStringUtils.replace(builder, &quot;XXXSENDTXXX&quot;, CHECKED);</span>
<span class="nc" id="L1381">          break;</span>
        case RECVMD5THROUGHMODE:
<span class="nc" id="L1383">          WaarpStringUtils.replace(builder, &quot;XXXRECVMTXXX&quot;, CHECKED);</span>
<span class="nc" id="L1384">          break;</span>
        case SENDMD5THROUGHMODE:
<span class="nc" id="L1386">          WaarpStringUtils.replace(builder, &quot;XXXSENDMTXXX&quot;, CHECKED);</span>
<span class="nc" id="L1387">          break;</span>
        default:
          break;
      }
    }
<span class="pc bpc" id="L1392" title="1 of 2 branches missed.">    if (gmode == -1) {// All Recv</span>
<span class="nc" id="L1393">      WaarpStringUtils.replace(builder, &quot;XXXARECVXXX&quot;, CHECKED);</span>
<span class="fc bfc" id="L1394" title="All 2 branches covered.">    } else if (gmode == -2) {// All Send</span>
<span class="fc" id="L1395">      WaarpStringUtils.replace(builder, &quot;XXXASENDXXX&quot;, CHECKED);</span>
<span class="pc bpc" id="L1396" title="1 of 2 branches missed.">    } else if (gmode == -3) {// All</span>
<span class="fc" id="L1397">      WaarpStringUtils.replace(builder, &quot;XXXALLXXX&quot;, CHECKED);</span>
    }
<span class="fc" id="L1399">    return builder.toString();</span>
  }

  private String rules0() {
<span class="fc" id="L1403">    getParams();</span>
<span class="fc" id="L1404">    String head = REQUEST.Rules.readHeader(this);</span>
    final String end;
<span class="fc" id="L1406">    end = REQUEST.Rules.readEnd();</span>
<span class="fc bfc" id="L1407" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L1408">      head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="fc" id="L1409">      return head + end;</span>
    }
    String body0;
    String body;
    String body1;
<span class="fc" id="L1414">    body0 = body1 = body = &quot;&quot;;</span>
<span class="fc" id="L1415">    final List&lt;String&gt; parms = params.get(ACTION);</span>
<span class="pc bpc" id="L1416" title="1 of 2 branches missed.">    if (parms != null) {</span>
<span class="fc" id="L1417">      body0 = REQUEST.Rules.readBodyHeader();</span>
<span class="fc" id="L1418">      final String parm = parms.get(0);</span>
<span class="pc bpc" id="L1419" title="1 of 4 branches missed.">      if (CREATE.equalsIgnoreCase(parm) || &quot;Update&quot;.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L1420">        final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="fc" id="L1421">        final String hostids = getTrimValue(&quot;hostids&quot;);</span>
<span class="fc" id="L1422">        final String recvp = getTrimValue(&quot;recvp&quot;);</span>
<span class="fc" id="L1423">        final String sendp = getTrimValue(&quot;sendp&quot;);</span>
<span class="fc" id="L1424">        final String archp = getTrimValue(&quot;archp&quot;);</span>
<span class="fc" id="L1425">        final String workp = getTrimValue(&quot;workp&quot;);</span>
<span class="fc" id="L1426">        final String rpre = getTrimValue(&quot;rpre&quot;);</span>
<span class="fc" id="L1427">        final String rpost = getTrimValue(&quot;rpost&quot;);</span>
<span class="fc" id="L1428">        final String rerr = getTrimValue(&quot;rerr&quot;);</span>
<span class="fc" id="L1429">        final String spre = getTrimValue(&quot;spre&quot;);</span>
<span class="fc" id="L1430">        final String spost = getTrimValue(&quot;spost&quot;);</span>
<span class="fc" id="L1431">        final String serr = getTrimValue(&quot;serr&quot;);</span>
<span class="fc" id="L1432">        final String mode = getTrimValue(&quot;mode&quot;);</span>
<span class="pc bpc" id="L1433" title="2 of 4 branches missed.">        if (rule == null || mode == null) {</span>
<span class="nc" id="L1434">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1435">          body = Messages.getString(&quot;HttpSslHandler.26&quot;) + parm + Messages</span>
<span class="nc" id="L1436">              .getString(&quot;HttpSslHandler.27&quot;); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L1437">          head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1438">          return head + body0 + body + body1 + end;</span>
        }
<span class="fc" id="L1440">        int gmode = 0;</span>

<span class="fc" id="L1442">        TRANSFERMODE tmode = null;</span>
<span class="pc bpc" id="L1443" title="1 of 2 branches missed.">        if (&quot;send&quot;.equals(mode)) {</span>
<span class="nc" id="L1444">          tmode = RequestPacket.TRANSFERMODE.SENDMODE;</span>
<span class="nc" id="L1445">          gmode = -2;</span>
<span class="pc bpc" id="L1446" title="1 of 2 branches missed.">        } else if (&quot;recv&quot;.equals(mode)) {</span>
<span class="nc" id="L1447">          tmode = RequestPacket.TRANSFERMODE.RECVMODE;</span>
<span class="nc" id="L1448">          gmode = -1;</span>
<span class="pc bpc" id="L1449" title="1 of 2 branches missed.">        } else if (&quot;sendmd5&quot;.equals(mode)) {</span>
<span class="fc" id="L1450">          tmode = RequestPacket.TRANSFERMODE.SENDMD5MODE;</span>
<span class="fc" id="L1451">          gmode = -2;</span>
<span class="nc bnc" id="L1452" title="All 2 branches missed.">        } else if (&quot;recvmd5&quot;.equals(mode)) {</span>
<span class="nc" id="L1453">          tmode = RequestPacket.TRANSFERMODE.RECVMD5MODE;</span>
<span class="nc" id="L1454">          gmode = -1;</span>
<span class="nc bnc" id="L1455" title="All 2 branches missed.">        } else if (&quot;sendth&quot;.equals(mode)) {</span>
<span class="nc" id="L1456">          tmode = RequestPacket.TRANSFERMODE.SENDTHROUGHMODE;</span>
<span class="nc" id="L1457">          gmode = -2;</span>
<span class="nc bnc" id="L1458" title="All 2 branches missed.">        } else if (&quot;recvth&quot;.equals(mode)) {</span>
<span class="nc" id="L1459">          tmode = RequestPacket.TRANSFERMODE.RECVTHROUGHMODE;</span>
<span class="nc" id="L1460">          gmode = -1;</span>
<span class="nc bnc" id="L1461" title="All 2 branches missed.">        } else if (&quot;sendthmd5&quot;.equals(mode)) {</span>
<span class="nc" id="L1462">          tmode = RequestPacket.TRANSFERMODE.SENDMD5THROUGHMODE;</span>
<span class="nc" id="L1463">          gmode = -2;</span>
<span class="nc bnc" id="L1464" title="All 2 branches missed.">        } else if (&quot;recvthmd5&quot;.equals(mode)) {</span>
<span class="nc" id="L1465">          tmode = RequestPacket.TRANSFERMODE.RECVMD5THROUGHMODE;</span>
<span class="nc" id="L1466">          gmode = -1;</span>
        }
<span class="fc" id="L1468">        head = resetOptionRules(head, rule, tmode, gmode);</span>
<span class="pc bpc" id="L1469" title="1 of 2 branches missed.">        if (logger.isDebugEnabled()) {</span>
<span class="nc bnc" id="L1470" title="All 2 branches missed.">          logger.debug(&quot;Recv UpdOrInsert: &quot; + rule + ':' + hostids + ':' +</span>
<span class="nc" id="L1471">                       (tmode != null? tmode.ordinal() : 0) + ':' + recvp +</span>
                       ':' + sendp + ':' + archp + ':' + workp + ':' + rpre +
                       ':' + rpost + ':' + rerr + ':' + spre + ':' + spost +
                       ':' + serr);
        }
<span class="pc bpc" id="L1476" title="1 of 2 branches missed.">        final DbRule dbrule =</span>
<span class="pc" id="L1477">            new DbRule(rule, hostids, (tmode != null? tmode.ordinal() : 0),</span>
                       recvp, sendp, archp, workp, rpre, rpost, rerr, spre,
                       spost, serr);
        try {
<span class="pc bpc" id="L1481" title="1 of 2 branches missed.">          if (CREATE.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L1482">            dbrule.insert();</span>
          } else {
<span class="pc bpc" id="L1484" title="1 of 2 branches missed.">            if (dbrule.exist()) {</span>
<span class="fc" id="L1485">              dbrule.update();</span>
            } else {
<span class="nc" id="L1487">              dbrule.insert();</span>
            }
          }
<span class="nc" id="L1490">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1491">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1492">          body = Messages.getString(&quot;HttpSslHandler.28&quot;) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1495">          head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1496">          return head + body0 + body + body1 + end;</span>
<span class="fc" id="L1497">        }</span>
<span class="fc" id="L1498">        body = REQUEST.Rules.readBody();</span>
<span class="fc" id="L1499">        body = dbrule.toSpecializedHtml(authentHttp, body);</span>
<span class="pc bpc" id="L1500" title="1 of 2 branches missed.">      } else if (FILTER.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L1501">        final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="fc" id="L1502">        final String mode = getTrimValue(&quot;mode&quot;);</span>
        TRANSFERMODE tmode;
<span class="fc" id="L1504">        int gmode = 0;</span>
<span class="pc bpc" id="L1505" title="1 of 2 branches missed.">        if (&quot;all&quot;.equals(mode)) {</span>
<span class="fc" id="L1506">          gmode = -3;</span>
<span class="nc bnc" id="L1507" title="All 2 branches missed.">        } else if (&quot;send&quot;.equals(mode)) {</span>
<span class="nc" id="L1508">          gmode = -2;</span>
<span class="nc bnc" id="L1509" title="All 2 branches missed.">        } else if (&quot;recv&quot;.equals(mode)) {</span>
<span class="nc" id="L1510">          gmode = -1;</span>
        }
<span class="pc bpc" id="L1512" title="1 of 2 branches missed.">        head = resetOptionRules(head, rule == null? &quot;&quot; : rule, null, gmode);</span>
<span class="fc" id="L1513">        body = REQUEST.Rules.readBody();</span>
<span class="fc" id="L1514">        final StringBuilder builder = new StringBuilder();</span>
<span class="fc" id="L1515">        boolean specific = false;</span>
<span class="fc" id="L1516">        int start = 1;</span>
<span class="pc bpc" id="L1517" title="1 of 2 branches missed.">        if (params.containsKey(&quot;send&quot;)) {</span>
<span class="nc" id="L1518">          tmode = RequestPacket.TRANSFERMODE.SENDMODE;</span>
<span class="nc bnc" id="L1519" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1520">          specific = true;</span>
<span class="nc" id="L1521">          createExport(body, builder, rule,</span>
<span class="nc" id="L1522">                       RequestPacket.TRANSFERMODE.SENDMODE.ordinal(),</span>
<span class="nc" id="L1523">                       getLimitRow() / 4, start);</span>
<span class="nc" id="L1524">          start += getLimitRow() / 4 + 1;</span>
        }
<span class="pc bpc" id="L1526" title="1 of 2 branches missed.">        if (params.containsKey(&quot;recv&quot;)) {</span>
<span class="nc" id="L1527">          tmode = RequestPacket.TRANSFERMODE.RECVMODE;</span>
<span class="nc bnc" id="L1528" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1529">          specific = true;</span>
<span class="nc" id="L1530">          createExport(body, builder, rule,</span>
<span class="nc" id="L1531">                       RequestPacket.TRANSFERMODE.RECVMODE.ordinal(),</span>
<span class="nc" id="L1532">                       getLimitRow() / 4, start);</span>
<span class="nc" id="L1533">          start += getLimitRow() / 4 + 1;</span>
        }
<span class="pc bpc" id="L1535" title="1 of 2 branches missed.">        if (params.containsKey(&quot;sendmd5&quot;)) {</span>
<span class="nc" id="L1536">          tmode = RequestPacket.TRANSFERMODE.SENDMD5MODE;</span>
<span class="nc bnc" id="L1537" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1538">          specific = true;</span>
<span class="nc" id="L1539">          createExport(body, builder, rule,</span>
<span class="nc" id="L1540">                       RequestPacket.TRANSFERMODE.SENDMD5MODE.ordinal(),</span>
<span class="nc" id="L1541">                       getLimitRow() / 4, start);</span>
<span class="nc" id="L1542">          start += getLimitRow() / 4 + 1;</span>
        }
<span class="pc bpc" id="L1544" title="1 of 2 branches missed.">        if (params.containsKey(&quot;recvmd5&quot;)) {</span>
<span class="nc" id="L1545">          tmode = RequestPacket.TRANSFERMODE.RECVMD5MODE;</span>
<span class="nc bnc" id="L1546" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1547">          specific = true;</span>
<span class="nc" id="L1548">          createExport(body, builder, rule,</span>
<span class="nc" id="L1549">                       RequestPacket.TRANSFERMODE.RECVMD5MODE.ordinal(),</span>
<span class="nc" id="L1550">                       getLimitRow() / 4, start);</span>
<span class="nc" id="L1551">          start += getLimitRow() / 4 + 1;</span>
        }
<span class="pc bpc" id="L1553" title="1 of 2 branches missed.">        if (params.containsKey(&quot;sendth&quot;)) {</span>
<span class="nc" id="L1554">          tmode = RequestPacket.TRANSFERMODE.SENDTHROUGHMODE;</span>
<span class="nc bnc" id="L1555" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1556">          specific = true;</span>
<span class="nc" id="L1557">          createExport(body, builder, rule,</span>
<span class="nc" id="L1558">                       RequestPacket.TRANSFERMODE.SENDTHROUGHMODE.ordinal(),</span>
<span class="nc" id="L1559">                       getLimitRow() / 4, start);</span>
<span class="nc" id="L1560">          start += getLimitRow() / 4 + 1;</span>
        }
<span class="pc bpc" id="L1562" title="1 of 2 branches missed.">        if (params.containsKey(&quot;recvth&quot;)) {</span>
<span class="nc" id="L1563">          tmode = RequestPacket.TRANSFERMODE.RECVTHROUGHMODE;</span>
<span class="nc bnc" id="L1564" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1565">          specific = true;</span>
<span class="nc" id="L1566">          createExport(body, builder, rule,</span>
<span class="nc" id="L1567">                       RequestPacket.TRANSFERMODE.RECVTHROUGHMODE.ordinal(),</span>
<span class="nc" id="L1568">                       getLimitRow() / 4, start);</span>
<span class="nc" id="L1569">          start += getLimitRow() / 4 + 1;</span>
        }
<span class="pc bpc" id="L1571" title="1 of 2 branches missed.">        if (params.containsKey(&quot;sendthmd5&quot;)) {</span>
<span class="nc" id="L1572">          tmode = RequestPacket.TRANSFERMODE.SENDMD5THROUGHMODE;</span>
<span class="nc bnc" id="L1573" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1574">          specific = true;</span>
<span class="nc" id="L1575">          createExport(body, builder, rule,</span>
<span class="nc" id="L1576">                       RequestPacket.TRANSFERMODE.SENDMD5THROUGHMODE.ordinal(),</span>
<span class="nc" id="L1577">                       getLimitRow() / 4, start);</span>
<span class="nc" id="L1578">          start += getLimitRow() / 4 + 1;</span>
        }
<span class="pc bpc" id="L1580" title="1 of 2 branches missed.">        if (params.containsKey(&quot;recvthmd5&quot;)) {</span>
<span class="nc" id="L1581">          tmode = RequestPacket.TRANSFERMODE.RECVMD5THROUGHMODE;</span>
<span class="nc bnc" id="L1582" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1583">          specific = true;</span>
<span class="nc" id="L1584">          createExport(body, builder, rule,</span>
<span class="nc" id="L1585">                       RequestPacket.TRANSFERMODE.RECVMD5THROUGHMODE.ordinal(),</span>
<span class="nc" id="L1586">                       getLimitRow() / 4, start);</span>
<span class="nc" id="L1587">          start += getLimitRow() / 4 + 1;</span>
        }
<span class="pc bpc" id="L1589" title="1 of 2 branches missed.">        if (!specific) {</span>
<span class="pc bpc" id="L1590" title="1 of 2 branches missed.">          if (gmode == -1) {</span>
            // recv
<span class="nc" id="L1592">            createExport(body, builder, rule,</span>
<span class="nc" id="L1593">                         RequestPacket.TRANSFERMODE.RECVMODE.ordinal(),</span>
<span class="nc" id="L1594">                         getLimitRow() / 4, start);</span>
<span class="nc" id="L1595">            start += getLimitRow() / 4 + 1;</span>
<span class="nc" id="L1596">            createExport(body, builder, rule,</span>
<span class="nc" id="L1597">                         RequestPacket.TRANSFERMODE.RECVMD5MODE.ordinal(),</span>
<span class="nc" id="L1598">                         getLimitRow() / 4, start);</span>
<span class="nc" id="L1599">            start += getLimitRow() / 4 + 1;</span>
<span class="nc" id="L1600">            createExport(body, builder, rule,</span>
<span class="nc" id="L1601">                         RequestPacket.TRANSFERMODE.RECVTHROUGHMODE.ordinal(),</span>
<span class="nc" id="L1602">                         getLimitRow() / 4, start);</span>
<span class="nc" id="L1603">            start += getLimitRow() / 4 + 1;</span>
<span class="nc" id="L1604">            createExport(body, builder, rule,</span>
                         RequestPacket.TRANSFERMODE.RECVMD5THROUGHMODE
<span class="nc" id="L1606">                             .ordinal(), getLimitRow() / 4, start);</span>
<span class="nc" id="L1607">            start += getLimitRow() / 4 + 1;</span>
<span class="pc bpc" id="L1608" title="1 of 2 branches missed.">          } else if (gmode == -2) {</span>
            // send
<span class="nc" id="L1610">            createExport(body, builder, rule,</span>
<span class="nc" id="L1611">                         RequestPacket.TRANSFERMODE.SENDMODE.ordinal(),</span>
<span class="nc" id="L1612">                         getLimitRow() / 4, start);</span>
<span class="nc" id="L1613">            start += getLimitRow() / 4 + 1;</span>
<span class="nc" id="L1614">            createExport(body, builder, rule,</span>
<span class="nc" id="L1615">                         RequestPacket.TRANSFERMODE.SENDMD5MODE.ordinal(),</span>
<span class="nc" id="L1616">                         getLimitRow() / 4, start);</span>
<span class="nc" id="L1617">            start += getLimitRow() / 4 + 1;</span>
<span class="nc" id="L1618">            createExport(body, builder, rule,</span>
<span class="nc" id="L1619">                         RequestPacket.TRANSFERMODE.SENDTHROUGHMODE.ordinal(),</span>
<span class="nc" id="L1620">                         getLimitRow() / 4, start);</span>
<span class="nc" id="L1621">            start += getLimitRow() / 4 + 1;</span>
<span class="nc" id="L1622">            createExport(body, builder, rule,</span>
                         RequestPacket.TRANSFERMODE.SENDMD5THROUGHMODE
<span class="nc" id="L1624">                             .ordinal(), getLimitRow() / 4, start);</span>
<span class="nc" id="L1625">            start += getLimitRow() / 4 + 1;</span>
          } else {
            // all
<span class="fc" id="L1628">            createExport(body, builder, rule, -1, getLimitRow(), start);</span>
<span class="fc" id="L1629">            start += getLimitRow() + 1;</span>
          }
        }
<span class="fc" id="L1632">        body = builder.toString();</span>
<span class="fc" id="L1633">        body1 = REQUEST.Rules.readBodyEnd();</span>
<span class="pc bnc" id="L1634" title="All 2 branches missed.">      } else if (&quot;Delete&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L1635">        final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="nc bnc" id="L1636" title="All 4 branches missed.">        if (rule == null || rule.isEmpty()) {</span>
<span class="nc" id="L1637">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1638">          body = Messages.getString(&quot;HttpSslHandler.29&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1639">          head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1640">          return head + body0 + body + body1 + end;</span>
        }
        final DbRule dbrule;
        try {
<span class="nc" id="L1644">          dbrule = new DbRule(rule);</span>
<span class="nc" id="L1645">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1646">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1647">          body = Messages.getString(&quot;HttpSslHandler.30&quot;) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1650">          head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1651">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L1652">        }</span>
        try {
<span class="nc" id="L1654">          dbrule.delete();</span>
<span class="nc" id="L1655">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1656">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1657">          body = Messages.getString(&quot;HttpSslHandler.30&quot;) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1660">          head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1661">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L1662">        }</span>
<span class="nc" id="L1663">        body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1664">        body = Messages.getString(&quot;HttpSslHandler.31&quot;) + rule +</span>
               B_CENTER_P; //$NON-NLS-1$
<span class="nc" id="L1666">        head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1667">        return head + body0 + body + body1 + end;</span>
      } else {
<span class="nc" id="L1669">        head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
      }
<span class="fc" id="L1671">      body1 = REQUEST.Rules.readBodyEnd();</span>
<span class="fc" id="L1672">    } else {</span>
<span class="nc" id="L1673">      head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
    }
<span class="fc" id="L1675">    return head + body0 + body + body1 + end;</span>
  }

  private String spooled0(final boolean detailed) {
    // XXXSPOOLEDXXX
<span class="fc" id="L1680">    final String spooled = REQUEST.Spooled.readFileUnique(this);</span>
    String uri;
<span class="pc bpc" id="L1682" title="1 of 2 branches missed.">    if (detailed) {</span>
<span class="nc" id="L1683">      uri = &quot;SpooledDetailed.html&quot;;</span>
    } else {
<span class="fc" id="L1685">      uri = &quot;Spooled.html&quot;;</span>
    }
<span class="fc" id="L1687">    final QueryStringDecoder queryStringDecoder =</span>
<span class="fc" id="L1688">        new QueryStringDecoder(request.uri());</span>
<span class="fc" id="L1689">    params = queryStringDecoder.parameters();</span>
<span class="fc" id="L1690">    String name = null;</span>
<span class="pc bpc" id="L1691" title="2 of 4 branches missed.">    if (params != null &amp;&amp; params.containsKey(&quot;name&quot;)) {</span>
<span class="nc" id="L1692">      name = getTrimValue(&quot;name&quot;);</span>
    }
<span class="fc" id="L1694">    int istatus = 0;</span>
<span class="pc bpc" id="L1695" title="2 of 4 branches missed.">    if (params != null &amp;&amp; params.containsKey(&quot;status&quot;)) {</span>
<span class="nc" id="L1696">      final String status = getTrimValue(&quot;status&quot;);</span>
      try {
<span class="nc" id="L1698">        istatus = Integer.parseInt(status);</span>
<span class="nc" id="L1699">      } catch (final NumberFormatException e1) {</span>
<span class="nc" id="L1700">        istatus = 0;</span>
<span class="nc" id="L1701">      }</span>
    }
<span class="pc bpc" id="L1703" title="3 of 4 branches missed.">    if (name != null &amp;&amp; !name.isEmpty()) {</span>
      // name is specified
<span class="nc" id="L1705">      uri = request.uri();</span>
<span class="nc bnc" id="L1706" title="All 2 branches missed.">      if (istatus != 0) {</span>
<span class="nc" id="L1707">        uri += &quot;&amp;status=&quot; + istatus;</span>
      }
<span class="nc" id="L1709">      final StringBuilder builder =</span>
<span class="nc" id="L1710">          SpooledInformTask.buildSpooledUniqueTable(uri, name);</span>
<span class="nc" id="L1711">      return spooled.replace(&quot;XXXSPOOLEDXXX&quot;, builder.toString());</span>
    } else {
<span class="pc bpc" id="L1713" title="1 of 2 branches missed.">      if (istatus != 0) {</span>
<span class="nc" id="L1714">        uri += &quot;&amp;status=&quot; + istatus;</span>
      }
<span class="fc" id="L1716">      final StringBuilder builder =</span>
<span class="fc" id="L1717">          SpooledInformTask.buildSpooledTable(detailed, istatus, uri);</span>
<span class="fc" id="L1718">      return spooled.replace(&quot;XXXSPOOLEDXXX&quot;, builder.toString());</span>
    }
  }

  /**
   * Applied current lang to system page
   *
   * @param builder
   */
  protected void langHandle(final StringBuilder builder) {
    // i18n: add here any new languages
<span class="fc" id="L1729">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXCURLANGENXXX.name(),</span>
<span class="fc bfc" id="L1730" title="All 2 branches covered.">                             &quot;en&quot;.equalsIgnoreCase(lang)? CHECKED : &quot;&quot;);</span>
<span class="fc" id="L1731">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXCURLANGFRXXX.name(),</span>
<span class="fc bfc" id="L1732" title="All 2 branches covered.">                             &quot;fr&quot;.equalsIgnoreCase(lang)? CHECKED : &quot;&quot;);</span>
<span class="fc" id="L1733">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXCURSYSLANGENXXX.name(),</span>
<span class="fc bfc" id="L1734" title="All 2 branches covered.">                             &quot;en&quot;.equalsIgnoreCase(Messages.getSlocale())?</span>
                                 CHECKED : &quot;&quot;);
<span class="fc" id="L1736">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXCURSYSLANGFRXXX.name(),</span>
<span class="fc bfc" id="L1737" title="All 2 branches covered.">                             &quot;fr&quot;.equalsIgnoreCase(Messages.getSlocale())?</span>
                                 CHECKED : &quot;&quot;);
<span class="fc" id="L1739">  }</span>

  private String systemLimitedSource0() {
<span class="fc" id="L1742">    final String system = REQUEST.SystemLimited.readFileUnique(this);</span>
<span class="pc bpc" id="L1743" title="2 of 4 branches missed.">    if (system == null || system.isEmpty()) {</span>
<span class="nc" id="L1744">      return REQUEST.System.readFileUnique(this);</span>
    }
<span class="fc" id="L1746">    return system;</span>
  }

  String systemLimited() {
<span class="fc" id="L1750">    getParams();</span>
    DbHostConfiguration config;
    try {
<span class="fc" id="L1753">      config = new DbHostConfiguration(Configuration.configuration.getHostId());</span>
<span class="nc" id="L1754">    } catch (final WaarpDatabaseException e2) {</span>
<span class="nc" id="L1755">      config =</span>
<span class="nc" id="L1756">          new DbHostConfiguration(Configuration.configuration.getHostId(), &quot;&quot;,</span>
                                  &quot;&quot;, &quot;&quot;, &quot;&quot;);
      try {
<span class="nc" id="L1759">        config.insert();</span>
<span class="nc" id="L1760">      } catch (final WaarpDatabaseException ignored) {</span>
        // nothing
<span class="nc" id="L1762">      }</span>
<span class="fc" id="L1763">    }</span>
<span class="fc bfc" id="L1764" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L1765">      final String system = systemLimitedSource0();</span>
<span class="fc" id="L1766">      final StringBuilder builder = new StringBuilder(system);</span>
<span class="fc" id="L1767">      replaceStringSystem(config, builder);</span>
<span class="fc" id="L1768">      langHandle(builder);</span>
<span class="fc" id="L1769">      return builder.toString();</span>
    }
<span class="fc" id="L1771">    String extraInformation = null;</span>
<span class="pc bpc" id="L1772" title="1 of 2 branches missed.">    if (params.containsKey(ACTION)) {</span>
<span class="fc" id="L1773">      final List&lt;String&gt; action = params.get(ACTION);</span>
<span class="fc bfc" id="L1774" title="All 2 branches covered.">      for (final String act : action) {</span>
<span class="pc bpc" id="L1775" title="1 of 2 branches missed.">        if (&quot;Language&quot;.equalsIgnoreCase(act)) {</span>
<span class="nc" id="L1776">          lang = getTrimValue(&quot;change&quot;);</span>
<span class="nc" id="L1777">          extraInformation =</span>
<span class="nc" id="L1778">              Messages.getString(HTTP_SSL_HANDLER_LANG_IS) + &quot;Web: &quot; + lang +</span>
              &quot; OpenR66: &quot; //$NON-NLS-1$
<span class="nc" id="L1780">              + Messages.getSlocale();</span>
<span class="pc bpc" id="L1781" title="1 of 2 branches missed.">        } else if (&quot;Disconnect&quot;.equalsIgnoreCase(act)) {</span>
<span class="nc" id="L1782">          String logon = logon();</span>
<span class="nc" id="L1783">          logon = logon.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(),</span>
                                   Messages
<span class="nc" id="L1785">                                       .getString(&quot;HttpSslHandler.DisActive&quot;));</span>
<span class="nc" id="L1786">          newSession = true;</span>
<span class="nc" id="L1787">          clearSession();</span>
<span class="nc" id="L1788">          forceClose = true;</span>
<span class="nc" id="L1789">          return logon;</span>
        }
<span class="fc" id="L1791">      }</span>
    }
<span class="fc" id="L1793">    final String system = systemLimitedSource0();</span>
<span class="fc" id="L1794">    final StringBuilder builder = new StringBuilder(system);</span>
<span class="fc" id="L1795">    replaceStringSystem(config, builder);</span>
<span class="fc" id="L1796">    langHandle(builder);</span>
<span class="pc bpc" id="L1797" title="1 of 2 branches missed.">    if (extraInformation != null) {</span>
<span class="nc" id="L1798">      builder.append(extraInformation);</span>
    }
<span class="fc" id="L1800">    return builder.toString();</span>
  }

  /**
   * @param config
   * @param builder
   */
  void replaceStringSystem(final DbHostConfiguration config,
                           final StringBuilder builder) {
<span class="fc" id="L1809">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXXBUSINESSXXX.toString(),</span>
<span class="fc" id="L1810">                             config.getBusiness());</span>
<span class="fc" id="L1811">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXXROLESXXX.toString(),</span>
<span class="fc" id="L1812">                             config.getRoles());</span>
<span class="fc" id="L1813">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXXALIASESXXX.toString(),</span>
<span class="fc" id="L1814">                             config.getAliases());</span>
<span class="fc" id="L1815">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXXOTHERXXX.toString(),</span>
<span class="fc" id="L1816">                             config.getOthers());</span>
<span class="fc" id="L1817">    WaarpStringUtils</span>
<span class="fc" id="L1818">        .replace(builder, REPLACEMENT.XXXXSESSIONLIMITWXXX.toString(),</span>
<span class="fc" id="L1819">                 Long.toString(</span>
<span class="fc" id="L1820">                     Configuration.configuration.getServerChannelWriteLimit()));</span>
<span class="fc" id="L1821">    WaarpStringUtils</span>
<span class="fc" id="L1822">        .replace(builder, REPLACEMENT.XXXXSESSIONLIMITRXXX.toString(),</span>
<span class="fc" id="L1823">                 Long.toString(</span>
<span class="fc" id="L1824">                     Configuration.configuration.getServerChannelReadLimit()));</span>
<span class="fc" id="L1825">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXXDELATRAFFICXXX.toString(),</span>
<span class="fc" id="L1826">                             Long.toString(</span>
<span class="fc" id="L1827">                                 Configuration.configuration.getDelayLimit()));</span>
<span class="fc" id="L1828">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXXDELAYCOMMDXXX.toString(),</span>
<span class="fc" id="L1829">                             Long.toString(Configuration.configuration</span>
<span class="fc" id="L1830">                                               .getDelayCommander()));</span>
<span class="fc" id="L1831">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXXDELAYRETRYXXX.toString(),</span>
<span class="fc" id="L1832">                             Long.toString(</span>
<span class="fc" id="L1833">                                 Configuration.configuration.getDelayRetry()));</span>
<span class="fc" id="L1834">    WaarpStringUtils</span>
<span class="fc" id="L1835">        .replace(builder, REPLACEMENT.XXXXCHANNELLIMITWXXX.toString(),</span>
<span class="fc" id="L1836">                 Long.toString(</span>
<span class="fc" id="L1837">                     Configuration.configuration.getServerGlobalWriteLimit()));</span>
<span class="fc" id="L1838">    WaarpStringUtils</span>
<span class="fc" id="L1839">        .replace(builder, REPLACEMENT.XXXXCHANNELLIMITRXXX.toString(),</span>
<span class="fc" id="L1840">                 Long.toString(</span>
<span class="fc" id="L1841">                     Configuration.configuration.getServerGlobalReadLimit()));</span>
<span class="fc" id="L1842">    WaarpStringUtils.replace(builder, &quot;XXXBLOCKXXX&quot;,</span>
<span class="fc bfc" id="L1843" title="All 2 branches covered.">                             Configuration.configuration.isShutdown()? CHECKED :</span>
                                 &quot;&quot;);
<span class="pc bpc" id="L1845" title="3 of 5 branches missed.">    switch (WaarpLoggerFactory.getLogLevel()) {</span>
      case DEBUG:
<span class="fc" id="L1847">        WaarpStringUtils.replace(builder, XXXLEVEL1XXX, CHECKED);</span>
<span class="fc" id="L1848">        WaarpStringUtils.replace(builder, XXXLEVEL2XXX, &quot;&quot;);</span>
<span class="fc" id="L1849">        WaarpStringUtils.replace(builder, XXXLEVEL3XXX, &quot;&quot;);</span>
<span class="fc" id="L1850">        WaarpStringUtils.replace(builder, XXXLEVEL4XXX, &quot;&quot;);</span>
<span class="fc" id="L1851">        break;</span>
      case INFO:
<span class="nc" id="L1853">        WaarpStringUtils.replace(builder, XXXLEVEL1XXX, &quot;&quot;);</span>
<span class="nc" id="L1854">        WaarpStringUtils.replace(builder, XXXLEVEL2XXX, CHECKED);</span>
<span class="nc" id="L1855">        WaarpStringUtils.replace(builder, XXXLEVEL3XXX, &quot;&quot;);</span>
<span class="nc" id="L1856">        WaarpStringUtils.replace(builder, XXXLEVEL4XXX, &quot;&quot;);</span>
<span class="nc" id="L1857">        break;</span>
      case WARN:
<span class="fc" id="L1859">        WaarpStringUtils.replace(builder, XXXLEVEL1XXX, &quot;&quot;);</span>
<span class="fc" id="L1860">        WaarpStringUtils.replace(builder, XXXLEVEL2XXX, &quot;&quot;);</span>
<span class="fc" id="L1861">        WaarpStringUtils.replace(builder, XXXLEVEL3XXX, CHECKED);</span>
<span class="fc" id="L1862">        WaarpStringUtils.replace(builder, XXXLEVEL4XXX, &quot;&quot;);</span>
<span class="fc" id="L1863">        break;</span>
      case ERROR:
<span class="nc" id="L1865">        WaarpStringUtils.replace(builder, XXXLEVEL1XXX, &quot;&quot;);</span>
<span class="nc" id="L1866">        WaarpStringUtils.replace(builder, XXXLEVEL2XXX, &quot;&quot;);</span>
<span class="nc" id="L1867">        WaarpStringUtils.replace(builder, XXXLEVEL3XXX, &quot;&quot;);</span>
<span class="nc" id="L1868">        WaarpStringUtils.replace(builder, XXXLEVEL4XXX, CHECKED);</span>
<span class="nc" id="L1869">        break;</span>
      default:
<span class="nc" id="L1871">        WaarpStringUtils.replace(builder, XXXLEVEL1XXX, &quot;&quot;);</span>
<span class="nc" id="L1872">        WaarpStringUtils.replace(builder, XXXLEVEL2XXX, &quot;&quot;);</span>
<span class="nc" id="L1873">        WaarpStringUtils.replace(builder, XXXLEVEL3XXX, &quot;&quot;);</span>
<span class="nc" id="L1874">        WaarpStringUtils.replace(builder, XXXLEVEL4XXX, &quot;&quot;);</span>
        break;

    }
<span class="fc" id="L1878">  }</span>

  String logout() {
<span class="fc" id="L1881">    String logon = logon();</span>
<span class="fc" id="L1882">    logon = logon.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(),</span>
<span class="fc" id="L1883">                             Messages.getString(&quot;HttpSslHandler.Disconnected&quot;));</span>
<span class="fc" id="L1884">    newSession = true;</span>
<span class="fc" id="L1885">    clearSession();</span>
<span class="fc" id="L1886">    forceClose = true;</span>
<span class="fc" id="L1887">    return logon;</span>
  }

  private String system0() {
<span class="fc" id="L1891">    getParams();</span>
    DbHostConfiguration config;
    try {
<span class="fc" id="L1894">      config = new DbHostConfiguration(Configuration.configuration.getHostId());</span>
<span class="nc" id="L1895">    } catch (final WaarpDatabaseException e2) {</span>
<span class="nc" id="L1896">      config =</span>
<span class="nc" id="L1897">          new DbHostConfiguration(Configuration.configuration.getHostId(), &quot;&quot;,</span>
                                  &quot;&quot;, &quot;&quot;, &quot;&quot;);
      try {
<span class="nc" id="L1900">        config.insert();</span>
<span class="nc" id="L1901">      } catch (final WaarpDatabaseException ignored) {</span>
        // nothing
<span class="nc" id="L1903">      }</span>
<span class="fc" id="L1904">    }</span>
<span class="fc bfc" id="L1905" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L1906">      final String system = REQUEST.System.readFileUnique(this);</span>
<span class="fc" id="L1907">      final StringBuilder builder = new StringBuilder(system);</span>
<span class="fc" id="L1908">      replaceStringSystem(config, builder);</span>
<span class="fc" id="L1909">      langHandle(builder);</span>
<span class="fc" id="L1910">      return builder.toString();</span>
    }
<span class="fc" id="L1912">    String extraInformation = null;</span>
<span class="pc bpc" id="L1913" title="1 of 2 branches missed.">    if (params.containsKey(ACTION)) {</span>
<span class="fc" id="L1914">      final List&lt;String&gt; action = params.get(ACTION);</span>
<span class="fc bfc" id="L1915" title="All 2 branches covered.">      for (final String act : action) {</span>
<span class="fc bfc" id="L1916" title="All 2 branches covered.">        if (&quot;Language&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L1917">          lang = getTrimValue(&quot;change&quot;);</span>
<span class="fc" id="L1918">          final String sys = getTrimValue(&quot;changesys&quot;);</span>
<span class="fc" id="L1919">          Messages.init(new Locale(sys));</span>
<span class="fc" id="L1920">          extraInformation =</span>
<span class="fc" id="L1921">              Messages.getString(HTTP_SSL_HANDLER_LANG_IS) + &quot;Web: &quot; + lang +</span>
              &quot; OpenR66: &quot; //$NON-NLS-1$
<span class="fc" id="L1923">              + Messages.getSlocale();</span>
<span class="fc bfc" id="L1924" title="All 2 branches covered.">        } else if (&quot;Level&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L1925">          final String loglevel = getTrimValue(&quot;loglevel&quot;);</span>
<span class="fc" id="L1926">          WaarpLogLevel level = WaarpLogLevel.WARN;</span>
<span class="fc bfc" id="L1927" title="All 2 branches covered.">          if (&quot;debug&quot;.equalsIgnoreCase(loglevel)) {</span>
<span class="fc" id="L1928">            level = WaarpLogLevel.DEBUG;</span>
<span class="pc bpc" id="L1929" title="1 of 2 branches missed.">          } else if (&quot;info&quot;.equalsIgnoreCase(loglevel)) {</span>
<span class="nc" id="L1930">            level = WaarpLogLevel.INFO;</span>
<span class="pc bpc" id="L1931" title="1 of 2 branches missed.">          } else if (&quot;warn&quot;.equalsIgnoreCase(loglevel)) {</span>
<span class="fc" id="L1932">            level = WaarpLogLevel.WARN;</span>
<span class="nc bnc" id="L1933" title="All 2 branches missed.">          } else if (ERROR2.equalsIgnoreCase(loglevel)) {</span>
<span class="nc" id="L1934">            level = WaarpLogLevel.ERROR;</span>
          }
<span class="fc" id="L1936">          WaarpLoggerFactory.setLogLevel(level);</span>
<span class="fc" id="L1937">          extraInformation = Messages.getString(HTTP_SSL_HANDLER_LANG_IS) +</span>
<span class="fc" id="L1938">                             level.name(); //$NON-NLS-1$</span>
<span class="fc bfc" id="L1939" title="All 2 branches covered.">        } else if (&quot;ExportConfig&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L1940">          final String directory =</span>
<span class="fc" id="L1941">              Configuration.configuration.getBaseDirectory() +</span>
              DirInterface.SEPARATOR +
<span class="fc" id="L1943">              Configuration.configuration.getArchivePath();</span>
<span class="fc" id="L1944">          extraInformation =</span>
<span class="fc" id="L1945">              Messages.getString(&quot;HttpSslHandler.ExportDir&quot;) + directory +</span>
              &quot;&lt;br&gt;&quot;; //$NON-NLS-1$
<span class="fc" id="L1947">          final String[] filenames = ServerActions</span>
<span class="fc" id="L1948">              .staticConfigExport(directory, true, true, true, true, true);</span>
          // hosts, rules, business, alias, roles
<span class="pc bpc" id="L1950" title="1 of 2 branches missed.">          if (filenames[0] != null) {</span>
<span class="fc" id="L1951">            extraInformation +=</span>
<span class="fc" id="L1952">                Messages.getString(&quot;HttpSslHandler.33&quot;); //$NON-NLS-1$</span>
          }
<span class="pc bpc" id="L1954" title="1 of 2 branches missed.">          if (filenames[1] != null) {</span>
<span class="fc" id="L1955">            extraInformation +=</span>
<span class="fc" id="L1956">                Messages.getString(&quot;HttpSslHandler.32&quot;); //$NON-NLS-1$</span>
          }
<span class="pc bpc" id="L1958" title="1 of 2 branches missed.">          if (filenames[2] != null) {</span>
<span class="fc" id="L1959">            extraInformation +=</span>
<span class="fc" id="L1960">                Messages.getString(&quot;HttpSslHandler.44&quot;); //$NON-NLS-1$</span>
          }
<span class="pc bpc" id="L1962" title="1 of 2 branches missed.">          if (filenames[3] != null) {</span>
<span class="fc" id="L1963">            extraInformation +=</span>
<span class="fc" id="L1964">                Messages.getString(&quot;HttpSslHandler.45&quot;); //$NON-NLS-1$</span>
          }
<span class="pc bpc" id="L1966" title="1 of 2 branches missed.">          if (filenames[4] != null) {</span>
<span class="fc" id="L1967">            extraInformation +=</span>
<span class="fc" id="L1968">                Messages.getString(&quot;HttpSslHandler.46&quot;); //$NON-NLS-1$</span>
          }
<span class="fc bfc" id="L1970" title="All 2 branches covered.">        } else if (&quot;Disconnect&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L1971">          return logout();</span>
<span class="fc bfc" id="L1972" title="All 2 branches covered.">        } else if (&quot;Block&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L1973">          final boolean block = params.containsKey(&quot;blocking&quot;);</span>
<span class="fc bfc" id="L1974" title="All 2 branches covered.">          if (block) {</span>
<span class="fc" id="L1975">            extraInformation =</span>
<span class="fc" id="L1976">                Messages.getString(&quot;HttpSslHandler.34&quot;); //$NON-NLS-1$</span>
          } else {
<span class="fc" id="L1978">            extraInformation =</span>
<span class="fc" id="L1979">                Messages.getString(&quot;HttpSslHandler.35&quot;); //$NON-NLS-1$</span>
          }
<span class="fc" id="L1981">          Configuration.configuration.setShutdown(block);</span>
<span class="fc bfc" id="L1982" title="All 2 branches covered.">        } else if (&quot;Shutdown&quot;.equalsIgnoreCase(act)) {</span>
          final String error;
<span class="fc" id="L1984">          if (Configuration.configuration</span>
<span class="pc bpc" id="L1985" title="1 of 2 branches missed.">                  .getShutdownConfiguration().serviceFuture != null) {</span>
<span class="nc" id="L1986">            error =</span>
<span class="nc" id="L1987">                error(Messages.getString(&quot;HttpSslHandler.38&quot;)); //$NON-NLS-1$</span>
          } else {
<span class="fc" id="L1989">            error =</span>
<span class="fc" id="L1990">                error(Messages.getString(&quot;HttpSslHandler.37&quot;)); //$NON-NLS-1$</span>
          }
<span class="fc" id="L1992">          WaarpShutdownHook.setRestart(false);</span>
<span class="fc" id="L1993">          newSession = true;</span>
<span class="fc" id="L1994">          clearSession();</span>
<span class="fc" id="L1995">          forceClose = true;</span>
<span class="fc" id="L1996">          shutdown = true;</span>
<span class="fc" id="L1997">          return error;</span>
<span class="pc bpc" id="L1998" title="1 of 2 branches missed.">        } else if (&quot;Restart&quot;.equalsIgnoreCase(act)) {</span>
          String error;
<span class="nc" id="L2000">          if (Configuration.configuration</span>
<span class="nc bnc" id="L2001" title="All 2 branches missed.">                  .getShutdownConfiguration().serviceFuture != null) {</span>
<span class="nc" id="L2002">            error =</span>
<span class="nc" id="L2003">                error(Messages.getString(&quot;HttpSslHandler.38&quot;)); //$NON-NLS-1$</span>
          } else {
<span class="nc" id="L2005">            error = error(Messages.getString(&quot;HttpSslHandler.39&quot;)</span>
                          //$NON-NLS-1$
<span class="nc" id="L2007">                          + Configuration.configuration.getTimeoutCon() * 2 /</span>
                            1000 + Messages
<span class="nc" id="L2009">                              .getString(&quot;HttpSslHandler.40&quot;)); //$NON-NLS-1$</span>
          }
<span class="nc" id="L2011">          error = error.replace(&quot;XXXRELOADHTTPXXX&quot;,</span>
                                &quot;HTTP-EQUIV=\&quot;refresh\&quot; CONTENT=\&quot;&quot; +
<span class="nc" id="L2013">                                Configuration.configuration.getTimeoutCon() *</span>
                                2 / 1000 + '&quot;');
<span class="nc" id="L2015">          WaarpShutdownHook.setRestart(true);</span>
<span class="nc" id="L2016">          newSession = true;</span>
<span class="nc" id="L2017">          clearSession();</span>
<span class="nc" id="L2018">          forceClose = true;</span>
<span class="nc" id="L2019">          shutdown = true;</span>
<span class="nc" id="L2020">          return error;</span>
<span class="fc bfc" id="L2021" title="All 2 branches covered.">        } else if (&quot;Validate&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L2022">          final String bsessionr = getTrimValue(&quot;BSESSR&quot;);</span>
<span class="fc" id="L2023">          long lsessionr =</span>
<span class="fc" id="L2024">              Configuration.configuration.getServerChannelReadLimit();</span>
          long lglobalr;
          long lsessionw;
          long lglobalw;
          long delay;
          try {
<span class="pc bpc" id="L2030" title="1 of 2 branches missed.">            if (bsessionr != null) {</span>
<span class="fc" id="L2031">              lsessionr = (Long.parseLong(bsessionr) / 10) * 10;</span>
            }
<span class="fc" id="L2033">            final String bglobalr = getTrimValue(&quot;BGLOBR&quot;);</span>
<span class="fc" id="L2034">            lglobalr = Configuration.configuration.getServerGlobalReadLimit();</span>
<span class="pc bpc" id="L2035" title="1 of 2 branches missed.">            if (bglobalr != null) {</span>
<span class="fc" id="L2036">              lglobalr = (Long.parseLong(bglobalr) / 10) * 10;</span>
            }
<span class="fc" id="L2038">            final String bsessionw = getTrimValue(&quot;BSESSW&quot;);</span>
<span class="fc" id="L2039">            lsessionw =</span>
<span class="fc" id="L2040">                Configuration.configuration.getServerChannelWriteLimit();</span>
<span class="pc bpc" id="L2041" title="1 of 2 branches missed.">            if (bsessionw != null) {</span>
<span class="fc" id="L2042">              lsessionw = (Long.parseLong(bsessionw) / 10) * 10;</span>
            }
<span class="fc" id="L2044">            final String bglobalw = getTrimValue(&quot;BGLOBW&quot;);</span>
<span class="fc" id="L2045">            lglobalw = Configuration.configuration.getServerGlobalWriteLimit();</span>
<span class="pc bpc" id="L2046" title="1 of 2 branches missed.">            if (bglobalw != null) {</span>
<span class="fc" id="L2047">              lglobalw = (Long.parseLong(bglobalw) / 10) * 10;</span>
            }
<span class="fc" id="L2049">            final String dtra = getTrimValue(&quot;DTRA&quot;);</span>
<span class="fc" id="L2050">            delay = Configuration.configuration.getDelayLimit();</span>
<span class="pc bpc" id="L2051" title="1 of 2 branches missed.">            if (dtra != null) {</span>
<span class="fc" id="L2052">              delay = (Long.parseLong(dtra) / 10) * 10;</span>
<span class="pc bpc" id="L2053" title="1 of 2 branches missed.">              if (delay &lt; 100) {</span>
<span class="nc" id="L2054">                delay = 100;</span>
              }
            }
<span class="fc" id="L2057">            Configuration.configuration</span>
<span class="fc" id="L2058">                .changeNetworkLimit(lglobalw, lglobalr, lsessionw, lsessionr,</span>
                                    delay);
<span class="fc" id="L2060">            final String dcomm = getTrimValue(&quot;DCOM&quot;);</span>
<span class="pc bpc" id="L2061" title="1 of 2 branches missed.">            if (dcomm != null) {</span>
<span class="fc" id="L2062">              Configuration.configuration</span>
<span class="fc" id="L2063">                  .setDelayCommander(Long.parseLong(dcomm));</span>
<span class="pc bpc" id="L2064" title="1 of 2 branches missed.">              if (Configuration.configuration.getDelayCommander() &lt;= 100) {</span>
<span class="fc" id="L2065">                Configuration.configuration.setDelayCommander(100);</span>
              }
<span class="fc" id="L2067">              Configuration.configuration.reloadCommanderDelay();</span>
            }
<span class="fc" id="L2069">            final String dret = getTrimValue(&quot;DRET&quot;);</span>
<span class="pc bpc" id="L2070" title="1 of 2 branches missed.">            if (dret != null) {</span>
<span class="fc" id="L2071">              Configuration.configuration.setDelayRetry(Long.parseLong(dret));</span>
<span class="pc bpc" id="L2072" title="1 of 2 branches missed.">              if (Configuration.configuration.getDelayRetry() &lt;= 1000) {</span>
<span class="fc" id="L2073">                Configuration.configuration.setDelayRetry(1000);</span>
              }
            }
<span class="fc" id="L2076">            extraInformation =</span>
<span class="fc" id="L2077">                Messages.getString(&quot;HttpSslHandler.41&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2078">          } catch (final NumberFormatException e) {</span>
<span class="nc" id="L2079">            extraInformation =</span>
<span class="nc" id="L2080">                Messages.getString(&quot;HttpSslHandler.42&quot;); //$NON-NLS-1$</span>
<span class="fc" id="L2081">          }</span>
<span class="pc bpc" id="L2082" title="1 of 2 branches missed.">        } else if (&quot;HostConfig&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L2083">          config.setBusiness(getTrimValue(&quot;BUSINESS&quot;));</span>
<span class="fc" id="L2084">          config.setRoles(getTrimValue(&quot;ROLES&quot;));</span>
<span class="fc" id="L2085">          config.setAliases(getTrimValue(&quot;ALIASES&quot;));</span>
<span class="fc" id="L2086">          config.setOthers(getTrimValue(&quot;OTHER&quot;));</span>
          try {
<span class="fc" id="L2088">            config.update();</span>
<span class="fc" id="L2089">            extraInformation =</span>
<span class="fc" id="L2090">                Messages.getString(&quot;HttpSslHandler.41&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2091">          } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L2092">            extraInformation =</span>
<span class="nc" id="L2093">                Messages.getString(&quot;HttpSslHandler.43&quot;); //$NON-NLS-1$</span>
<span class="fc" id="L2094">          }</span>
        }
<span class="fc" id="L2096">      }</span>
    }
<span class="fc" id="L2098">    final String system = REQUEST.System.readFileUnique(this);</span>
<span class="fc" id="L2099">    final StringBuilder builder = new StringBuilder(system);</span>
<span class="fc" id="L2100">    replaceStringSystem(config, builder);</span>
<span class="fc" id="L2101">    langHandle(builder);</span>
<span class="pc bpc" id="L2102" title="1 of 2 branches missed.">    if (extraInformation != null) {</span>
<span class="fc" id="L2103">      builder.append(extraInformation);</span>
    }
<span class="fc" id="L2105">    return builder.toString();</span>
  }

  private void getParams() {
<span class="fc bfc" id="L2109" title="All 2 branches covered.">    if (request.method() == HttpMethod.GET) {</span>
<span class="fc" id="L2110">      params = null;</span>
<span class="pc bpc" id="L2111" title="1 of 2 branches missed.">    } else if (request.method() == HttpMethod.POST) {</span>
<span class="fc" id="L2112">      final ByteBuf content = request.content();</span>
<span class="pc bpc" id="L2113" title="1 of 2 branches missed.">      if (content.isReadable()) {</span>
<span class="fc" id="L2114">        final String param = content.toString(WaarpStringUtils.UTF8);</span>
<span class="fc" id="L2115">        final QueryStringDecoder queryStringDecoder2 =</span>
            new QueryStringDecoder(&quot;/?&quot; + param);
<span class="fc" id="L2117">        params = queryStringDecoder2.parameters();</span>
<span class="fc" id="L2118">        boolean invalidEntry = false;</span>
<span class="fc bfc" id="L2119" title="All 2 branches covered.">        for (final Entry&lt;String, List&lt;String&gt;&gt; paramCheck : params.entrySet()) {</span>
          try {
<span class="fc" id="L2121">            ParametersChecker.checkSanityString(paramCheck.getValue().toArray(</span>
                ParametersChecker.ZERO_ARRAY_STRING));
<span class="nc" id="L2123">          } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L2124">            logger.error(</span>
<span class="nc" id="L2125">                &quot;Arguments incompatible with Security: &quot; + paramCheck.getKey(),</span>
                e);
<span class="nc" id="L2127">            invalidEntry = true;</span>
<span class="fc" id="L2128">          }</span>
<span class="fc" id="L2129">        }</span>
<span class="pc bpc" id="L2130" title="1 of 2 branches missed.">        if (invalidEntry) {</span>
<span class="nc bnc" id="L2131" title="All 2 branches missed.">          for (final Entry&lt;String, List&lt;String&gt;&gt; paramCheck : params</span>
<span class="nc" id="L2132">              .entrySet()) {</span>
<span class="nc" id="L2133">            paramCheck.getValue().clear();</span>
<span class="nc" id="L2134">          }</span>
<span class="nc" id="L2135">          params.clear();</span>
<span class="nc" id="L2136">          params = null;</span>
<span class="nc" id="L2137">          logger.error(&quot;No parameter validated since security issue found&quot;);</span>
<span class="nc" id="L2138">          return;</span>
        }
<span class="fc bfc" id="L2140" title="All 2 branches covered.">        if (params.containsKey(sLIMITROW)) {</span>
<span class="fc" id="L2141">          final String snb = getTrimValue(sLIMITROW);</span>
<span class="pc bpc" id="L2142" title="1 of 2 branches missed.">          if (snb != null) {</span>
            try {
<span class="fc" id="L2144">              final int old = getLimitRow();</span>
<span class="fc" id="L2145">              setLimitRow(Integer.parseInt(snb));</span>
<span class="pc bpc" id="L2146" title="1 of 2 branches missed.">              if (getLimitRow() &lt; 5) {</span>
<span class="nc" id="L2147">                setLimitRow(old);</span>
              }
<span class="nc" id="L2149">            } catch (final Exception ignored) {</span>
              // nothing
<span class="fc" id="L2151">            }</span>
          }
        }
<span class="fc" id="L2154">      } else {</span>
<span class="nc" id="L2155">        params = null;</span>
      }
    }
<span class="fc" id="L2158">  }</span>

  protected void clearSession() {
<span class="fc bfc" id="L2161" title="All 2 branches covered.">    if (admin != null) {</span>
<span class="fc" id="L2162">      final R66Session lsession = sessions.remove(admin.value());</span>
<span class="fc" id="L2163">      admin = null;</span>
<span class="pc bpc" id="L2164" title="1 of 2 branches missed.">      if (lsession != null) {</span>
<span class="fc" id="L2165">        lsession.setStatus(75);</span>
<span class="fc" id="L2166">        lsession.clear();</span>
      }
    }
<span class="fc" id="L2169">  }</span>

  private void checkAuthent(final ChannelHandlerContext ctx) {
<span class="fc" id="L2172">    newSession = true;</span>
<span class="fc bfc" id="L2173" title="All 2 branches covered.">    if (request.method() == HttpMethod.GET) {</span>
<span class="fc" id="L2174">      String logon = logon();</span>
<span class="fc" id="L2175">      logon = logon.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(), &quot;&quot;);</span>
<span class="fc" id="L2176">      responseContent.append(logon);</span>
<span class="fc" id="L2177">      clearSession();</span>
<span class="fc" id="L2178">      writeResponse(ctx);</span>
<span class="fc" id="L2179">      return;</span>
<span class="pc bpc" id="L2180" title="1 of 2 branches missed.">    } else if (request.method() == HttpMethod.POST) {</span>
<span class="fc" id="L2181">      getParams();</span>
<span class="pc bpc" id="L2182" title="1 of 2 branches missed.">      if (params == null) {</span>
<span class="nc" id="L2183">        String logon = logon();</span>
<span class="nc" id="L2184">        logon = logon.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(),</span>
                                 Messages
<span class="nc" id="L2186">                                     .getString(&quot;HttpSslHandler.EmptyLogin&quot;));</span>
<span class="nc" id="L2187">        responseContent.append(logon);</span>
<span class="nc" id="L2188">        clearSession();</span>
<span class="nc" id="L2189">        writeResponse(ctx);</span>
<span class="nc" id="L2190">        return;</span>
      }
    }
<span class="fc" id="L2193">    boolean getMenu = false;</span>
<span class="pc bpc" id="L2194" title="2 of 4 branches missed.">    if (params != null &amp;&amp; params.containsKey(&quot;Logon&quot;)) {</span>
<span class="fc" id="L2195">      String name = null;</span>
<span class="fc" id="L2196">      String password = null;</span>
      List&lt;String&gt; values;
<span class="pc bpc" id="L2198" title="1 of 2 branches missed.">      if (!params.isEmpty()) {</span>
        // get values
<span class="pc bpc" id="L2200" title="1 of 2 branches missed.">        if (params.containsKey(&quot;name&quot;)) {</span>
<span class="fc" id="L2201">          values = params.get(&quot;name&quot;);</span>
<span class="pc bpc" id="L2202" title="1 of 2 branches missed.">          if (values != null) {</span>
<span class="fc" id="L2203">            name = values.get(0);</span>
<span class="pc bpc" id="L2204" title="2 of 4 branches missed.">            if (name == null || name.isEmpty()) {</span>
<span class="nc" id="L2205">              getMenu = true;</span>
            }
          }
        } else {
<span class="nc" id="L2209">          getMenu = true;</span>
        }
        // search the nb param
<span class="pc bpc" id="L2212" title="2 of 4 branches missed.">        if (!getMenu &amp;&amp; params.containsKey(&quot;passwd&quot;)) {</span>
<span class="fc" id="L2213">          values = params.get(&quot;passwd&quot;);</span>
<span class="pc bpc" id="L2214" title="1 of 2 branches missed.">          if (values != null) {</span>
<span class="fc" id="L2215">            password = values.get(0);</span>
<span class="pc bpc" id="L2216" title="2 of 4 branches missed.">            getMenu = password == null || password.isEmpty();</span>
          } else {
<span class="nc" id="L2218">            getMenu = true;</span>
          }
        } else {
<span class="nc" id="L2221">          getMenu = true;</span>
        }
      } else {
<span class="nc" id="L2224">        getMenu = true;</span>
      }
<span class="pc bpc" id="L2226" title="2 of 4 branches missed.">      if (!getMenu &amp;&amp; name != null) {</span>
<span class="fc" id="L2227">        logger.debug(&quot;Name? {} Passwd? {}&quot;,</span>
<span class="fc" id="L2228">                     name.equals(Configuration.configuration.getAdminName()),</span>
<span class="fc" id="L2229">                     Arrays.equals(password.getBytes(WaarpStringUtils.UTF8),</span>
                                   Configuration.configuration
<span class="fc" id="L2231">                                       .getServerAdminKey()));</span>
<span class="fc bfc" id="L2232" title="All 2 branches covered.">        if (name.equals(Configuration.configuration.getAdminName()) &amp;&amp; Arrays</span>
<span class="pc bpc" id="L2233" title="1 of 2 branches missed.">            .equals(password.getBytes(WaarpStringUtils.UTF8),</span>
<span class="fc" id="L2234">                    Configuration.configuration.getServerAdminKey())) {</span>
<span class="fc" id="L2235">          authentHttp.getAuth().specialNoSessionAuth(true,</span>
                                                     Configuration.configuration
<span class="fc" id="L2237">                                                         .getHostId());</span>
<span class="fc" id="L2238">          authentHttp.setStatus(70);</span>
        } else {
          try {
<span class="fc" id="L2241">            authentHttp.getAuth().connectionHttps(name, FilesystemBasedDigest</span>
<span class="fc" id="L2242">                .passwdCrypt(password.getBytes(WaarpStringUtils.UTF8)));</span>
<span class="nc" id="L2243">          } catch (final Reply530Exception e1) {</span>
<span class="nc" id="L2244">            getMenu = true;</span>
<span class="nc" id="L2245">          } catch (final Reply421Exception e1) {</span>
<span class="nc" id="L2246">            getMenu = true;</span>
<span class="pc" id="L2247">          }</span>
        }
<span class="pc bpc" id="L2249" title="1 of 2 branches missed.">        if (!authentHttp.isAuthenticated()) {</span>
<span class="nc" id="L2250">          authentHttp.setStatus(71);</span>
<span class="nc" id="L2251">          logger.info(&quot;Still not authenticated: {}&quot;, authentHttp);</span>
<span class="nc" id="L2252">          getMenu = true;</span>
        }
<span class="fc" id="L2254">        logger.debug(&quot;Identified: {}:{}&quot;, authentHttp.getAuth().isIdentified(),</span>
<span class="fc" id="L2255">                     authentHttp.isAuthenticated());</span>
      }
<span class="fc" id="L2257">    } else {</span>
<span class="nc" id="L2258">      getMenu = true;</span>
    }
<span class="pc bpc" id="L2260" title="1 of 2 branches missed.">    if (getMenu) {</span>
<span class="nc" id="L2261">      String logon = logon();</span>
<span class="nc" id="L2262">      logon = logon.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(),</span>
<span class="nc" id="L2263">                               Messages.getString(&quot;HttpSslHandler.BadLogin&quot;));</span>
<span class="nc" id="L2264">      responseContent.append(logon);</span>
<span class="nc" id="L2265">      clearSession();</span>
<span class="nc" id="L2266">    } else {</span>
<span class="fc" id="L2267">      final String index = index();</span>
<span class="fc" id="L2268">      responseContent.append(index);</span>
<span class="fc" id="L2269">      clearSession();</span>
<span class="fc" id="L2270">      admin = new DefaultCookie(</span>
<span class="fc" id="L2271">          R66SESSION + Configuration.configuration.getHostId(),</span>
<span class="fc" id="L2272">          Configuration.configuration.getHostId() +</span>
<span class="fc" id="L2273">          Long.toHexString(RANDOM.nextLong()));</span>
<span class="fc" id="L2274">      sessions.put(admin.value(), authentHttp);</span>
<span class="fc" id="L2275">      authentHttp.setStatus(72);</span>
<span class="fc" id="L2276">      logger.debug(&quot;CreateSession: {}:{}&quot;, uriRequest, admin);</span>
    }
<span class="fc" id="L2278">    writeResponse(ctx);</span>
<span class="fc" id="L2279">  }</span>

  @Override
  protected void channelRead0(final ChannelHandlerContext ctx,
                              final FullHttpRequest msg) {
<span class="fc" id="L2284">    final FullHttpRequest httpRequest = this.request = msg;</span>
<span class="fc" id="L2285">    final QueryStringDecoder queryStringDecoder =</span>
<span class="fc" id="L2286">        new QueryStringDecoder(httpRequest.uri());</span>
<span class="fc" id="L2287">    uriRequest = queryStringDecoder.path();</span>
<span class="fc" id="L2288">    logger.debug(&quot;Msg: {}&quot;, uriRequest);</span>
<span class="fc bfc" id="L2289" title="All 4 branches covered.">    if (uriRequest.contains(&quot;gre/&quot;) || uriRequest.contains(&quot;img/&quot;) ||</span>
<span class="pc bpc" id="L2290" title="1 of 4 branches missed.">        uriRequest.contains(&quot;res/&quot;) || uriRequest.contains(&quot;favicon.ico&quot;)) {</span>
<span class="fc" id="L2291">      HttpWriteCacheEnable.writeFile(httpRequest, ctx,</span>
                                     Configuration.configuration
<span class="fc" id="L2293">                                         .getHttpBasePath() + uriRequest,</span>
                                     R66SESSION +
<span class="fc" id="L2295">                                     Configuration.configuration.getHostId());</span>
<span class="fc" id="L2296">      return;</span>
    }
<span class="fc" id="L2298">    checkSession(ctx.channel());</span>
    try {
<span class="fc bfc" id="L2300" title="All 2 branches covered.">      if (!authentHttp.isAuthenticated()) {</span>
<span class="fc" id="L2301">        logger.debug(&quot;Not Authent: {}:{}&quot;, uriRequest, authentHttp);</span>
<span class="fc" id="L2302">        checkAuthent(ctx);</span>
<span class="fc" id="L2303">        return;</span>
      }
<span class="fc" id="L2305">      String find = uriRequest;</span>
<span class="pc bpc" id="L2306" title="1 of 2 branches missed.">      if (uriRequest.charAt(0) == '/') {</span>
<span class="fc" id="L2307">        find = uriRequest.substring(1);</span>
      }
<span class="fc" id="L2309">      REQUEST req = REQUEST.index;</span>
<span class="fc bfc" id="L2310" title="All 2 branches covered.">      if (find.length() != 0) {</span>
<span class="fc" id="L2311">        find = find.substring(0, find.indexOf('.'));</span>
        try {
<span class="fc" id="L2313">          req = REQUEST.valueOf(find);</span>
<span class="nc" id="L2314">        } catch (final IllegalArgumentException e1) {</span>
<span class="nc" id="L2315">          req = REQUEST.index;</span>
<span class="nc" id="L2316">          logger.info(&quot;NotFound: {}:{}&quot;, find, uriRequest);</span>
<span class="fc" id="L2317">        }</span>
      }
<span class="pc bpc" id="L2319" title="1 of 11 branches missed.">      switch (req) {</span>
        case CancelRestart:
<span class="pc bpc" id="L2321" title="1 of 2 branches missed.">          if (authentHttp.getAuth().isValidRole(ROLE.TRANSFER)) {</span>
<span class="fc" id="L2322">            responseContent.append(cancelRestart0());</span>
          } else {
<span class="nc" id="L2324">            responseContent.append(unallowed(</span>
<span class="nc" id="L2325">                Messages.getString(&quot;HttpSslHandler.CancelRestartUnallowed&quot;)));</span>
          }
<span class="nc" id="L2327">          break;</span>
        case Export:
<span class="pc bpc" id="L2329" title="1 of 2 branches missed.">          if (authentHttp.getAuth().isValidRole(ROLE.SYSTEM)) {</span>
<span class="fc" id="L2330">            responseContent.append(export0());</span>
          } else {
<span class="nc" id="L2332">            responseContent.append(unallowed(</span>
<span class="nc" id="L2333">                Messages.getString(&quot;HttpSslHandler.ExportUnallowed&quot;)));</span>
          }
<span class="nc" id="L2335">          break;</span>
        case Hosts:
<span class="fc bfc" id="L2337" title="All 2 branches covered.">          if (authentHttp.getAuth().isValidRole(ROLE.HOST)) {</span>
<span class="fc" id="L2338">            responseContent.append(hosts0());</span>
          } else {
<span class="fc" id="L2340">            responseContent.append(</span>
<span class="fc" id="L2341">                unallowed(Messages.getString(&quot;HttpSslHandler.HostUnallowed&quot;)));</span>
          }
<span class="fc" id="L2343">          break;</span>
        case Listing:
<span class="fc" id="L2345">          responseContent.append(listing0());</span>
<span class="fc" id="L2346">          break;</span>
        case Logout:
<span class="fc" id="L2348">          responseContent.append(logout());</span>
<span class="fc" id="L2349">          break;</span>
        case Rules:
<span class="fc bfc" id="L2351" title="All 2 branches covered.">          if (authentHttp.getAuth().isValidRole(ROLE.RULE)) {</span>
<span class="fc" id="L2352">            responseContent.append(rules0());</span>
          } else {
<span class="fc" id="L2354">            responseContent.append(</span>
<span class="fc" id="L2355">                unallowed(Messages.getString(&quot;HttpSslHandler.RulesUnallowed&quot;)));</span>
          }
<span class="fc" id="L2357">          break;</span>
        case System:
<span class="pc bpc" id="L2359" title="1 of 2 branches missed.">          if (authentHttp.getAuth().isValidRole(ROLE.SYSTEM)) {</span>
<span class="fc" id="L2360">            responseContent.append(system0());</span>
          } else {
<span class="nc" id="L2362">            responseContent.append(systemLimited());</span>
          }
<span class="nc" id="L2364">          break;</span>
        case Transfers:
<span class="fc" id="L2366">          responseContent.append(transfers());</span>
<span class="fc" id="L2367">          break;</span>
        case Spooled:
<span class="fc" id="L2369">          responseContent.append(spooled0(false));</span>
<span class="fc" id="L2370">          break;</span>
        case SpooledDetailed:
<span class="nc" id="L2372">          responseContent.append(spooled0(true));</span>
<span class="nc" id="L2373">          break;</span>
        default:
<span class="fc" id="L2375">          responseContent.append(index());</span>
          break;
      }
<span class="fc" id="L2378">      writeResponse(ctx);</span>
    } finally {
<span class="fc" id="L2380">      closeConnection();</span>
    }
<span class="fc" id="L2382">  }</span>

  protected void checkSession(final Channel channel) {
<span class="fc" id="L2385">    final String cookieString = request.headers().get(HttpHeaderNames.COOKIE);</span>
<span class="fc bfc" id="L2386" title="All 2 branches covered.">    if (cookieString != null) {</span>
<span class="fc" id="L2387">      final Set&lt;Cookie&gt; cookies = ServerCookieDecoder.LAX.decode(cookieString);</span>
<span class="pc bpc" id="L2388" title="1 of 2 branches missed.">      if (!cookies.isEmpty()) {</span>
<span class="fc bfc" id="L2389" title="All 2 branches covered.">        for (final Cookie elt : cookies) {</span>
<span class="fc bfc" id="L2390" title="All 2 branches covered.">          if (elt.name().equalsIgnoreCase(</span>
<span class="fc" id="L2391">              R66SESSION + Configuration.configuration.getHostId())) {</span>
<span class="fc" id="L2392">            logger.debug(&quot;Found session: {}&quot;, elt);</span>
<span class="fc" id="L2393">            admin = elt;</span>
<span class="fc" id="L2394">            final R66Session session = sessions.get(admin.value());</span>
<span class="fc bfc" id="L2395" title="All 2 branches covered.">            if (session != null) {</span>
<span class="fc" id="L2396">              authentHttp = session;</span>
<span class="fc" id="L2397">              authentHttp.setStatus(73);</span>
            } else {
<span class="fc" id="L2399">              admin = null;</span>
            }
<span class="pc bpc" id="L2401" title="1 of 2 branches missed.">          } else if (elt.name().equalsIgnoreCase(I18NEXT)) {</span>
<span class="fc" id="L2402">            logger.debug(&quot;Found i18next: {}&quot;, elt);</span>
<span class="fc" id="L2403">            lang = elt.value();</span>
          }
<span class="fc" id="L2405">        }</span>
      }
    }
    try {
<span class="fc" id="L2409">      dbSession = new DbSession(DbConstantR66.admin, false);</span>
<span class="fc" id="L2410">      DbAdmin.incHttpSession();</span>
<span class="nc" id="L2411">    } catch (final WaarpDatabaseNoConnectionException e1) {</span>
      // Cannot connect so use default connection
<span class="nc" id="L2413">      logger.warn(&quot;Use default database connection&quot;);</span>
<span class="nc" id="L2414">      dbSession = DbConstantR66.admin.getSession();</span>
<span class="fc" id="L2415">    }</span>
<span class="fc bfc" id="L2416" title="All 2 branches covered.">    if (admin == null) {</span>
<span class="fc" id="L2417">      logger.debug(&quot;NoSession: {}:{}&quot;, uriRequest, admin);</span>
    }
<span class="fc" id="L2419">  }</span>

  protected void closeConnection() {
<span class="pc bpc" id="L2422" title="2 of 4 branches missed.">    if (dbSession != null &amp;&amp; dbSession != DbConstantR66.admin.getSession()) {</span>
<span class="fc" id="L2423">      DbAdmin.decHttpSession();</span>
<span class="fc" id="L2424">      dbSession.disconnect();</span>
    }
<span class="fc" id="L2426">    dbSession = null;</span>
<span class="fc" id="L2427">  }</span>

  private void handleCookies(final HttpResponse response) {
<span class="fc" id="L2430">    final String cookieString = request.headers().get(HttpHeaderNames.COOKIE);</span>
<span class="fc" id="L2431">    boolean i18nextFound = false;</span>
<span class="fc bfc" id="L2432" title="All 2 branches covered.">    if (cookieString != null) {</span>
<span class="fc" id="L2433">      final Set&lt;Cookie&gt; cookies = ServerCookieDecoder.LAX.decode(cookieString);</span>
<span class="pc bpc" id="L2434" title="1 of 2 branches missed.">      if (!cookies.isEmpty()) {</span>
        // Reset the sessions if necessary.
<span class="fc" id="L2436">        boolean findSession = false;</span>
<span class="fc bfc" id="L2437" title="All 2 branches covered.">        for (final Cookie cookie : cookies) {</span>
<span class="fc bfc" id="L2438" title="All 2 branches covered.">          if (cookie.name().equalsIgnoreCase(</span>
<span class="fc" id="L2439">              R66SESSION + Configuration.configuration.getHostId())) {</span>
<span class="fc bfc" id="L2440" title="All 2 branches covered.">            if (newSession) {</span>
<span class="fc" id="L2441">              findSession = false;</span>
            } else {
<span class="fc" id="L2443">              findSession = true;</span>
<span class="fc" id="L2444">              response.headers().add(HttpHeaderNames.SET_COOKIE,</span>
<span class="fc" id="L2445">                                     ServerCookieEncoder.LAX.encode(cookie));</span>
            }
<span class="pc bpc" id="L2447" title="1 of 2 branches missed.">          } else if (cookie.name().equalsIgnoreCase(I18NEXT)) {</span>
<span class="fc" id="L2448">            i18nextFound = true;</span>
<span class="fc" id="L2449">            cookie.setValue(lang);</span>
<span class="fc" id="L2450">            response.headers().add(HttpHeaderNames.SET_COOKIE,</span>
<span class="fc" id="L2451">                                   ServerCookieEncoder.LAX.encode(cookie));</span>
          } else {
<span class="nc" id="L2453">            response.headers().add(HttpHeaderNames.SET_COOKIE,</span>
<span class="nc" id="L2454">                                   ServerCookieEncoder.LAX.encode(cookie));</span>
          }
<span class="fc" id="L2456">        }</span>
<span class="pc bpc" id="L2457" title="1 of 2 branches missed.">        if (!i18nextFound) {</span>
<span class="nc" id="L2458">          final Cookie cookie = new DefaultCookie(I18NEXT, lang);</span>
<span class="nc" id="L2459">          response.headers().add(HttpHeaderNames.SET_COOKIE,</span>
<span class="nc" id="L2460">                                 ServerCookieEncoder.LAX.encode(cookie));</span>
        }
<span class="fc" id="L2462">        newSession = false;</span>
<span class="fc bfc" id="L2463" title="All 4 branches covered.">        if (!findSession &amp;&amp; admin != null) {</span>
<span class="fc" id="L2464">          response.headers().add(HttpHeaderNames.SET_COOKIE,</span>
<span class="fc" id="L2465">                                 ServerCookieEncoder.LAX.encode(admin));</span>
<span class="fc" id="L2466">          logger.debug(&quot;AddSession: {}:{}&quot;, uriRequest, admin);</span>
        }
      }
<span class="fc" id="L2469">    } else {</span>
<span class="fc" id="L2470">      final Cookie cookie = new DefaultCookie(I18NEXT, lang);</span>
<span class="fc" id="L2471">      response.headers().add(HttpHeaderNames.SET_COOKIE,</span>
<span class="fc" id="L2472">                             ServerCookieEncoder.LAX.encode(cookie));</span>
<span class="pc bpc" id="L2473" title="1 of 2 branches missed.">      if (admin != null) {</span>
<span class="nc" id="L2474">        logger.debug(&quot;AddSession: {}:{}&quot;, uriRequest, admin);</span>
<span class="nc" id="L2475">        response.headers().add(HttpHeaderNames.SET_COOKIE,</span>
<span class="nc" id="L2476">                               ServerCookieEncoder.LAX.encode(admin));</span>
      }
    }
<span class="fc" id="L2479">  }</span>

  /**
   * Write the response
   *
   * @param ctx
   */
  protected void writeResponse(final ChannelHandlerContext ctx) {
    // Convert the response content to a ByteBuf.
<span class="fc" id="L2488">    final ByteBuf buf = Unpooled</span>
<span class="fc" id="L2489">        .copiedBuffer(responseContent.toString(), WaarpStringUtils.UTF8);</span>
<span class="fc" id="L2490">    responseContent.setLength(0);</span>

    // Decide whether to close the connection or not.
<span class="fc" id="L2493">    final boolean keepAlive = HttpUtil.isKeepAlive(request);</span>
<span class="pc bpc" id="L2494" title="2 of 6 branches missed.">    final boolean close = HttpHeaderValues.CLOSE.contentEqualsIgnoreCase(</span>
<span class="fc" id="L2495">        request.headers().get(HttpHeaderNames.CONNECTION)) || !keepAlive ||</span>
                          forceClose;

    // Build the response object.
<span class="fc" id="L2499">    final FullHttpResponse response =</span>
        new DefaultFullHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.OK,
                                    buf);
<span class="fc" id="L2502">    response.headers().add(HttpHeaderNames.CONTENT_LENGTH,</span>
<span class="fc" id="L2503">                           response.content().readableBytes());</span>
<span class="fc" id="L2504">    response.headers().set(HttpHeaderNames.CONTENT_TYPE, &quot;text/html&quot;);</span>
<span class="pc bpc" id="L2505" title="1 of 2 branches missed.">    if (keepAlive) {</span>
<span class="fc" id="L2506">      response.headers()</span>
<span class="fc" id="L2507">              .set(HttpHeaderNames.CONNECTION, HttpHeaderValues.KEEP_ALIVE);</span>
    }
<span class="fc bfc" id="L2509" title="All 2 branches covered.">    if (!close) {</span>
      // There's no need to add 'Content-Length' header
      // if this is the last response.
<span class="fc" id="L2512">      response.headers().set(HttpHeaderNames.CONTENT_LENGTH,</span>
<span class="fc" id="L2513">                             String.valueOf(buf.readableBytes()));</span>
    }

<span class="fc" id="L2516">    handleCookies(response);</span>

    // Write the response.
<span class="fc" id="L2519">    final ChannelFuture future = ctx.writeAndFlush(response);</span>
    // Close the connection after the write operation is done if necessary.
<span class="fc bfc" id="L2521" title="All 2 branches covered.">    if (close) {</span>
<span class="fc" id="L2522">      future.addListener(WaarpSslUtility.SSLCLOSE);</span>
    }
<span class="fc bfc" id="L2524" title="All 2 branches covered.">    if (shutdown) {</span>
<span class="fc" id="L2525">      ChannelUtils.startShutdown();</span>
    }
<span class="fc" id="L2527">  }</span>

  /**
   * Send an error and close
   *
   * @param ctx
   * @param status
   */
  void sendError(final ChannelHandlerContext ctx,
                 final HttpResponseStatus status) {
<span class="nc" id="L2537">    responseContent.setLength(0);</span>
<span class="nc" id="L2538">    responseContent.append(error(status.toString()));</span>
<span class="nc" id="L2539">    final FullHttpResponse response =</span>
        new DefaultFullHttpResponse(HttpVersion.HTTP_1_1, status, Unpooled
<span class="nc" id="L2541">            .copiedBuffer(responseContent.toString(), WaarpStringUtils.UTF8));</span>
<span class="nc" id="L2542">    response.headers().add(HttpHeaderNames.CONTENT_LENGTH,</span>
<span class="nc" id="L2543">                           response.content().readableBytes());</span>
<span class="nc" id="L2544">    response.headers().set(HttpHeaderNames.CONTENT_TYPE, &quot;text/html&quot;);</span>
<span class="nc" id="L2545">    responseContent.setLength(0);</span>
<span class="nc" id="L2546">    clearSession();</span>
    // Close the connection as soon as the error message is sent.
<span class="nc" id="L2548">    ctx.writeAndFlush(response).addListener(WaarpSslUtility.SSLCLOSE);</span>
<span class="nc" id="L2549">  }</span>

  @Override
  public void exceptionCaught(final ChannelHandlerContext ctx,
                              final Throwable cause) {
<span class="nc" id="L2554">    final OpenR66Exception exception = OpenR66ExceptionTrappedFactory</span>
<span class="nc" id="L2555">        .getExceptionFromTrappedException(ctx.channel(), cause);</span>
<span class="nc bnc" id="L2556" title="All 2 branches missed.">    if (exception != null) {</span>
<span class="nc bnc" id="L2557" title="All 2 branches missed.">      if (!(exception instanceof OpenR66ProtocolBusinessNoWriteBackException)) {</span>
<span class="nc bnc" id="L2558" title="All 2 branches missed.">        if (cause instanceof IOException) {</span>
          // Nothing to do
<span class="nc" id="L2560">          return;</span>
        }
<span class="nc" id="L2562">        logger.warn(&quot;Exception in HttpSslHandler {}&quot;, exception.getMessage());</span>
      }
<span class="nc bnc" id="L2564" title="All 2 branches missed.">      if (ctx.channel().isActive()) {</span>
<span class="nc" id="L2565">        sendError(ctx, HttpResponseStatus.BAD_REQUEST);</span>
      }
    } else {
      // Nothing to do
    }
<span class="nc" id="L2570">  }</span>

  @Override
  public void channelActive(final ChannelHandlerContext ctx) throws Exception {
<span class="fc" id="L2574">    final Channel channel = ctx.channel();</span>
<span class="fc" id="L2575">    Configuration.configuration.getHttpChannelGroup().add(channel);</span>
<span class="fc" id="L2576">    super.channelActive(ctx);</span>
<span class="fc" id="L2577">  }</span>

  /**
   * @return the lIMITROW
   */
  public int getLimitRow() {
<span class="fc" id="L2583">    return limitRow;</span>
  }

  /**
   * @param lIMITROW the lIMITROW to set
   */
  void setLimitRow(final int lIMITROW) {
<span class="fc" id="L2590">    limitRow = lIMITROW;</span>
<span class="fc" id="L2591">  }</span>

  /**
   * @return the rEFRESH
   */
  public int getRefresh() {
<span class="fc" id="L2597">    return refresh;</span>
  }

  /**
   * @param rEFRESH the rEFRESH to set
   */
  void setRefresh(final int rEFRESH) {
<span class="nc" id="L2604">    refresh = rEFRESH;</span>
<span class="nc" id="L2605">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>