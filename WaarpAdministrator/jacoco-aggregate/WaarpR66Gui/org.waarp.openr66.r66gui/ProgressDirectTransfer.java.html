<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>ProgressDirectTransfer.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Waarp Administrator</a> &gt; <a href="../index.html" class="el_bundle">WaarpR66Gui</a> &gt; <a href="index.source.html" class="el_package">org.waarp.openr66.r66gui</a> &gt; <span class="el_source">ProgressDirectTransfer.java</span></div><h1>ProgressDirectTransfer.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.openr66.r66gui;

import org.waarp.openr66.client.ProgressBarTransfer;
import org.waarp.openr66.protocol.networkhandler.NetworkTransaction;
import org.waarp.openr66.protocol.utils.R66Future;

import javax.swing.JEditorPane;
import javax.swing.JProgressBar;

/**
 *
 */
public class ProgressDirectTransfer extends ProgressBarTransfer {
  private final JProgressBar progressBar;
  private final JEditorPane textFieldStatus;
<span class="nc" id="L35">  private boolean firstCall = true;</span>
<span class="nc" id="L36">  private int nbBlock = 1;</span>
<span class="nc" id="L37">  private long lastTime = System.currentTimeMillis();</span>
  private int lastRank;

  /**
   * @param future
   * @param remoteHost
   * @param filename
   * @param rulename
   * @param fileinfo
   * @param isMD5
   * @param blocksize
   * @param id
   * @param networkTransaction
   * @param callbackdelay
   */
  public ProgressDirectTransfer(final R66Future future, final String remoteHost,
                                final String filename, final String rulename,
                                final String fileinfo, final boolean isMD5,
                                final int blocksize, final long id,
                                final NetworkTransaction networkTransaction,
                                final long callbackdelay,
                                final JProgressBar progressBar,
                                final JEditorPane textFieldStatus) {
<span class="nc" id="L60">    super(future, remoteHost, filename, rulename, fileinfo, isMD5, blocksize,</span>
          id, networkTransaction, callbackdelay);
<span class="nc" id="L62">    this.textFieldStatus = textFieldStatus;</span>
<span class="nc" id="L63">    this.progressBar = progressBar;</span>
<span class="nc" id="L64">    this.progressBar.setIndeterminate(true);</span>
<span class="nc" id="L65">    this.progressBar.setValue(0);</span>
<span class="nc" id="L66">    this.progressBar.setVisible(true);</span>
<span class="nc" id="L67">    this.textFieldStatus.setText(&quot;Initializing transfer...&quot;);</span>
<span class="nc" id="L68">  }</span>

  @Override
  public void callBack(final int currentBlock, final int blocksize) {
<span class="nc bnc" id="L72" title="All 2 branches missed.">    if (firstCall) {</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">      if (filesize != 0) {</span>
<span class="nc" id="L74">        progressBar.setIndeterminate(false);</span>
<span class="nc" id="L75">        nbBlock = (int) Math.ceil((double) filesize / (double) blocksize);</span>
      }
<span class="nc" id="L77">      firstCall = false;</span>
    }
<span class="nc" id="L79">    final long newtime = System.currentTimeMillis() + 1;</span>
<span class="nc" id="L80">    final int sendsize = (currentBlock - lastRank) * blocksize;</span>
<span class="nc" id="L81">    final long time = (newtime - lastTime) * 1024 / 1000;</span>
<span class="nc" id="L82">    final long speedKB = sendsize / time;</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">    if (filesize == 0) {</span>
<span class="nc" id="L84">      textFieldStatus.setText(</span>
          &quot;Bytes transmitted: &quot; + currentBlock * blocksize + &quot; at &quot; + speedKB +
          &quot; KB/s&quot;);
    } else {
<span class="nc" id="L88">      progressBar.setValue(currentBlock * 100 / nbBlock);</span>
<span class="nc" id="L89">      textFieldStatus.setText(</span>
          &quot;Bytes transmitted: &quot; + currentBlock * blocksize + &quot; on &quot; + filesize +
          &quot; at &quot; + speedKB + &quot; KB/s&quot;);
    }
<span class="nc" id="L93">    lastTime = newtime - 1;</span>
<span class="nc" id="L94">    lastRank = currentBlock;</span>
<span class="nc" id="L95">  }</span>

  @Override
  public void lastCallBack(final boolean success, final int currentBlock,
                           final int blocksize) {
<span class="nc" id="L100">    progressBar.setIndeterminate(false);</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">    if (filesize != 0) {</span>
<span class="nc" id="L102">      progressBar.setValue(100);</span>
    }
<span class="nc" id="L104">    textFieldStatus.setText(</span>
        &quot;Finally Bytes transmitted: &quot; + currentBlock * blocksize +
        &quot; with Status: &quot; + success);
<span class="nc" id="L107">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>