<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>HttpRestR66Handler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Waarp Administrator</a> &gt; <a href="../index.html" class="el_bundle">WaarpR66</a> &gt; <a href="index.source.html" class="el_package">org.waarp.openr66.protocol.http.rest</a> &gt; <span class="el_source">HttpRestR66Handler.java</span></div><h1>HttpRestR66Handler.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.openr66.protocol.http.rest;

import io.netty.bootstrap.ServerBootstrap;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelHandlerContext;
import io.netty.handler.codec.http.HttpResponseStatus;
import org.waarp.common.command.exception.Reply421Exception;
import org.waarp.common.command.exception.Reply530Exception;
import org.waarp.common.database.DbSession;
import org.waarp.common.database.exception.WaarpDatabaseException;
import org.waarp.common.database.exception.WaarpDatabaseNoConnectionException;
import org.waarp.common.digest.FilesystemBasedDigest;
import org.waarp.common.logging.SysErrLogger;
import org.waarp.common.logging.WaarpLogger;
import org.waarp.common.logging.WaarpLoggerFactory;
import org.waarp.common.utility.WaarpNettyUtil;
import org.waarp.common.utility.WaarpStringUtils;
import org.waarp.gateway.kernel.exception.HttpInvalidAuthenticationException;
import org.waarp.gateway.kernel.rest.HttpRestHandler;
import org.waarp.gateway.kernel.rest.RestConfiguration;
import org.waarp.openr66.context.R66Session;
import org.waarp.openr66.database.DbConstantR66;
import org.waarp.openr66.database.data.DbHostAuth;
import org.waarp.openr66.protocol.configuration.Configuration;
import org.waarp.openr66.protocol.http.rest.handler.DbConfigurationR66RestMethodHandler;
import org.waarp.openr66.protocol.http.rest.handler.DbHostAuthR66RestMethodHandler;
import org.waarp.openr66.protocol.http.rest.handler.DbHostConfigurationR66RestMethodHandler;
import org.waarp.openr66.protocol.http.rest.handler.DbRuleR66RestMethodHandler;
import org.waarp.openr66.protocol.http.rest.handler.DbTaskRunnerR66RestMethodHandler;
import org.waarp.openr66.protocol.http.rest.handler.HttpRestBandwidthR66Handler;
import org.waarp.openr66.protocol.http.rest.handler.HttpRestBusinessR66Handler;
import org.waarp.openr66.protocol.http.rest.handler.HttpRestConfigR66Handler;
import org.waarp.openr66.protocol.http.rest.handler.HttpRestControlR66Handler;
import org.waarp.openr66.protocol.http.rest.handler.HttpRestInformationR66Handler;
import org.waarp.openr66.protocol.http.rest.handler.HttpRestLogR66Handler;
import org.waarp.openr66.protocol.http.rest.handler.HttpRestServerR66Handler;
import org.waarp.openr66.protocol.localhandler.ServerActions;

import java.net.InetSocketAddress;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashMap;
import java.util.List;

/**
 * Handler for Rest HTTP support for R66
 */
public class HttpRestR66Handler extends HttpRestHandler {

  /**
   * Internal Logger
   */
<span class="fc" id="L72">  private static final WaarpLogger logger =</span>
<span class="fc" id="L73">      WaarpLoggerFactory.getLogger(HttpRestR66Handler.class);</span>
<span class="fc" id="L74">  private static final METHOD[] METHOD_0_LENGTH = new METHOD[0];</span>

<span class="fc" id="L76">  private static final HashMap&lt;String, DbSession&gt; dbSessionFromUser =</span>
      new HashMap&lt;String, DbSession&gt;();

<span class="fc" id="L79">  public enum RESTHANDLERS {</span>
<span class="fc" id="L80">    DbHostAuth(DbHostAuthR66RestMethodHandler.BASEURI,</span>
               org.waarp.openr66.database.data.DbHostAuth.class),
<span class="fc" id="L82">    DbRule(DbRuleR66RestMethodHandler.BASEURI,</span>
           org.waarp.openr66.database.data.DbRule.class),
<span class="fc" id="L84">    DbTaskRunner(DbTaskRunnerR66RestMethodHandler.BASEURI,</span>
                 org.waarp.openr66.database.data.DbTaskRunner.class),
<span class="fc" id="L86">    DbHostConfiguration(DbHostConfigurationR66RestMethodHandler.BASEURI,</span>
                        org.waarp.openr66.database.data.DbHostConfiguration.class),
<span class="fc" id="L88">    DbConfiguration(DbConfigurationR66RestMethodHandler.BASEURI,</span>
                    org.waarp.openr66.database.data.DbConfiguration.class),
<span class="fc" id="L90">    Bandwidth(HttpRestBandwidthR66Handler.BASEURI, null),</span>
<span class="fc" id="L91">    Business(HttpRestBusinessR66Handler.BASEURI, null),</span>
<span class="fc" id="L92">    Config(HttpRestConfigR66Handler.BASEURI, null),</span>
<span class="fc" id="L93">    Information(HttpRestInformationR66Handler.BASEURI, null),</span>
<span class="fc" id="L94">    Log(HttpRestLogR66Handler.BASEURI, null),</span>
<span class="fc" id="L95">    Server(HttpRestServerR66Handler.BASEURI, null),</span>
<span class="fc" id="L96">    Control(HttpRestControlR66Handler.BASEURI, null);</span>

    public final String uri;
    @SuppressWarnings(&quot;rawtypes&quot;)
    public final Class clasz;

    @SuppressWarnings(&quot;rawtypes&quot;)
<span class="fc" id="L103">    RESTHANDLERS(final String uri, final Class clasz) {</span>
<span class="fc" id="L104">      this.uri = uri;</span>
<span class="fc" id="L105">      this.clasz = clasz;</span>
<span class="fc" id="L106">    }</span>

    public static RESTHANDLERS getRESTHANDLER(final String baseUri) {
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">      for (final RESTHANDLERS resthandler : RESTHANDLERS.values()) {</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">        if (resthandler.uri.equals(baseUri)) {</span>
<span class="fc" id="L111">          return resthandler;</span>
        }
      }
<span class="nc" id="L114">      return null;</span>
    }
  }

  /**
   * To be called once to ensure default is built
   */
  public static void defaultHandlers() {
<span class="fc" id="L122">    synchronized (defaultConfiguration) {</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">      if (defaultConfiguration.restHashMap.isEmpty()) {</span>
<span class="fc" id="L124">        defaultConfiguration.setRestAuthenticated(true);</span>
<span class="fc" id="L125">        defaultConfiguration</span>
<span class="fc" id="L126">            .setResthandlersCrud(new byte[RESTHANDLERS.values().length]);</span>
<span class="fc" id="L127">        Arrays.fill(defaultConfiguration.getResthandlersCrud(), (byte) 0x0F);</span>
<span class="fc" id="L128">        final METHOD[] methods = METHOD.values();</span>
<span class="fc" id="L129">        defaultConfiguration.restHashMap.put(RESTHANDLERS.DbTaskRunner.uri,</span>
                                             new DbTaskRunnerR66RestMethodHandler(
                                                 defaultConfiguration,
                                                 methods));
<span class="fc" id="L133">        defaultConfiguration.restHashMap.put(RESTHANDLERS.DbHostAuth.uri,</span>
                                             new DbHostAuthR66RestMethodHandler(
                                                 defaultConfiguration,
                                                 methods));
<span class="fc" id="L137">        defaultConfiguration.restHashMap.put(RESTHANDLERS.DbRule.uri,</span>
                                             new DbRuleR66RestMethodHandler(
                                                 defaultConfiguration,
                                                 methods));
<span class="fc" id="L141">        defaultConfiguration.restHashMap</span>
<span class="fc" id="L142">            .put(RESTHANDLERS.DbHostConfiguration.uri,</span>
                 new DbHostConfigurationR66RestMethodHandler(
                     defaultConfiguration, methods));
<span class="fc" id="L145">        defaultConfiguration.restHashMap.put(RESTHANDLERS.DbConfiguration.uri,</span>
                                             new DbConfigurationR66RestMethodHandler(
                                                 defaultConfiguration,
                                                 methods));
<span class="fc" id="L149">        defaultConfiguration.restHashMap.put(RESTHANDLERS.Bandwidth.uri,</span>
                                             new HttpRestBandwidthR66Handler(
                                                 defaultConfiguration,
                                                 methods));
<span class="fc" id="L153">        defaultConfiguration.restHashMap.put(RESTHANDLERS.Business.uri,</span>
                                             new HttpRestBusinessR66Handler(
                                                 defaultConfiguration,
                                                 methods));
<span class="fc" id="L157">        defaultConfiguration.restHashMap.put(RESTHANDLERS.Config.uri,</span>
                                             new HttpRestConfigR66Handler(
                                                 defaultConfiguration,
                                                 methods));
<span class="fc" id="L161">        defaultConfiguration.restHashMap.put(RESTHANDLERS.Information.uri,</span>
                                             new HttpRestInformationR66Handler(
                                                 defaultConfiguration,
                                                 methods));
<span class="fc" id="L165">        defaultConfiguration.restHashMap.put(RESTHANDLERS.Log.uri,</span>
                                             new HttpRestLogR66Handler(
                                                 defaultConfiguration,
                                                 methods));
<span class="fc" id="L169">        defaultConfiguration.restHashMap.put(RESTHANDLERS.Server.uri,</span>
                                             new HttpRestServerR66Handler(
                                                 defaultConfiguration,
                                                 methods));
<span class="fc" id="L173">        defaultConfiguration.restHashMap.put(RESTHANDLERS.Control.uri,</span>
                                             new HttpRestControlR66Handler(
                                                 defaultConfiguration,
                                                 methods));
      }
<span class="fc" id="L178">    }</span>
<span class="fc" id="L179">  }</span>

  public HttpRestR66Handler(final RestConfiguration config) {
<span class="fc" id="L182">    super(config);</span>
<span class="fc" id="L183">    restHashMap = config.restHashMap;</span>
<span class="fc" id="L184">  }</span>

  protected static METHOD[] getMethods(final byte check) {
<span class="fc" id="L187">    final List&lt;METHOD&gt; methods = new ArrayList&lt;METHOD&gt;();</span>
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">    if (RestConfiguration.CRUD.CREATE.isValid(check)) {</span>
<span class="fc" id="L189">      methods.add(METHOD.POST);</span>
    }
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">    if (RestConfiguration.CRUD.READ.isValid(check)) {</span>
<span class="fc" id="L192">      methods.add(METHOD.GET);</span>
    }
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">    if (RestConfiguration.CRUD.UPDATE.isValid(check)) {</span>
<span class="fc" id="L195">      methods.add(METHOD.PUT);</span>
    }
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">    if (RestConfiguration.CRUD.DELETE.isValid(check)) {</span>
<span class="fc" id="L198">      methods.add(METHOD.DELETE);</span>
    }
<span class="fc" id="L200">    return methods.toArray(METHOD_0_LENGTH);</span>
  }

  public static void instantiateHandlers(
      final RestConfiguration restConfiguration) {
<span class="fc" id="L205">    defaultHandlers();</span>
<span class="pc bpc" id="L206" title="1 of 2 branches missed.">    if (restConfiguration == null) {</span>
<span class="nc" id="L207">      return;</span>
    }
<span class="fc" id="L209">    byte check =</span>
<span class="fc" id="L210">        restConfiguration.getResthandlersCrud()[RESTHANDLERS.DbTaskRunner</span>
<span class="fc" id="L211">            .ordinal()];</span>
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">    if (check != 0) {</span>
<span class="fc" id="L213">      final METHOD[] methods = getMethods(check);</span>
<span class="fc" id="L214">      restConfiguration.restHashMap.put(RESTHANDLERS.DbTaskRunner.uri,</span>
                                        new DbTaskRunnerR66RestMethodHandler(
                                            restConfiguration, methods));
    }
<span class="fc" id="L218">    check = restConfiguration.getResthandlersCrud()[RESTHANDLERS.DbHostAuth</span>
<span class="fc" id="L219">        .ordinal()];</span>
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">    if (check != 0) {</span>
<span class="fc" id="L221">      final METHOD[] methods = getMethods(check);</span>
<span class="fc" id="L222">      restConfiguration.restHashMap.put(RESTHANDLERS.DbHostAuth.uri,</span>
                                        new DbHostAuthR66RestMethodHandler(
                                            restConfiguration, methods));
    }
<span class="fc" id="L226">    check =</span>
<span class="fc" id="L227">        restConfiguration.getResthandlersCrud()[RESTHANDLERS.DbRule.ordinal()];</span>
<span class="pc bpc" id="L228" title="1 of 2 branches missed.">    if (check != 0) {</span>
<span class="fc" id="L229">      final METHOD[] methods = getMethods(check);</span>
<span class="fc" id="L230">      restConfiguration.restHashMap.put(RESTHANDLERS.DbRule.uri,</span>
                                        new DbRuleR66RestMethodHandler(
                                            restConfiguration, methods));
    }
<span class="fc" id="L234">    check =</span>
<span class="fc" id="L235">        restConfiguration.getResthandlersCrud()[RESTHANDLERS.DbHostConfiguration</span>
<span class="fc" id="L236">            .ordinal()];</span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">    if (check != 0) {</span>
<span class="fc" id="L238">      final METHOD[] methods = getMethods(check);</span>
<span class="fc" id="L239">      restConfiguration.restHashMap.put(RESTHANDLERS.DbHostConfiguration.uri,</span>
                                        new DbHostConfigurationR66RestMethodHandler(
                                            restConfiguration, methods));
    }
<span class="fc" id="L243">    check = restConfiguration.getResthandlersCrud()[RESTHANDLERS.DbConfiguration</span>
<span class="fc" id="L244">        .ordinal()];</span>
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">    if (check != 0) {</span>
<span class="fc" id="L246">      final METHOD[] methods = getMethods(check);</span>
<span class="fc" id="L247">      restConfiguration.restHashMap.put(RESTHANDLERS.DbConfiguration.uri,</span>
                                        new DbConfigurationR66RestMethodHandler(
                                            restConfiguration, methods));
    }
<span class="fc" id="L251">    check = restConfiguration.getResthandlersCrud()[RESTHANDLERS.Bandwidth</span>
<span class="fc" id="L252">        .ordinal()];</span>
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">    if (check != 0) {</span>
<span class="fc" id="L254">      final METHOD[] methods = getMethods(check);</span>
<span class="fc" id="L255">      restConfiguration.restHashMap.put(RESTHANDLERS.Bandwidth.uri,</span>
                                        new HttpRestBandwidthR66Handler(
                                            restConfiguration, methods));
    }
<span class="fc" id="L259">    check = restConfiguration.getResthandlersCrud()[RESTHANDLERS.Business</span>
<span class="fc" id="L260">        .ordinal()];</span>
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">    if (check != 0) {</span>
<span class="fc" id="L262">      final METHOD[] methods = getMethods(check);</span>
<span class="fc" id="L263">      restConfiguration.restHashMap.put(RESTHANDLERS.Business.uri,</span>
                                        new HttpRestBusinessR66Handler(
                                            restConfiguration, methods));
    }
<span class="fc" id="L267">    check =</span>
<span class="fc" id="L268">        restConfiguration.getResthandlersCrud()[RESTHANDLERS.Config.ordinal()];</span>
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">    if (check != 0) {</span>
<span class="fc" id="L270">      final METHOD[] methods = getMethods(check);</span>
<span class="fc" id="L271">      restConfiguration.restHashMap.put(RESTHANDLERS.Config.uri,</span>
                                        new HttpRestConfigR66Handler(
                                            restConfiguration, methods));
    }
<span class="fc" id="L275">    check = restConfiguration.getResthandlersCrud()[RESTHANDLERS.Information</span>
<span class="fc" id="L276">        .ordinal()];</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">    if (check != 0) {</span>
<span class="fc" id="L278">      final METHOD[] methods = getMethods(check);</span>
<span class="fc" id="L279">      restConfiguration.restHashMap.put(RESTHANDLERS.Information.uri,</span>
                                        new HttpRestInformationR66Handler(
                                            restConfiguration, methods));
    }
<span class="fc" id="L283">    check = restConfiguration.getResthandlersCrud()[RESTHANDLERS.Log.ordinal()];</span>
<span class="pc bpc" id="L284" title="1 of 2 branches missed.">    if (check != 0) {</span>
<span class="fc" id="L285">      final METHOD[] methods = getMethods(check);</span>
<span class="fc" id="L286">      restConfiguration.restHashMap.put(RESTHANDLERS.Log.uri,</span>
                                        new HttpRestLogR66Handler(
                                            restConfiguration, methods));
    }
<span class="fc" id="L290">    check =</span>
<span class="fc" id="L291">        restConfiguration.getResthandlersCrud()[RESTHANDLERS.Server.ordinal()];</span>
<span class="pc bpc" id="L292" title="1 of 2 branches missed.">    if (check != 0) {</span>
<span class="fc" id="L293">      final METHOD[] methods = getMethods(check);</span>
<span class="fc" id="L294">      restConfiguration.restHashMap.put(RESTHANDLERS.Server.uri,</span>
                                        new HttpRestServerR66Handler(
                                            restConfiguration, methods));
    }
<span class="fc" id="L298">    check =</span>
<span class="fc" id="L299">        restConfiguration.getResthandlersCrud()[RESTHANDLERS.Control.ordinal()];</span>
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">    if (check != 0) {</span>
<span class="fc" id="L301">      final METHOD[] methods = getMethods(check);</span>
<span class="fc" id="L302">      restConfiguration.restHashMap.put(RESTHANDLERS.Control.uri,</span>
                                        new HttpRestControlR66Handler(
                                            restConfiguration, methods));
    }
<span class="fc" id="L306">    logger.debug(&quot;Initialized handler: &quot; + RESTHANDLERS.values().length);</span>
<span class="fc" id="L307">  }</span>

  /**
   * Server Actions handler
   */
<span class="fc" id="L312">  private final ServerActions serverHandler = new ServerActions();</span>

  @Override
  protected void checkConnection(final ChannelHandlerContext ctx)
      throws HttpInvalidAuthenticationException {
<span class="fc" id="L317">    logger.debug(&quot;Request: {} ### {}&quot;, arguments, response);</span>
    final String user;
<span class="fc" id="L319">    String key = null;</span>
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">    if (restConfiguration.isRestAuthenticated()) {</span>
<span class="nc" id="L321">      user = arguments.getXAuthUser();</span>
<span class="nc bnc" id="L322" title="All 4 branches missed.">      if (user == null || user.isEmpty()) {</span>
<span class="nc" id="L323">        status = HttpResponseStatus.UNAUTHORIZED;</span>
<span class="nc" id="L324">        throw new HttpInvalidAuthenticationException(&quot;Empty Authentication&quot;);</span>
      }
      final DbHostAuth host;
      try {
<span class="nc" id="L328">        host = new DbHostAuth(user);</span>
<span class="nc" id="L329">        key = new String(host.getHostkey(), WaarpStringUtils.UTF8);</span>
<span class="nc" id="L330">      } catch (final WaarpDatabaseException e) {</span>
        // might be global Admin
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (user.equals(Configuration.configuration.getAdminName())) {</span>
<span class="nc" id="L333">          key = new String(Configuration.configuration.getServerAdminKey(),</span>
                           WaarpStringUtils.UTF8);
        }
<span class="nc" id="L336">      }</span>
<span class="nc bnc" id="L337" title="All 4 branches missed.">      if (key == null || key.isEmpty()) {</span>
<span class="nc" id="L338">        status = HttpResponseStatus.UNAUTHORIZED;</span>
<span class="nc" id="L339">        throw new HttpInvalidAuthenticationException(&quot;Wrong Authentication&quot;);</span>
      }
<span class="nc bnc" id="L341" title="All 2 branches missed.">      if (restConfiguration.isRestSignature()) {</span>
<span class="nc" id="L342">        arguments.checkBaseAuthent(restConfiguration.getHmacSha256(), key,</span>
<span class="nc" id="L343">                                   restConfiguration.getRestTimeLimit());</span>
      } else {
<span class="nc" id="L345">        arguments.checkTime(restConfiguration.getRestTimeLimit());</span>
      }
    } else {
      // User set only for right access, not for signature check
<span class="fc" id="L349">      user = Configuration.configuration.getAdminName();</span>
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">      if (restConfiguration.isRestSignature()) {</span>
<span class="nc" id="L351">        arguments.checkBaseAuthent(restConfiguration.getHmacSha256(), null,</span>
<span class="nc" id="L352">                                   restConfiguration.getRestTimeLimit());</span>
      } else {
<span class="fc" id="L354">        arguments.checkTime(restConfiguration.getRestTimeLimit());</span>
      }
    }
<span class="fc" id="L357">    getServerHandler().newSession();</span>
<span class="fc" id="L358">    final R66Session session = getServerHandler().getSession();</span>
<span class="pc bpc" id="L359" title="1 of 2 branches missed.">    if (!restConfiguration.isRestAuthenticated()) {</span>
      // Default is Admin
<span class="fc" id="L361">      session.getAuth().specialNoSessionAuth(true, Configuration.configuration</span>
<span class="fc" id="L362">          .getHostSslId());</span>
    } else {
      // we have one DbSession per connection, only after authentication
<span class="nc" id="L365">      DbSession temp = getDbSessionFromUser().get(user);</span>
<span class="nc bnc" id="L366" title="All 2 branches missed.">      if (temp == null) {</span>
        try {
<span class="nc" id="L368">          temp = new DbSession(DbConstantR66.admin, false);</span>
<span class="nc" id="L369">          getDbSessionFromUser().put(user, temp);</span>
<span class="nc" id="L370">        } catch (final WaarpDatabaseNoConnectionException ignored) {</span>
          // nothing
<span class="nc" id="L372">        }</span>
      }
<span class="nc bnc" id="L374" title="All 2 branches missed.">      if (temp != null) {</span>
<span class="nc" id="L375">        temp.useConnection();</span>
<span class="nc" id="L376">        dbSession = temp;</span>
      }
<span class="nc bnc" id="L378" title="All 2 branches missed.">      if (key == null) {</span>
<span class="nc" id="L379">        status = HttpResponseStatus.UNAUTHORIZED;</span>
<span class="nc" id="L380">        throw new HttpInvalidAuthenticationException(&quot;Wrong Authentication&quot;);</span>
      }
      try {
<span class="nc" id="L383">        session.getAuth().connectionHttps(user, FilesystemBasedDigest</span>
<span class="nc" id="L384">            .passwdCrypt(key.getBytes(WaarpStringUtils.UTF8)));</span>
<span class="nc" id="L385">      } catch (final Reply530Exception e) {</span>
<span class="nc" id="L386">        status = HttpResponseStatus.UNAUTHORIZED;</span>
<span class="nc" id="L387">        throw new HttpInvalidAuthenticationException(&quot;Wrong Authentication&quot;, e);</span>
<span class="nc" id="L388">      } catch (final Reply421Exception e) {</span>
<span class="nc" id="L389">        status = HttpResponseStatus.SERVICE_UNAVAILABLE;</span>
<span class="nc" id="L390">        throw new HttpInvalidAuthenticationException(&quot;Service unavailable&quot;, e);</span>
<span class="nc" id="L391">      }</span>
    }
<span class="fc" id="L393">    arguments.setXAuthRole(session.getAuth().getRole());</span>
<span class="fc" id="L394">    arguments.methodFromUri();</span>
<span class="fc" id="L395">    arguments.methodFromHeader();</span>
<span class="fc" id="L396">  }</span>

  @Override
  public void channelInactive(final ChannelHandlerContext ctx)
      throws Exception {
<span class="fc" id="L401">    super.channelInactive(ctx);</span>
<span class="fc" id="L402">    getServerHandler().channelClosed();</span>
<span class="fc" id="L403">  }</span>

  /**
   * Called at the beginning of every new request
   * &lt;p&gt;
   * Override if needed
   */
  @Override
  protected void initialize() {
<span class="fc" id="L412">    super.initialize();</span>
<span class="fc" id="L413">  }</span>

  /**
   * Initialize the REST service (server side) for one restConfiguration
   *
   * @param restConfiguration
   */
  public static void initializeService(
      final RestConfiguration restConfiguration) {
<span class="fc" id="L422">    instantiateHandlers(restConfiguration);</span>
<span class="pc bpc" id="L423" title="1 of 2 branches missed.">    if (group == null) {</span>
<span class="fc" id="L424">      group = Configuration.configuration.getHttpChannelGroup();</span>
    }
    // Configure the server.
<span class="fc" id="L427">    final ServerBootstrap httpBootstrap = new ServerBootstrap();</span>
<span class="fc" id="L428">    WaarpNettyUtil.setServerBootstrap(httpBootstrap, Configuration.configuration</span>
<span class="fc" id="L429">        .getHttpWorkerGroup(), (int) Configuration.configuration</span>
<span class="fc" id="L430">        .getTimeoutCon());</span>
    // Set up the event pipeline factory.
<span class="pc bpc" id="L432" title="1 of 2 branches missed.">    if (restConfiguration.isRestSsl()) {</span>
<span class="nc" id="L433">      httpBootstrap.childHandler(new HttpRestR66Initializer(false, Configuration</span>
<span class="nc" id="L434">          .getWaarpSslContextFactory(), restConfiguration));</span>
    } else {
<span class="fc" id="L436">      httpBootstrap.childHandler(</span>
          new HttpRestR66Initializer(false, null, restConfiguration));
    }
    // Bind and start to accept incoming connections.
    final ChannelFuture future;
<span class="pc bpc" id="L441" title="1 of 2 branches missed.">    if (restConfiguration != null &amp;&amp;</span>
<span class="pc bpc" id="L442" title="1 of 2 branches missed.">        restConfiguration.getRestAddress() != null &amp;&amp;</span>
<span class="pc bpc" id="L443" title="1 of 2 branches missed.">        !restConfiguration.getRestAddress().isEmpty()) {</span>
<span class="fc" id="L444">      future = httpBootstrap.bind(</span>
<span class="fc" id="L445">          new InetSocketAddress(restConfiguration.getRestAddress(),</span>
<span class="fc" id="L446">                                restConfiguration.getRestPort()));</span>
    } else {
<span class="nc" id="L448">      future = httpBootstrap</span>
<span class="nc" id="L449">          .bind(new InetSocketAddress(restConfiguration.getRestPort()));</span>
    }
    try {
<span class="fc" id="L452">      future.await();</span>
<span class="nc" id="L453">    } catch (final InterruptedException e) {//NOSONAR</span>
<span class="nc" id="L454">      SysErrLogger.FAKE_LOGGER.ignoreLog(e);</span>
<span class="fc" id="L455">    }</span>
<span class="pc bpc" id="L456" title="1 of 2 branches missed.">    if (future.isSuccess()) {</span>
<span class="nc" id="L457">      group.add(future.channel());</span>
    }
<span class="fc" id="L459">  }</span>

  /**
   * @return the dbSessionFromUser
   */
  public static HashMap&lt;String, DbSession&gt; getDbSessionFromUser() {
<span class="nc" id="L465">    return dbSessionFromUser;</span>
  }

  /**
   * @return the serverHandler
   */
  public ServerActions getServerHandler() {
<span class="fc" id="L472">    return serverHandler;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>