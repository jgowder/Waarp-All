<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>WaarpPassword.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Waarp Gateway Ftp</a> &gt; <a href="../index.html" class="el_bundle">WaarpPassword</a> &gt; <a href="index.source.html" class="el_package">org.waarp.uip</a> &gt; <span class="el_source">WaarpPassword.java</span></div><h1>WaarpPassword.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.uip;

import org.waarp.common.crypto.Blowfish;
import org.waarp.common.crypto.Des;
import org.waarp.common.crypto.KeyObject;
import org.waarp.common.exception.CryptoException;
import org.waarp.common.file.FileUtils;
import org.waarp.common.logging.SysErrLogger;
import org.waarp.common.utility.DetectionUtils;
import org.waarp.common.utility.SystemPropertyUtil;
import org.waarp.common.utility.WaarpStringUtils;

import java.io.BufferedReader;
import java.io.DataInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStreamReader;

/**
 * Console Command Line Main class to provide Password Management for GoldenGate
 * Products.
 */
public class WaarpPassword {
<span class="fc" id="L45">  static boolean desModel = true;</span>
  static boolean clearPasswordView;
  static final String HELPOPTIONS = &quot;Options available\r\n&quot; +
                                    &quot;* -ki file to specify the Key File by default\r\n&quot; +
                                    &quot;* -ko file to specify a new Key File to build and save\r\n\r\n&quot; +
                                    &quot;* -des to specify DES format (default)\r\n&quot; +
                                    &quot;* -blf to specify BlowFish format\r\n\r\n&quot; +
                                    &quot;* -pi file to specify a GGP File by default(password)\r\n&quot; +
                                    &quot;* -pwd to specify a clear ggp password as entry\r\n&quot; +
                                    &quot;* -cpwd to specify a crypted ggp password as entry\r\n&quot; +
                                    &quot;* -po file to specify a GGP File as output for the password\r\n&quot; +
                                    &quot;* -clear to specify uncrypted password shown as clear text&quot;;
  static final String GGPEXTENSION = &quot;ggp&quot;;
  static String ki;
  static String ko;
  static String pi;
  static String po;
  static String pwd;
  static String cpwd;

  private File keyFile;
  private File passwordFile;
  private String clearPassword;
  private String cryptedPassword;

  private final KeyObject currentKey;

  /**
   * @param args
   *
   * @throws Exception
   */
  public static void main(String[] args) throws Exception {
<span class="fc bfc" id="L78" title="All 2 branches covered.">    if (!loadOptions(args)) {</span>
      // Bad options
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">      if (DetectionUtils.isJunit()) {</span>
<span class="fc" id="L81">        return;</span>
      }
<span class="nc" id="L83">      System.exit(2);//NOSONAR</span>
    }
<span class="fc" id="L85">    final WaarpPassword waarpPassword = new WaarpPassword();</span>
<span class="fc bfc" id="L86" title="All 4 branches covered.">    if (po == null &amp;&amp; pi == null) {</span>
      // stop
<span class="fc" id="L88">      SysErrLogger.FAKE_LOGGER.syserr(&quot;Key written&quot;);</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">      if (DetectionUtils.isJunit()) {</span>
<span class="fc" id="L90">        return;</span>
      }
<span class="nc" id="L92">      System.exit(0);//NOSONAR</span>
    }
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">    if (waarpPassword.clearPassword == null ||</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">        waarpPassword.clearPassword.length() == 0) {</span>
<span class="nc" id="L96">      SysErrLogger.FAKE_LOGGER.syserr(&quot;Password to crypt:&quot;);</span>
<span class="nc" id="L97">      final String newp = waarpPassword.readString();</span>
<span class="nc bnc" id="L98" title="All 4 branches missed.">      if (newp == null || newp.length() == 0) {</span>
<span class="nc" id="L99">        SysErrLogger.FAKE_LOGGER.syserr(&quot;No password as input&quot;);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (DetectionUtils.isJunit()) {</span>
<span class="nc" id="L101">          return;</span>
        }
<span class="nc" id="L103">        System.exit(4);//NOSONAR</span>
      }
<span class="nc" id="L105">      waarpPassword.setClearPassword(newp);</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">      if (po != null) {</span>
<span class="nc" id="L107">        waarpPassword.setPasswordFile(new File(po));</span>
<span class="nc" id="L108">        waarpPassword.savePasswordFile();</span>
      }
<span class="nc bnc" id="L110" title="All 2 branches missed.">      if (clearPasswordView) {</span>
<span class="nc" id="L111">        SysErrLogger.FAKE_LOGGER</span>
<span class="nc" id="L112">            .syserr(&quot;ClearPwd: &quot; + waarpPassword.getClearPassword());</span>
<span class="nc" id="L113">        SysErrLogger.FAKE_LOGGER</span>
<span class="nc" id="L114">            .syserr(&quot;CryptedPwd: &quot; + waarpPassword.getCryptedPassword());</span>
      }
    }
<span class="fc" id="L117">  }</span>

  public static boolean loadOptions(String[] args) {
<span class="fc" id="L120">    desModel = true;</span>
<span class="fc" id="L121">    clearPasswordView = false;</span>
<span class="fc" id="L122">    ki = null;</span>
<span class="fc" id="L123">    ko = null;</span>
<span class="fc" id="L124">    pi = null;</span>
<span class="fc" id="L125">    po = null;</span>
<span class="fc" id="L126">    pwd = null;</span>
<span class="fc" id="L127">    cpwd = null;</span>

    int i;
<span class="fc bfc" id="L130" title="All 2 branches covered.">    if (args.length == 0) {</span>
<span class="fc" id="L131">      SysErrLogger.FAKE_LOGGER.syserr(HELPOPTIONS);</span>
<span class="fc" id="L132">      return false;</span>
    }
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">    if (!SystemPropertyUtil.isFileEncodingCorrect()) {</span>
<span class="nc" id="L135">      SysErrLogger.FAKE_LOGGER.syserr(</span>
          &quot;Issue while trying to set UTF-8 as default file encoding: use -Dfile.encoding=UTF-8 as java command argument\n&quot; +
          &quot;Currently file.encoding is: &quot; +
<span class="nc" id="L138">          SystemPropertyUtil.get(SystemPropertyUtil.FILE_ENCODING));</span>
<span class="nc" id="L139">      return false;</span>
    }
<span class="fc bfc" id="L141" title="All 2 branches covered.">    for (i = 0; i &lt; args.length; i++) {</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">      if (&quot;-ki&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L143">        i++;</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">        if (i &lt; args.length) {</span>
<span class="fc" id="L145">          ki = args[i];</span>
        } else {
<span class="nc" id="L147">          SysErrLogger.FAKE_LOGGER.syserr(&quot;-ki needs a file as argument&quot;);</span>
<span class="nc" id="L148">          return false;</span>
        }
<span class="fc bfc" id="L150" title="All 2 branches covered.">      } else if (&quot;-ko&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L151">        i++;</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">        if (i &lt; args.length) {</span>
<span class="fc" id="L153">          ko = args[i];</span>
        } else {
<span class="nc" id="L155">          SysErrLogger.FAKE_LOGGER.syserr(&quot;-ko needs a file as argument&quot;);</span>
<span class="nc" id="L156">          return false;</span>
        }
<span class="fc bfc" id="L158" title="All 2 branches covered.">      } else if (&quot;-pi&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L159">        i++;</span>
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">        if (i &lt; args.length) {</span>
<span class="fc" id="L161">          pi = args[i];</span>
        } else {
<span class="nc" id="L163">          SysErrLogger.FAKE_LOGGER.syserr(&quot;-pi needs a file as argument&quot;);</span>
<span class="nc" id="L164">          return false;</span>
        }
<span class="fc bfc" id="L166" title="All 2 branches covered.">      } else if (&quot;-po&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L167">        i++;</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">        if (i &lt; args.length) {</span>
<span class="fc" id="L169">          po = args[i];</span>
        } else {
<span class="nc" id="L171">          SysErrLogger.FAKE_LOGGER.syserr(&quot;-po needs a file as argument&quot;);</span>
<span class="nc" id="L172">          return false;</span>
        }
<span class="fc bfc" id="L174" title="All 2 branches covered.">      } else if (&quot;-des&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L175">        desModel = true;</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">      } else if (&quot;-blf&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L177">        desModel = false;</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">      } else if (&quot;-pwd&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L179">        i++;</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">        if (i &lt; args.length) {</span>
<span class="fc" id="L181">          pwd = args[i];</span>
        } else {
<span class="nc" id="L183">          SysErrLogger.FAKE_LOGGER.syserr(&quot;-pwd needs a password as argument&quot;);</span>
<span class="nc" id="L184">          return false;</span>
        }
<span class="fc bfc" id="L186" title="All 2 branches covered.">      } else if (&quot;-cpwd&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L187">        i++;</span>
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">        if (i &lt; args.length) {</span>
<span class="fc" id="L189">          cpwd = args[i];</span>
        } else {
<span class="nc" id="L191">          SysErrLogger.FAKE_LOGGER</span>
<span class="nc" id="L192">              .syserr(&quot;-cpwd needs a crypted password as argument&quot;);</span>
<span class="nc" id="L193">          return false;</span>
        }
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">      } else if (&quot;-clear&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L196">        clearPasswordView = true;</span>
      } else {
<span class="nc" id="L198">        SysErrLogger.FAKE_LOGGER.syserr(&quot;Unknown option: &quot; + args[i]);</span>
<span class="nc" id="L199">        return false;</span>
      }
    }
<span class="pc bpc" id="L202" title="1 of 4 branches missed.">    if (ki == null &amp;&amp; ko == null) {</span>
<span class="nc" id="L203">      SysErrLogger.FAKE_LOGGER</span>
<span class="nc" id="L204">          .syserr(&quot;You must specify one of ki or ko options&quot;);</span>
<span class="nc" id="L205">      return false;</span>
    }
<span class="fc bfc" id="L207" title="All 2 branches covered.">    if (ki == null) {</span>
<span class="fc" id="L208">      ki = ko;</span>
    }
<span class="pc bpc" id="L210" title="5 of 6 branches missed.">    if (ki == null &amp;&amp; (po != null || pi != null)) {</span>
<span class="nc" id="L211">      SysErrLogger.FAKE_LOGGER.syserr(</span>
          &quot;If pi or po options are set, ki or ko options must be set also!\n&quot;);
<span class="nc" id="L213">      return false;</span>
    }
<span class="pc bpc" id="L215" title="2 of 8 branches missed.">    if (pi == null &amp;&amp; po == null &amp;&amp; (pwd != null || cpwd != null)) {</span>
<span class="nc" id="L216">      SysErrLogger.FAKE_LOGGER.syserr(</span>
          &quot;Cannot create a password if no password GGP file is specified with pi or po options&quot;);
<span class="nc" id="L218">      return false;</span>
    }
<span class="fc" id="L220">    return true;</span>
  }

<span class="fc" id="L223">  public WaarpPassword() throws Exception {</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">    if (desModel) {</span>
<span class="fc" id="L225">      currentKey = new Des();</span>
    } else {
<span class="fc" id="L227">      currentKey = new Blowfish();</span>
    }
<span class="fc bfc" id="L229" title="All 2 branches covered.">    if (ko != null) {</span>
<span class="fc" id="L230">      createNewKey();</span>
<span class="fc" id="L231">      saveKey(new File(ko));</span>
    }
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">    if (ki != null) {</span>
<span class="fc" id="L234">      loadKey(new File(ki));</span>
    }
<span class="fc bfc" id="L236" title="All 2 branches covered.">    if (pi != null) {</span>
<span class="fc" id="L237">      setPasswordFile(new File(pi));</span>
<span class="fc" id="L238">      loadPasswordFile();</span>
    }
<span class="fc bfc" id="L240" title="All 2 branches covered.">    if (pwd != null) {</span>
<span class="fc" id="L241">      setClearPassword(pwd);</span>
    }
<span class="fc bfc" id="L243" title="All 2 branches covered.">    if (cpwd != null) {</span>
<span class="fc" id="L244">      setCryptedPassword(cpwd);</span>
    }
<span class="fc bfc" id="L246" title="All 2 branches covered.">    if (po != null) {</span>
<span class="fc" id="L247">      setPasswordFile(new File(po));</span>
<span class="fc" id="L248">      savePasswordFile();</span>
    }
<span class="fc bfc" id="L250" title="All 2 branches covered.">    if (clearPassword != null) {</span>
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">      if (clearPasswordView) {</span>
<span class="fc" id="L252">        SysErrLogger.FAKE_LOGGER.syserr(&quot;ClearPwd: &quot; + getClearPassword());</span>
      }
<span class="fc" id="L254">      SysErrLogger.FAKE_LOGGER.syserr(&quot;CryptedPwd: &quot; + getCryptedPassword());</span>
    }
<span class="fc" id="L256">  }</span>

  private String readString() {
<span class="nc" id="L259">    String read = &quot;&quot;;</span>
<span class="nc" id="L260">    final InputStreamReader input =</span>
        new InputStreamReader(System.in, WaarpStringUtils.UTF8);
<span class="nc" id="L262">    final BufferedReader reader = new BufferedReader(input);</span>
    try {
<span class="nc" id="L264">      read = reader.readLine();</span>
<span class="nc" id="L265">    } catch (final IOException e) {</span>
<span class="nc" id="L266">      SysErrLogger.FAKE_LOGGER.syserr(e);</span>
<span class="nc" id="L267">    }</span>
<span class="nc" id="L268">    return read;</span>
  }

  /**
   * Create a new Key but do not save it on file
   *
   * @throws Exception
   */
  public void createNewKey() throws Exception {
    try {
<span class="fc" id="L278">      currentKey.generateKey();</span>
<span class="nc" id="L279">    } catch (final Exception e) {</span>
<span class="nc" id="L280">      throw new CryptoException(&quot;Create New Key in error&quot;, e);</span>
<span class="fc" id="L281">    }</span>
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">    if (clearPassword != null) {</span>
<span class="nc" id="L283">      setClearPassword(clearPassword);</span>
    }
<span class="fc" id="L285">  }</span>

  /**
   * @param file source file
   *
   * @throws CryptoException
   */
  public void loadKey(File file) throws CryptoException {
<span class="fc" id="L293">    keyFile = file;</span>
    try {
<span class="fc" id="L295">      currentKey.setSecretKey(file);</span>
<span class="nc" id="L296">    } catch (final IOException e) {</span>
<span class="nc" id="L297">      throw new CryptoException(&quot;Load Key in error&quot;, e);</span>
<span class="fc" id="L298">    }</span>
<span class="fc" id="L299">  }</span>

  /**
   * @param file destination file, if null previously set file is used
   *
   * @throws CryptoException
   */
  public void saveKey(File file) throws CryptoException {
<span class="pc bpc" id="L307" title="1 of 2 branches missed.">    if (file != null) {</span>
<span class="fc" id="L308">      keyFile = file;</span>
    }
    try {
<span class="fc" id="L311">      currentKey.saveSecretKey(keyFile);</span>
<span class="nc" id="L312">    } catch (final IOException e) {</span>
<span class="nc" id="L313">      throw new CryptoException(&quot;Save Key in error&quot;, e);</span>
<span class="fc" id="L314">    }</span>
<span class="fc" id="L315">  }</span>

  /**
   * @return True if the associated key is ready
   */
  public boolean keyReady() {
<span class="nc" id="L321">    return currentKey.keyReady();</span>
  }

  /**
   * @return The File associated with the current Key
   */
  public File getKeyFile() {
<span class="nc" id="L328">    return keyFile;</span>
  }

  /**
   * Set the new password and its crypted value
   *
   * @param passwd
   *
   * @throws Exception
   */
  public void setClearPassword(String passwd) throws Exception {
<span class="fc" id="L339">    clearPassword = passwd;</span>
<span class="fc" id="L340">    cryptedPassword = currentKey.cryptToHex(clearPassword);</span>
<span class="fc" id="L341">  }</span>

  /**
   * @return the passwordFile
   */
  public File getPasswordFile() {
<span class="nc" id="L347">    return passwordFile;</span>
  }

  /**
   * @param passwordFile the passwordFile to set
   *
   * @throws IOException
   */
  public void setPasswordFile(File passwordFile) {
<span class="fc" id="L356">    this.passwordFile = passwordFile;</span>
<span class="fc" id="L357">  }</span>

  /**
   * Save the Crypted Paswword to the File
   *
   * @throws IOException
   */
  public void savePasswordFile() throws IOException {
<span class="fc" id="L365">    final FileOutputStream outputStream = new FileOutputStream(passwordFile);</span>
    try {
<span class="fc" id="L367">      outputStream.write(cryptedPassword.getBytes(WaarpStringUtils.UTF8));</span>
    } finally {
<span class="fc" id="L369">      FileUtils.close(outputStream);</span>
    }
<span class="fc" id="L371">  }</span>

  /**
   * Load the crypted password from the file
   *
   * @throws Exception
   */
  public void loadPasswordFile() throws Exception {
<span class="pc bpc" id="L379" title="1 of 2 branches missed.">    if (passwordFile.canRead()) {</span>
<span class="fc" id="L380">      final int len = (int) passwordFile.length();</span>
<span class="fc" id="L381">      final byte[] key = new byte[len];</span>
      FileInputStream inputStream;
<span class="fc" id="L383">      inputStream = new FileInputStream(passwordFile);</span>
<span class="fc" id="L384">      DataInputStream dis = null;</span>
      try {
<span class="fc" id="L386">        dis = new DataInputStream(inputStream);</span>
<span class="fc" id="L387">        dis.readFully(key);</span>
      } finally {
<span class="pc bpc" id="L389" title="1 of 2 branches missed.">        if (dis != null) {</span>
<span class="fc" id="L390">          FileUtils.close(dis);</span>
        } else {
<span class="nc" id="L392">          FileUtils.close(inputStream);</span>
        }
      }
<span class="fc" id="L395">      setCryptedPassword(new String(key, WaarpStringUtils.UTF8));</span>
<span class="fc" id="L396">    } else {</span>
<span class="nc" id="L397">      throw new CryptoException(&quot;Cannot read crypto file&quot;);</span>
    }
<span class="fc" id="L399">  }</span>

  /**
   * @return the cryptedPassword
   */
  public String getCryptedPassword() {
<span class="fc" id="L405">    return cryptedPassword;</span>
  }

  /**
   * @param cryptedPassword the cryptedPassword to set
   *
   * @throws Exception
   */
  public void setCryptedPassword(String cryptedPassword) throws Exception {
<span class="fc" id="L414">    this.cryptedPassword = cryptedPassword;</span>
<span class="fc" id="L415">    clearPassword = currentKey.decryptHexInString(cryptedPassword);</span>
<span class="fc" id="L416">  }</span>

  /**
   * @return the clearPassword
   */
  public String getClearPassword() {
<span class="fc" id="L422">    return clearPassword;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>