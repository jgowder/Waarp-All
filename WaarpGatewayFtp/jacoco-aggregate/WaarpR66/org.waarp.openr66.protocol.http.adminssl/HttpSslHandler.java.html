<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>HttpSslHandler.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">Waarp Gateway Ftp</a> &gt; <a href="../index.html" class="el_bundle">WaarpR66</a> &gt; <a href="index.source.html" class="el_package">org.waarp.openr66.protocol.http.adminssl</a> &gt; <span class="el_source">HttpSslHandler.java</span></div><h1>HttpSslHandler.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.openr66.protocol.http.adminssl;

import io.netty.buffer.ByteBuf;
import io.netty.buffer.Unpooled;
import io.netty.channel.Channel;
import io.netty.channel.ChannelFuture;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.SimpleChannelInboundHandler;
import io.netty.handler.codec.http.DefaultFullHttpResponse;
import io.netty.handler.codec.http.FullHttpRequest;
import io.netty.handler.codec.http.FullHttpResponse;
import io.netty.handler.codec.http.HttpHeaderNames;
import io.netty.handler.codec.http.HttpHeaderValues;
import io.netty.handler.codec.http.HttpMethod;
import io.netty.handler.codec.http.HttpResponse;
import io.netty.handler.codec.http.HttpResponseStatus;
import io.netty.handler.codec.http.HttpUtil;
import io.netty.handler.codec.http.HttpVersion;
import io.netty.handler.codec.http.QueryStringDecoder;
import io.netty.handler.codec.http.cookie.Cookie;
import io.netty.handler.codec.http.cookie.DefaultCookie;
import io.netty.handler.codec.http.cookie.ServerCookieDecoder;
import io.netty.handler.codec.http.cookie.ServerCookieEncoder;
import io.netty.handler.traffic.TrafficCounter;
import org.waarp.common.command.exception.Reply421Exception;
import org.waarp.common.command.exception.Reply530Exception;
import org.waarp.common.crypto.ssl.WaarpSslUtility;
import org.waarp.common.database.DbAdmin;
import org.waarp.common.database.DbPreparedStatement;
import org.waarp.common.database.DbSession;
import org.waarp.common.database.exception.WaarpDatabaseException;
import org.waarp.common.database.exception.WaarpDatabaseNoConnectionException;
import org.waarp.common.database.exception.WaarpDatabaseSqlException;
import org.waarp.common.digest.FilesystemBasedDigest;
import org.waarp.common.exception.FileTransferException;
import org.waarp.common.exception.InvalidArgumentException;
import org.waarp.common.file.DirInterface;
import org.waarp.common.logging.WaarpLogLevel;
import org.waarp.common.logging.WaarpLogger;
import org.waarp.common.logging.WaarpLoggerFactory;
import org.waarp.common.role.RoleDefault.ROLE;
import org.waarp.common.utility.ParametersChecker;
import org.waarp.common.utility.ThreadLocalRandom;
import org.waarp.common.utility.Version;
import org.waarp.common.utility.WaarpShutdownHook;
import org.waarp.common.utility.WaarpStringUtils;
import org.waarp.gateway.kernel.http.HttpWriteCacheEnable;
import org.waarp.openr66.client.Message;
import org.waarp.openr66.context.ErrorCode;
import org.waarp.openr66.context.R66FiniteDualStates;
import org.waarp.openr66.context.R66Result;
import org.waarp.openr66.context.R66Session;
import org.waarp.openr66.context.task.SpooledInformTask;
import org.waarp.openr66.database.DbConstantR66;
import org.waarp.openr66.database.data.DbHostAuth;
import org.waarp.openr66.database.data.DbHostConfiguration;
import org.waarp.openr66.database.data.DbRule;
import org.waarp.openr66.database.data.DbTaskRunner;
import org.waarp.openr66.protocol.configuration.Configuration;
import org.waarp.openr66.protocol.configuration.Messages;
import org.waarp.openr66.protocol.exception.OpenR66Exception;
import org.waarp.openr66.protocol.exception.OpenR66ExceptionTrappedFactory;
import org.waarp.openr66.protocol.exception.OpenR66ProtocolBusinessException;
import org.waarp.openr66.protocol.exception.OpenR66ProtocolBusinessNoWriteBackException;
import org.waarp.openr66.protocol.localhandler.LocalChannelReference;
import org.waarp.openr66.protocol.localhandler.LocalServerHandler;
import org.waarp.openr66.protocol.localhandler.ServerActions;
import org.waarp.openr66.protocol.localhandler.packet.ErrorPacket;
import org.waarp.openr66.protocol.localhandler.packet.RequestPacket;
import org.waarp.openr66.protocol.localhandler.packet.RequestPacket.TRANSFERMODE;
import org.waarp.openr66.protocol.localhandler.packet.TestPacket;
import org.waarp.openr66.protocol.networkhandler.NetworkTransaction;
import org.waarp.openr66.protocol.utils.ChannelUtils;
import org.waarp.openr66.protocol.utils.NbAndSpecialId;
import org.waarp.openr66.protocol.utils.R66Future;
import org.waarp.openr66.protocol.utils.TransferUtils;

import java.io.IOException;
import java.sql.Timestamp;
import java.util.Arrays;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Set;
import java.util.concurrent.ConcurrentHashMap;

/**
 *
 */
<span class="fc" id="L110">public class HttpSslHandler</span>
    extends SimpleChannelInboundHandler&lt;FullHttpRequest&gt; {
  private static final String XXXLEVEL4XXX = &quot;XXXLEVEL4XXX&quot;;
  private static final String XXXLEVEL3XXX = &quot;XXXLEVEL3XXX&quot;;
  private static final String XXXLEVEL2XXX = &quot;XXXLEVEL2XXX&quot;;
  private static final String XXXLEVEL1XXX = &quot;XXXLEVEL1XXX&quot;;
  private static final String OPEN_R66_WEB_ERROR = &quot;OpenR66 Web Error {}&quot;;
  private static final String HTTP_SSL_HANDLER_MOPS = &quot;HttpSslHandler.MOPS&quot;;
  private static final String HTTP_SSL_HANDLER_LANG_IS =
      &quot;HttpSslHandler.LangIs&quot;;
  private static final String HTTP_SSL_HANDLER_17 = &quot;HttpSslHandler.17&quot;;
  private static final String EXPORT_ERROR = &quot;Export error: {}&quot;;
  private static final String CHECKED = &quot;checked&quot;;
  private static final String HTTP_SSL_HANDLER_NOT_ACTIVE =
      &quot;HttpSslHandler.NotActive&quot;;
  private static final String HTTP_SSL_HANDLER_ACTIVE = &quot;HttpSslHandler.Active&quot;;
  private static final String AN_ERROR_OCCURS_WHILE_ACCESSING_A_RUNNER =
      &quot;An error occurs while accessing a Runner: {}&quot;;
  private static final String ADDRESS = &quot;address&quot;;
  private static final String CREATE = &quot;Create&quot;;
  private static final String ERROR2 = &quot;error&quot;;
  private static final String TRANSFER2 = &quot;transfer&quot;;
  private static final String PENDING2 = &quot;pending&quot;;
  private static final String START2 = &quot;start&quot;;
  private static final String STOPID2 = &quot;stopid&quot;;
  private static final String STARTID2 = &quot;startid&quot;;
  private static final String FILTER = &quot;Filter&quot;;
  private static final String ACTION = &quot;ACTION&quot;;
  private static final String HTTP_SSL_HANDLER_3 = &quot;HttpSslHandler.3&quot;;
  private static final String BR_B = &quot;&lt;br&gt;&lt;b&gt;&quot;;
  private static final String B_CENTER_P = &quot;&lt;/b&gt;&lt;/center&gt;&lt;/p&gt;&quot;;
  /**
   * Internal Logger
   */
<span class="fc" id="L144">  private static final WaarpLogger logger =</span>
<span class="fc" id="L145">      WaarpLoggerFactory.getLogger(HttpSslHandler.class);</span>
  /**
   * Session Management
   */
<span class="fc" id="L149">  protected static final ConcurrentHashMap&lt;String, R66Session&gt; sessions =</span>
      new ConcurrentHashMap&lt;String, R66Session&gt;();
<span class="fc" id="L151">  protected static final ThreadLocalRandom RANDOM = ThreadLocalRandom.current();</span>

<span class="fc" id="L153">  protected R66Session authentHttp = new R66Session();</span>

  protected FullHttpRequest request;
  protected boolean newSession;
  protected volatile Cookie admin;
<span class="fc" id="L158">  protected final StringBuilder responseContent = new StringBuilder();</span>
  protected String uriRequest;
  protected Map&lt;String, List&lt;String&gt;&gt; params;
<span class="fc" id="L161">  protected String lang = Messages.getSlocale();</span>
  protected boolean forceClose;
  protected boolean shutdown;

  protected static final String R66SESSION = &quot;R66SESSION&quot;;
  protected static final String I18NEXT = &quot;i18next&quot;;

<span class="fc" id="L168">  private enum REQUEST {</span>
<span class="fc" id="L169">    Logon(&quot;Logon.html&quot;), Logout(&quot;Logon.html&quot;), index(&quot;index.html&quot;),</span>
<span class="fc" id="L170">    error(&quot;error.html&quot;), unallowed(&quot;NotAllowed.html&quot;),</span>
<span class="fc" id="L171">    Transfers(&quot;Transfers.html&quot;),</span>
<span class="fc" id="L172">    Listing(&quot;Listing_head.html&quot;, &quot;Listing_body0.html&quot;, &quot;Listing_body.html&quot;,</span>
            &quot;Listing_body1.html&quot;, &quot;Listing_end.html&quot;),
<span class="fc" id="L174">    CancelRestart(&quot;CancelRestart_head.html&quot;, &quot;CancelRestart_body0.html&quot;,</span>
                  &quot;CancelRestart_body.html&quot;, &quot;CancelRestart_body1.html&quot;,
<span class="fc" id="L176">                  &quot;CancelRestart_end.html&quot;), Export(&quot;Export.html&quot;),</span>
<span class="fc" id="L177">    Hosts(&quot;Hosts_head.html&quot;, &quot;Hosts_body0.html&quot;, &quot;Hosts_body.html&quot;,</span>
          &quot;Hosts_body1.html&quot;, &quot;Hosts_end.html&quot;),
<span class="fc" id="L179">    Rules(&quot;Rules_head.html&quot;, &quot;Rules_body0.html&quot;, &quot;Rules_body.html&quot;,</span>
<span class="fc" id="L180">          &quot;Rules_body1.html&quot;, &quot;Rules_end.html&quot;), System(&quot;System.html&quot;),</span>
<span class="fc" id="L181">    SystemLimited(&quot;SystemLimited.html&quot;), Spooled(&quot;Spooled.html&quot;),</span>
<span class="fc" id="L182">    SpooledDetailed(&quot;Spooled.html&quot;);</span>

    private final String header;
    private final String headerBody;
    private final String body;
    private final String endBody;
    private final String end;

    /**
     * Constructor for a unique file
     *
     * @param uniquefile
     */
<span class="fc" id="L195">    REQUEST(String uniquefile) {</span>
<span class="fc" id="L196">      header = uniquefile;</span>
<span class="fc" id="L197">      headerBody = null;</span>
<span class="fc" id="L198">      body = null;</span>
<span class="fc" id="L199">      endBody = null;</span>
<span class="fc" id="L200">      end = null;</span>
<span class="fc" id="L201">    }</span>

    /**
     * @param header
     * @param headerBody
     * @param body
     * @param endBody
     * @param end
     */
    REQUEST(String header, String headerBody, String body, String endBody,
<span class="fc" id="L211">            String end) {</span>
<span class="fc" id="L212">      this.header = header;</span>
<span class="fc" id="L213">      this.headerBody = headerBody;</span>
<span class="fc" id="L214">      this.body = body;</span>
<span class="fc" id="L215">      this.endBody = endBody;</span>
<span class="fc" id="L216">      this.end = end;</span>
<span class="fc" id="L217">    }</span>

    /**
     * Reader for a unique file
     *
     * @return the content of the unique file
     */
    public String readFileUnique(HttpSslHandler handler) {
<span class="fc" id="L225">      return handler.readFileHeader(</span>
<span class="fc" id="L226">          Configuration.configuration.getHttpBasePath() + header);</span>
    }

    public String readHeader(HttpSslHandler handler) {
<span class="fc" id="L230">      return handler.readFileHeader(</span>
<span class="fc" id="L231">          Configuration.configuration.getHttpBasePath() + header);</span>
    }

    public String readBodyHeader() {
<span class="fc" id="L235">      return WaarpStringUtils</span>
<span class="fc" id="L236">          .readFile(Configuration.configuration.getHttpBasePath() + headerBody);</span>
    }

    public String readBody() {
<span class="fc" id="L240">      return WaarpStringUtils</span>
<span class="fc" id="L241">          .readFile(Configuration.configuration.getHttpBasePath() + body);</span>
    }

    public String readBodyEnd() {
<span class="fc" id="L245">      return WaarpStringUtils</span>
<span class="fc" id="L246">          .readFile(Configuration.configuration.getHttpBasePath() + endBody);</span>
    }

    public String readEnd() {
<span class="fc" id="L250">      return WaarpStringUtils</span>
<span class="fc" id="L251">          .readFile(Configuration.configuration.getHttpBasePath() + end);</span>
    }
  }

<span class="fc" id="L255">  protected enum REPLACEMENT {</span>
<span class="fc" id="L256">    XXXHOSTIDXXX, XXXADMINXXX, XXXVERSIONXXX, XXXBANDWIDTHXXX,</span>
<span class="fc" id="L257">    XXXBANDWIDTHINXXX, XXXBANDWIDTHOUTXXX, XXXXSESSIONLIMITRXXX,</span>
<span class="fc" id="L258">    XXXXSESSIONLIMITWXXX, XXXXCHANNELLIMITRXXX, XXXXCHANNELLIMITWXXX,</span>
<span class="fc" id="L259">    XXXXDELAYCOMMDXXX, XXXXDELAYRETRYXXX, XXXXDELATRAFFICXXX, XXXLOCALXXX,</span>
<span class="fc" id="L260">    XXXNETWORKXXX, XXXNBTRANSFERSXXX, XXXERRORMESGXXX, XXXXBUSINESSXXX,</span>
<span class="fc" id="L261">    XXXXROLESXXX, XXXXALIASESXXX, XXXXOTHERXXX, XXXLIMITROWXXX, XXXREFRESHXXX,</span>
<span class="fc" id="L262">    XXXLANGXXX, XXXCURLANGENXXX, XXXCURLANGFRXXX, XXXCURSYSLANGENXXX,</span>
<span class="fc" id="L263">    XXXCURSYSLANGFRXXX</span>
  }

  public static final String sLIMITROW = &quot;LIMITROW&quot;;
  static final String XXXRESULTXXX = &quot;XXXRESULTXXX&quot;;

<span class="fc" id="L269">  private int limitRow = 48; // better if it can</span>
  // be divided by 4
  private int refresh;

  /**
   * The Database connection attached to this NetworkChannelReference shared
   * among all associated LocalChannels
   * in the session
   */
  DbSession dbSession;

  public static String hashStatus() {
<span class="nc" id="L281">    return &quot;HttpSslHandler: [sessions: &quot; + sessions.size() + &quot;] &quot;;</span>
  }

  String readFileHeader(String filename) {
    String value;
    try {
<span class="fc" id="L287">      value = WaarpStringUtils.readFileException(filename);</span>
<span class="nc" id="L288">    } catch (final InvalidArgumentException e) {</span>
<span class="nc" id="L289">      logger.error(&quot;Error while trying to open: &quot; + filename, e);</span>
<span class="nc" id="L290">      return &quot;&quot;;</span>
<span class="nc" id="L291">    } catch (final FileTransferException e) {</span>
<span class="nc" id="L292">      logger.error(&quot;Error while trying to read: &quot; + filename, e);</span>
<span class="nc" id="L293">      return &quot;&quot;;</span>
<span class="fc" id="L294">    }</span>
<span class="fc" id="L295">    final StringBuilder builder = new StringBuilder(value);</span>
<span class="fc" id="L296">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXLOCALXXX.toString(),</span>
<span class="fc" id="L297">                             Configuration.configuration.getLocalTransaction()</span>
<span class="fc" id="L298">                                                        .getNumberLocalChannel() +</span>
<span class="fc" id="L299">                             &quot; Thread(&quot; + Thread.activeCount() + ')');</span>
<span class="fc" id="L300">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXNETWORKXXX.toString(),</span>
<span class="fc" id="L301">                             Integer.toString(DbAdmin.getNbConnection() -</span>
<span class="fc" id="L302">                                              Configuration.getNbDbSession()));</span>
<span class="fc" id="L303">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXNBTRANSFERSXXX.toString(),</span>
<span class="fc" id="L304">                             Long.toString(Configuration.configuration</span>
<span class="fc" id="L305">                                               .getMonitoring().nbCountAllRunningStep));</span>
<span class="fc" id="L306">    WaarpStringUtils.replaceAll(builder, REPLACEMENT.XXXHOSTIDXXX.toString(),</span>
<span class="fc" id="L307">                                Configuration.configuration.getHostId());</span>
<span class="fc bfc" id="L308" title="All 2 branches covered.">    if (authentHttp.isAuthenticated()) {</span>
<span class="fc" id="L309">      WaarpStringUtils.replace(builder, REPLACEMENT.XXXADMINXXX.toString(),</span>
<span class="fc" id="L310">                               Messages.getString(</span>
                                   &quot;HttpSslHandler.1&quot;)); //$NON-NLS-1$
    } else {
<span class="fc" id="L313">      WaarpStringUtils.replace(builder, REPLACEMENT.XXXADMINXXX.toString(),</span>
<span class="fc" id="L314">                               Messages.getString(</span>
                                   &quot;HttpSslHandler.0&quot;)); //$NON-NLS-1$
    }
<span class="fc" id="L317">    final TrafficCounter trafficCounter =</span>
<span class="fc" id="L318">        Configuration.configuration.getGlobalTrafficShapingHandler()</span>
<span class="fc" id="L319">                                   .trafficCounter();</span>
<span class="fc" id="L320">    final long read = trafficCounter.lastReadThroughput();</span>
<span class="fc" id="L321">    final long write = trafficCounter.lastWriteThroughput();</span>
<span class="fc" id="L322">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXBANDWIDTHXXX.toString(),</span>
<span class="fc" id="L323">                             Messages.getString(&quot;HttpSslHandler.IN&quot;) +</span>
                             (read &gt;&gt; 20) + //$NON-NLS-1$
<span class="fc" id="L325">                             Messages.getString(HTTP_SSL_HANDLER_MOPS) +</span>
                             //$NON-NLS-1$
<span class="fc" id="L327">                             Messages.getString(&quot;HttpSslHandler.OUT&quot;) +</span>
                             //$NON-NLS-1$
<span class="fc" id="L329">                             (write &gt;&gt; 20) + Messages.getString(</span>
                                 HTTP_SSL_HANDLER_MOPS)); //$NON-NLS-1$
<span class="fc" id="L331">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXBANDWIDTHINXXX.toString(),</span>
<span class="fc" id="L332">                             (read &gt;&gt; 20) + Messages.getString(</span>
                                 HTTP_SSL_HANDLER_MOPS)); //$NON-NLS-1$
<span class="fc" id="L334">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXBANDWIDTHOUTXXX.toString(),</span>
<span class="fc" id="L335">                             (write &gt;&gt; 20) + Messages.getString(</span>
                                 HTTP_SSL_HANDLER_MOPS)); //$NON-NLS-1$
<span class="fc" id="L337">    WaarpStringUtils.replaceAll(builder, REPLACEMENT.XXXLIMITROWXXX.toString(),</span>
<span class="fc" id="L338">                                String.valueOf(getLimitRow()));</span>
<span class="fc" id="L339">    WaarpStringUtils.replaceAll(builder, REPLACEMENT.XXXREFRESHXXX.toString(),</span>
<span class="fc" id="L340">                                String.valueOf(getRefresh() / 1000));</span>
<span class="fc" id="L341">    WaarpStringUtils</span>
<span class="fc" id="L342">        .replaceAll(builder, REPLACEMENT.XXXLANGXXX.toString(), lang);</span>
<span class="fc" id="L343">    return builder.toString();</span>
  }

  protected String getTrimValue(String varname) {
<span class="fc" id="L347">    final List&lt;String&gt; varlist = params.get(varname);</span>
<span class="pc bpc" id="L348" title="2 of 4 branches missed.">    if (varlist != null &amp;&amp; !varlist.isEmpty()) {</span>
<span class="fc" id="L349">      String value = params.get(varname).get(0).trim();</span>
<span class="fc bfc" id="L350" title="All 2 branches covered.">      if (value.isEmpty()) {</span>
<span class="fc" id="L351">        value = null;</span>
      }
<span class="fc" id="L353">      return value;</span>
    }
<span class="nc" id="L355">    return null;</span>
  }

  String getValue(String varname) {
<span class="fc" id="L359">    return params.get(varname).get(0);</span>
  }

  private String index() {
<span class="fc" id="L363">    final String index = REQUEST.index.readFileUnique(this);</span>
<span class="fc" id="L364">    final StringBuilder builder = new StringBuilder(index);</span>
<span class="fc" id="L365">    WaarpStringUtils.replaceAll(builder, REPLACEMENT.XXXHOSTIDXXX.toString(),</span>
<span class="fc" id="L366">                                Configuration.configuration.getHostId());</span>
<span class="fc" id="L367">    WaarpStringUtils.replaceAll(builder, REPLACEMENT.XXXADMINXXX.toString(),</span>
<span class="fc" id="L368">                                Messages.getString(</span>
                                    &quot;HttpSslHandler.2&quot;)); //$NON-NLS-1$
<span class="fc" id="L370">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXVERSIONXXX.toString(),</span>
<span class="fc" id="L371">                             Version.fullIdentifier());</span>
<span class="fc" id="L372">    return builder.toString();</span>
  }

  protected String error(String mesg) {
<span class="nc" id="L376">    final String index = REQUEST.error.readFileUnique(this);</span>
<span class="nc" id="L377">    return index.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(), mesg);</span>
  }

  private String unallowed(String mesg) {
<span class="fc" id="L381">    final String index = REQUEST.unallowed.readFileUnique(this);</span>
<span class="pc bpc" id="L382" title="2 of 4 branches missed.">    if (index == null || index.isEmpty()) {</span>
<span class="nc" id="L383">      return error(mesg);</span>
    }
<span class="fc" id="L385">    return index.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(), mesg);</span>
  }

  protected String logon() {
<span class="fc" id="L389">    return REQUEST.Logon.readFileUnique(this);</span>
  }

  private String transfers() {
<span class="fc" id="L393">    return REQUEST.Transfers.readFileUnique(this);</span>
  }

  String resetOptionTransfer(String header, String startid, String stopid,
                             String start, String stop, String rule, String req,
                             boolean pending, boolean transfer, boolean error,
                             boolean done, boolean all) {
<span class="fc" id="L400">    final StringBuilder builder = new StringBuilder(header);</span>
<span class="fc" id="L401">    WaarpStringUtils.replace(builder, &quot;XXXSTARTIDXXX&quot;, startid);</span>
<span class="fc" id="L402">    WaarpStringUtils.replace(builder, &quot;XXXSTOPIDXXX&quot;, stopid);</span>
<span class="fc" id="L403">    WaarpStringUtils.replace(builder, &quot;XXXSTARTXXX&quot;, start);</span>
<span class="fc" id="L404">    WaarpStringUtils.replace(builder, &quot;XXXSTOPXXX&quot;, stop);</span>
<span class="fc" id="L405">    WaarpStringUtils.replace(builder, &quot;XXXRULEXXX&quot;, rule);</span>
<span class="fc" id="L406">    WaarpStringUtils.replace(builder, &quot;XXXREQXXX&quot;, req);</span>
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">    WaarpStringUtils.replace(builder, &quot;XXXPENDXXX&quot;, pending? CHECKED : &quot;&quot;);</span>
<span class="pc bpc" id="L408" title="1 of 2 branches missed.">    WaarpStringUtils.replace(builder, &quot;XXXTRANSXXX&quot;, transfer? CHECKED : &quot;&quot;);</span>
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">    WaarpStringUtils.replace(builder, &quot;XXXERRXXX&quot;, error? CHECKED : &quot;&quot;);</span>
<span class="fc bfc" id="L410" title="All 2 branches covered.">    WaarpStringUtils.replace(builder, &quot;XXXDONEXXX&quot;, done? CHECKED : &quot;&quot;);</span>
<span class="fc bfc" id="L411" title="All 2 branches covered.">    WaarpStringUtils.replace(builder, &quot;XXXALLXXX&quot;, all? CHECKED : &quot;&quot;);</span>
<span class="fc" id="L412">    return builder.toString();</span>
  }

  String checkAuthorizedToSeeAll() {
<span class="fc" id="L416">    boolean seeAll = false;</span>
<span class="pc bpc" id="L417" title="1 of 2 branches missed.">    if (authentHttp.getAuth().isValidRole(ROLE.CONFIGADMIN)) {</span>
      DbHostConfiguration dbhc;
      try {
<span class="fc" id="L420">        dbhc = new DbHostConfiguration(Configuration.configuration.getHostId());</span>
<span class="nc" id="L421">      } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L422">        return null;</span>
<span class="fc" id="L423">      }</span>
<span class="pc bpc" id="L424" title="2 of 4 branches missed.">      seeAll = dbhc != null &amp;&amp; dbhc.isSeeAllId(authentHttp.getAuth().getUser());</span>
    }
<span class="pc bpc" id="L426" title="1 of 2 branches missed.">    if (seeAll) {</span>
<span class="nc" id="L427">      return &quot;*&quot;;</span>
    }
<span class="fc" id="L429">    return null;</span>
  }

  private String listing0() {
<span class="fc" id="L433">    getParams();</span>
<span class="fc bfc" id="L434" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L435">      String head = REQUEST.Listing.readHeader(this);</span>
<span class="fc" id="L436">      head =</span>
<span class="fc" id="L437">          resetOptionTransfer(head, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false, false,</span>
                              false, true);
<span class="fc" id="L439">      final String end = REQUEST.Listing.readEnd().replace(XXXRESULTXXX, &quot;&quot;);</span>
<span class="fc" id="L440">      return head + end;</span>
    }
<span class="fc" id="L442">    String head = REQUEST.Listing.readHeader(this);</span>
    String body0;
    String body;
    String body1;
<span class="fc" id="L446">    body0 = body1 = body = &quot;&quot;;</span>
<span class="fc" id="L447">    StringBuilder endText = new StringBuilder();</span>
<span class="fc" id="L448">    final List&lt;String&gt; parms = params.get(ACTION);</span>
<span class="pc bpc" id="L449" title="1 of 2 branches missed.">    if (parms != null) {</span>
<span class="fc" id="L450">      body0 = REQUEST.Listing.readBodyHeader();</span>
<span class="fc" id="L451">      final String parm = parms.get(0);</span>
<span class="pc bpc" id="L452" title="1 of 2 branches missed.">      final boolean isNotReload = !&quot;Reload&quot;.equalsIgnoreCase(parm);</span>
<span class="pc bpc" id="L453" title="3 of 4 branches missed.">      if (FILTER.equalsIgnoreCase(parm) || !isNotReload) {</span>
<span class="fc" id="L454">        String startid = getTrimValue(STARTID2);</span>
<span class="fc" id="L455">        String stopid = getTrimValue(STOPID2);</span>
<span class="pc bpc" id="L456" title="4 of 6 branches missed.">        if (isNotReload &amp;&amp; startid != null &amp;&amp; stopid == null) {</span>
<span class="nc" id="L457">          stopid = Long.MAX_VALUE + &quot;&quot;;</span>
        }
<span class="pc bpc" id="L459" title="4 of 6 branches missed.">        if (isNotReload &amp;&amp; stopid != null &amp;&amp; startid == null) {</span>
<span class="nc" id="L460">          startid = (DbConstantR66.ILLEGALVALUE + 1) + &quot;&quot;;</span>
        }
<span class="fc" id="L462">        String start = getValue(START2);</span>
<span class="fc" id="L463">        String stop = getValue(&quot;stop&quot;);</span>
<span class="fc" id="L464">        final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="fc" id="L465">        final String req = getTrimValue(&quot;req&quot;);</span>
        boolean pending;
        boolean transfer;
        boolean error;
        boolean done;
        boolean all;
<span class="fc" id="L471">        pending = params.containsKey(PENDING2);</span>
<span class="fc" id="L472">        transfer = params.containsKey(TRANSFER2);</span>
<span class="fc" id="L473">        error = params.containsKey(ERROR2);</span>
<span class="fc" id="L474">        done = params.containsKey(&quot;done&quot;);</span>
<span class="fc" id="L475">        all = params.containsKey(&quot;all&quot;);</span>
<span class="pc bpc" id="L476" title="7 of 8 branches missed.">        if (pending &amp;&amp; transfer &amp;&amp; error &amp;&amp; done) {</span>
<span class="nc" id="L477">          all = true;</span>
<span class="pc bpc" id="L478" title="4 of 8 branches missed.">        } else if (!(pending || transfer || error || done)) {</span>
<span class="fc" id="L479">          all = true;</span>
        }
<span class="fc" id="L481">        final Timestamp tstart = WaarpStringUtils.fixDate(start);</span>
<span class="pc bpc" id="L482" title="1 of 2 branches missed.">        if (tstart != null) {</span>
<span class="nc" id="L483">          start = tstart.toString();</span>
        }
<span class="fc" id="L485">        final Timestamp tstop = WaarpStringUtils.fixDate(stop, tstart);</span>
<span class="pc bpc" id="L486" title="1 of 2 branches missed.">        if (tstop != null) {</span>
<span class="nc" id="L487">          stop = tstop.toString();</span>
        }
<span class="fc" id="L489">        Long idstart = null;</span>
<span class="fc" id="L490">        body = REQUEST.Listing.readBody();</span>
<span class="fc" id="L491">        final String seeAll = checkAuthorizedToSeeAll();</span>
<span class="fc" id="L492">        DbPreparedStatement preparedStatement = null;</span>
        try {
<span class="fc" id="L494">          preparedStatement = DbTaskRunner</span>
<span class="fc" id="L495">              .getFilterPrepareStatement(dbSession, getLimitRow(), false,</span>
                                         startid, stopid, tstart, tstop, rule,
                                         req, pending, transfer, error, done,
                                         all, seeAll);
<span class="fc" id="L499">          preparedStatement.executeQuery();</span>
<span class="fc" id="L500">          final StringBuilder builder = new StringBuilder();</span>
<span class="fc" id="L501">          int i = 0;</span>
<span class="pc bpc" id="L502" title="1 of 2 branches missed.">          while (preparedStatement.getNext()) {</span>
            try {
<span class="nc" id="L504">              i++;</span>
<span class="nc" id="L505">              final DbTaskRunner taskRunner =</span>
<span class="nc" id="L506">                  DbTaskRunner.getFromStatementNoRule(preparedStatement);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">              if (isNotReload) {</span>
<span class="nc" id="L508">                final long specid = taskRunner.getSpecialId();</span>
<span class="nc bnc" id="L509" title="All 4 branches missed.">                if (idstart == null || idstart &gt; specid) {</span>
<span class="nc" id="L510">                  idstart = specid;</span>
                }
              }
<span class="nc" id="L513">              final LocalChannelReference lcr =</span>
<span class="nc" id="L514">                  Configuration.configuration.getLocalTransaction()</span>
<span class="nc" id="L515">                                             .getFromRequest(</span>
<span class="nc" id="L516">                                                 taskRunner.getKey());</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">              builder.append(taskRunner.toSpecializedHtml(authentHttp, body,</span>
                                                          lcr != null? Messages
<span class="nc" id="L519">                                                              .getString(</span>
                                                                  HTTP_SSL_HANDLER_ACTIVE) :
                                                              Messages
<span class="nc" id="L522">                                                                  .getString(</span>
                                                                      HTTP_SSL_HANDLER_NOT_ACTIVE)));
<span class="nc bnc" id="L524" title="All 2 branches missed.">              if (i &gt; getLimitRow()) {</span>
<span class="nc" id="L525">                break;</span>
              }
<span class="nc" id="L527">            } catch (final WaarpDatabaseException e) {</span>
              // try to continue if possible
<span class="nc" id="L529">              logger.warn(AN_ERROR_OCCURS_WHILE_ACCESSING_A_RUNNER,</span>
<span class="nc" id="L530">                          e.getMessage());</span>
<span class="nc" id="L531">              endText.append(e.getMessage()).append(&quot;&lt;/BR&gt;&quot;);</span>
<span class="nc" id="L532">            }</span>
          }
<span class="fc" id="L534">          preparedStatement.realClose();</span>
<span class="fc" id="L535">          body = builder.toString();</span>
<span class="nc" id="L536">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">          if (preparedStatement != null) {</span>
<span class="nc" id="L538">            preparedStatement.realClose();</span>
          }
<span class="nc" id="L540">          logger.warn(OPEN_R66_WEB_ERROR, e.getMessage());</span>
<span class="fc" id="L541">        }</span>
<span class="pc bpc" id="L542" title="2 of 4 branches missed.">        head = resetOptionTransfer(head, startid == null?</span>
<span class="pc bpc" id="L543" title="3 of 6 branches missed.">                                       idstart != null? idstart.toString() : &quot;&quot; : startid,</span>
                                   stopid == null? &quot;&quot; : stopid, start, stop,
                                   rule == null? &quot;&quot; : rule,
                                   req == null? &quot;&quot; : req, pending, transfer,
                                   error, done, all);
<span class="fc" id="L548">      } else {</span>
<span class="nc" id="L549">        head = resetOptionTransfer(head, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false,</span>
                                   false, false, true);
      }
<span class="fc" id="L552">      body1 = REQUEST.Listing.readBodyEnd();</span>
<span class="fc" id="L553">    } else {</span>
<span class="nc" id="L554">      head =</span>
<span class="nc" id="L555">          resetOptionTransfer(head, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false, false,</span>
                              false, true);
    }
<span class="fc" id="L558">    final String end =</span>
<span class="fc" id="L559">        REQUEST.Listing.readEnd().replace(XXXRESULTXXX, endText.toString());</span>
<span class="fc" id="L560">    return head + body0 + body + body1 + end;</span>
  }

  private String cancelRestart0() {
<span class="fc" id="L564">    getParams();</span>
<span class="fc bfc" id="L565" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L566">      String head = REQUEST.CancelRestart.readHeader(this);</span>
<span class="fc" id="L567">      head =</span>
<span class="fc" id="L568">          resetOptionTransfer(head, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false, false,</span>
                              false, true);
      String end;
<span class="fc" id="L571">      end = REQUEST.CancelRestart.readEnd();</span>
<span class="fc" id="L572">      return head + end;</span>
    }
<span class="fc" id="L574">    String head = REQUEST.CancelRestart.readHeader(this);</span>
    String body0;
    String body;
    String body1;
<span class="fc" id="L578">    body0 = body1 = body = &quot;&quot;;</span>
<span class="fc" id="L579">    final List&lt;String&gt; parms = params.get(ACTION);</span>
<span class="fc" id="L580">    final String seeAll = checkAuthorizedToSeeAll();</span>
<span class="pc bpc" id="L581" title="1 of 2 branches missed.">    if (parms != null) {</span>
<span class="fc" id="L582">      body0 = REQUEST.CancelRestart.readBodyHeader();</span>
<span class="fc" id="L583">      final String parm = parms.get(0);</span>
<span class="pc bpc" id="L584" title="1 of 2 branches missed.">      final boolean isNotReload = !&quot;Reload&quot;.equalsIgnoreCase(parm);</span>
<span class="pc bpc" id="L585" title="3 of 4 branches missed.">      if (FILTER.equalsIgnoreCase(parm) || !isNotReload) {</span>
<span class="fc" id="L586">        String startid = getTrimValue(STARTID2);</span>
<span class="fc" id="L587">        String stopid = getTrimValue(STOPID2);</span>
<span class="pc bpc" id="L588" title="4 of 6 branches missed.">        if (isNotReload &amp;&amp; startid != null &amp;&amp; stopid == null) {</span>
<span class="nc" id="L589">          stopid = Long.MAX_VALUE + &quot;&quot;;</span>
        }
<span class="pc bpc" id="L591" title="4 of 6 branches missed.">        if (isNotReload &amp;&amp; stopid != null &amp;&amp; startid == null) {</span>
<span class="nc" id="L592">          startid = (DbConstantR66.ILLEGALVALUE + 1) + &quot;&quot;;</span>
        }
<span class="fc" id="L594">        String start = getValue(START2);</span>
<span class="fc" id="L595">        String stop = getValue(&quot;stop&quot;);</span>
<span class="fc" id="L596">        final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="fc" id="L597">        final String req = getTrimValue(&quot;req&quot;);</span>
        boolean pending;
        boolean transfer;
        boolean error;
        boolean done;
        boolean all;
<span class="fc" id="L603">        pending = params.containsKey(PENDING2);</span>
<span class="fc" id="L604">        transfer = params.containsKey(TRANSFER2);</span>
<span class="fc" id="L605">        error = params.containsKey(ERROR2);</span>
<span class="fc" id="L606">        done = params.containsKey(&quot;done&quot;);</span>
<span class="fc" id="L607">        all = params.containsKey(&quot;all&quot;);</span>
<span class="pc bpc" id="L608" title="7 of 8 branches missed.">        if (pending &amp;&amp; transfer &amp;&amp; error &amp;&amp; done) {</span>
<span class="nc" id="L609">          all = true;</span>
<span class="pc bpc" id="L610" title="4 of 8 branches missed.">        } else if (!(pending || transfer || error || done)) {</span>
<span class="fc" id="L611">          all = true;</span>
        }
<span class="fc" id="L613">        final Timestamp tstart = WaarpStringUtils.fixDate(start);</span>
<span class="pc bpc" id="L614" title="1 of 2 branches missed.">        if (tstart != null) {</span>
<span class="nc" id="L615">          start = tstart.toString();</span>
        }
<span class="fc" id="L617">        final Timestamp tstop = WaarpStringUtils.fixDate(stop, tstart);</span>
<span class="pc bpc" id="L618" title="1 of 2 branches missed.">        if (tstop != null) {</span>
<span class="nc" id="L619">          stop = tstop.toString();</span>
        }
<span class="fc" id="L621">        body = REQUEST.CancelRestart.readBody();</span>
<span class="fc" id="L622">        Long idstart = null;</span>
<span class="fc" id="L623">        DbPreparedStatement preparedStatement = null;</span>
        try {
<span class="fc" id="L625">          preparedStatement = DbTaskRunner</span>
<span class="fc" id="L626">              .getFilterPrepareStatement(dbSession, getLimitRow(), false,</span>
                                         startid, stopid, tstart, tstop, rule,
                                         req, pending, transfer, error, done,
                                         all, seeAll);
<span class="fc" id="L630">          preparedStatement.executeQuery();</span>
<span class="fc" id="L631">          final StringBuilder builder = new StringBuilder();</span>
<span class="fc" id="L632">          int i = 0;</span>
<span class="pc bpc" id="L633" title="1 of 2 branches missed.">          while (preparedStatement.getNext()) {</span>
            try {
<span class="nc" id="L635">              i++;</span>
<span class="nc" id="L636">              final DbTaskRunner taskRunner =</span>
<span class="nc" id="L637">                  DbTaskRunner.getFromStatementNoRule(preparedStatement);</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">              if (isNotReload) {</span>
<span class="nc" id="L639">                final long specid = taskRunner.getSpecialId();</span>
<span class="nc bnc" id="L640" title="All 4 branches missed.">                if (idstart == null || idstart &gt; specid) {</span>
<span class="nc" id="L641">                  idstart = specid;</span>
                }
              }
<span class="nc" id="L644">              final LocalChannelReference lcr =</span>
<span class="nc" id="L645">                  Configuration.configuration.getLocalTransaction()</span>
<span class="nc" id="L646">                                             .getFromRequest(</span>
<span class="nc" id="L647">                                                 taskRunner.getKey());</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">              builder.append(taskRunner.toSpecializedHtml(authentHttp, body,</span>
                                                          lcr != null? Messages
<span class="nc" id="L650">                                                              .getString(</span>
                                                                  HTTP_SSL_HANDLER_ACTIVE) :
                                                              Messages
<span class="nc" id="L653">                                                                  .getString(</span>
                                                                      HTTP_SSL_HANDLER_NOT_ACTIVE)));
<span class="nc bnc" id="L655" title="All 2 branches missed.">              if (i &gt; getLimitRow()) {</span>
<span class="nc" id="L656">                break;</span>
              }
<span class="nc" id="L658">            } catch (final WaarpDatabaseException e) {</span>
              // try to continue if possible
<span class="nc" id="L660">              logger.warn(AN_ERROR_OCCURS_WHILE_ACCESSING_A_RUNNER,</span>
<span class="nc" id="L661">                          e.getMessage());</span>
<span class="nc" id="L662">              continue;</span>
<span class="nc" id="L663">            }</span>
          }
<span class="fc" id="L665">          preparedStatement.realClose();</span>
<span class="fc" id="L666">          body = builder.toString();</span>
<span class="nc" id="L667">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc bnc" id="L668" title="All 2 branches missed.">          if (preparedStatement != null) {</span>
<span class="nc" id="L669">            preparedStatement.realClose();</span>
          }
<span class="nc" id="L671">          logger.warn(OPEN_R66_WEB_ERROR, e.getMessage());</span>
<span class="fc" id="L672">        }</span>
<span class="pc bpc" id="L673" title="2 of 4 branches missed.">        head = resetOptionTransfer(head, startid == null?</span>
<span class="pc bpc" id="L674" title="3 of 6 branches missed.">                                       idstart != null? idstart.toString() : &quot;&quot; : startid,</span>
                                   stopid == null? &quot;&quot; : stopid, start, stop,
                                   rule == null? &quot;&quot; : rule,
                                   req == null? &quot;&quot; : req, pending, transfer,
                                   error, done, all);
<span class="fc" id="L679">        body1 = REQUEST.CancelRestart.readBodyEnd();</span>
<span class="pc bnc" id="L680" title="All 2 branches missed.">      } else if (&quot;RestartAll&quot;.equalsIgnoreCase(parm) ||</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">                 &quot;StopAll&quot;.equalsIgnoreCase(parm) ||</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">                 &quot;StopCleanAll&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">        final boolean stopcommand = &quot;StopAll&quot;.equalsIgnoreCase(parm) ||</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">                                    &quot;StopCleanAll&quot;.equalsIgnoreCase(parm);</span>
<span class="nc" id="L685">        final String startid = getTrimValue(STARTID2);</span>
<span class="nc" id="L686">        final String stopid = getTrimValue(STOPID2);</span>
<span class="nc" id="L687">        String start = getValue(START2);</span>
<span class="nc" id="L688">        String stop = getValue(&quot;stop&quot;);</span>
<span class="nc" id="L689">        final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="nc" id="L690">        final String req = getTrimValue(&quot;req&quot;);</span>
        boolean pending;
        boolean transfer;
        boolean error;
        boolean done;
        boolean all;
<span class="nc" id="L696">        pending = params.containsKey(PENDING2);</span>
<span class="nc" id="L697">        transfer = params.containsKey(TRANSFER2);</span>
<span class="nc" id="L698">        error = params.containsKey(ERROR2);</span>
<span class="nc" id="L699">        done = false;</span>
<span class="nc" id="L700">        all = false;</span>
<span class="nc bnc" id="L701" title="All 8 branches missed.">        if (pending &amp;&amp; transfer &amp;&amp; error &amp;&amp; done) {</span>
<span class="nc" id="L702">          all = true;</span>
<span class="nc bnc" id="L703" title="All 8 branches missed.">        } else if (!(pending || transfer || error || done)) {</span>
<span class="nc" id="L704">          all = true;</span>
<span class="nc" id="L705">          pending = true;</span>
<span class="nc" id="L706">          transfer = true;</span>
<span class="nc" id="L707">          error = true;</span>
        }
<span class="nc" id="L709">        final Timestamp tstart = WaarpStringUtils.fixDate(start);</span>
<span class="nc bnc" id="L710" title="All 2 branches missed.">        if (tstart != null) {</span>
<span class="nc" id="L711">          start = tstart.toString();</span>
        }
<span class="nc" id="L713">        final Timestamp tstop = WaarpStringUtils.fixDate(stop, tstart);</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">        if (tstop != null) {</span>
<span class="nc" id="L715">          stop = tstop.toString();</span>
        }
<span class="nc bnc" id="L717" title="All 8 branches missed.">        head = resetOptionTransfer(head, startid == null? &quot;&quot; : startid,</span>
                                   stopid == null? &quot;&quot; : stopid, start, stop,
                                   rule == null? &quot;&quot; : rule,
                                   req == null? &quot;&quot; : req, pending, transfer,
                                   error, done, all);
<span class="nc" id="L722">        body = REQUEST.CancelRestart.readBody();</span>
<span class="nc" id="L723">        final StringBuilder builder = new StringBuilder();</span>
<span class="nc bnc" id="L724" title="All 2 branches missed.">        if (stopcommand) {</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">          if (&quot;StopCleanAll&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L726">            TransferUtils</span>
<span class="nc" id="L727">                .cleanSelectedTransfers(dbSession, 0, builder, authentHttp,</span>
                                        body, startid, stopid, tstart, tstop,
                                        rule, req, pending, transfer, error,
                                        seeAll);
          } else {
<span class="nc" id="L732">            TransferUtils</span>
<span class="nc" id="L733">                .stopSelectedTransfers(dbSession, 0, builder, authentHttp, body,</span>
                                       startid, stopid, tstart, tstop, rule,
                                       req, pending, transfer, error, seeAll);
          }
        } else {
<span class="nc" id="L738">          DbPreparedStatement preparedStatement = null;</span>
          try {
<span class="nc" id="L740">            preparedStatement = DbTaskRunner</span>
<span class="nc" id="L741">                .getFilterPrepareStatement(dbSession, 0, false, startid, stopid,</span>
                                           tstart, tstop, rule, req, pending,
                                           transfer, error, done, all, seeAll);
<span class="nc" id="L744">            preparedStatement.executeQuery();</span>
<span class="nc bnc" id="L745" title="All 2 branches missed.">            while (preparedStatement.getNext()) {</span>
              try {
<span class="nc" id="L747">                final DbTaskRunner taskRunner =</span>
<span class="nc" id="L748">                    DbTaskRunner.getFromStatement(preparedStatement);</span>
<span class="nc" id="L749">                final LocalChannelReference lcr =</span>
<span class="nc" id="L750">                    Configuration.configuration.getLocalTransaction()</span>
<span class="nc" id="L751">                                               .getFromRequest(</span>
<span class="nc" id="L752">                                                   taskRunner.getKey());</span>
<span class="nc" id="L753">                final R66Result finalResult =</span>
<span class="nc" id="L754">                    TransferUtils.restartTransfer(taskRunner, lcr);</span>
<span class="nc" id="L755">                final ErrorCode result = finalResult.getCode();</span>
<span class="nc" id="L756">                final ErrorCode last = taskRunner.getErrorInfo();</span>
<span class="nc" id="L757">                taskRunner.setErrorExecutionStatus(result);</span>
<span class="nc bnc" id="L758" title="All 2 branches missed.">                builder.append(taskRunner.toSpecializedHtml(authentHttp, body,</span>
                                                            lcr != null?
                                                                Messages
<span class="nc" id="L761">                                                                    .getString(</span>
                                                                        HTTP_SSL_HANDLER_ACTIVE) :
                                                                Messages
<span class="nc" id="L764">                                                                    .getString(</span>
                                                                        HTTP_SSL_HANDLER_NOT_ACTIVE)));
<span class="nc" id="L766">                taskRunner.setErrorExecutionStatus(last);</span>
<span class="nc" id="L767">              } catch (final WaarpDatabaseException e) {</span>
                // try to continue if possible
<span class="nc" id="L769">                logger.warn(AN_ERROR_OCCURS_WHILE_ACCESSING_A_RUNNER,</span>
<span class="nc" id="L770">                            e.getMessage());</span>
<span class="nc" id="L771">                continue;</span>
<span class="nc" id="L772">              }</span>
            }
<span class="nc" id="L774">            preparedStatement.realClose();</span>
<span class="nc" id="L775">          } catch (final WaarpDatabaseException e) {</span>
<span class="nc bnc" id="L776" title="All 2 branches missed.">            if (preparedStatement != null) {</span>
<span class="nc" id="L777">              preparedStatement.realClose();</span>
            }
<span class="nc" id="L779">            logger.warn(OPEN_R66_WEB_ERROR, e.getMessage());</span>
<span class="nc" id="L780">          }</span>
        }
<span class="nc bnc" id="L782" title="All 2 branches missed.">        if (builder != null) {</span>
<span class="nc" id="L783">          body = builder.toString();</span>
        }
<span class="nc" id="L785">        body1 = REQUEST.CancelRestart.readBodyEnd();</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">      } else if (&quot;Cancel&quot;.equalsIgnoreCase(parm) ||</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">                 &quot;CancelClean&quot;.equalsIgnoreCase(parm) ||</span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">                 &quot;Stop&quot;.equalsIgnoreCase(parm)) {</span>
        // Cancel or Stop
<span class="nc" id="L790">        final boolean stop = &quot;Stop&quot;.equalsIgnoreCase(parm);</span>
<span class="nc" id="L791">        final String specid = getValue(&quot;specid&quot;);</span>
<span class="nc" id="L792">        final String reqd = getValue(&quot;reqd&quot;);</span>
<span class="nc" id="L793">        final String reqr = getValue(&quot;reqr&quot;);</span>
<span class="nc" id="L794">        final LocalChannelReference lcr =</span>
<span class="nc" id="L795">            Configuration.configuration.getLocalTransaction().getFromRequest(</span>
                reqd + ' ' + reqr + ' ' + specid);
        // stop the current transfer
        ErrorCode result;
        long lspecid;
        try {
<span class="nc" id="L801">          lspecid = Long.parseLong(specid);</span>
<span class="nc" id="L802">        } catch (final NumberFormatException e) {</span>
<span class="nc" id="L803">          body = &quot;&quot;;</span>
<span class="nc" id="L804">          body1 = REQUEST.CancelRestart.readBodyEnd();</span>
<span class="nc" id="L805">          body1 += BR_B + parm +</span>
<span class="nc" id="L806">                   Messages.getString(HTTP_SSL_HANDLER_3); //$NON-NLS-2$</span>
          String end;
<span class="nc" id="L808">          end = REQUEST.CancelRestart.readEnd();</span>
<span class="nc" id="L809">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L810">        }</span>
<span class="nc" id="L811">        DbTaskRunner taskRunner = null;</span>
        try {
<span class="nc" id="L813">          taskRunner = new DbTaskRunner(authentHttp, null, lspecid, reqr, reqd);</span>
<span class="nc" id="L814">        } catch (final WaarpDatabaseException ignored) {</span>
          // nothing
<span class="nc" id="L816">        }</span>
<span class="nc bnc" id="L817" title="All 2 branches missed.">        if (taskRunner == null) {</span>
<span class="nc" id="L818">          body = &quot;&quot;;</span>
<span class="nc" id="L819">          body1 = REQUEST.CancelRestart.readBodyEnd();</span>
<span class="nc" id="L820">          body1 += BR_B + parm +</span>
<span class="nc" id="L821">                   Messages.getString(HTTP_SSL_HANDLER_3); //$NON-NLS-2$</span>
          String end;
<span class="nc" id="L823">          end = REQUEST.CancelRestart.readEnd();</span>
<span class="nc" id="L824">          return head + body0 + body + body1 + end;</span>
        }
<span class="nc bnc" id="L826" title="All 2 branches missed.">        final ErrorCode code =</span>
            stop? ErrorCode.StoppedTransfer : ErrorCode.CanceledTransfer;
<span class="nc bnc" id="L828" title="All 2 branches missed.">        if (lcr != null) {</span>
<span class="nc" id="L829">          final int rank = taskRunner.getRank();</span>
<span class="nc" id="L830">          lcr.sessionNewState(R66FiniteDualStates.ERROR);</span>
<span class="nc" id="L831">          final ErrorPacket error =</span>
<span class="nc" id="L832">              new ErrorPacket(&quot;Transfer &quot; + parm + ' ' + rank, code.getCode(),</span>
                              ErrorPacket.FORWARDCLOSECODE);
          try {
            // inform local instead of remote
<span class="nc" id="L836">            LocalServerHandler.channelRead0(lcr, error);</span>
<span class="nc" id="L837">          } catch (final Exception ignored) {</span>
            // nothing
<span class="nc" id="L839">          }</span>
<span class="nc" id="L840">          result = ErrorCode.CompleteOk;</span>
<span class="nc" id="L841">        } else {</span>
          // Transfer is not running
          // But is the database saying the contrary
<span class="nc" id="L844">          result = ErrorCode.TransferOk;</span>
<span class="nc bnc" id="L845" title="All 4 branches missed.">          if (taskRunner != null &amp;&amp; taskRunner.stopOrCancelRunner(code)) {</span>
<span class="nc" id="L846">            result = ErrorCode.CompleteOk;</span>
          }
        }
<span class="nc bnc" id="L849" title="All 2 branches missed.">        if (taskRunner != null) {</span>
<span class="nc bnc" id="L850" title="All 2 branches missed.">          if (&quot;CancelClean&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L851">            TransferUtils.cleanOneTransfer(taskRunner, null, authentHttp, null);</span>
          }
<span class="nc" id="L853">          body = REQUEST.CancelRestart.readBody();</span>
<span class="nc bnc" id="L854" title="All 2 branches missed.">          body = taskRunner.toSpecializedHtml(authentHttp, body, lcr != null?</span>
<span class="nc" id="L855">              Messages.getString(HTTP_SSL_HANDLER_ACTIVE)</span>
              //$NON-NLS-1$
<span class="nc" id="L857">              : Messages.getString(HTTP_SSL_HANDLER_NOT_ACTIVE)); //$NON-NLS-1$</span>
<span class="nc" id="L858">          String tstart = taskRunner.getStart().toString();</span>
<span class="nc" id="L859">          String tstop = taskRunner.getStop().toString();</span>
<span class="nc" id="L860">          head = resetOptionTransfer(head, String</span>
<span class="nc" id="L861">                                         .valueOf(taskRunner.getSpecialId() - 1), String.valueOf(</span>
<span class="nc" id="L862">              taskRunner.getSpecialId() + 1), tstart, tstop,</span>
<span class="nc" id="L863">                                     taskRunner.getRuleId(),</span>
<span class="nc" id="L864">                                     taskRunner.getRequested(), false, false,</span>
                                     false, false, true);
        }
<span class="nc" id="L867">        body1 = REQUEST.CancelRestart.readBodyEnd();</span>
<span class="nc bnc" id="L868" title="All 2 branches missed.">        body1 += BR_B + (result == ErrorCode.CompleteOk?</span>
<span class="nc" id="L869">            parm + Messages.getString(&quot;HttpSslHandler.5&quot;) :</span>
            //$NON-NLS-2$
<span class="nc" id="L871">            parm + Messages.getString(&quot;HttpSslHandler.4&quot;)) +</span>
                 &quot;&lt;/b&gt;&quot;; //$NON-NLS-1$
<span class="nc bnc" id="L873" title="All 2 branches missed.">      } else if (&quot;Restart&quot;.equalsIgnoreCase(parm)) {</span>
        // Restart
<span class="nc" id="L875">        final String specid = getValue(&quot;specid&quot;);</span>
<span class="nc" id="L876">        final String reqd = getValue(&quot;reqd&quot;);</span>
<span class="nc" id="L877">        final String reqr = getValue(&quot;reqr&quot;);</span>
        long lspecid;
        try {
<span class="nc" id="L880">          lspecid = Long.parseLong(specid);</span>
<span class="nc" id="L881">        } catch (final NumberFormatException e) {</span>
<span class="nc" id="L882">          body = &quot;&quot;;</span>
<span class="nc" id="L883">          body1 = REQUEST.CancelRestart.readBodyEnd();</span>
<span class="nc" id="L884">          body1 += BR_B + parm +</span>
<span class="nc" id="L885">                   Messages.getString(HTTP_SSL_HANDLER_3); //$NON-NLS-2$</span>
          String end;
<span class="nc" id="L887">          end = REQUEST.CancelRestart.readEnd();</span>
<span class="nc" id="L888">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L889">        }</span>
        DbTaskRunner taskRunner;
        String comment;
        try {
<span class="nc" id="L893">          taskRunner = new DbTaskRunner(authentHttp, null, lspecid, reqr, reqd);</span>
<span class="nc" id="L894">          final LocalChannelReference lcr =</span>
<span class="nc" id="L895">              Configuration.configuration.getLocalTransaction()</span>
<span class="nc" id="L896">                                         .getFromRequest(taskRunner.getKey());</span>
<span class="nc" id="L897">          final R66Result finalResult =</span>
<span class="nc" id="L898">              TransferUtils.restartTransfer(taskRunner, lcr);</span>
<span class="nc" id="L899">          comment = (String) finalResult.getOther();</span>
<span class="nc" id="L900">          body = REQUEST.CancelRestart.readBody();</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">          body = taskRunner.toSpecializedHtml(authentHttp, body, lcr != null?</span>
<span class="nc" id="L902">              Messages.getString(HTTP_SSL_HANDLER_ACTIVE)</span>
              //$NON-NLS-1$
<span class="nc" id="L904">              : Messages.getString(HTTP_SSL_HANDLER_NOT_ACTIVE)); //$NON-NLS-1$</span>
<span class="nc" id="L905">          String tstart = taskRunner.getStart().toString();</span>
<span class="nc" id="L906">          String tstop = taskRunner.getStop().toString();</span>
<span class="nc" id="L907">          head = resetOptionTransfer(head, String</span>
<span class="nc" id="L908">                                         .valueOf(taskRunner.getSpecialId() - 1), String.valueOf(</span>
<span class="nc" id="L909">              taskRunner.getSpecialId() + 1), tstart, tstop,</span>
<span class="nc" id="L910">                                     taskRunner.getRuleId(),</span>
<span class="nc" id="L911">                                     taskRunner.getRequested(), false, false,</span>
                                     false, false, true);
<span class="nc" id="L913">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L914">          body = &quot;&quot;;</span>
<span class="nc" id="L915">          comment = Messages.getString(&quot;ErrorCode.17&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L916">        }</span>
<span class="nc" id="L917">        body1 = REQUEST.CancelRestart.readBodyEnd();</span>
<span class="nc" id="L918">        body1 += BR_B + comment + &quot;&lt;/b&gt;&quot;;</span>
<span class="nc" id="L919">      } else {</span>
<span class="nc" id="L920">        head = resetOptionTransfer(head, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false,</span>
                                   false, false, true);
      }
<span class="fc" id="L923">    } else {</span>
<span class="nc" id="L924">      head =</span>
<span class="nc" id="L925">          resetOptionTransfer(head, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false, false,</span>
                              false, true);
    }
    String end;
<span class="fc" id="L929">    end = REQUEST.CancelRestart.readEnd();</span>
<span class="fc" id="L930">    return head + body0 + body + body1 + end;</span>
  }

  private String export0() {
<span class="fc" id="L934">    getParams();</span>
<span class="fc bfc" id="L935" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L936">      String body = REQUEST.Export.readFileUnique(this);</span>
<span class="fc" id="L937">      body =</span>
<span class="fc" id="L938">          resetOptionTransfer(body, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, &quot;&quot;, false, false, false,</span>
                              true, false);
<span class="fc" id="L940">      return body.replace(XXXRESULTXXX, &quot;&quot;);</span>
    }
<span class="fc" id="L942">    String body = REQUEST.Export.readFileUnique(this);</span>
<span class="fc" id="L943">    String start = getValue(START2);</span>
<span class="fc" id="L944">    String stop = getValue(&quot;stop&quot;);</span>
<span class="fc" id="L945">    final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="fc" id="L946">    final String req = getTrimValue(&quot;req&quot;);</span>
    boolean pending;
    boolean transfer;
    boolean error;
    boolean done;
    boolean all;
<span class="fc" id="L952">    pending = params.containsKey(PENDING2);</span>
<span class="fc" id="L953">    transfer = params.containsKey(TRANSFER2);</span>
<span class="fc" id="L954">    error = params.containsKey(ERROR2);</span>
<span class="fc" id="L955">    done = params.containsKey(&quot;done&quot;);</span>
<span class="fc" id="L956">    all = params.containsKey(&quot;all&quot;);</span>
<span class="fc" id="L957">    boolean toPurge = params.containsKey(&quot;purge&quot;);</span>
<span class="pc bpc" id="L958" title="1 of 2 branches missed.">    if (toPurge) {</span>
<span class="nc" id="L959">      transfer = false;</span>
    }
<span class="pc bpc" id="L961" title="7 of 8 branches missed.">    if (pending &amp;&amp; transfer &amp;&amp; error &amp;&amp; done) {</span>
<span class="nc" id="L962">      all = true;</span>
<span class="pc bpc" id="L963" title="4 of 8 branches missed.">    } else if (!(pending || transfer || error || done)) {</span>
<span class="nc" id="L964">      all = true;</span>
    }
<span class="fc" id="L966">    final Timestamp tstart = WaarpStringUtils.fixDate(start);</span>
<span class="pc bpc" id="L967" title="1 of 2 branches missed.">    if (tstart != null) {</span>
<span class="nc" id="L968">      start = tstart.toString();</span>
    }
<span class="fc" id="L970">    final Timestamp tstop = WaarpStringUtils.fixDate(stop, tstart);</span>
<span class="pc bpc" id="L971" title="1 of 2 branches missed.">    if (tstop != null) {</span>
<span class="nc" id="L972">      stop = tstop.toString();</span>
    }
<span class="pc bpc" id="L974" title="2 of 4 branches missed.">    body =</span>
<span class="fc" id="L975">        resetOptionTransfer(body, &quot;&quot;, &quot;&quot;, start, stop, rule == null? &quot;&quot; : rule,</span>
                            req == null? &quot;&quot; : req, pending, transfer, error,
                            done, all);
<span class="fc" id="L978">    boolean isexported = true;</span>
    // clean a bit the database before exporting
    try {
<span class="fc" id="L981">      DbTaskRunner.changeFinishedToDone();</span>
<span class="nc" id="L982">    } catch (final WaarpDatabaseNoConnectionException e2) {</span>
      // should not be
<span class="fc" id="L984">    }</span>
    // create export of log and optionally purge them from database
<span class="fc" id="L986">    DbPreparedStatement getValid = null;</span>
<span class="fc" id="L987">    NbAndSpecialId nbAndSpecialId = null;</span>
<span class="fc" id="L988">    final String filename = Configuration.configuration.getBaseDirectory() +</span>
<span class="fc" id="L989">                            Configuration.configuration.getArchivePath() +</span>
                            DirInterface.SEPARATOR +
<span class="fc" id="L991">                            Configuration.configuration.getHostId() + '_' +</span>
<span class="fc" id="L992">                            System.currentTimeMillis() + &quot;_runners.xml&quot;;</span>
<span class="fc" id="L993">    String errorMsg = &quot;&quot;;</span>
<span class="fc" id="L994">    final String seeAll = checkAuthorizedToSeeAll();</span>
    try {
<span class="fc" id="L996">      getValid = DbTaskRunner</span>
<span class="fc" id="L997">          .getFilterPrepareStatement(dbSession, 0, // 0 means no limit</span>
                                     true, null, null, tstart, tstop, rule, req,
                                     pending, transfer, error, done, all,
                                     seeAll);
<span class="fc" id="L1001">      nbAndSpecialId = DbTaskRunner.writeXMLWriter(getValid, filename);</span>
<span class="nc" id="L1002">    } catch (final WaarpDatabaseNoConnectionException e1) {</span>
<span class="nc" id="L1003">      isexported = false;</span>
<span class="nc" id="L1004">      toPurge = false;</span>
<span class="nc" id="L1005">      logger.warn(EXPORT_ERROR, e1.getMessage());</span>
<span class="nc" id="L1006">      errorMsg = e1.getMessage();</span>
<span class="nc" id="L1007">    } catch (final WaarpDatabaseSqlException e1) {</span>
<span class="nc" id="L1008">      isexported = false;</span>
<span class="nc" id="L1009">      toPurge = false;</span>
<span class="nc" id="L1010">      logger.warn(EXPORT_ERROR, e1.getMessage());</span>
<span class="nc" id="L1011">      errorMsg = e1.getMessage();</span>
<span class="nc" id="L1012">    } catch (final OpenR66ProtocolBusinessException e) {</span>
<span class="nc" id="L1013">      isexported = false;</span>
<span class="nc" id="L1014">      toPurge = false;</span>
<span class="nc" id="L1015">      logger.warn(EXPORT_ERROR, e.getMessage());</span>
<span class="nc" id="L1016">      errorMsg = e.getMessage();</span>
    } finally {
<span class="pc bpc" id="L1018" title="1 of 2 branches missed.">      if (getValid != null) {</span>
<span class="fc" id="L1019">        getValid.realClose();</span>
      }
    }
<span class="fc" id="L1022">    int purge = 0;</span>
<span class="pc bpc" id="L1023" title="2 of 4 branches missed.">    if (isexported &amp;&amp; nbAndSpecialId != null) {</span>
<span class="pc bpc" id="L1024" title="1 of 2 branches missed.">      if (nbAndSpecialId.nb &lt;= 0) {</span>
<span class="fc" id="L1025">        return body.replace(XXXRESULTXXX, Messages</span>
<span class="fc" id="L1026">            .getString(&quot;HttpSslHandler.7&quot;)); //$NON-NLS-1$</span>
      }
      // in case of purge
<span class="nc bnc" id="L1029" title="All 4 branches missed.">      if (isexported &amp;&amp; toPurge) {</span>
        // purge with same filter all runners where globallasttep
        // is ALLDONE or ERROR
        // but getting the higher Special first
<span class="nc" id="L1033">        final String stopId = Long.toString(nbAndSpecialId.higherSpecialId);</span>
        try {
<span class="nc" id="L1035">          purge = DbTaskRunner</span>
<span class="nc" id="L1036">              .purgeLogPrepareStatement(dbSession, null, stopId, tstart, tstop,</span>
                                        rule, req, pending, transfer, error,
                                        done, all);
<span class="nc" id="L1039">        } catch (final WaarpDatabaseNoConnectionException ignored) {</span>
          // nothing
<span class="nc" id="L1041">        } catch (final WaarpDatabaseSqlException e) {</span>
<span class="nc" id="L1042">          logger.warn(&quot;Purge error: {}&quot;, e.getMessage());</span>
<span class="nc" id="L1043">        }</span>
      }
    }
<span class="nc bnc" id="L1046" title="All 2 branches missed.">    return body.replace(XXXRESULTXXX, &quot;Export &quot; + (isexported?</span>
<span class="nc" id="L1047">        &quot;&lt;B&gt;&quot; + Messages.getString(&quot;HttpSslHandler.8&quot;) + //$NON-NLS-2$</span>
<span class="nc bnc" id="L1048" title="All 2 branches missed.">        filename + Messages.getString(&quot;HttpSslHandler.9&quot;) +</span>
        (nbAndSpecialId != null? nbAndSpecialId.nb : 0) +
<span class="nc" id="L1050">        Messages.getString(&quot;HttpSslHandler.10&quot;)</span>
        //$NON-NLS-1$ //$NON-NLS-2$
<span class="nc" id="L1052">        + purge + Messages.getString(&quot;HttpSslHandler.11&quot;) + &quot;&lt;/B&gt;&quot; :</span>
        //$NON-NLS-1$
<span class="nc" id="L1054">        &quot;&lt;B&gt;&quot; + Messages.getString(&quot;HttpSslHandler.12&quot;))) + &quot;&lt;/B&gt;&quot; +</span>
           errorMsg; //$NON-NLS-1$
  }

  String resetOptionHosts(String header, String host, String addr, boolean ssl,
                          boolean active) {
<span class="fc" id="L1060">    final StringBuilder builder = new StringBuilder(header);</span>
<span class="fc" id="L1061">    WaarpStringUtils.replace(builder, &quot;XXXFHOSTXXX&quot;, host);</span>
<span class="fc" id="L1062">    WaarpStringUtils.replace(builder, &quot;XXXFADDRXXX&quot;, addr);</span>
<span class="pc bpc" id="L1063" title="1 of 2 branches missed.">    WaarpStringUtils.replace(builder, &quot;XXXFSSLXXX&quot;, ssl? CHECKED : &quot;&quot;);</span>
<span class="pc bpc" id="L1064" title="1 of 2 branches missed.">    WaarpStringUtils.replace(builder, &quot;XXXFACTIVXXX&quot;, active? CHECKED : &quot;&quot;);</span>
<span class="fc" id="L1065">    return builder.toString();</span>
  }

  private String hosts0() {
<span class="fc" id="L1069">    getParams();</span>
<span class="fc" id="L1070">    String head = REQUEST.Hosts.readHeader(this);</span>
    String end;
<span class="fc" id="L1072">    end = REQUEST.Hosts.readEnd();</span>
<span class="fc bfc" id="L1073" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L1074">      head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="fc" id="L1075">      return head + end;</span>
    }
    String body0;
    String body;
    String body1;
<span class="fc" id="L1080">    body0 = body1 = body = &quot;&quot;;</span>
<span class="fc" id="L1081">    final List&lt;String&gt; parms = params.get(ACTION);</span>
<span class="pc bpc" id="L1082" title="1 of 2 branches missed.">    if (parms != null) {</span>
<span class="fc" id="L1083">      body0 = REQUEST.Hosts.readBodyHeader();</span>
<span class="fc" id="L1084">      final String parm = parms.get(0);</span>
<span class="fc bfc" id="L1085" title="All 2 branches covered.">      if (CREATE.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L1086">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="fc" id="L1087">        final String addr = getTrimValue(ADDRESS);</span>
<span class="fc" id="L1088">        final String port = getTrimValue(&quot;port&quot;);</span>
<span class="fc" id="L1089">        final String key = getTrimValue(&quot;hostkey&quot;);</span>
        boolean ssl;
        boolean admin;
        boolean isclient;
        boolean isactive;
        boolean isproxified;
<span class="fc" id="L1095">        ssl = params.containsKey(&quot;ssl&quot;);</span>
<span class="fc" id="L1096">        admin = params.containsKey(&quot;admin&quot;);</span>
<span class="fc" id="L1097">        isclient = params.containsKey(&quot;isclient&quot;);</span>
<span class="fc" id="L1098">        isactive = params.containsKey(&quot;isactive&quot;);</span>
<span class="fc" id="L1099">        isproxified = params.containsKey(&quot;isproxified&quot;);</span>
<span class="pc bpc" id="L1100" title="4 of 8 branches missed.">        if (host == null || addr == null || port == null || key == null) {</span>
<span class="nc" id="L1101">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1102">          body = Messages.getString(&quot;HttpSslHandler.13&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1103">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L1104">          return head + body0 + body + body1 + end;</span>
        }
        int iport;
        try {
<span class="fc" id="L1108">          iport = Integer.parseInt(port);</span>
<span class="nc" id="L1109">        } catch (final NumberFormatException e1) {</span>
<span class="nc" id="L1110">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1111">          body = Messages.getString(&quot;HttpSslHandler.14&quot;) + e1.getMessage() +</span>
                 B_CENTER_P; //$NON-NLS-1$
<span class="nc" id="L1113">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L1114">          return head + body0 + body + body1 + end;</span>
<span class="fc" id="L1115">        }</span>
<span class="fc" id="L1116">        final DbHostAuth dbhost = new DbHostAuth(host, addr, iport, ssl,</span>
<span class="fc" id="L1117">                                                 key.getBytes(</span>
                                                     WaarpStringUtils.UTF8),
                                                 admin, isclient);
<span class="fc" id="L1120">        dbhost.setActive(isactive);</span>
<span class="fc" id="L1121">        dbhost.setProxified(isproxified);</span>
        try {
<span class="fc" id="L1123">          dbhost.insert();</span>
<span class="nc" id="L1124">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1125">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1126">          body = Messages.getString(&quot;HttpSslHandler.14&quot;) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1129">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L1130">          return head + body0 + body + body1 + end;</span>
<span class="fc" id="L1131">        }</span>
<span class="fc" id="L1132">        head = resetOptionHosts(head, host, addr, ssl, isactive);</span>
<span class="fc" id="L1133">        body = REQUEST.Hosts.readBody();</span>
<span class="fc" id="L1134">        body = dbhost.toSpecializedHtml(authentHttp, body, false);</span>
<span class="pc bpc" id="L1135" title="1 of 2 branches missed.">      } else if (FILTER.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L1136">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="fc" id="L1137">        final String addr = getTrimValue(ADDRESS);</span>
<span class="fc" id="L1138">        final boolean ssl = params.containsKey(&quot;ssl&quot;);</span>
<span class="fc" id="L1139">        final boolean isactive = params.containsKey(&quot;active&quot;);</span>
<span class="pc bpc" id="L1140" title="2 of 4 branches missed.">        head = resetOptionHosts(head, host == null? &quot;&quot; : host,</span>
                                addr == null? &quot;&quot; : addr, ssl, isactive);
<span class="fc" id="L1142">        body = REQUEST.Hosts.readBody();</span>
<span class="fc" id="L1143">        DbPreparedStatement preparedStatement = null;</span>
        try {
<span class="fc" id="L1145">          preparedStatement = DbHostAuth</span>
<span class="fc" id="L1146">              .getFilterPrepareStament(dbSession, host, addr, ssl, isactive);</span>
<span class="fc" id="L1147">          preparedStatement.executeQuery();</span>
<span class="fc" id="L1148">          final StringBuilder builder = new StringBuilder();</span>
<span class="fc" id="L1149">          int i = 0;</span>
<span class="fc bfc" id="L1150" title="All 2 branches covered.">          while (preparedStatement.getNext()) {</span>
<span class="fc" id="L1151">            i++;</span>
<span class="fc" id="L1152">            final DbHostAuth dbhost =</span>
<span class="fc" id="L1153">                DbHostAuth.getFromStatement(preparedStatement);</span>
<span class="fc" id="L1154">            builder.append(dbhost.toSpecializedHtml(authentHttp, body, false));</span>
<span class="pc bpc" id="L1155" title="1 of 2 branches missed.">            if (i &gt; getLimitRow()) {</span>
<span class="nc" id="L1156">              break;</span>
            }
<span class="fc" id="L1158">          }</span>
<span class="fc" id="L1159">          preparedStatement.realClose();</span>
<span class="fc" id="L1160">          body = builder.toString();</span>
<span class="nc" id="L1161">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc bnc" id="L1162" title="All 2 branches missed.">          if (preparedStatement != null) {</span>
<span class="nc" id="L1163">            preparedStatement.realClose();</span>
          }
<span class="nc" id="L1165">          logger.warn(OPEN_R66_WEB_ERROR, e.getMessage());</span>
<span class="fc" id="L1166">        }</span>
<span class="fc" id="L1167">        body1 = REQUEST.Hosts.readBodyEnd();</span>
<span class="pc bnc" id="L1168" title="All 2 branches missed.">      } else if (&quot;Update&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L1169">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="nc" id="L1170">        final String addr = getTrimValue(ADDRESS);</span>
<span class="nc" id="L1171">        final String port = getTrimValue(&quot;port&quot;);</span>
<span class="nc" id="L1172">        final String key = getTrimValue(&quot;hostkey&quot;);</span>
        boolean ssl;
        boolean admin;
        boolean isclient;
        boolean isactive;
        boolean isproxified;
<span class="nc" id="L1178">        ssl = params.containsKey(&quot;ssl&quot;);</span>
<span class="nc" id="L1179">        admin = params.containsKey(&quot;admin&quot;);</span>
<span class="nc" id="L1180">        isclient = params.containsKey(&quot;isclient&quot;);</span>
<span class="nc" id="L1181">        isactive = params.containsKey(&quot;isactive&quot;);</span>
<span class="nc" id="L1182">        isproxified = params.containsKey(&quot;isproxified&quot;);</span>
<span class="nc bnc" id="L1183" title="All 8 branches missed.">        if (host == null || addr == null || port == null || key == null) {</span>
<span class="nc" id="L1184">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1185">          body = Messages.getString(&quot;HttpSslHandler.15&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1186">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L1187">          return head + body0 + body + body1 + end;</span>
        }
        int iport;
        try {
<span class="nc" id="L1191">          iport = Integer.parseInt(port);</span>
<span class="nc" id="L1192">        } catch (final NumberFormatException e1) {</span>
<span class="nc" id="L1193">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1194">          body = Messages.getString(&quot;HttpSslHandler.16&quot;) + e1.getMessage() +</span>
                 B_CENTER_P; //$NON-NLS-1$
<span class="nc" id="L1196">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L1197">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L1198">        }</span>
<span class="nc" id="L1199">        final DbHostAuth dbhost = new DbHostAuth(host, addr, iport, ssl,</span>
<span class="nc" id="L1200">                                                 key.getBytes(</span>
                                                     WaarpStringUtils.UTF8),
                                                 admin, isclient);
<span class="nc" id="L1203">        dbhost.setActive(isactive);</span>
<span class="nc" id="L1204">        dbhost.setProxified(isproxified);</span>
        try {
<span class="nc bnc" id="L1206" title="All 2 branches missed.">          if (dbhost.exist()) {</span>
<span class="nc" id="L1207">            dbhost.update();</span>
          } else {
<span class="nc" id="L1209">            dbhost.insert();</span>
          }
<span class="nc" id="L1211">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1212">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1213">          body = Messages.getString(&quot;HttpSslHandler.16&quot;) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1216">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, ssl, isactive);</span>
<span class="nc" id="L1217">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L1218">        }</span>
<span class="nc" id="L1219">        head = resetOptionHosts(head, host, addr, ssl, isactive);</span>
<span class="nc" id="L1220">        body = REQUEST.Hosts.readBody();</span>
<span class="nc" id="L1221">        body = dbhost.toSpecializedHtml(authentHttp, body, false);</span>
<span class="nc bnc" id="L1222" title="All 2 branches missed.">      } else if (&quot;TestConn&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L1223">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="nc bnc" id="L1224" title="All 4 branches missed.">        if (host == null || host.isEmpty()) {</span>
<span class="nc" id="L1225">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1226">          body = Messages.getString(HTTP_SSL_HANDLER_17); //$NON-NLS-1$</span>
<span class="nc" id="L1227">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1228">          return head + body0 + body + body1 + end;</span>
        }
        DbHostAuth dbhost;
        try {
<span class="nc" id="L1232">          dbhost = new DbHostAuth(host);</span>
<span class="nc" id="L1233">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1234">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1235">          body = Messages.getString(HTTP_SSL_HANDLER_17) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1238">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1239">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L1240">        }</span>
<span class="nc" id="L1241">        final R66Future result = new R66Future(true);</span>
<span class="nc" id="L1242">        final TestPacket packet = new TestPacket(&quot;MSG&quot;, &quot;CheckConnection&quot;, 100);</span>
<span class="nc" id="L1243">        final Message transaction = new Message(</span>
<span class="nc" id="L1244">            Configuration.configuration.getInternalRunner()</span>
<span class="nc" id="L1245">                                       .getNetworkTransaction(), result, dbhost,</span>
            packet);
<span class="nc" id="L1247">        transaction.run();</span>
<span class="nc" id="L1248">        result.awaitOrInterruptible();</span>
<span class="nc" id="L1249">        head =</span>
<span class="nc" id="L1250">            resetOptionHosts(head, &quot;&quot;, &quot;&quot;, dbhost.isSsl(), dbhost.isActive());</span>
<span class="nc" id="L1251">        body = REQUEST.Hosts.readBody();</span>
<span class="nc bnc" id="L1252" title="All 2 branches missed.">        if (result.isSuccess()) {</span>
<span class="nc" id="L1253">          body = dbhost.toSpecializedHtml(authentHttp, body, false);</span>
<span class="nc" id="L1254">          body += Messages.getString(&quot;HttpSslHandler.18&quot;); //$NON-NLS-1$</span>
        } else {
<span class="nc" id="L1256">          body = dbhost.toSpecializedHtml(authentHttp, body, false);</span>
<span class="nc" id="L1257">          body += Messages.getString(&quot;HttpSslHandler.19&quot;)//$NON-NLS-1$</span>
<span class="nc" id="L1258">                  + result.getResult().getCode().getMesg() + B_CENTER_P;</span>
        }
<span class="nc bnc" id="L1260" title="All 2 branches missed.">      } else if (&quot;CloseConn&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L1261">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="nc bnc" id="L1262" title="All 4 branches missed.">        if (host == null || host.isEmpty()) {</span>
<span class="nc" id="L1263">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1264">          body = Messages.getString(HTTP_SSL_HANDLER_17); //$NON-NLS-1$</span>
<span class="nc" id="L1265">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1266">          return head + body0 + body + body1 + end;</span>
        }
        DbHostAuth dbhost;
        try {
<span class="nc" id="L1270">          dbhost = new DbHostAuth(host);</span>
<span class="nc" id="L1271">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1272">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1273">          body = Messages.getString(HTTP_SSL_HANDLER_17) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1276">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1277">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L1278">        }</span>
<span class="nc" id="L1279">        body = REQUEST.Hosts.readBody();</span>
<span class="nc" id="L1280">        final boolean resultShutDown = NetworkTransaction</span>
<span class="nc" id="L1281">            .shuttingdownNetworkChannelsPerHostID(dbhost.getHostid());</span>
<span class="nc" id="L1282">        head =</span>
<span class="nc" id="L1283">            resetOptionHosts(head, &quot;&quot;, &quot;&quot;, dbhost.isSsl(), dbhost.isActive());</span>
<span class="nc bnc" id="L1284" title="All 2 branches missed.">        if (resultShutDown) {</span>
<span class="nc" id="L1285">          body = dbhost.toSpecializedHtml(authentHttp, body, false);</span>
<span class="nc" id="L1286">          body += Messages.getString(&quot;HttpSslHandler.21&quot;); //$NON-NLS-1$</span>
        } else {
<span class="nc" id="L1288">          body = dbhost.toSpecializedHtml(authentHttp, body, false);</span>
<span class="nc" id="L1289">          body += Messages.getString(&quot;HttpSslHandler.22&quot;); //$NON-NLS-1$</span>
        }
<span class="nc bnc" id="L1291" title="All 2 branches missed.">      } else if (&quot;Delete&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L1292">        final String host = getTrimValue(&quot;host&quot;);</span>
<span class="nc bnc" id="L1293" title="All 4 branches missed.">        if (host == null || host.isEmpty()) {</span>
<span class="nc" id="L1294">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1295">          body = Messages.getString(&quot;HttpSslHandler.23&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1296">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1297">          return head + body0 + body + body1 + end;</span>
        }
        DbHostAuth dbhost;
        try {
<span class="nc" id="L1301">          dbhost = new DbHostAuth(host);</span>
<span class="nc" id="L1302">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1303">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1304">          body = Messages.getString(&quot;HttpSslHandler.24&quot;) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1307">          head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
<span class="nc" id="L1308">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L1309">        }</span>
        try {
<span class="nc" id="L1311">          dbhost.delete();</span>
<span class="nc" id="L1312">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1313">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1314">          body = Messages.getString(&quot;HttpSslHandler.24&quot;) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1317">          head =</span>
<span class="nc" id="L1318">              resetOptionHosts(head, &quot;&quot;, &quot;&quot;, dbhost.isSsl(), dbhost.isActive());</span>
<span class="nc" id="L1319">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L1320">        }</span>
<span class="nc" id="L1321">        body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1322">        body = Messages.getString(&quot;HttpSslHandler.25&quot;) + host +</span>
               B_CENTER_P; //$NON-NLS-1$
<span class="nc" id="L1324">        head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, dbhost.isActive());</span>
<span class="nc" id="L1325">        return head + body0 + body + body1 + end;</span>
      } else {
<span class="nc" id="L1327">        head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
      }
<span class="fc" id="L1329">      body1 = REQUEST.Hosts.readBodyEnd();</span>
<span class="fc" id="L1330">    } else {</span>
<span class="nc" id="L1331">      head = resetOptionHosts(head, &quot;&quot;, &quot;&quot;, false, true);</span>
    }
<span class="fc" id="L1333">    return head + body0 + body + body1 + end;</span>
  }

  private void createExport(String body, StringBuilder builder, String rule,
                            int mode, int limit, int start) {
<span class="fc" id="L1338">    DbPreparedStatement preparedStatement = null;</span>
    try {
<span class="fc" id="L1340">      preparedStatement = DbRule.getFilterPrepareStament(dbSession, rule, mode);</span>
<span class="fc" id="L1341">      preparedStatement.executeQuery();</span>
<span class="fc" id="L1342">      int i = 0;</span>
<span class="fc bfc" id="L1343" title="All 2 branches covered.">      while (preparedStatement.getNext()) {</span>
<span class="fc" id="L1344">        final DbRule dbrule = DbRule.getFromStatement(preparedStatement);</span>
<span class="fc" id="L1345">        String temp = dbrule.toSpecializedHtml(authentHttp, body);</span>
<span class="fc" id="L1346">        temp = temp.replace(&quot;XXXRANKXXX&quot;, String.valueOf(start + i));</span>
<span class="fc" id="L1347">        builder.append(temp);</span>
<span class="fc" id="L1348">        i++;</span>
<span class="pc bpc" id="L1349" title="1 of 2 branches missed.">        if (i &gt; limit) {</span>
<span class="nc" id="L1350">          break;</span>
        }
<span class="fc" id="L1352">      }</span>
<span class="fc" id="L1353">      preparedStatement.realClose();</span>
<span class="nc" id="L1354">    } catch (final WaarpDatabaseException e) {</span>
<span class="nc bnc" id="L1355" title="All 2 branches missed.">      if (preparedStatement != null) {</span>
<span class="nc" id="L1356">        preparedStatement.realClose();</span>
      }
<span class="nc" id="L1358">      logger.warn(OPEN_R66_WEB_ERROR, e.getMessage());</span>
<span class="fc" id="L1359">    }</span>
<span class="fc" id="L1360">  }</span>

  String resetOptionRules(String header, String rule,
                          RequestPacket.TRANSFERMODE mode, int gmode) {
<span class="fc" id="L1364">    final StringBuilder builder = new StringBuilder(header);</span>
<span class="fc" id="L1365">    WaarpStringUtils.replace(builder, &quot;XXXRULEXXX&quot;, rule);</span>
<span class="pc bpc" id="L1366" title="1 of 2 branches missed.">    if (mode != null) {</span>
<span class="nc bnc" id="L1367" title="All 9 branches missed.">      switch (mode) {</span>
        case RECVMODE:
<span class="nc" id="L1369">          WaarpStringUtils.replace(builder, &quot;XXXRECVXXX&quot;, CHECKED);</span>
<span class="nc" id="L1370">          break;</span>
        case SENDMODE:
<span class="nc" id="L1372">          WaarpStringUtils.replace(builder, &quot;XXXSENDXXX&quot;, CHECKED);</span>
<span class="nc" id="L1373">          break;</span>
        case RECVMD5MODE:
<span class="nc" id="L1375">          WaarpStringUtils.replace(builder, &quot;XXXRECVMXXX&quot;, CHECKED);</span>
<span class="nc" id="L1376">          break;</span>
        case SENDMD5MODE:
<span class="nc" id="L1378">          WaarpStringUtils.replace(builder, &quot;XXXSENDMXXX&quot;, CHECKED);</span>
<span class="nc" id="L1379">          break;</span>
        case RECVTHROUGHMODE:
<span class="nc" id="L1381">          WaarpStringUtils.replace(builder, &quot;XXXRECVTXXX&quot;, CHECKED);</span>
<span class="nc" id="L1382">          break;</span>
        case SENDTHROUGHMODE:
<span class="nc" id="L1384">          WaarpStringUtils.replace(builder, &quot;XXXSENDTXXX&quot;, CHECKED);</span>
<span class="nc" id="L1385">          break;</span>
        case RECVMD5THROUGHMODE:
<span class="nc" id="L1387">          WaarpStringUtils.replace(builder, &quot;XXXRECVMTXXX&quot;, CHECKED);</span>
<span class="nc" id="L1388">          break;</span>
        case SENDMD5THROUGHMODE:
<span class="nc" id="L1390">          WaarpStringUtils.replace(builder, &quot;XXXSENDMTXXX&quot;, CHECKED);</span>
<span class="nc" id="L1391">          break;</span>
        default:
          break;
      }
    }
<span class="pc bpc" id="L1396" title="1 of 2 branches missed.">    if (gmode == -1) {// All Recv</span>
<span class="nc" id="L1397">      WaarpStringUtils.replace(builder, &quot;XXXARECVXXX&quot;, CHECKED);</span>
<span class="pc bpc" id="L1398" title="1 of 2 branches missed.">    } else if (gmode == -2) {// All Send</span>
<span class="nc" id="L1399">      WaarpStringUtils.replace(builder, &quot;XXXASENDXXX&quot;, CHECKED);</span>
<span class="pc bpc" id="L1400" title="1 of 2 branches missed.">    } else if (gmode == -3) {// All</span>
<span class="fc" id="L1401">      WaarpStringUtils.replace(builder, &quot;XXXALLXXX&quot;, CHECKED);</span>
    }
<span class="fc" id="L1403">    return builder.toString();</span>
  }

  private String rules0() {
<span class="fc" id="L1407">    getParams();</span>
<span class="fc" id="L1408">    String head = REQUEST.Rules.readHeader(this);</span>
    String end;
<span class="fc" id="L1410">    end = REQUEST.Rules.readEnd();</span>
<span class="fc bfc" id="L1411" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L1412">      head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="fc" id="L1413">      return head + end;</span>
    }
    String body0;
    String body;
    String body1;
<span class="fc" id="L1418">    body0 = body1 = body = &quot;&quot;;</span>
<span class="fc" id="L1419">    final List&lt;String&gt; parms = params.get(ACTION);</span>
<span class="pc bpc" id="L1420" title="1 of 2 branches missed.">    if (parms != null) {</span>
<span class="fc" id="L1421">      body0 = REQUEST.Rules.readBodyHeader();</span>
<span class="fc" id="L1422">      final String parm = parms.get(0);</span>
<span class="pc bpc" id="L1423" title="2 of 4 branches missed.">      if (CREATE.equalsIgnoreCase(parm) || &quot;Update&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L1424">        final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="nc" id="L1425">        final String hostids = getTrimValue(&quot;hostids&quot;);</span>
<span class="nc" id="L1426">        final String recvp = getTrimValue(&quot;recvp&quot;);</span>
<span class="nc" id="L1427">        final String sendp = getTrimValue(&quot;sendp&quot;);</span>
<span class="nc" id="L1428">        final String archp = getTrimValue(&quot;archp&quot;);</span>
<span class="nc" id="L1429">        final String workp = getTrimValue(&quot;workp&quot;);</span>
<span class="nc" id="L1430">        final String rpre = getTrimValue(&quot;rpre&quot;);</span>
<span class="nc" id="L1431">        final String rpost = getTrimValue(&quot;rpost&quot;);</span>
<span class="nc" id="L1432">        final String rerr = getTrimValue(&quot;rerr&quot;);</span>
<span class="nc" id="L1433">        final String spre = getTrimValue(&quot;spre&quot;);</span>
<span class="nc" id="L1434">        final String spost = getTrimValue(&quot;spost&quot;);</span>
<span class="nc" id="L1435">        final String serr = getTrimValue(&quot;serr&quot;);</span>
<span class="nc" id="L1436">        final String mode = getTrimValue(&quot;mode&quot;);</span>
<span class="nc bnc" id="L1437" title="All 4 branches missed.">        if (rule == null || mode == null) {</span>
<span class="nc" id="L1438">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1439">          body = Messages.getString(&quot;HttpSslHandler.26&quot;) + parm + Messages</span>
<span class="nc" id="L1440">              .getString(&quot;HttpSslHandler.27&quot;); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L1441">          head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1442">          return head + body0 + body + body1 + end;</span>
        }
<span class="nc" id="L1444">        int gmode = 0;</span>

<span class="nc" id="L1446">        TRANSFERMODE tmode = null;</span>
<span class="nc bnc" id="L1447" title="All 2 branches missed.">        if (&quot;send&quot;.equals(mode)) {</span>
<span class="nc" id="L1448">          tmode = RequestPacket.TRANSFERMODE.SENDMODE;</span>
<span class="nc" id="L1449">          gmode = -2;</span>
<span class="nc bnc" id="L1450" title="All 2 branches missed.">        } else if (&quot;recv&quot;.equals(mode)) {</span>
<span class="nc" id="L1451">          tmode = RequestPacket.TRANSFERMODE.RECVMODE;</span>
<span class="nc" id="L1452">          gmode = -1;</span>
<span class="nc bnc" id="L1453" title="All 2 branches missed.">        } else if (&quot;sendmd5&quot;.equals(mode)) {</span>
<span class="nc" id="L1454">          tmode = RequestPacket.TRANSFERMODE.SENDMD5MODE;</span>
<span class="nc" id="L1455">          gmode = -2;</span>
<span class="nc bnc" id="L1456" title="All 2 branches missed.">        } else if (&quot;recvmd5&quot;.equals(mode)) {</span>
<span class="nc" id="L1457">          tmode = RequestPacket.TRANSFERMODE.RECVMD5MODE;</span>
<span class="nc" id="L1458">          gmode = -1;</span>
<span class="nc bnc" id="L1459" title="All 2 branches missed.">        } else if (&quot;sendth&quot;.equals(mode)) {</span>
<span class="nc" id="L1460">          tmode = RequestPacket.TRANSFERMODE.SENDTHROUGHMODE;</span>
<span class="nc" id="L1461">          gmode = -2;</span>
<span class="nc bnc" id="L1462" title="All 2 branches missed.">        } else if (&quot;recvth&quot;.equals(mode)) {</span>
<span class="nc" id="L1463">          tmode = RequestPacket.TRANSFERMODE.RECVTHROUGHMODE;</span>
<span class="nc" id="L1464">          gmode = -1;</span>
<span class="nc bnc" id="L1465" title="All 2 branches missed.">        } else if (&quot;sendthmd5&quot;.equals(mode)) {</span>
<span class="nc" id="L1466">          tmode = RequestPacket.TRANSFERMODE.SENDMD5THROUGHMODE;</span>
<span class="nc" id="L1467">          gmode = -2;</span>
<span class="nc bnc" id="L1468" title="All 2 branches missed.">        } else if (&quot;recvthmd5&quot;.equals(mode)) {</span>
<span class="nc" id="L1469">          tmode = RequestPacket.TRANSFERMODE.RECVMD5THROUGHMODE;</span>
<span class="nc" id="L1470">          gmode = -1;</span>
        }
<span class="nc" id="L1472">        head = resetOptionRules(head, rule, tmode, gmode);</span>
<span class="nc bnc" id="L1473" title="All 2 branches missed.">        logger.debug(&quot;Recv UpdOrInsert: &quot; + rule + ':' + hostids + ':' +</span>
<span class="nc" id="L1474">                     (tmode != null? tmode.ordinal() : 0) + ':' + recvp + ':' +</span>
                     sendp + ':' + archp + ':' + workp + ':' + rpre + ':' +
                     rpost + ':' + rerr + ':' + spre + ':' + spost + ':' +
                     serr);
<span class="nc bnc" id="L1478" title="All 2 branches missed.">        final DbRule dbrule =</span>
<span class="nc" id="L1479">            new DbRule(rule, hostids, (tmode != null? tmode.ordinal() : 0),</span>
                       recvp, sendp, archp, workp, rpre, rpost, rerr, spre,
                       spost, serr);
        try {
<span class="nc bnc" id="L1483" title="All 2 branches missed.">          if (CREATE.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L1484">            dbrule.insert();</span>
          } else {
<span class="nc bnc" id="L1486" title="All 2 branches missed.">            if (dbrule.exist()) {</span>
<span class="nc" id="L1487">              dbrule.update();</span>
            } else {
<span class="nc" id="L1489">              dbrule.insert();</span>
            }
          }
<span class="nc" id="L1492">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1493">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1494">          body = Messages.getString(&quot;HttpSslHandler.28&quot;) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1497">          head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1498">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L1499">        }</span>
<span class="nc" id="L1500">        body = REQUEST.Rules.readBody();</span>
<span class="nc" id="L1501">        body = dbrule.toSpecializedHtml(authentHttp, body);</span>
<span class="pc bpc" id="L1502" title="1 of 2 branches missed.">      } else if (FILTER.equalsIgnoreCase(parm)) {</span>
<span class="fc" id="L1503">        final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="fc" id="L1504">        final String mode = getTrimValue(&quot;mode&quot;);</span>
        TRANSFERMODE tmode;
<span class="fc" id="L1506">        int gmode = 0;</span>
<span class="pc bpc" id="L1507" title="1 of 2 branches missed.">        if (&quot;all&quot;.equals(mode)) {</span>
<span class="fc" id="L1508">          gmode = -3;</span>
<span class="nc bnc" id="L1509" title="All 2 branches missed.">        } else if (&quot;send&quot;.equals(mode)) {</span>
<span class="nc" id="L1510">          gmode = -2;</span>
<span class="nc bnc" id="L1511" title="All 2 branches missed.">        } else if (&quot;recv&quot;.equals(mode)) {</span>
<span class="nc" id="L1512">          gmode = -1;</span>
        }
<span class="pc bpc" id="L1514" title="1 of 2 branches missed.">        head = resetOptionRules(head, rule == null? &quot;&quot; : rule, null, gmode);</span>
<span class="fc" id="L1515">        body = REQUEST.Rules.readBody();</span>
<span class="fc" id="L1516">        final StringBuilder builder = new StringBuilder();</span>
<span class="fc" id="L1517">        boolean specific = false;</span>
<span class="fc" id="L1518">        int start = 1;</span>
<span class="pc bpc" id="L1519" title="1 of 2 branches missed.">        if (params.containsKey(&quot;send&quot;)) {</span>
<span class="nc" id="L1520">          tmode = RequestPacket.TRANSFERMODE.SENDMODE;</span>
<span class="nc bnc" id="L1521" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1522">          specific = true;</span>
<span class="nc" id="L1523">          createExport(body, builder, rule,</span>
<span class="nc" id="L1524">                       RequestPacket.TRANSFERMODE.SENDMODE.ordinal(),</span>
<span class="nc" id="L1525">                       getLimitRow() / 4, start);</span>
<span class="nc" id="L1526">          start += getLimitRow() / 4 + 1;</span>
        }
<span class="pc bpc" id="L1528" title="1 of 2 branches missed.">        if (params.containsKey(&quot;recv&quot;)) {</span>
<span class="nc" id="L1529">          tmode = RequestPacket.TRANSFERMODE.RECVMODE;</span>
<span class="nc bnc" id="L1530" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1531">          specific = true;</span>
<span class="nc" id="L1532">          createExport(body, builder, rule,</span>
<span class="nc" id="L1533">                       RequestPacket.TRANSFERMODE.RECVMODE.ordinal(),</span>
<span class="nc" id="L1534">                       getLimitRow() / 4, start);</span>
<span class="nc" id="L1535">          start += getLimitRow() / 4 + 1;</span>
        }
<span class="pc bpc" id="L1537" title="1 of 2 branches missed.">        if (params.containsKey(&quot;sendmd5&quot;)) {</span>
<span class="nc" id="L1538">          tmode = RequestPacket.TRANSFERMODE.SENDMD5MODE;</span>
<span class="nc bnc" id="L1539" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1540">          specific = true;</span>
<span class="nc" id="L1541">          createExport(body, builder, rule,</span>
<span class="nc" id="L1542">                       RequestPacket.TRANSFERMODE.SENDMD5MODE.ordinal(),</span>
<span class="nc" id="L1543">                       getLimitRow() / 4, start);</span>
<span class="nc" id="L1544">          start += getLimitRow() / 4 + 1;</span>
        }
<span class="pc bpc" id="L1546" title="1 of 2 branches missed.">        if (params.containsKey(&quot;recvmd5&quot;)) {</span>
<span class="nc" id="L1547">          tmode = RequestPacket.TRANSFERMODE.RECVMD5MODE;</span>
<span class="nc bnc" id="L1548" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1549">          specific = true;</span>
<span class="nc" id="L1550">          createExport(body, builder, rule,</span>
<span class="nc" id="L1551">                       RequestPacket.TRANSFERMODE.RECVMD5MODE.ordinal(),</span>
<span class="nc" id="L1552">                       getLimitRow() / 4, start);</span>
<span class="nc" id="L1553">          start += getLimitRow() / 4 + 1;</span>
        }
<span class="pc bpc" id="L1555" title="1 of 2 branches missed.">        if (params.containsKey(&quot;sendth&quot;)) {</span>
<span class="nc" id="L1556">          tmode = RequestPacket.TRANSFERMODE.SENDTHROUGHMODE;</span>
<span class="nc bnc" id="L1557" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1558">          specific = true;</span>
<span class="nc" id="L1559">          createExport(body, builder, rule,</span>
<span class="nc" id="L1560">                       RequestPacket.TRANSFERMODE.SENDTHROUGHMODE.ordinal(),</span>
<span class="nc" id="L1561">                       getLimitRow() / 4, start);</span>
<span class="nc" id="L1562">          start += getLimitRow() / 4 + 1;</span>
        }
<span class="pc bpc" id="L1564" title="1 of 2 branches missed.">        if (params.containsKey(&quot;recvth&quot;)) {</span>
<span class="nc" id="L1565">          tmode = RequestPacket.TRANSFERMODE.RECVTHROUGHMODE;</span>
<span class="nc bnc" id="L1566" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1567">          specific = true;</span>
<span class="nc" id="L1568">          createExport(body, builder, rule,</span>
<span class="nc" id="L1569">                       RequestPacket.TRANSFERMODE.RECVTHROUGHMODE.ordinal(),</span>
<span class="nc" id="L1570">                       getLimitRow() / 4, start);</span>
<span class="nc" id="L1571">          start += getLimitRow() / 4 + 1;</span>
        }
<span class="pc bpc" id="L1573" title="1 of 2 branches missed.">        if (params.containsKey(&quot;sendthmd5&quot;)) {</span>
<span class="nc" id="L1574">          tmode = RequestPacket.TRANSFERMODE.SENDMD5THROUGHMODE;</span>
<span class="nc bnc" id="L1575" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1576">          specific = true;</span>
<span class="nc" id="L1577">          createExport(body, builder, rule,</span>
<span class="nc" id="L1578">                       RequestPacket.TRANSFERMODE.SENDMD5THROUGHMODE.ordinal(),</span>
<span class="nc" id="L1579">                       getLimitRow() / 4, start);</span>
<span class="nc" id="L1580">          start += getLimitRow() / 4 + 1;</span>
        }
<span class="pc bpc" id="L1582" title="1 of 2 branches missed.">        if (params.containsKey(&quot;recvthmd5&quot;)) {</span>
<span class="nc" id="L1583">          tmode = RequestPacket.TRANSFERMODE.RECVMD5THROUGHMODE;</span>
<span class="nc bnc" id="L1584" title="All 2 branches missed.">          head = resetOptionRules(head, rule == null? &quot;&quot; : rule, tmode, gmode);</span>
<span class="nc" id="L1585">          specific = true;</span>
<span class="nc" id="L1586">          createExport(body, builder, rule,</span>
<span class="nc" id="L1587">                       RequestPacket.TRANSFERMODE.RECVMD5THROUGHMODE.ordinal(),</span>
<span class="nc" id="L1588">                       getLimitRow() / 4, start);</span>
<span class="nc" id="L1589">          start += getLimitRow() / 4 + 1;</span>
        }
<span class="pc bpc" id="L1591" title="1 of 2 branches missed.">        if (!specific) {</span>
<span class="pc bpc" id="L1592" title="1 of 2 branches missed.">          if (gmode == -1) {</span>
            // recv
<span class="nc" id="L1594">            createExport(body, builder, rule,</span>
<span class="nc" id="L1595">                         RequestPacket.TRANSFERMODE.RECVMODE.ordinal(),</span>
<span class="nc" id="L1596">                         getLimitRow() / 4, start);</span>
<span class="nc" id="L1597">            start += getLimitRow() / 4 + 1;</span>
<span class="nc" id="L1598">            createExport(body, builder, rule,</span>
<span class="nc" id="L1599">                         RequestPacket.TRANSFERMODE.RECVMD5MODE.ordinal(),</span>
<span class="nc" id="L1600">                         getLimitRow() / 4, start);</span>
<span class="nc" id="L1601">            start += getLimitRow() / 4 + 1;</span>
<span class="nc" id="L1602">            createExport(body, builder, rule,</span>
<span class="nc" id="L1603">                         RequestPacket.TRANSFERMODE.RECVTHROUGHMODE.ordinal(),</span>
<span class="nc" id="L1604">                         getLimitRow() / 4, start);</span>
<span class="nc" id="L1605">            start += getLimitRow() / 4 + 1;</span>
<span class="nc" id="L1606">            createExport(body, builder, rule,</span>
                         RequestPacket.TRANSFERMODE.RECVMD5THROUGHMODE
<span class="nc" id="L1608">                             .ordinal(), getLimitRow() / 4, start);</span>
<span class="nc" id="L1609">            start += getLimitRow() / 4 + 1;</span>
<span class="pc bpc" id="L1610" title="1 of 2 branches missed.">          } else if (gmode == -2) {</span>
            // send
<span class="nc" id="L1612">            createExport(body, builder, rule,</span>
<span class="nc" id="L1613">                         RequestPacket.TRANSFERMODE.SENDMODE.ordinal(),</span>
<span class="nc" id="L1614">                         getLimitRow() / 4, start);</span>
<span class="nc" id="L1615">            start += getLimitRow() / 4 + 1;</span>
<span class="nc" id="L1616">            createExport(body, builder, rule,</span>
<span class="nc" id="L1617">                         RequestPacket.TRANSFERMODE.SENDMD5MODE.ordinal(),</span>
<span class="nc" id="L1618">                         getLimitRow() / 4, start);</span>
<span class="nc" id="L1619">            start += getLimitRow() / 4 + 1;</span>
<span class="nc" id="L1620">            createExport(body, builder, rule,</span>
<span class="nc" id="L1621">                         RequestPacket.TRANSFERMODE.SENDTHROUGHMODE.ordinal(),</span>
<span class="nc" id="L1622">                         getLimitRow() / 4, start);</span>
<span class="nc" id="L1623">            start += getLimitRow() / 4 + 1;</span>
<span class="nc" id="L1624">            createExport(body, builder, rule,</span>
                         RequestPacket.TRANSFERMODE.SENDMD5THROUGHMODE
<span class="nc" id="L1626">                             .ordinal(), getLimitRow() / 4, start);</span>
<span class="nc" id="L1627">            start += getLimitRow() / 4 + 1;</span>
          } else {
            // all
<span class="fc" id="L1630">            createExport(body, builder, rule, -1, getLimitRow(), start);</span>
<span class="fc" id="L1631">            start += getLimitRow() + 1;</span>
          }
        }
<span class="fc" id="L1634">        body = builder.toString();</span>
<span class="fc" id="L1635">        body1 = REQUEST.Rules.readBodyEnd();</span>
<span class="pc bnc" id="L1636" title="All 2 branches missed.">      } else if (&quot;Delete&quot;.equalsIgnoreCase(parm)) {</span>
<span class="nc" id="L1637">        final String rule = getTrimValue(&quot;rule&quot;);</span>
<span class="nc bnc" id="L1638" title="All 4 branches missed.">        if (rule == null || rule.isEmpty()) {</span>
<span class="nc" id="L1639">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1640">          body = Messages.getString(&quot;HttpSslHandler.29&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1641">          head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1642">          return head + body0 + body + body1 + end;</span>
        }
        DbRule dbrule;
        try {
<span class="nc" id="L1646">          dbrule = new DbRule(rule);</span>
<span class="nc" id="L1647">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1648">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1649">          body = Messages.getString(&quot;HttpSslHandler.30&quot;) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1652">          head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1653">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L1654">        }</span>
        try {
<span class="nc" id="L1656">          dbrule.delete();</span>
<span class="nc" id="L1657">        } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L1658">          body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1659">          body = Messages.getString(&quot;HttpSslHandler.30&quot;) + e.getMessage()</span>
                 //$NON-NLS-1$
                 + B_CENTER_P;
<span class="nc" id="L1662">          head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1663">          return head + body0 + body + body1 + end;</span>
<span class="nc" id="L1664">        }</span>
<span class="nc" id="L1665">        body0 = body1 = body = &quot;&quot;;</span>
<span class="nc" id="L1666">        body = Messages.getString(&quot;HttpSslHandler.31&quot;) + rule +</span>
               B_CENTER_P; //$NON-NLS-1$
<span class="nc" id="L1668">        head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
<span class="nc" id="L1669">        return head + body0 + body + body1 + end;</span>
      } else {
<span class="nc" id="L1671">        head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
      }
<span class="fc" id="L1673">      body1 = REQUEST.Rules.readBodyEnd();</span>
<span class="fc" id="L1674">    } else {</span>
<span class="nc" id="L1675">      head = resetOptionRules(head, &quot;&quot;, null, -3);</span>
    }
<span class="fc" id="L1677">    return head + body0 + body + body1 + end;</span>
  }

  private String spooled0(boolean detailed) {
    // XXXSPOOLEDXXX
<span class="fc" id="L1682">    final String spooled = REQUEST.Spooled.readFileUnique(this);</span>
    String uri;
<span class="pc bpc" id="L1684" title="1 of 2 branches missed.">    if (detailed) {</span>
<span class="nc" id="L1685">      uri = &quot;SpooledDetailed.html&quot;;</span>
    } else {
<span class="fc" id="L1687">      uri = &quot;Spooled.html&quot;;</span>
    }
<span class="fc" id="L1689">    final QueryStringDecoder queryStringDecoder =</span>
<span class="fc" id="L1690">        new QueryStringDecoder(request.uri());</span>
<span class="fc" id="L1691">    params = queryStringDecoder.parameters();</span>
<span class="fc" id="L1692">    String name = null;</span>
<span class="pc bpc" id="L1693" title="2 of 4 branches missed.">    if (params != null &amp;&amp; params.containsKey(&quot;name&quot;)) {</span>
<span class="nc" id="L1694">      name = getTrimValue(&quot;name&quot;);</span>
    }
<span class="fc" id="L1696">    int istatus = 0;</span>
<span class="pc bpc" id="L1697" title="2 of 4 branches missed.">    if (params != null &amp;&amp; params.containsKey(&quot;status&quot;)) {</span>
<span class="nc" id="L1698">      final String status = getTrimValue(&quot;status&quot;);</span>
      try {
<span class="nc" id="L1700">        istatus = Integer.parseInt(status);</span>
<span class="nc" id="L1701">      } catch (final NumberFormatException e1) {</span>
<span class="nc" id="L1702">        istatus = 0;</span>
<span class="nc" id="L1703">      }</span>
    }
<span class="pc bpc" id="L1705" title="3 of 4 branches missed.">    if (name != null &amp;&amp; !name.isEmpty()) {</span>
      // name is specified
<span class="nc" id="L1707">      uri = request.uri();</span>
<span class="nc bnc" id="L1708" title="All 2 branches missed.">      if (istatus != 0) {</span>
<span class="nc" id="L1709">        uri += &quot;&amp;status=&quot; + istatus;</span>
      }
<span class="nc" id="L1711">      final StringBuilder builder =</span>
<span class="nc" id="L1712">          SpooledInformTask.buildSpooledUniqueTable(uri, name);</span>
<span class="nc" id="L1713">      return spooled.replace(&quot;XXXSPOOLEDXXX&quot;, builder.toString());</span>
    } else {
<span class="pc bpc" id="L1715" title="1 of 2 branches missed.">      if (istatus != 0) {</span>
<span class="nc" id="L1716">        uri += &quot;&amp;status=&quot; + istatus;</span>
      }
<span class="fc" id="L1718">      final StringBuilder builder =</span>
<span class="fc" id="L1719">          SpooledInformTask.buildSpooledTable(detailed, istatus, uri);</span>
<span class="fc" id="L1720">      return spooled.replace(&quot;XXXSPOOLEDXXX&quot;, builder.toString());</span>
    }
  }

  /**
   * Applied current lang to system page
   *
   * @param builder
   */
  protected void langHandle(StringBuilder builder) {
    // i18n: add here any new languages
<span class="fc" id="L1731">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXCURLANGENXXX.name(),</span>
<span class="fc bfc" id="L1732" title="All 2 branches covered.">                             &quot;en&quot;.equalsIgnoreCase(lang)? CHECKED : &quot;&quot;);</span>
<span class="fc" id="L1733">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXCURLANGFRXXX.name(),</span>
<span class="fc bfc" id="L1734" title="All 2 branches covered.">                             &quot;fr&quot;.equalsIgnoreCase(lang)? CHECKED : &quot;&quot;);</span>
<span class="fc" id="L1735">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXCURSYSLANGENXXX.name(),</span>
<span class="fc bfc" id="L1736" title="All 2 branches covered.">                             &quot;en&quot;.equalsIgnoreCase(Messages.getSlocale())?</span>
                                 CHECKED : &quot;&quot;);
<span class="fc" id="L1738">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXCURSYSLANGFRXXX.name(),</span>
<span class="fc bfc" id="L1739" title="All 2 branches covered.">                             &quot;fr&quot;.equalsIgnoreCase(Messages.getSlocale())?</span>
                                 CHECKED : &quot;&quot;);
<span class="fc" id="L1741">  }</span>

  private String systemLimitedSource0() {
<span class="fc" id="L1744">    final String system = REQUEST.SystemLimited.readFileUnique(this);</span>
<span class="pc bpc" id="L1745" title="2 of 4 branches missed.">    if (system == null || system.isEmpty()) {</span>
<span class="nc" id="L1746">      return REQUEST.System.readFileUnique(this);</span>
    }
<span class="fc" id="L1748">    return system;</span>
  }

  String systemLimited() {
<span class="fc" id="L1752">    getParams();</span>
    DbHostConfiguration config;
    try {
<span class="fc" id="L1755">      config = new DbHostConfiguration(Configuration.configuration.getHostId());</span>
<span class="nc" id="L1756">    } catch (final WaarpDatabaseException e2) {</span>
<span class="nc" id="L1757">      config =</span>
<span class="nc" id="L1758">          new DbHostConfiguration(Configuration.configuration.getHostId(), &quot;&quot;,</span>
                                  &quot;&quot;, &quot;&quot;, &quot;&quot;);
      try {
<span class="nc" id="L1761">        config.insert();</span>
<span class="nc" id="L1762">      } catch (final WaarpDatabaseException ignored) {</span>
        // nothing
<span class="nc" id="L1764">      }</span>
<span class="fc" id="L1765">    }</span>
<span class="fc bfc" id="L1766" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L1767">      final String system = systemLimitedSource0();</span>
<span class="fc" id="L1768">      final StringBuilder builder = new StringBuilder(system);</span>
<span class="fc" id="L1769">      replaceStringSystem(config, builder);</span>
<span class="fc" id="L1770">      langHandle(builder);</span>
<span class="fc" id="L1771">      return builder.toString();</span>
    }
<span class="fc" id="L1773">    String extraInformation = null;</span>
<span class="pc bpc" id="L1774" title="1 of 2 branches missed.">    if (params.containsKey(ACTION)) {</span>
<span class="fc" id="L1775">      final List&lt;String&gt; action = params.get(ACTION);</span>
<span class="fc bfc" id="L1776" title="All 2 branches covered.">      for (final String act : action) {</span>
<span class="pc bpc" id="L1777" title="1 of 2 branches missed.">        if (&quot;Language&quot;.equalsIgnoreCase(act)) {</span>
<span class="nc" id="L1778">          lang = getTrimValue(&quot;change&quot;);</span>
<span class="nc" id="L1779">          extraInformation =</span>
<span class="nc" id="L1780">              Messages.getString(HTTP_SSL_HANDLER_LANG_IS) + &quot;Web: &quot; + lang +</span>
              &quot; OpenR66: &quot; //$NON-NLS-1$
<span class="nc" id="L1782">              + Messages.getSlocale();</span>
<span class="pc bpc" id="L1783" title="1 of 2 branches missed.">        } else if (&quot;Disconnect&quot;.equalsIgnoreCase(act)) {</span>
<span class="nc" id="L1784">          String logon = logon();</span>
<span class="nc" id="L1785">          logon = logon.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(),</span>
                                   Messages
<span class="nc" id="L1787">                                       .getString(&quot;HttpSslHandler.DisActive&quot;));</span>
<span class="nc" id="L1788">          newSession = true;</span>
<span class="nc" id="L1789">          clearSession();</span>
<span class="nc" id="L1790">          forceClose = true;</span>
<span class="nc" id="L1791">          return logon;</span>
        }
<span class="fc" id="L1793">      }</span>
    }
<span class="fc" id="L1795">    final String system = systemLimitedSource0();</span>
<span class="fc" id="L1796">    final StringBuilder builder = new StringBuilder(system);</span>
<span class="fc" id="L1797">    replaceStringSystem(config, builder);</span>
<span class="fc" id="L1798">    langHandle(builder);</span>
<span class="pc bpc" id="L1799" title="1 of 2 branches missed.">    if (extraInformation != null) {</span>
<span class="nc" id="L1800">      builder.append(extraInformation);</span>
    }
<span class="fc" id="L1802">    return builder.toString();</span>
  }

  /**
   * @param config
   * @param builder
   */
  void replaceStringSystem(DbHostConfiguration config, StringBuilder builder) {
<span class="fc" id="L1810">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXXBUSINESSXXX.toString(),</span>
<span class="fc" id="L1811">                             config.getBusiness());</span>
<span class="fc" id="L1812">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXXROLESXXX.toString(),</span>
<span class="fc" id="L1813">                             config.getRoles());</span>
<span class="fc" id="L1814">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXXALIASESXXX.toString(),</span>
<span class="fc" id="L1815">                             config.getAliases());</span>
<span class="fc" id="L1816">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXXOTHERXXX.toString(),</span>
<span class="fc" id="L1817">                             config.getOthers());</span>
<span class="fc" id="L1818">    WaarpStringUtils</span>
<span class="fc" id="L1819">        .replace(builder, REPLACEMENT.XXXXSESSIONLIMITWXXX.toString(),</span>
<span class="fc" id="L1820">                 Long.toString(</span>
<span class="fc" id="L1821">                     Configuration.configuration.getServerChannelWriteLimit()));</span>
<span class="fc" id="L1822">    WaarpStringUtils</span>
<span class="fc" id="L1823">        .replace(builder, REPLACEMENT.XXXXSESSIONLIMITRXXX.toString(),</span>
<span class="fc" id="L1824">                 Long.toString(</span>
<span class="fc" id="L1825">                     Configuration.configuration.getServerChannelReadLimit()));</span>
<span class="fc" id="L1826">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXXDELATRAFFICXXX.toString(),</span>
<span class="fc" id="L1827">                             Long.toString(</span>
<span class="fc" id="L1828">                                 Configuration.configuration.getDelayLimit()));</span>
<span class="fc" id="L1829">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXXDELAYCOMMDXXX.toString(),</span>
<span class="fc" id="L1830">                             Long.toString(Configuration.configuration</span>
<span class="fc" id="L1831">                                               .getDelayCommander()));</span>
<span class="fc" id="L1832">    WaarpStringUtils.replace(builder, REPLACEMENT.XXXXDELAYRETRYXXX.toString(),</span>
<span class="fc" id="L1833">                             Long.toString(</span>
<span class="fc" id="L1834">                                 Configuration.configuration.getDelayRetry()));</span>
<span class="fc" id="L1835">    WaarpStringUtils</span>
<span class="fc" id="L1836">        .replace(builder, REPLACEMENT.XXXXCHANNELLIMITWXXX.toString(),</span>
<span class="fc" id="L1837">                 Long.toString(</span>
<span class="fc" id="L1838">                     Configuration.configuration.getServerGlobalWriteLimit()));</span>
<span class="fc" id="L1839">    WaarpStringUtils</span>
<span class="fc" id="L1840">        .replace(builder, REPLACEMENT.XXXXCHANNELLIMITRXXX.toString(),</span>
<span class="fc" id="L1841">                 Long.toString(</span>
<span class="fc" id="L1842">                     Configuration.configuration.getServerGlobalReadLimit()));</span>
<span class="fc" id="L1843">    WaarpStringUtils.replace(builder, &quot;XXXBLOCKXXX&quot;,</span>
<span class="fc bfc" id="L1844" title="All 2 branches covered.">                             Configuration.configuration.isShutdown()? CHECKED :</span>
                                 &quot;&quot;);
<span class="pc bpc" id="L1846" title="3 of 5 branches missed.">    switch (WaarpLoggerFactory.getLogLevel()) {</span>
      case DEBUG:
<span class="fc" id="L1848">        WaarpStringUtils.replace(builder, XXXLEVEL1XXX, CHECKED);</span>
<span class="fc" id="L1849">        WaarpStringUtils.replace(builder, XXXLEVEL2XXX, &quot;&quot;);</span>
<span class="fc" id="L1850">        WaarpStringUtils.replace(builder, XXXLEVEL3XXX, &quot;&quot;);</span>
<span class="fc" id="L1851">        WaarpStringUtils.replace(builder, XXXLEVEL4XXX, &quot;&quot;);</span>
<span class="fc" id="L1852">        break;</span>
      case INFO:
<span class="nc" id="L1854">        WaarpStringUtils.replace(builder, XXXLEVEL1XXX, &quot;&quot;);</span>
<span class="nc" id="L1855">        WaarpStringUtils.replace(builder, XXXLEVEL2XXX, CHECKED);</span>
<span class="nc" id="L1856">        WaarpStringUtils.replace(builder, XXXLEVEL3XXX, &quot;&quot;);</span>
<span class="nc" id="L1857">        WaarpStringUtils.replace(builder, XXXLEVEL4XXX, &quot;&quot;);</span>
<span class="nc" id="L1858">        break;</span>
      case WARN:
<span class="fc" id="L1860">        WaarpStringUtils.replace(builder, XXXLEVEL1XXX, &quot;&quot;);</span>
<span class="fc" id="L1861">        WaarpStringUtils.replace(builder, XXXLEVEL2XXX, &quot;&quot;);</span>
<span class="fc" id="L1862">        WaarpStringUtils.replace(builder, XXXLEVEL3XXX, CHECKED);</span>
<span class="fc" id="L1863">        WaarpStringUtils.replace(builder, XXXLEVEL4XXX, &quot;&quot;);</span>
<span class="fc" id="L1864">        break;</span>
      case ERROR:
<span class="nc" id="L1866">        WaarpStringUtils.replace(builder, XXXLEVEL1XXX, &quot;&quot;);</span>
<span class="nc" id="L1867">        WaarpStringUtils.replace(builder, XXXLEVEL2XXX, &quot;&quot;);</span>
<span class="nc" id="L1868">        WaarpStringUtils.replace(builder, XXXLEVEL3XXX, &quot;&quot;);</span>
<span class="nc" id="L1869">        WaarpStringUtils.replace(builder, XXXLEVEL4XXX, CHECKED);</span>
<span class="nc" id="L1870">        break;</span>
      default:
<span class="nc" id="L1872">        WaarpStringUtils.replace(builder, XXXLEVEL1XXX, &quot;&quot;);</span>
<span class="nc" id="L1873">        WaarpStringUtils.replace(builder, XXXLEVEL2XXX, &quot;&quot;);</span>
<span class="nc" id="L1874">        WaarpStringUtils.replace(builder, XXXLEVEL3XXX, &quot;&quot;);</span>
<span class="nc" id="L1875">        WaarpStringUtils.replace(builder, XXXLEVEL4XXX, &quot;&quot;);</span>
        break;

    }
<span class="fc" id="L1879">  }</span>

  String logout() {
<span class="fc" id="L1882">    String logon = logon();</span>
<span class="fc" id="L1883">    logon = logon.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(),</span>
<span class="fc" id="L1884">                             Messages.getString(&quot;HttpSslHandler.Disconnected&quot;));</span>
<span class="fc" id="L1885">    newSession = true;</span>
<span class="fc" id="L1886">    clearSession();</span>
<span class="fc" id="L1887">    forceClose = true;</span>
<span class="fc" id="L1888">    return logon;</span>
  }

  private String system0() {
<span class="fc" id="L1892">    getParams();</span>
    DbHostConfiguration config;
    try {
<span class="fc" id="L1895">      config = new DbHostConfiguration(Configuration.configuration.getHostId());</span>
<span class="nc" id="L1896">    } catch (final WaarpDatabaseException e2) {</span>
<span class="nc" id="L1897">      config =</span>
<span class="nc" id="L1898">          new DbHostConfiguration(Configuration.configuration.getHostId(), &quot;&quot;,</span>
                                  &quot;&quot;, &quot;&quot;, &quot;&quot;);
      try {
<span class="nc" id="L1901">        config.insert();</span>
<span class="nc" id="L1902">      } catch (final WaarpDatabaseException ignored) {</span>
        // nothing
<span class="nc" id="L1904">      }</span>
<span class="fc" id="L1905">    }</span>
<span class="fc bfc" id="L1906" title="All 2 branches covered.">    if (params == null) {</span>
<span class="fc" id="L1907">      final String system = REQUEST.System.readFileUnique(this);</span>
<span class="fc" id="L1908">      final StringBuilder builder = new StringBuilder(system);</span>
<span class="fc" id="L1909">      replaceStringSystem(config, builder);</span>
<span class="fc" id="L1910">      langHandle(builder);</span>
<span class="fc" id="L1911">      return builder.toString();</span>
    }
<span class="fc" id="L1913">    String extraInformation = null;</span>
<span class="pc bpc" id="L1914" title="1 of 2 branches missed.">    if (params.containsKey(ACTION)) {</span>
<span class="fc" id="L1915">      final List&lt;String&gt; action = params.get(ACTION);</span>
<span class="fc bfc" id="L1916" title="All 2 branches covered.">      for (final String act : action) {</span>
<span class="fc bfc" id="L1917" title="All 2 branches covered.">        if (&quot;Language&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L1918">          lang = getTrimValue(&quot;change&quot;);</span>
<span class="fc" id="L1919">          final String sys = getTrimValue(&quot;changesys&quot;);</span>
<span class="fc" id="L1920">          Messages.init(new Locale(sys));</span>
<span class="fc" id="L1921">          extraInformation =</span>
<span class="fc" id="L1922">              Messages.getString(HTTP_SSL_HANDLER_LANG_IS) + &quot;Web: &quot; + lang +</span>
              &quot; OpenR66: &quot; //$NON-NLS-1$
<span class="fc" id="L1924">              + Messages.getSlocale();</span>
<span class="fc bfc" id="L1925" title="All 2 branches covered.">        } else if (&quot;Level&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L1926">          final String loglevel = getTrimValue(&quot;loglevel&quot;);</span>
<span class="fc" id="L1927">          WaarpLogLevel level = WaarpLogLevel.WARN;</span>
<span class="fc bfc" id="L1928" title="All 2 branches covered.">          if (&quot;debug&quot;.equalsIgnoreCase(loglevel)) {</span>
<span class="fc" id="L1929">            level = WaarpLogLevel.DEBUG;</span>
<span class="pc bpc" id="L1930" title="1 of 2 branches missed.">          } else if (&quot;info&quot;.equalsIgnoreCase(loglevel)) {</span>
<span class="nc" id="L1931">            level = WaarpLogLevel.INFO;</span>
<span class="pc bpc" id="L1932" title="1 of 2 branches missed.">          } else if (&quot;warn&quot;.equalsIgnoreCase(loglevel)) {</span>
<span class="fc" id="L1933">            level = WaarpLogLevel.WARN;</span>
<span class="nc bnc" id="L1934" title="All 2 branches missed.">          } else if (ERROR2.equalsIgnoreCase(loglevel)) {</span>
<span class="nc" id="L1935">            level = WaarpLogLevel.ERROR;</span>
          }
<span class="fc" id="L1937">          WaarpLoggerFactory.setLogLevel(level);</span>
<span class="fc" id="L1938">          extraInformation = Messages.getString(HTTP_SSL_HANDLER_LANG_IS) +</span>
<span class="fc" id="L1939">                             level.name(); //$NON-NLS-1$</span>
<span class="fc bfc" id="L1940" title="All 2 branches covered.">        } else if (&quot;ExportConfig&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L1941">          final String directory =</span>
<span class="fc" id="L1942">              Configuration.configuration.getBaseDirectory() +</span>
              DirInterface.SEPARATOR +
<span class="fc" id="L1944">              Configuration.configuration.getArchivePath();</span>
<span class="fc" id="L1945">          extraInformation =</span>
<span class="fc" id="L1946">              Messages.getString(&quot;HttpSslHandler.ExportDir&quot;) + directory +</span>
              &quot;&lt;br&gt;&quot;; //$NON-NLS-1$
<span class="fc" id="L1948">          final String[] filenames = ServerActions</span>
<span class="fc" id="L1949">              .staticConfigExport(directory, true, true, true, true, true);</span>
          // hosts, rules, business, alias, roles
<span class="pc bpc" id="L1951" title="1 of 2 branches missed.">          if (filenames[0] != null) {</span>
<span class="fc" id="L1952">            extraInformation +=</span>
<span class="fc" id="L1953">                Messages.getString(&quot;HttpSslHandler.33&quot;); //$NON-NLS-1$</span>
          }
<span class="pc bpc" id="L1955" title="1 of 2 branches missed.">          if (filenames[1] != null) {</span>
<span class="fc" id="L1956">            extraInformation +=</span>
<span class="fc" id="L1957">                Messages.getString(&quot;HttpSslHandler.32&quot;); //$NON-NLS-1$</span>
          }
<span class="pc bpc" id="L1959" title="1 of 2 branches missed.">          if (filenames[2] != null) {</span>
<span class="fc" id="L1960">            extraInformation +=</span>
<span class="fc" id="L1961">                Messages.getString(&quot;HttpSslHandler.44&quot;); //$NON-NLS-1$</span>
          }
<span class="pc bpc" id="L1963" title="1 of 2 branches missed.">          if (filenames[3] != null) {</span>
<span class="fc" id="L1964">            extraInformation +=</span>
<span class="fc" id="L1965">                Messages.getString(&quot;HttpSslHandler.45&quot;); //$NON-NLS-1$</span>
          }
<span class="pc bpc" id="L1967" title="1 of 2 branches missed.">          if (filenames[4] != null) {</span>
<span class="fc" id="L1968">            extraInformation +=</span>
<span class="fc" id="L1969">                Messages.getString(&quot;HttpSslHandler.46&quot;); //$NON-NLS-1$</span>
          }
<span class="fc bfc" id="L1971" title="All 2 branches covered.">        } else if (&quot;Disconnect&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L1972">          return logout();</span>
<span class="fc bfc" id="L1973" title="All 2 branches covered.">        } else if (&quot;Block&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L1974">          final boolean block = params.containsKey(&quot;blocking&quot;);</span>
<span class="fc bfc" id="L1975" title="All 2 branches covered.">          if (block) {</span>
<span class="fc" id="L1976">            extraInformation =</span>
<span class="fc" id="L1977">                Messages.getString(&quot;HttpSslHandler.34&quot;); //$NON-NLS-1$</span>
          } else {
<span class="fc" id="L1979">            extraInformation =</span>
<span class="fc" id="L1980">                Messages.getString(&quot;HttpSslHandler.35&quot;); //$NON-NLS-1$</span>
          }
<span class="fc" id="L1982">          Configuration.configuration.setShutdown(block);</span>
<span class="pc bpc" id="L1983" title="1 of 2 branches missed.">        } else if (&quot;Shutdown&quot;.equalsIgnoreCase(act)) {</span>
          String error;
<span class="nc" id="L1985">          if (Configuration.configuration</span>
<span class="nc bnc" id="L1986" title="All 2 branches missed.">                  .getShutdownConfiguration().serviceFuture != null) {</span>
<span class="nc" id="L1987">            error =</span>
<span class="nc" id="L1988">                error(Messages.getString(&quot;HttpSslHandler.38&quot;)); //$NON-NLS-1$</span>
          } else {
<span class="nc" id="L1990">            error =</span>
<span class="nc" id="L1991">                error(Messages.getString(&quot;HttpSslHandler.37&quot;)); //$NON-NLS-1$</span>
          }
<span class="nc" id="L1993">          WaarpShutdownHook.setRestart(false);</span>
<span class="nc" id="L1994">          newSession = true;</span>
<span class="nc" id="L1995">          clearSession();</span>
<span class="nc" id="L1996">          forceClose = true;</span>
<span class="nc" id="L1997">          shutdown = true;</span>
<span class="nc" id="L1998">          return error;</span>
<span class="pc bpc" id="L1999" title="1 of 2 branches missed.">        } else if (&quot;Restart&quot;.equalsIgnoreCase(act)) {</span>
          String error;
<span class="nc" id="L2001">          if (Configuration.configuration</span>
<span class="nc bnc" id="L2002" title="All 2 branches missed.">                  .getShutdownConfiguration().serviceFuture != null) {</span>
<span class="nc" id="L2003">            error =</span>
<span class="nc" id="L2004">                error(Messages.getString(&quot;HttpSslHandler.38&quot;)); //$NON-NLS-1$</span>
          } else {
<span class="nc" id="L2006">            error = error(Messages.getString(&quot;HttpSslHandler.39&quot;)</span>
                          //$NON-NLS-1$
<span class="nc" id="L2008">                          + Configuration.configuration.getTimeoutCon() * 2 /</span>
                            1000 + Messages
<span class="nc" id="L2010">                              .getString(&quot;HttpSslHandler.40&quot;)); //$NON-NLS-1$</span>
          }
<span class="nc" id="L2012">          error = error.replace(&quot;XXXRELOADHTTPXXX&quot;,</span>
                                &quot;HTTP-EQUIV=\&quot;refresh\&quot; CONTENT=\&quot;&quot; +
<span class="nc" id="L2014">                                Configuration.configuration.getTimeoutCon() *</span>
                                2 / 1000 + '&quot;');
<span class="nc" id="L2016">          WaarpShutdownHook.setRestart(true);</span>
<span class="nc" id="L2017">          newSession = true;</span>
<span class="nc" id="L2018">          clearSession();</span>
<span class="nc" id="L2019">          forceClose = true;</span>
<span class="nc" id="L2020">          shutdown = true;</span>
<span class="nc" id="L2021">          return error;</span>
<span class="fc bfc" id="L2022" title="All 2 branches covered.">        } else if (&quot;Validate&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L2023">          final String bsessionr = getTrimValue(&quot;BSESSR&quot;);</span>
<span class="fc" id="L2024">          long lsessionr =</span>
<span class="fc" id="L2025">              Configuration.configuration.getServerChannelReadLimit();</span>
          long lglobalr;
          long lsessionw;
          long lglobalw;
          long delay;
          try {
<span class="pc bpc" id="L2031" title="1 of 2 branches missed.">            if (bsessionr != null) {</span>
<span class="fc" id="L2032">              lsessionr = (Long.parseLong(bsessionr) / 10) * 10;</span>
            }
<span class="fc" id="L2034">            final String bglobalr = getTrimValue(&quot;BGLOBR&quot;);</span>
<span class="fc" id="L2035">            lglobalr = Configuration.configuration.getServerGlobalReadLimit();</span>
<span class="pc bpc" id="L2036" title="1 of 2 branches missed.">            if (bglobalr != null) {</span>
<span class="fc" id="L2037">              lglobalr = (Long.parseLong(bglobalr) / 10) * 10;</span>
            }
<span class="fc" id="L2039">            final String bsessionw = getTrimValue(&quot;BSESSW&quot;);</span>
<span class="fc" id="L2040">            lsessionw =</span>
<span class="fc" id="L2041">                Configuration.configuration.getServerChannelWriteLimit();</span>
<span class="pc bpc" id="L2042" title="1 of 2 branches missed.">            if (bsessionw != null) {</span>
<span class="fc" id="L2043">              lsessionw = (Long.parseLong(bsessionw) / 10) * 10;</span>
            }
<span class="fc" id="L2045">            final String bglobalw = getTrimValue(&quot;BGLOBW&quot;);</span>
<span class="fc" id="L2046">            lglobalw = Configuration.configuration.getServerGlobalWriteLimit();</span>
<span class="pc bpc" id="L2047" title="1 of 2 branches missed.">            if (bglobalw != null) {</span>
<span class="fc" id="L2048">              lglobalw = (Long.parseLong(bglobalw) / 10) * 10;</span>
            }
<span class="fc" id="L2050">            final String dtra = getTrimValue(&quot;DTRA&quot;);</span>
<span class="fc" id="L2051">            delay = Configuration.configuration.getDelayLimit();</span>
<span class="pc bpc" id="L2052" title="1 of 2 branches missed.">            if (dtra != null) {</span>
<span class="fc" id="L2053">              delay = (Long.parseLong(dtra) / 10) * 10;</span>
<span class="pc bpc" id="L2054" title="1 of 2 branches missed.">              if (delay &lt; 100) {</span>
<span class="nc" id="L2055">                delay = 100;</span>
              }
            }
<span class="fc" id="L2058">            Configuration.configuration</span>
<span class="fc" id="L2059">                .changeNetworkLimit(lglobalw, lglobalr, lsessionw, lsessionr,</span>
                                    delay);
<span class="fc" id="L2061">            final String dcomm = getTrimValue(&quot;DCOM&quot;);</span>
<span class="pc bpc" id="L2062" title="1 of 2 branches missed.">            if (dcomm != null) {</span>
<span class="fc" id="L2063">              Configuration.configuration</span>
<span class="fc" id="L2064">                  .setDelayCommander(Long.parseLong(dcomm));</span>
<span class="pc bpc" id="L2065" title="1 of 2 branches missed.">              if (Configuration.configuration.getDelayCommander() &lt;= 100) {</span>
<span class="fc" id="L2066">                Configuration.configuration.setDelayCommander(100);</span>
              }
<span class="fc" id="L2068">              Configuration.configuration.reloadCommanderDelay();</span>
            }
<span class="fc" id="L2070">            final String dret = getTrimValue(&quot;DRET&quot;);</span>
<span class="pc bpc" id="L2071" title="1 of 2 branches missed.">            if (dret != null) {</span>
<span class="fc" id="L2072">              Configuration.configuration.setDelayRetry(Long.parseLong(dret));</span>
<span class="pc bpc" id="L2073" title="1 of 2 branches missed.">              if (Configuration.configuration.getDelayRetry() &lt;= 1000) {</span>
<span class="fc" id="L2074">                Configuration.configuration.setDelayRetry(1000);</span>
              }
            }
<span class="fc" id="L2077">            extraInformation =</span>
<span class="fc" id="L2078">                Messages.getString(&quot;HttpSslHandler.41&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2079">          } catch (final NumberFormatException e) {</span>
<span class="nc" id="L2080">            extraInformation =</span>
<span class="nc" id="L2081">                Messages.getString(&quot;HttpSslHandler.42&quot;); //$NON-NLS-1$</span>
<span class="fc" id="L2082">          }</span>
<span class="pc bpc" id="L2083" title="1 of 2 branches missed.">        } else if (&quot;HostConfig&quot;.equalsIgnoreCase(act)) {</span>
<span class="fc" id="L2084">          config.setBusiness(getTrimValue(&quot;BUSINESS&quot;));</span>
<span class="fc" id="L2085">          config.setRoles(getTrimValue(&quot;ROLES&quot;));</span>
<span class="fc" id="L2086">          config.setAliases(getTrimValue(&quot;ALIASES&quot;));</span>
<span class="fc" id="L2087">          config.setOthers(getTrimValue(&quot;OTHER&quot;));</span>
          try {
<span class="fc" id="L2089">            config.update();</span>
<span class="fc" id="L2090">            extraInformation =</span>
<span class="fc" id="L2091">                Messages.getString(&quot;HttpSslHandler.41&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2092">          } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L2093">            extraInformation =</span>
<span class="nc" id="L2094">                Messages.getString(&quot;HttpSslHandler.43&quot;); //$NON-NLS-1$</span>
<span class="fc" id="L2095">          }</span>
        }
<span class="fc" id="L2097">      }</span>
    }
<span class="fc" id="L2099">    final String system = REQUEST.System.readFileUnique(this);</span>
<span class="fc" id="L2100">    final StringBuilder builder = new StringBuilder(system);</span>
<span class="fc" id="L2101">    replaceStringSystem(config, builder);</span>
<span class="fc" id="L2102">    langHandle(builder);</span>
<span class="pc bpc" id="L2103" title="1 of 2 branches missed.">    if (extraInformation != null) {</span>
<span class="fc" id="L2104">      builder.append(extraInformation);</span>
    }
<span class="fc" id="L2106">    return builder.toString();</span>
  }

  private void getParams() {
<span class="fc bfc" id="L2110" title="All 2 branches covered.">    if (request.method() == HttpMethod.GET) {</span>
<span class="fc" id="L2111">      params = null;</span>
<span class="pc bpc" id="L2112" title="1 of 2 branches missed.">    } else if (request.method() == HttpMethod.POST) {</span>
<span class="fc" id="L2113">      final ByteBuf content = request.content();</span>
<span class="pc bpc" id="L2114" title="1 of 2 branches missed.">      if (content.isReadable()) {</span>
<span class="fc" id="L2115">        final String param = content.toString(WaarpStringUtils.UTF8);</span>
<span class="fc" id="L2116">        final QueryStringDecoder queryStringDecoder2 =</span>
            new QueryStringDecoder(&quot;/?&quot; + param);
<span class="fc" id="L2118">        params = queryStringDecoder2.parameters();</span>
<span class="fc" id="L2119">        boolean invalidEntry = false;</span>
<span class="fc bfc" id="L2120" title="All 2 branches covered.">        for (Entry&lt;String, List&lt;String&gt;&gt; paramCheck : params.entrySet()) {</span>
          try {
<span class="fc" id="L2122">            ParametersChecker.checkSanityString(paramCheck.getValue().toArray(</span>
                ParametersChecker.ZERO_ARRAY_STRING));
<span class="nc" id="L2124">          } catch (InvalidArgumentException e) {</span>
<span class="nc" id="L2125">            logger.error(</span>
<span class="nc" id="L2126">                &quot;Arguments incompatible with Security: &quot; + paramCheck.getKey(),</span>
                e);
<span class="nc" id="L2128">            invalidEntry = true;</span>
<span class="fc" id="L2129">          }</span>
<span class="fc" id="L2130">        }</span>
<span class="pc bpc" id="L2131" title="1 of 2 branches missed.">        if (invalidEntry) {</span>
<span class="nc bnc" id="L2132" title="All 2 branches missed.">          for (Entry&lt;String, List&lt;String&gt;&gt; paramCheck : params.entrySet()) {</span>
<span class="nc" id="L2133">            paramCheck.getValue().clear();</span>
<span class="nc" id="L2134">          }</span>
<span class="nc" id="L2135">          params.clear();</span>
<span class="nc" id="L2136">          params = null;</span>
<span class="nc" id="L2137">          logger.error(&quot;No parameter validated since security issue found&quot;);</span>
<span class="nc" id="L2138">          return;</span>
        }
<span class="fc bfc" id="L2140" title="All 2 branches covered.">        if (params.containsKey(sLIMITROW)) {</span>
<span class="fc" id="L2141">          final String snb = getTrimValue(sLIMITROW);</span>
<span class="pc bpc" id="L2142" title="1 of 2 branches missed.">          if (snb != null) {</span>
            try {
<span class="fc" id="L2144">              final int old = getLimitRow();</span>
<span class="fc" id="L2145">              setLimitRow(Integer.parseInt(snb));</span>
<span class="pc bpc" id="L2146" title="1 of 2 branches missed.">              if (getLimitRow() &lt; 5) {</span>
<span class="nc" id="L2147">                setLimitRow(old);</span>
              }
<span class="nc" id="L2149">            } catch (final Exception ignored) {</span>
              // nothing
<span class="fc" id="L2151">            }</span>
          }
        }
<span class="fc" id="L2154">      } else {</span>
<span class="nc" id="L2155">        params = null;</span>
      }
    }
<span class="fc" id="L2158">  }</span>

  protected void clearSession() {
<span class="fc bfc" id="L2161" title="All 2 branches covered.">    if (admin != null) {</span>
<span class="fc" id="L2162">      final R66Session lsession = sessions.remove(admin.value());</span>
<span class="fc" id="L2163">      admin = null;</span>
<span class="pc bpc" id="L2164" title="1 of 2 branches missed.">      if (lsession != null) {</span>
<span class="fc" id="L2165">        lsession.setStatus(75);</span>
<span class="fc" id="L2166">        lsession.clear();</span>
      }
    }
<span class="fc" id="L2169">  }</span>

  private void checkAuthent(ChannelHandlerContext ctx) {
<span class="fc" id="L2172">    newSession = true;</span>
<span class="fc bfc" id="L2173" title="All 2 branches covered.">    if (request.method() == HttpMethod.GET) {</span>
<span class="fc" id="L2174">      String logon = logon();</span>
<span class="fc" id="L2175">      logon = logon.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(), &quot;&quot;);</span>
<span class="fc" id="L2176">      responseContent.append(logon);</span>
<span class="fc" id="L2177">      clearSession();</span>
<span class="fc" id="L2178">      writeResponse(ctx);</span>
<span class="fc" id="L2179">      return;</span>
<span class="pc bpc" id="L2180" title="1 of 2 branches missed.">    } else if (request.method() == HttpMethod.POST) {</span>
<span class="fc" id="L2181">      getParams();</span>
<span class="pc bpc" id="L2182" title="1 of 2 branches missed.">      if (params == null) {</span>
<span class="nc" id="L2183">        String logon = logon();</span>
<span class="nc" id="L2184">        logon = logon.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(),</span>
                                 Messages
<span class="nc" id="L2186">                                     .getString(&quot;HttpSslHandler.EmptyLogin&quot;));</span>
<span class="nc" id="L2187">        responseContent.append(logon);</span>
<span class="nc" id="L2188">        clearSession();</span>
<span class="nc" id="L2189">        writeResponse(ctx);</span>
<span class="nc" id="L2190">        return;</span>
      }
    }
<span class="fc" id="L2193">    boolean getMenu = false;</span>
<span class="pc bpc" id="L2194" title="2 of 4 branches missed.">    if (params != null &amp;&amp; params.containsKey(&quot;Logon&quot;)) {</span>
<span class="fc" id="L2195">      String name = null;</span>
<span class="fc" id="L2196">      String password = null;</span>
      List&lt;String&gt; values;
<span class="pc bpc" id="L2198" title="1 of 2 branches missed.">      if (!params.isEmpty()) {</span>
        // get values
<span class="pc bpc" id="L2200" title="1 of 2 branches missed.">        if (params.containsKey(&quot;name&quot;)) {</span>
<span class="fc" id="L2201">          values = params.get(&quot;name&quot;);</span>
<span class="pc bpc" id="L2202" title="1 of 2 branches missed.">          if (values != null) {</span>
<span class="fc" id="L2203">            name = values.get(0);</span>
<span class="pc bpc" id="L2204" title="2 of 4 branches missed.">            if (name == null || name.isEmpty()) {</span>
<span class="nc" id="L2205">              getMenu = true;</span>
            }
          }
        } else {
<span class="nc" id="L2209">          getMenu = true;</span>
        }
        // search the nb param
<span class="pc bpc" id="L2212" title="2 of 4 branches missed.">        if (!getMenu &amp;&amp; params.containsKey(&quot;passwd&quot;)) {</span>
<span class="fc" id="L2213">          values = params.get(&quot;passwd&quot;);</span>
<span class="pc bpc" id="L2214" title="1 of 2 branches missed.">          if (values != null) {</span>
<span class="fc" id="L2215">            password = values.get(0);</span>
<span class="pc bpc" id="L2216" title="2 of 4 branches missed.">            getMenu = password == null || password.isEmpty();</span>
          } else {
<span class="nc" id="L2218">            getMenu = true;</span>
          }
        } else {
<span class="nc" id="L2221">          getMenu = true;</span>
        }
      } else {
<span class="nc" id="L2224">        getMenu = true;</span>
      }
<span class="pc bpc" id="L2226" title="2 of 4 branches missed.">      if (!getMenu &amp;&amp; name != null) {</span>
<span class="fc" id="L2227">        logger.debug(</span>
<span class="fc" id="L2228">            &quot;Name? &quot; + name.equals(Configuration.configuration.getAdminName()) +</span>
            &quot; Passwd? &quot; + Arrays
<span class="fc" id="L2230">                .equals(password.getBytes(WaarpStringUtils.UTF8),</span>
<span class="fc" id="L2231">                        Configuration.configuration.getServerAdminKey()));</span>
<span class="fc bfc" id="L2232" title="All 2 branches covered.">        if (name.equals(Configuration.configuration.getAdminName()) &amp;&amp; Arrays</span>
<span class="pc bpc" id="L2233" title="1 of 2 branches missed.">            .equals(password.getBytes(WaarpStringUtils.UTF8),</span>
<span class="fc" id="L2234">                    Configuration.configuration.getServerAdminKey())) {</span>
<span class="fc" id="L2235">          authentHttp.getAuth().specialNoSessionAuth(true,</span>
                                                     Configuration.configuration
<span class="fc" id="L2237">                                                         .getHostId());</span>
<span class="fc" id="L2238">          authentHttp.setStatus(70);</span>
        } else {
          try {
<span class="fc" id="L2241">            authentHttp.getAuth().connectionHttps(name, FilesystemBasedDigest</span>
<span class="fc" id="L2242">                .passwdCrypt(password.getBytes(WaarpStringUtils.UTF8)));</span>
<span class="nc" id="L2243">          } catch (final Reply530Exception e1) {</span>
<span class="nc" id="L2244">            getMenu = true;</span>
<span class="nc" id="L2245">          } catch (final Reply421Exception e1) {</span>
<span class="nc" id="L2246">            getMenu = true;</span>
<span class="pc" id="L2247">          }</span>
        }
<span class="pc bpc" id="L2249" title="1 of 2 branches missed.">        if (!authentHttp.isAuthenticated()) {</span>
<span class="nc" id="L2250">          authentHttp.setStatus(71);</span>
<span class="nc" id="L2251">          logger.debug(&quot;Still not authenticated: {}&quot;, authentHttp);</span>
<span class="nc" id="L2252">          getMenu = true;</span>
        }
<span class="fc" id="L2254">        logger.debug(</span>
<span class="fc" id="L2255">            &quot;Identified: &quot; + authentHttp.getAuth().isIdentified() + ':' +</span>
<span class="fc" id="L2256">            authentHttp.isAuthenticated());</span>
      }
<span class="fc" id="L2258">    } else {</span>
<span class="nc" id="L2259">      getMenu = true;</span>
    }
<span class="pc bpc" id="L2261" title="1 of 2 branches missed.">    if (getMenu) {</span>
<span class="nc" id="L2262">      String logon = logon();</span>
<span class="nc" id="L2263">      logon = logon.replaceAll(REPLACEMENT.XXXERRORMESGXXX.toString(),</span>
<span class="nc" id="L2264">                               Messages.getString(&quot;HttpSslHandler.BadLogin&quot;));</span>
<span class="nc" id="L2265">      responseContent.append(logon);</span>
<span class="nc" id="L2266">      clearSession();</span>
<span class="nc" id="L2267">    } else {</span>
<span class="fc" id="L2268">      final String index = index();</span>
<span class="fc" id="L2269">      responseContent.append(index);</span>
<span class="fc" id="L2270">      clearSession();</span>
<span class="fc" id="L2271">      admin = new DefaultCookie(</span>
<span class="fc" id="L2272">          R66SESSION + Configuration.configuration.getHostId(),</span>
<span class="fc" id="L2273">          Configuration.configuration.getHostId() +</span>
<span class="fc" id="L2274">          Long.toHexString(RANDOM.nextLong()));</span>
<span class="fc" id="L2275">      sessions.put(admin.value(), authentHttp);</span>
<span class="fc" id="L2276">      authentHttp.setStatus(72);</span>
<span class="fc" id="L2277">      logger.debug(&quot;CreateSession: &quot; + uriRequest + &quot;:{}&quot;, admin);</span>
    }
<span class="fc" id="L2279">    writeResponse(ctx);</span>
<span class="fc" id="L2280">  }</span>

  @Override
  protected void channelRead0(ChannelHandlerContext ctx, FullHttpRequest msg)
      throws Exception {
<span class="fc" id="L2285">    final FullHttpRequest request = this.request = msg;</span>
<span class="fc" id="L2286">    final QueryStringDecoder queryStringDecoder =</span>
<span class="fc" id="L2287">        new QueryStringDecoder(request.uri());</span>
<span class="fc" id="L2288">    uriRequest = queryStringDecoder.path();</span>
<span class="fc" id="L2289">    logger.debug(&quot;Msg: &quot; + uriRequest);</span>
<span class="fc bfc" id="L2290" title="All 4 branches covered.">    if (uriRequest.contains(&quot;gre/&quot;) || uriRequest.contains(&quot;img/&quot;) ||</span>
<span class="pc bpc" id="L2291" title="1 of 4 branches missed.">        uriRequest.contains(&quot;res/&quot;) || uriRequest.contains(&quot;favicon.ico&quot;)) {</span>
<span class="fc" id="L2292">      HttpWriteCacheEnable.writeFile(request, ctx, Configuration.configuration</span>
<span class="fc" id="L2293">                                                       .getHttpBasePath() +</span>
                                                   uriRequest, R66SESSION +
                                                               Configuration.configuration
<span class="fc" id="L2296">                                                                   .getHostId());</span>
<span class="fc" id="L2297">      return;</span>
    }
<span class="fc" id="L2299">    checkSession(ctx.channel());</span>
    try {
<span class="fc bfc" id="L2301" title="All 2 branches covered.">      if (!authentHttp.isAuthenticated()) {</span>
<span class="fc" id="L2302">        logger.debug(&quot;Not Authent: &quot; + uriRequest + &quot;:{}&quot;, authentHttp);</span>
<span class="fc" id="L2303">        checkAuthent(ctx);</span>
<span class="fc" id="L2304">        return;</span>
      }
<span class="fc" id="L2306">      String find = uriRequest;</span>
<span class="pc bpc" id="L2307" title="1 of 2 branches missed.">      if (uriRequest.charAt(0) == '/') {</span>
<span class="fc" id="L2308">        find = uriRequest.substring(1);</span>
      }
<span class="fc" id="L2310">      REQUEST req = REQUEST.index;</span>
<span class="fc bfc" id="L2311" title="All 2 branches covered.">      if (find.length() != 0) {</span>
<span class="fc" id="L2312">        find = find.substring(0, find.indexOf('.'));</span>
        try {
<span class="fc" id="L2314">          req = REQUEST.valueOf(find);</span>
<span class="nc" id="L2315">        } catch (final IllegalArgumentException e1) {</span>
<span class="nc" id="L2316">          req = REQUEST.index;</span>
<span class="nc" id="L2317">          logger.debug(&quot;NotFound: &quot; + find + ':' + uriRequest);</span>
<span class="fc" id="L2318">        }</span>
      }
<span class="pc bpc" id="L2320" title="1 of 11 branches missed.">      switch (req) {</span>
        case CancelRestart:
<span class="pc bpc" id="L2322" title="1 of 2 branches missed.">          if (authentHttp.getAuth().isValidRole(ROLE.TRANSFER)) {</span>
<span class="fc" id="L2323">            responseContent.append(cancelRestart0());</span>
          } else {
<span class="nc" id="L2325">            responseContent.append(unallowed(</span>
<span class="nc" id="L2326">                Messages.getString(&quot;HttpSslHandler.CancelRestartUnallowed&quot;)));</span>
          }
<span class="nc" id="L2328">          break;</span>
        case Export:
<span class="pc bpc" id="L2330" title="1 of 2 branches missed.">          if (authentHttp.getAuth().isValidRole(ROLE.SYSTEM)) {</span>
<span class="fc" id="L2331">            responseContent.append(export0());</span>
          } else {
<span class="nc" id="L2333">            responseContent.append(unallowed(</span>
<span class="nc" id="L2334">                Messages.getString(&quot;HttpSslHandler.ExportUnallowed&quot;)));</span>
          }
<span class="nc" id="L2336">          break;</span>
        case Hosts:
<span class="fc bfc" id="L2338" title="All 2 branches covered.">          if (authentHttp.getAuth().isValidRole(ROLE.HOST)) {</span>
<span class="fc" id="L2339">            responseContent.append(hosts0());</span>
          } else {
<span class="fc" id="L2341">            responseContent.append(</span>
<span class="fc" id="L2342">                unallowed(Messages.getString(&quot;HttpSslHandler.HostUnallowed&quot;)));</span>
          }
<span class="fc" id="L2344">          break;</span>
        case Listing:
<span class="fc" id="L2346">          responseContent.append(listing0());</span>
<span class="fc" id="L2347">          break;</span>
        case Logout:
<span class="fc" id="L2349">          responseContent.append(logout());</span>
<span class="fc" id="L2350">          break;</span>
        case Rules:
<span class="fc bfc" id="L2352" title="All 2 branches covered.">          if (authentHttp.getAuth().isValidRole(ROLE.RULE)) {</span>
<span class="fc" id="L2353">            responseContent.append(rules0());</span>
          } else {
<span class="fc" id="L2355">            responseContent.append(</span>
<span class="fc" id="L2356">                unallowed(Messages.getString(&quot;HttpSslHandler.RulesUnallowed&quot;)));</span>
          }
<span class="fc" id="L2358">          break;</span>
        case System:
<span class="pc bpc" id="L2360" title="1 of 2 branches missed.">          if (authentHttp.getAuth().isValidRole(ROLE.SYSTEM)) {</span>
<span class="fc" id="L2361">            responseContent.append(system0());</span>
          } else {
<span class="nc" id="L2363">            responseContent.append(systemLimited());</span>
          }
<span class="nc" id="L2365">          break;</span>
        case Transfers:
<span class="fc" id="L2367">          responseContent.append(transfers());</span>
<span class="fc" id="L2368">          break;</span>
        case Spooled:
<span class="fc" id="L2370">          responseContent.append(spooled0(false));</span>
<span class="fc" id="L2371">          break;</span>
        case SpooledDetailed:
<span class="nc" id="L2373">          responseContent.append(spooled0(true));</span>
<span class="nc" id="L2374">          break;</span>
        default:
<span class="fc" id="L2376">          responseContent.append(index());</span>
          break;
      }
<span class="fc" id="L2379">      writeResponse(ctx);</span>
    } finally {
<span class="fc" id="L2381">      closeConnection();</span>
    }
<span class="fc" id="L2383">  }</span>

  protected void checkSession(Channel channel) {
<span class="fc" id="L2386">    final String cookieString = request.headers().get(HttpHeaderNames.COOKIE);</span>
<span class="fc bfc" id="L2387" title="All 2 branches covered.">    if (cookieString != null) {</span>
<span class="fc" id="L2388">      final Set&lt;Cookie&gt; cookies = ServerCookieDecoder.LAX.decode(cookieString);</span>
<span class="pc bpc" id="L2389" title="1 of 2 branches missed.">      if (!cookies.isEmpty()) {</span>
<span class="fc bfc" id="L2390" title="All 2 branches covered.">        for (final Cookie elt : cookies) {</span>
<span class="fc bfc" id="L2391" title="All 2 branches covered.">          if (elt.name().equalsIgnoreCase(</span>
<span class="fc" id="L2392">              R66SESSION + Configuration.configuration.getHostId())) {</span>
<span class="fc" id="L2393">            logger.debug(&quot;Found session: &quot; + elt);</span>
<span class="fc" id="L2394">            admin = elt;</span>
<span class="fc" id="L2395">            final R66Session session = sessions.get(admin.value());</span>
<span class="fc bfc" id="L2396" title="All 2 branches covered.">            if (session != null) {</span>
<span class="fc" id="L2397">              authentHttp = session;</span>
<span class="fc" id="L2398">              authentHttp.setStatus(73);</span>
            } else {
<span class="fc" id="L2400">              admin = null;</span>
<span class="fc" id="L2401">              continue;</span>
            }
<span class="pc bpc" id="L2403" title="1 of 2 branches missed.">          } else if (elt.name().equalsIgnoreCase(I18NEXT)) {</span>
<span class="fc" id="L2404">            logger.debug(&quot;Found i18next: &quot; + elt);</span>
<span class="fc" id="L2405">            lang = elt.value();</span>
          }
<span class="fc" id="L2407">        }</span>
      }
    }
    try {
<span class="fc" id="L2411">      dbSession = new DbSession(DbConstantR66.admin, false);</span>
<span class="fc" id="L2412">      DbAdmin.incHttpSession();</span>
<span class="nc" id="L2413">    } catch (final WaarpDatabaseNoConnectionException e1) {</span>
      // Cannot connect so use default connection
<span class="nc" id="L2415">      logger.warn(&quot;Use default database connection&quot;);</span>
<span class="nc" id="L2416">      dbSession = DbConstantR66.admin.getSession();</span>
<span class="fc" id="L2417">    }</span>
<span class="fc bfc" id="L2418" title="All 2 branches covered.">    if (admin == null) {</span>
<span class="fc" id="L2419">      logger.debug(&quot;NoSession: &quot; + uriRequest + &quot;:{}&quot;, admin);</span>
    }
<span class="fc" id="L2421">  }</span>

  protected void closeConnection() {
<span class="pc bpc" id="L2424" title="2 of 4 branches missed.">    if (dbSession != null &amp;&amp; dbSession != DbConstantR66.admin.getSession()) {</span>
<span class="fc" id="L2425">      DbAdmin.decHttpSession();</span>
<span class="fc" id="L2426">      dbSession.disconnect();</span>
    }
<span class="fc" id="L2428">    dbSession = null;</span>
<span class="fc" id="L2429">  }</span>

  private void handleCookies(HttpResponse response) {
<span class="fc" id="L2432">    final String cookieString = request.headers().get(HttpHeaderNames.COOKIE);</span>
<span class="fc" id="L2433">    boolean i18nextFound = false;</span>
<span class="fc bfc" id="L2434" title="All 2 branches covered.">    if (cookieString != null) {</span>
<span class="fc" id="L2435">      final Set&lt;Cookie&gt; cookies = ServerCookieDecoder.LAX.decode(cookieString);</span>
<span class="pc bpc" id="L2436" title="1 of 2 branches missed.">      if (!cookies.isEmpty()) {</span>
        // Reset the sessions if necessary.
<span class="fc" id="L2438">        boolean findSession = false;</span>
<span class="fc bfc" id="L2439" title="All 2 branches covered.">        for (final Cookie cookie : cookies) {</span>
<span class="fc bfc" id="L2440" title="All 2 branches covered.">          if (cookie.name().equalsIgnoreCase(</span>
<span class="fc" id="L2441">              R66SESSION + Configuration.configuration.getHostId())) {</span>
<span class="fc bfc" id="L2442" title="All 2 branches covered.">            if (newSession) {</span>
<span class="fc" id="L2443">              findSession = false;</span>
            } else {
<span class="fc" id="L2445">              findSession = true;</span>
<span class="fc" id="L2446">              response.headers().add(HttpHeaderNames.SET_COOKIE,</span>
<span class="fc" id="L2447">                                     ServerCookieEncoder.LAX.encode(cookie));</span>
            }
<span class="pc bpc" id="L2449" title="1 of 2 branches missed.">          } else if (cookie.name().equalsIgnoreCase(I18NEXT)) {</span>
<span class="fc" id="L2450">            i18nextFound = true;</span>
<span class="fc" id="L2451">            cookie.setValue(lang);</span>
<span class="fc" id="L2452">            response.headers().add(HttpHeaderNames.SET_COOKIE,</span>
<span class="fc" id="L2453">                                   ServerCookieEncoder.LAX.encode(cookie));</span>
          } else {
<span class="nc" id="L2455">            response.headers().add(HttpHeaderNames.SET_COOKIE,</span>
<span class="nc" id="L2456">                                   ServerCookieEncoder.LAX.encode(cookie));</span>
          }
<span class="fc" id="L2458">        }</span>
<span class="pc bpc" id="L2459" title="1 of 2 branches missed.">        if (!i18nextFound) {</span>
<span class="nc" id="L2460">          final Cookie cookie = new DefaultCookie(I18NEXT, lang);</span>
<span class="nc" id="L2461">          response.headers().add(HttpHeaderNames.SET_COOKIE,</span>
<span class="nc" id="L2462">                                 ServerCookieEncoder.LAX.encode(cookie));</span>
        }
<span class="fc" id="L2464">        newSession = false;</span>
<span class="fc bfc" id="L2465" title="All 4 branches covered.">        if (!findSession &amp;&amp; admin != null) {</span>
<span class="fc" id="L2466">          response.headers().add(HttpHeaderNames.SET_COOKIE,</span>
<span class="fc" id="L2467">                                 ServerCookieEncoder.LAX.encode(admin));</span>
<span class="fc" id="L2468">          logger.debug(&quot;AddSession: &quot; + uriRequest + &quot;:{}&quot;, admin);</span>
        }
      }
<span class="fc" id="L2471">    } else {</span>
<span class="fc" id="L2472">      final Cookie cookie = new DefaultCookie(I18NEXT, lang);</span>
<span class="fc" id="L2473">      response.headers().add(HttpHeaderNames.SET_COOKIE,</span>
<span class="fc" id="L2474">                             ServerCookieEncoder.LAX.encode(cookie));</span>
<span class="pc bpc" id="L2475" title="1 of 2 branches missed.">      if (admin != null) {</span>
<span class="nc" id="L2476">        logger.debug(&quot;AddSession: &quot; + uriRequest + &quot;:{}&quot;, admin);</span>
<span class="nc" id="L2477">        response.headers().add(HttpHeaderNames.SET_COOKIE,</span>
<span class="nc" id="L2478">                               ServerCookieEncoder.LAX.encode(admin));</span>
      }
    }
<span class="fc" id="L2481">  }</span>

  /**
   * Write the response
   *
   * @param ctx
   */
  protected void writeResponse(ChannelHandlerContext ctx) {
    // Convert the response content to a ByteBuf.
<span class="fc" id="L2490">    final ByteBuf buf = Unpooled</span>
<span class="fc" id="L2491">        .copiedBuffer(responseContent.toString(), WaarpStringUtils.UTF8);</span>
<span class="fc" id="L2492">    responseContent.setLength(0);</span>

    // Decide whether to close the connection or not.
<span class="fc" id="L2495">    final boolean keepAlive = HttpUtil.isKeepAlive(request);</span>
<span class="pc bpc" id="L2496" title="2 of 6 branches missed.">    final boolean close = HttpHeaderValues.CLOSE.contentEqualsIgnoreCase(</span>
<span class="fc" id="L2497">        request.headers().get(HttpHeaderNames.CONNECTION)) || !keepAlive ||</span>
                          forceClose;

    // Build the response object.
<span class="fc" id="L2501">    final FullHttpResponse response =</span>
        new DefaultFullHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.OK,
                                    buf);
<span class="fc" id="L2504">    response.headers().add(HttpHeaderNames.CONTENT_LENGTH,</span>
<span class="fc" id="L2505">                           response.content().readableBytes());</span>
<span class="fc" id="L2506">    response.headers().set(HttpHeaderNames.CONTENT_TYPE, &quot;text/html&quot;);</span>
<span class="pc bpc" id="L2507" title="1 of 2 branches missed.">    if (keepAlive) {</span>
<span class="fc" id="L2508">      response.headers()</span>
<span class="fc" id="L2509">              .set(HttpHeaderNames.CONNECTION, HttpHeaderValues.KEEP_ALIVE);</span>
    }
<span class="fc bfc" id="L2511" title="All 2 branches covered.">    if (!close) {</span>
      // There's no need to add 'Content-Length' header
      // if this is the last response.
<span class="fc" id="L2514">      response.headers().set(HttpHeaderNames.CONTENT_LENGTH,</span>
<span class="fc" id="L2515">                             String.valueOf(buf.readableBytes()));</span>
    }

<span class="fc" id="L2518">    handleCookies(response);</span>

    // Write the response.
<span class="fc" id="L2521">    final ChannelFuture future = ctx.writeAndFlush(response);</span>
    // Close the connection after the write operation is done if necessary.
<span class="fc bfc" id="L2523" title="All 2 branches covered.">    if (close) {</span>
<span class="fc" id="L2524">      future.addListener(WaarpSslUtility.SSLCLOSE);</span>
    }
<span class="pc bpc" id="L2526" title="1 of 2 branches missed.">    if (shutdown) {</span>
<span class="nc" id="L2527">      ChannelUtils.startShutdown();</span>
    }
<span class="fc" id="L2529">  }</span>

  /**
   * Send an error and close
   *
   * @param ctx
   * @param status
   */
  void sendError(ChannelHandlerContext ctx, HttpResponseStatus status) {
<span class="nc" id="L2538">    responseContent.setLength(0);</span>
<span class="nc" id="L2539">    responseContent.append(error(status.toString()));</span>
<span class="nc" id="L2540">    final FullHttpResponse response =</span>
        new DefaultFullHttpResponse(HttpVersion.HTTP_1_1, status, Unpooled
<span class="nc" id="L2542">            .copiedBuffer(responseContent.toString(), WaarpStringUtils.UTF8));</span>
<span class="nc" id="L2543">    response.headers().add(HttpHeaderNames.CONTENT_LENGTH,</span>
<span class="nc" id="L2544">                           response.content().readableBytes());</span>
<span class="nc" id="L2545">    response.headers().set(HttpHeaderNames.CONTENT_TYPE, &quot;text/html&quot;);</span>
<span class="nc" id="L2546">    responseContent.setLength(0);</span>
<span class="nc" id="L2547">    clearSession();</span>
    // Close the connection as soon as the error message is sent.
<span class="nc" id="L2549">    ctx.writeAndFlush(response).addListener(WaarpSslUtility.SSLCLOSE);</span>
<span class="nc" id="L2550">  }</span>

  @Override
  public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause)
      throws Exception {
<span class="nc" id="L2555">    final OpenR66Exception exception = OpenR66ExceptionTrappedFactory</span>
<span class="nc" id="L2556">        .getExceptionFromTrappedException(ctx.channel(), cause);</span>
<span class="nc bnc" id="L2557" title="All 2 branches missed.">    if (exception != null) {</span>
<span class="nc bnc" id="L2558" title="All 2 branches missed.">      if (!(exception instanceof OpenR66ProtocolBusinessNoWriteBackException)) {</span>
<span class="nc bnc" id="L2559" title="All 2 branches missed.">        if (cause instanceof IOException) {</span>
          // Nothing to do
<span class="nc" id="L2561">          return;</span>
        }
<span class="nc" id="L2563">        logger.warn(&quot;Exception in HttpSslHandler {}&quot;, exception.getMessage());</span>
      }
<span class="nc bnc" id="L2565" title="All 2 branches missed.">      if (ctx.channel().isActive()) {</span>
<span class="nc" id="L2566">        sendError(ctx, HttpResponseStatus.BAD_REQUEST);</span>
      }
    } else {
      // Nothing to do
    }
<span class="nc" id="L2571">  }</span>

  @Override
  public void channelActive(ChannelHandlerContext ctx) throws Exception {
<span class="fc" id="L2575">    final Channel channel = ctx.channel();</span>
<span class="fc" id="L2576">    Configuration.configuration.getHttpChannelGroup().add(channel);</span>
<span class="fc" id="L2577">    super.channelActive(ctx);</span>
<span class="fc" id="L2578">  }</span>

  /**
   * @return the lIMITROW
   */
  public int getLimitRow() {
<span class="fc" id="L2584">    return limitRow;</span>
  }

  /**
   * @param lIMITROW the lIMITROW to set
   */
  void setLimitRow(int lIMITROW) {
<span class="fc" id="L2591">    limitRow = lIMITROW;</span>
<span class="fc" id="L2592">  }</span>

  /**
   * @return the rEFRESH
   */
  public int getRefresh() {
<span class="fc" id="L2598">    return refresh;</span>
  }

  /**
   * @param rEFRESH the rEFRESH to set
   */
  void setRefresh(int rEFRESH) {
<span class="nc" id="L2605">    refresh = rEFRESH;</span>
<span class="nc" id="L2606">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>