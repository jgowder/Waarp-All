<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FtpMonitoring.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Waarp Gateway Ftp</a> &gt; <a href="index.source.html" class="el_package">org.waarp.gateway.ftp.snmp</a> &gt; <span class="el_source">FtpMonitoring.java</span></div><h1>FtpMonitoring.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.gateway.ftp.snmp;

import io.netty.handler.traffic.TrafficCounter;
import org.waarp.common.command.ReplyCode;
import org.waarp.common.database.DbPreparedStatement;
import org.waarp.common.database.DbSession;
import org.waarp.common.database.data.AbstractDbData.UpdatedInfo;
import org.waarp.common.database.exception.WaarpDatabaseException;
import org.waarp.common.database.exception.WaarpDatabaseNoConnectionException;
import org.waarp.common.database.exception.WaarpDatabaseSqlException;
import org.waarp.common.logging.WaarpLogger;
import org.waarp.common.logging.WaarpLoggerFactory;
import org.waarp.gateway.ftp.config.FileBasedConfiguration;
import org.waarp.gateway.ftp.database.DbConstantFtp;
import org.waarp.gateway.ftp.database.data.DbTransferLog;
import org.waarp.gateway.ftp.snmp.FtpPrivateMib.MibLevel;
import org.waarp.gateway.ftp.snmp.FtpPrivateMib.WaarpDetailedValuesIndex;
import org.waarp.gateway.ftp.snmp.FtpPrivateMib.WaarpErrorValuesIndex;
import org.waarp.gateway.ftp.snmp.FtpPrivateMib.WaarpGlobalValuesIndex;
import org.waarp.snmp.WaarpSnmpAgent;
import org.waarp.snmp.interf.WaarpInterfaceMonitor;

/**
 * SNMP Monitoring class for FTP Exec
 */
public class FtpMonitoring implements WaarpInterfaceMonitor {
  /**
   * Internal Logger
   */
<span class="fc" id="L49">  private static final WaarpLogger logger =</span>
<span class="fc" id="L50">      WaarpLoggerFactory.getLogger(FtpMonitoring.class);</span>

  public WaarpSnmpAgent agent;

  // global informations
  public long nbNetworkConnection;
  public long secondsRunning;
  public long nbThread;
  public long bandwidthIn;
  public long bandwidthOut;

  // Internal data
  private final DbSession dbSession;
<span class="fc" id="L63">  private final TrafficCounter trafficCounter =</span>
      FileBasedConfiguration.fileBasedConfiguration
<span class="fc" id="L65">          .getFtpInternalConfiguration().getGlobalTrafficShapingHandler()</span>
<span class="fc" id="L66">          .trafficCounter();</span>

  public long nbCountInfoUnknown;
  public long nbCountInfoNotUpdated;
  public long nbCountInfoInterrupted;
  public long nbCountInfoToSubmit;
  public long nbCountInfoError;
  public long nbCountInfoRunning;
  public long nbCountInfoDone;

  public long nbInActiveTransfer;
  public long nbOutActiveTransfer;
<span class="fc" id="L78">  public long lastInActiveTransfer = System.currentTimeMillis();</span>
<span class="fc" id="L79">  public long lastOutActiveTransfer = System.currentTimeMillis();</span>
  public long nbInTotalTransfer;
  public long nbOutTotalTransfer;
  public long nbInErrorTransfer;
  public long nbOutErrorTransfer;

  public long nbCountAllTransfer;

  // Info for other reasons than transfers
<span class="fc" id="L88">  private final long[] replyInfoNotransfers =</span>
<span class="fc" id="L89">      new long[WaarpDetailedValuesIndex.reply_350.ordinal() + 1];</span>
  // Error for other reasons than transfers
<span class="fc" id="L91">  private final long[] replyErrorNotransfers =</span>
<span class="fc" id="L92">      new long[WaarpErrorValuesIndex.reply_553.ordinal() + 1];</span>

  {
<span class="fc bfc" id="L95" title="All 2 branches covered.">    for (int i = 0; i &lt;= WaarpDetailedValuesIndex.reply_350.ordinal(); i++) {</span>
<span class="fc" id="L96">      replyInfoNotransfers[i] = 0;</span>
    }
<span class="fc bfc" id="L98" title="All 2 branches covered.">    for (int i = 0; i &lt;= WaarpErrorValuesIndex.reply_553.ordinal(); i++) {</span>
<span class="fc" id="L99">      replyErrorNotransfers[i] = 0;</span>
    }
  }

  // Overall status including past, future and current transfers
  private DbPreparedStatement countInfo;

  // Current situation of all transfers, running or not
  private DbPreparedStatement countInActiveTransfer;
  private DbPreparedStatement countOutActiveTransfer;
  private DbPreparedStatement countInTotalTransfer;
  private DbPreparedStatement countOutTotalTransfer;
  private DbPreparedStatement countInErrorTransfer;
  private DbPreparedStatement countOutErrorTransfer;
  private DbPreparedStatement countAllTransfer;
  // Error Status on all transfers
  private DbPreparedStatement countStatus;

  /**
   * @param session
   */
<span class="fc" id="L120">  public FtpMonitoring(final DbSession session) {</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">    if (session != null) {</span>
<span class="nc" id="L122">      dbSession = session;</span>
    } else {
<span class="fc" id="L124">      dbSession = DbConstantFtp.gatewayAdmin.getSession();</span>
    }
<span class="fc" id="L126">    initialize();</span>
<span class="fc" id="L127">  }</span>

  @Override
  public void setAgent(final WaarpSnmpAgent agent) {
<span class="fc" id="L131">    this.agent = agent;</span>
<span class="fc" id="L132">    lastInActiveTransfer = this.agent.getUptimeSystemTime();</span>
<span class="fc" id="L133">    lastOutActiveTransfer = this.agent.getUptimeSystemTime();</span>
<span class="fc" id="L134">  }</span>

  @Override
  public void initialize() {
<span class="fc" id="L138">    logger.debug(&quot;Initialize monitoring&quot;);</span>
    try {
      // Overall status including past, future and current transfers
<span class="fc" id="L141">      countInfo = DbTransferLog.getCountInfoPrepareStatement(dbSession);</span>
      // Count of Active/All In/Out transfers
<span class="fc" id="L143">      countInActiveTransfer = DbTransferLog</span>
<span class="fc" id="L144">          .getCountInOutRunningPrepareStatement(dbSession, true, true);</span>
<span class="fc" id="L145">      countOutActiveTransfer = DbTransferLog</span>
<span class="fc" id="L146">          .getCountInOutRunningPrepareStatement(dbSession, false, true);</span>
<span class="fc" id="L147">      countInTotalTransfer = DbTransferLog</span>
<span class="fc" id="L148">          .getCountInOutRunningPrepareStatement(dbSession, true, false);</span>
<span class="fc" id="L149">      countOutTotalTransfer = DbTransferLog</span>
<span class="fc" id="L150">          .getCountInOutRunningPrepareStatement(dbSession, false, false);</span>

<span class="fc" id="L152">      countInErrorTransfer =</span>
<span class="fc" id="L153">          DbTransferLog.getCountInOutErrorPrepareStatement(dbSession, true);</span>
<span class="fc" id="L154">      countOutErrorTransfer =</span>
<span class="fc" id="L155">          DbTransferLog.getCountInOutErrorPrepareStatement(dbSession, false);</span>
      // All
<span class="fc" id="L157">      countAllTransfer = DbTransferLog.getCountAllPrepareStatement(dbSession);</span>
      // Error Status on all transfers
<span class="fc" id="L159">      countStatus = DbTransferLog.getCountStatusPrepareStatement(dbSession);</span>
<span class="nc" id="L160">    } catch (final WaarpDatabaseException ignored) {</span>
      // nothing
<span class="fc" id="L162">    }</span>
<span class="fc" id="L163">  }</span>

  @Override
  public void releaseResources() {
    try {
<span class="fc" id="L168">      logger.debug(&quot;Release monitoring&quot;);</span>
      // Overall status including past, future and current transfers
<span class="fc" id="L170">      countInfo.realClose();</span>

<span class="fc" id="L172">      countInActiveTransfer.realClose();</span>
<span class="fc" id="L173">      countOutActiveTransfer.realClose();</span>
<span class="fc" id="L174">      countInTotalTransfer.realClose();</span>
<span class="fc" id="L175">      countOutTotalTransfer.realClose();</span>
<span class="fc" id="L176">      countInErrorTransfer.realClose();</span>
<span class="fc" id="L177">      countOutErrorTransfer.realClose();</span>

<span class="fc" id="L179">      countAllTransfer.realClose();</span>
      // Error Status on all transfers
<span class="fc" id="L181">      countStatus.realClose();</span>
<span class="nc" id="L182">    } catch (final NullPointerException ignored) {</span>
      // nothing
<span class="fc" id="L184">    }</span>
<span class="fc" id="L185">  }</span>

<span class="fc" id="L187">  private static final int REF421 =</span>
      ReplyCode.REPLY_421_SERVICE_NOT_AVAILABLE_CLOSING_CONTROL_CONNECTION
<span class="fc" id="L189">          .ordinal();</span>

  /**
   * Update the reply code counter for other operations than a transfer
   *
   * @param code
   */
  public void updateCodeNoTransfer(final ReplyCode code) {
<span class="nc" id="L197">    int i = code.ordinal();</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">    if (i &gt;= REF421) {</span>
<span class="nc" id="L199">      i -= REF421;</span>
<span class="nc" id="L200">      replyErrorNotransfers[i]++;</span>
    } else {
<span class="nc" id="L202">      replyInfoNotransfers[i]++;</span>
    }
<span class="nc" id="L204">  }</span>

  /**
   * Update the last InBound connection time
   */
  public void updateLastInBound() {
<span class="fc" id="L210">    lastInActiveTransfer = System.currentTimeMillis();</span>
<span class="fc" id="L211">  }</span>

  /**
   * Update the last OutBound connection time
   */
  public void updateLastOutBand() {
<span class="fc" id="L217">    lastOutActiveTransfer = System.currentTimeMillis();</span>
<span class="fc" id="L218">  }</span>

  /**
   * Update the value for one particular MIB entry
   *
   * @param type
   * @param entry
   */
  public void run(final int type, final int entry) {
<span class="fc" id="L227">    final long nbMs =</span>
<span class="fc" id="L228">        FileBasedConfiguration.fileBasedConfiguration.getAgentSnmp()</span>
<span class="fc" id="L229">                                                     .getUptime() + 100;</span>
<span class="fc" id="L230">    final MibLevel level = MibLevel.values()[type];</span>
<span class="fc bfc" id="L231" title="All 4 branches covered.">    switch (level) {</span>
      case globalInfo:// Global
<span class="pc bpc" id="L233" title="1 of 2 branches missed.">        if (((FtpPrivateMib) agent.getMib()).rowGlobal != null) {</span>
<span class="nc" id="L234">          run(nbMs, WaarpGlobalValuesIndex.values()[entry]);</span>
        }
<span class="fc" id="L236">        return;</span>
      case detailedInfo:// Detailed
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">        if (((FtpPrivateMib) agent.getMib()).rowDetailed != null) {</span>
<span class="nc" id="L239">          run(nbMs, WaarpDetailedValuesIndex.values()[entry]);</span>
        }
<span class="fc" id="L241">        return;</span>
      case errorInfo:// Error
<span class="pc bpc" id="L243" title="1 of 2 branches missed.">        if (((FtpPrivateMib) agent.getMib()).rowError != null) {</span>
<span class="nc" id="L244">          run(nbMs, WaarpErrorValuesIndex.values()[entry]);</span>
        }
<span class="fc" id="L246">        return;</span>
      default:
        break;
    }
<span class="fc" id="L250">  }</span>

  /**
   * Update a value in Global MIB part
   *
   * @param rank
   * @param value
   */
  protected void updateGlobalValue(final int rank, final long value) {
<span class="nc" id="L259">    ((FtpPrivateMib) agent.getMib()).rowGlobal.setValue(rank, value);</span>
<span class="nc" id="L260">  }</span>

  /**
   * Update a value in Detailed MIB part
   *
   * @param rank
   * @param value
   */
  protected void updateDetailedValue(final int rank, final long value) {
<span class="nc" id="L269">    ((FtpPrivateMib) agent.getMib()).rowDetailed.setValue(rank, value);</span>
<span class="nc" id="L270">  }</span>

  /**
   * Update a value in Error MIB part
   *
   * @param rank
   * @param value
   */
  protected void updateErrorValue(final int rank, final long value) {
<span class="nc" id="L279">    ((FtpPrivateMib) agent.getMib()).rowError.setValue(rank, value);</span>
<span class="nc" id="L280">  }</span>

  /**
   * Update a value in Global MIB part
   *
   * @param nbMs
   * @param entry
   */
  protected void run(final long nbMs, final WaarpGlobalValuesIndex entry) {
<span class="nc" id="L289">    synchronized (trafficCounter) {</span>
      long val;
<span class="nc" id="L291">      final long limitDate = System.currentTimeMillis() - nbMs;</span>
      // Global
      try {
<span class="nc bnc" id="L294" title="All 22 branches missed.">        switch (entry) {</span>
          case applUptime:
          case applOperStatus:
          case applLastChange:
          case memoryTotal:
          case memoryFree:
          case memoryUsed:
<span class="nc" id="L301">            return;</span>
          case applInboundAssociations:
<span class="nc" id="L303">            DbTransferLog</span>
<span class="nc" id="L304">                .finishSelectOrCountPrepareStatement(countInActiveTransfer,</span>
                                                     limitDate);
<span class="nc" id="L306">            nbInActiveTransfer = DbTransferLog</span>
<span class="nc" id="L307">                .getResultCountPrepareStatement(countInActiveTransfer);</span>
<span class="nc" id="L308">            updateGlobalValue(entry.ordinal(), nbInActiveTransfer);</span>
<span class="nc" id="L309">            return;</span>
          case applOutboundAssociations:
<span class="nc" id="L311">            DbTransferLog</span>
<span class="nc" id="L312">                .finishSelectOrCountPrepareStatement(countOutActiveTransfer,</span>
                                                     limitDate);
<span class="nc" id="L314">            nbOutActiveTransfer = DbTransferLog</span>
<span class="nc" id="L315">                .getResultCountPrepareStatement(countOutActiveTransfer);</span>
<span class="nc" id="L316">            updateGlobalValue(entry.ordinal(), nbOutActiveTransfer);</span>
<span class="nc" id="L317">            return;</span>
          case applAccumInboundAssociations:
<span class="nc" id="L319">            DbTransferLog</span>
<span class="nc" id="L320">                .finishSelectOrCountPrepareStatement(countInTotalTransfer,</span>
                                                     limitDate);
<span class="nc" id="L322">            nbInTotalTransfer = DbTransferLog</span>
<span class="nc" id="L323">                .getResultCountPrepareStatement(countInTotalTransfer);</span>
<span class="nc" id="L324">            updateGlobalValue(entry.ordinal(), nbInTotalTransfer);</span>
<span class="nc" id="L325">            return;</span>
          case applAccumOutboundAssociations:
<span class="nc" id="L327">            DbTransferLog</span>
<span class="nc" id="L328">                .finishSelectOrCountPrepareStatement(countOutTotalTransfer,</span>
                                                     limitDate);
<span class="nc" id="L330">            nbOutTotalTransfer = DbTransferLog</span>
<span class="nc" id="L331">                .getResultCountPrepareStatement(countOutTotalTransfer);</span>
<span class="nc" id="L332">            updateGlobalValue(entry.ordinal(), nbOutTotalTransfer);</span>
<span class="nc" id="L333">            return;</span>
          case applLastInboundActivity:
<span class="nc" id="L335">            val = (lastInActiveTransfer - agent.getUptimeSystemTime()) / 10;</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">            if (val &lt; 0) {</span>
<span class="nc" id="L337">              val = 0;</span>
            }
<span class="nc" id="L339">            updateGlobalValue(entry.ordinal(), val);</span>
<span class="nc" id="L340">            return;</span>
          case applLastOutboundActivity:
<span class="nc" id="L342">            val = (lastOutActiveTransfer - agent.getUptimeSystemTime()) / 10;</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">            if (val &lt; 0) {</span>
<span class="nc" id="L344">              val = 0;</span>
            }
<span class="nc" id="L346">            updateGlobalValue(entry.ordinal(), val);</span>
<span class="nc" id="L347">            return;</span>
          case applRejectedInboundAssociations:
<span class="nc" id="L349">            DbTransferLog</span>
<span class="nc" id="L350">                .finishSelectOrCountPrepareStatement(countInErrorTransfer,</span>
                                                     limitDate);
<span class="nc" id="L352">            nbInErrorTransfer = DbTransferLog</span>
<span class="nc" id="L353">                .getResultCountPrepareStatement(countInErrorTransfer);</span>
<span class="nc" id="L354">            updateGlobalValue(entry.ordinal(), nbInErrorTransfer);</span>
<span class="nc" id="L355">            return;</span>
          case applFailedOutboundAssociations:
<span class="nc" id="L357">            DbTransferLog</span>
<span class="nc" id="L358">                .finishSelectOrCountPrepareStatement(countOutErrorTransfer,</span>
                                                     limitDate);
<span class="nc" id="L360">            nbOutErrorTransfer = DbTransferLog</span>
<span class="nc" id="L361">                .getResultCountPrepareStatement(countOutErrorTransfer);</span>
<span class="nc" id="L362">            updateGlobalValue(entry.ordinal(), nbOutErrorTransfer);</span>
<span class="nc" id="L363">            return;</span>
          case applInboundBandwidthKBS:
<span class="nc" id="L365">            val = trafficCounter.lastReadThroughput() &gt;&gt; 10;// B/s -&gt; KB/s</span>
<span class="nc" id="L366">            updateGlobalValue(entry.ordinal(), val);</span>
<span class="nc" id="L367">            return;</span>
          case applOutboundBandwidthKBS:
<span class="nc" id="L369">            val = trafficCounter.lastWriteThroughput() &gt;&gt; 10;</span>
<span class="nc" id="L370">            updateGlobalValue(entry.ordinal(), val);</span>
<span class="nc" id="L371">            return;</span>
          case nbInfoUnknown:
<span class="nc" id="L373">            nbCountInfoUnknown = DbTransferLog</span>
<span class="nc" id="L374">                .getResultCountPrepareStatement(countInfo, UpdatedInfo.UNKNOWN,</span>
                                                limitDate);
<span class="nc" id="L376">            updateGlobalValue(entry.ordinal(), nbCountInfoUnknown);</span>
<span class="nc" id="L377">            return;</span>
          case nbInfoNotUpdated:
<span class="nc" id="L379">            nbCountInfoNotUpdated = DbTransferLog</span>
<span class="nc" id="L380">                .getResultCountPrepareStatement(countInfo,</span>
                                                UpdatedInfo.NOTUPDATED,
                                                limitDate);
<span class="nc" id="L383">            updateGlobalValue(entry.ordinal(), nbCountInfoNotUpdated);</span>
<span class="nc" id="L384">            return;</span>
          case nbInfoInterrupted:
<span class="nc" id="L386">            nbCountInfoInterrupted = DbTransferLog</span>
<span class="nc" id="L387">                .getResultCountPrepareStatement(countInfo,</span>
                                                UpdatedInfo.INTERRUPTED,
                                                limitDate);
<span class="nc" id="L390">            updateGlobalValue(entry.ordinal(), nbCountInfoInterrupted);</span>
<span class="nc" id="L391">            return;</span>
          case nbInfoToSubmit:
<span class="nc" id="L393">            nbCountInfoToSubmit = DbTransferLog</span>
<span class="nc" id="L394">                .getResultCountPrepareStatement(countInfo, UpdatedInfo.TOSUBMIT,</span>
                                                limitDate);
<span class="nc" id="L396">            updateGlobalValue(entry.ordinal(), nbCountInfoToSubmit);</span>
<span class="nc" id="L397">            return;</span>
          case nbInfoError:
<span class="nc" id="L399">            nbCountInfoError = DbTransferLog</span>
<span class="nc" id="L400">                .getResultCountPrepareStatement(countInfo, UpdatedInfo.INERROR,</span>
                                                limitDate);
<span class="nc" id="L402">            updateGlobalValue(entry.ordinal(), nbCountInfoError);</span>
<span class="nc" id="L403">            return;</span>
          case nbInfoRunning:
<span class="nc" id="L405">            nbCountInfoRunning = DbTransferLog</span>
<span class="nc" id="L406">                .getResultCountPrepareStatement(countInfo, UpdatedInfo.RUNNING,</span>
                                                limitDate);
<span class="nc" id="L408">            updateGlobalValue(entry.ordinal(), nbCountInfoRunning);</span>
<span class="nc" id="L409">            return;</span>
          case nbInfoDone:
<span class="nc" id="L411">            nbCountInfoDone = DbTransferLog</span>
<span class="nc" id="L412">                .getResultCountPrepareStatement(countInfo, UpdatedInfo.DONE,</span>
                                                limitDate);
<span class="nc" id="L414">            updateGlobalValue(entry.ordinal(), nbCountInfoDone);</span>
<span class="nc" id="L415">            return;</span>
          case nbAllTransfer:
<span class="nc" id="L417">            DbTransferLog.finishSelectOrCountPrepareStatement(countAllTransfer,</span>
                                                              limitDate);
<span class="nc" id="L419">            nbCountAllTransfer =</span>
<span class="nc" id="L420">                DbTransferLog.getResultCountPrepareStatement(countAllTransfer);</span>
<span class="nc" id="L421">            updateGlobalValue(entry.ordinal(), nbCountAllTransfer);</span>
<span class="nc" id="L422">            return;</span>
          case nbThreads:
<span class="nc" id="L424">            nbThread = Thread.activeCount();</span>
<span class="nc" id="L425">            updateGlobalValue(entry.ordinal(), nbThread);</span>
<span class="nc" id="L426">            return;</span>
          case nbNetworkConnection:
<span class="nc" id="L428">            nbNetworkConnection = FileBasedConfiguration.fileBasedConfiguration</span>
<span class="nc" id="L429">                .getFtpInternalConfiguration().getNumberSessions();</span>
<span class="nc" id="L430">            updateGlobalValue(entry.ordinal(), nbNetworkConnection);</span>
        }
<span class="nc" id="L432">      } catch (final WaarpDatabaseNoConnectionException ignored) {</span>
        // nothing
<span class="nc" id="L434">      } catch (final WaarpDatabaseSqlException ignored) {</span>
        // nothing
<span class="nc" id="L436">      }</span>
<span class="nc" id="L437">    }</span>
<span class="nc" id="L438">  }</span>

  /**
   * Update a value in Detailed MIB part
   *
   * @param nbMs
   * @param entry
   */
  protected void run(final long nbMs, final WaarpDetailedValuesIndex entry) {
<span class="nc" id="L447">    synchronized (trafficCounter) {</span>
<span class="nc" id="L448">      final long limitDate = System.currentTimeMillis() - nbMs;</span>
      // Detailed
<span class="nc" id="L450">      final long value = DbTransferLog</span>
<span class="nc" id="L451">          .getResultCountPrepareStatement(countStatus, entry.code, limitDate);</span>
<span class="nc" id="L452">      updateDetailedValue(entry.ordinal(),</span>
<span class="nc" id="L453">                          value + replyInfoNotransfers[entry.ordinal()]);</span>
<span class="nc" id="L454">    }</span>
<span class="nc" id="L455">  }</span>

  /**
   * Update a value in Error MIB part
   *
   * @param nbMs
   * @param entry
   */
  protected void run(final long nbMs, final WaarpErrorValuesIndex entry) {
<span class="nc" id="L464">    synchronized (trafficCounter) {</span>
<span class="nc" id="L465">      final long limitDate = System.currentTimeMillis() - nbMs;</span>
      // Error
<span class="nc" id="L467">      final long value = DbTransferLog</span>
<span class="nc" id="L468">          .getResultCountPrepareStatement(countStatus, entry.code, limitDate);</span>
<span class="nc" id="L469">      updateErrorValue(entry.ordinal(),</span>
<span class="nc" id="L470">                       value + replyErrorNotransfers[entry.ordinal()]);</span>
<span class="nc" id="L471">    }</span>
<span class="nc" id="L472">  }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>