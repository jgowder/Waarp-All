<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DbRule.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Waarp OpenR66</a> &gt; <a href="index.source.html" class="el_package">org.waarp.openr66.database.data</a> &gt; <span class="el_source">DbRule.java</span></div><h1>DbRule.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.openr66.database.data;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;
import org.dom4j.Document;
import org.dom4j.DocumentException;
import org.waarp.common.database.DbPreparedStatement;
import org.waarp.common.database.DbSession;
import org.waarp.common.database.exception.WaarpDatabaseException;
import org.waarp.common.database.exception.WaarpDatabaseNoConnectionException;
import org.waarp.common.database.exception.WaarpDatabaseNoDataException;
import org.waarp.common.database.exception.WaarpDatabaseSqlException;
import org.waarp.common.file.DirInterface;
import org.waarp.common.file.FileUtils;
import org.waarp.common.json.JsonHandler;
import org.waarp.common.logging.WaarpLogger;
import org.waarp.common.logging.WaarpLoggerFactory;
import org.waarp.common.utility.WaarpStringUtils;
import org.waarp.common.xml.XmlUtil;
import org.waarp.common.xml.XmlValue;
import org.waarp.openr66.configuration.RuleFileBasedConfiguration;
import org.waarp.openr66.context.R66Session;
import org.waarp.openr66.dao.AbstractDAO;
import org.waarp.openr66.dao.DAOFactory;
import org.waarp.openr66.dao.Filter;
import org.waarp.openr66.dao.RuleDAO;
import org.waarp.openr66.dao.database.DBRuleDAO;
import org.waarp.openr66.dao.database.StatementExecutor;
import org.waarp.openr66.dao.exception.DAOConnectionException;
import org.waarp.openr66.dao.exception.DAONoDataException;
import org.waarp.openr66.database.data.DbTaskRunner.TASKSTEP;
import org.waarp.openr66.pojo.Rule;
import org.waarp.openr66.pojo.RuleTask;
import org.waarp.openr66.pojo.Transfer;
import org.waarp.openr66.protocol.configuration.Configuration;
import org.waarp.openr66.protocol.exception.OpenR66ProtocolBusinessException;
import org.waarp.openr66.protocol.exception.OpenR66ProtocolSystemException;
import org.waarp.openr66.protocol.localhandler.packet.RequestPacket;

import java.io.File;
import java.io.StringReader;
import java.sql.SQLException;
import java.sql.Types;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

/**
 * Rule Table object
 */
public class DbRule extends AbstractDbDataDao&lt;Rule&gt; {
  private static final String RULE_NOT_FOUND = &quot;Rule not found&quot;;
  /**
   * Internal Logger
   */
<span class="fc" id="L76">  private static final WaarpLogger logger =</span>
<span class="fc" id="L77">      WaarpLoggerFactory.getLogger(DbRule.class);</span>
<span class="fc" id="L78">  private static final String[] STRING_0_LENGTH = new String[0];</span>
<span class="fc" id="L79">  private static final String[][] STRINGS_0_0_LENGTH = new String[0][0];</span>

<span class="fc" id="L81">  public enum Columns {</span>
<span class="fc" id="L82">    HOSTIDS, MODETRANS, RECVPATH, SENDPATH, ARCHIVEPATH, WORKPATH, RPRETASKS,</span>
<span class="fc" id="L83">    RPOSTTASKS, RERRORTASKS, SPRETASKS, SPOSTTASKS, SERRORTASKS, UPDATEDINFO,</span>
<span class="fc" id="L84">    IDRULE</span>
  }

<span class="fc" id="L87">  public static final int[] dbTypes = {</span>
      Types.LONGVARCHAR, Types.INTEGER, Types.NVARCHAR, Types.NVARCHAR,
      Types.NVARCHAR, Types.NVARCHAR, Types.LONGVARCHAR, Types.LONGVARCHAR,
      Types.LONGVARCHAR, Types.LONGVARCHAR, Types.LONGVARCHAR,
      Types.LONGVARCHAR, Types.INTEGER, Types.NVARCHAR
  };

  public static final String table = &quot; RULES &quot;;

  /**
   * Internal context XML fields
   */
  public static final String TASK_TYPE = &quot;type&quot;;

  /**
   * Internal context XML fields
   */
  public static final String TASK_PATH = &quot;path&quot;;

  /**
   * Internal context XML fields
   */
  public static final String TASK_DELAY = &quot;delay&quot;;
  /**
   * Internal context XML fields
   */
  public static final String TASK_COMMENT = &quot;comment&quot;;

  // ALL TABLE SHOULD IMPLEMENT THIS
  public static final int NBPRKEY = 1;

<span class="fc" id="L118">  protected static final String selectAllFields =</span>
<span class="fc" id="L119">      Columns.HOSTIDS.name() + ',' + Columns.MODETRANS.name() + ',' +</span>
<span class="fc" id="L120">      Columns.RECVPATH.name() + ',' + Columns.SENDPATH.name() + ',' +</span>
<span class="fc" id="L121">      Columns.ARCHIVEPATH.name() + ',' + Columns.WORKPATH.name() + ',' +</span>
<span class="fc" id="L122">      Columns.RPRETASKS.name() + ',' + Columns.RPOSTTASKS.name() + ',' +</span>
<span class="fc" id="L123">      Columns.RERRORTASKS.name() + ',' + Columns.SPRETASKS.name() + ',' +</span>
<span class="fc" id="L124">      Columns.SPOSTTASKS.name() + ',' + Columns.SERRORTASKS.name() + ',' +</span>
<span class="fc" id="L125">      Columns.UPDATEDINFO.name() + ',' + Columns.IDRULE.name();</span>

<span class="fc" id="L127">  protected static final String updateAllFields =</span>
<span class="fc" id="L128">      Columns.HOSTIDS.name() + &quot;=?,&quot; + Columns.MODETRANS.name() + &quot;=?,&quot; +</span>
<span class="fc" id="L129">      Columns.RECVPATH.name() + &quot;=?,&quot; + Columns.SENDPATH.name() + &quot;=?,&quot; +</span>
<span class="fc" id="L130">      Columns.ARCHIVEPATH.name() + &quot;=?,&quot; + Columns.WORKPATH.name() + &quot;=?,&quot; +</span>
<span class="fc" id="L131">      Columns.RPRETASKS.name() + &quot;=?,&quot; + Columns.RPOSTTASKS.name() + &quot;=?,&quot; +</span>
<span class="fc" id="L132">      Columns.RERRORTASKS.name() + &quot;=?,&quot; + Columns.SPRETASKS.name() + &quot;=?,&quot; +</span>
<span class="fc" id="L133">      Columns.SPOSTTASKS.name() + &quot;=?,&quot; + Columns.SERRORTASKS.name() + &quot;=?,&quot; +</span>
<span class="fc" id="L134">      Columns.UPDATEDINFO.name() + &quot;=?&quot;;</span>

  protected static final String insertAllValues =
      &quot; (?,?,?,?,?,?,?,?,?,?,?,?,?,?) &quot;;

  @Override
  protected void initObject() {
    // Nothing
<span class="fc" id="L142">  }</span>

  @Override
  protected String getTable() {
<span class="nc" id="L146">    return table;</span>
  }

  @Override
  protected AbstractDAO&lt;Rule&gt; getDao() throws DAOConnectionException {
<span class="fc" id="L151">    return DAOFactory.getInstance().getRuleDAO();</span>
  }

  @Override
  protected String getPrimaryKey() {
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">    if (pojo != null) {</span>
<span class="fc" id="L157">      return pojo.getName();</span>
    }
<span class="nc" id="L159">    throw new IllegalArgumentException(&quot;pojo is null&quot;);</span>
  }

  @Override
  protected String getPrimaryField() {
<span class="nc" id="L164">    return Columns.IDRULE.name();</span>
  }

  protected final void checkPath() {
<span class="pc bpc" id="L168" title="2 of 4 branches missed.">    if (getRecvPath() != null &amp;&amp; !getRecvPath().isEmpty() &amp;&amp;</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">        getRecvPath().charAt(0) != DirInterface.SEPARATORCHAR) {</span>
<span class="nc" id="L170">      pojo.setRecvPath(DirInterface.SEPARATOR + getRecvPath());</span>
    }
<span class="pc bpc" id="L172" title="2 of 4 branches missed.">    if (getSendPath() != null &amp;&amp; !getSendPath().isEmpty() &amp;&amp;</span>
<span class="pc bpc" id="L173" title="1 of 2 branches missed.">        getSendPath().charAt(0) != DirInterface.SEPARATORCHAR) {</span>
<span class="nc" id="L174">      pojo.setSendPath(DirInterface.SEPARATOR + getSendPath());</span>
    }
<span class="pc bpc" id="L176" title="2 of 4 branches missed.">    if (getArchivePath() != null &amp;&amp; !getArchivePath().isEmpty() &amp;&amp;</span>
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">        getArchivePath().charAt(0) != DirInterface.SEPARATORCHAR) {</span>
<span class="nc" id="L178">      pojo.setArchivePath(DirInterface.SEPARATOR + getArchivePath());</span>
    }
<span class="pc bpc" id="L180" title="2 of 4 branches missed.">    if (getWorkPath() != null &amp;&amp; !getWorkPath().isEmpty() &amp;&amp;</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">        getWorkPath().charAt(0) != DirInterface.SEPARATORCHAR) {</span>
<span class="nc" id="L182">      pojo.setWorkPath(DirInterface.SEPARATOR + getWorkPath());</span>
    }
<span class="fc" id="L184">  }</span>

  /**
   * @param idRule
   * @param ids
   * @param mode
   * @param recvPath
   * @param sendPath
   * @param archivePath
   * @param workPath
   * @param rpreTasks
   * @param rpostTasks
   * @param rerrorTasks
   * @param spreTasks
   * @param spostTasks
   * @param serrorTasks
   */
  public DbRule(String idRule, String ids, int mode, String recvPath,
                String sendPath, String archivePath, String workPath,
                String rpreTasks, String rpostTasks, String rerrorTasks,
<span class="nc" id="L204">                String spreTasks, String spostTasks, String serrorTasks) {</span>
<span class="nc" id="L205">    pojo = new Rule(idRule, mode, Arrays.asList(getIdsRule(ids)), recvPath,</span>
                    sendPath, archivePath, workPath,
<span class="nc" id="L207">                    fromLegacyTasks(getTasksRule(rpreTasks)),</span>
<span class="nc" id="L208">                    fromLegacyTasks(getTasksRule(rpostTasks)),</span>
<span class="nc" id="L209">                    fromLegacyTasks(getTasksRule(rerrorTasks)),</span>
<span class="nc" id="L210">                    fromLegacyTasks(getTasksRule(spreTasks)),</span>
<span class="nc" id="L211">                    fromLegacyTasks(getTasksRule(spostTasks)),</span>
<span class="nc" id="L212">                    fromLegacyTasks(getTasksRule(serrorTasks)));</span>
<span class="nc" id="L213">    checkPath();</span>
<span class="nc" id="L214">  }</span>

  /**
   * @param idRule
   *
   * @throws WaarpDatabaseException
   */
<span class="fc" id="L221">  public DbRule(String idRule) throws WaarpDatabaseException {</span>
<span class="fc" id="L222">    RuleDAO ruleAccess = null;</span>
    try {
<span class="fc" id="L224">      ruleAccess = DAOFactory.getInstance().getRuleDAO();</span>
<span class="fc" id="L225">      pojo = ruleAccess.select(idRule);</span>
<span class="nc" id="L226">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L227">      throw new WaarpDatabaseException(e);</span>
<span class="nc" id="L228">    } catch (final DAONoDataException e) {</span>
<span class="nc" id="L229">      throw new WaarpDatabaseNoDataException(RULE_NOT_FOUND + &quot; &quot; + idRule, e);</span>
    } finally {
<span class="fc" id="L231">      DAOFactory.closeDAO(ruleAccess);</span>
    }
<span class="fc" id="L233">    checkPath();</span>
<span class="fc" id="L234">  }</span>

<span class="nc" id="L236">  public DbRule(Rule rule) {</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">    if (rule == null) {</span>
<span class="nc" id="L238">      throw new IllegalArgumentException(</span>
          &quot;Argument in constructor cannot be null&quot;);
    }
<span class="nc" id="L241">    this.pojo = rule;</span>
<span class="nc" id="L242">    checkPath();</span>
<span class="nc" id="L243">  }</span>

  /**
   * Constructor used from XML file
   *
   * @param idrule
   * @param idsArrayRef
   * @param recvpath
   * @param sendpath
   * @param archivepath
   * @param workpath
   * @param rpretasksArray
   * @param rposttasksArray
   * @param rerrortasksArray
   * @param spretasksArray
   * @param sposttasksArray
   * @param serrortasksArray
   */
  public DbRule(String idrule, String[] idsArrayRef, int mode, String recvpath,
                String sendpath, String archivepath, String workpath,
                String[][] rpretasksArray, String[][] rposttasksArray,
                String[][] rerrortasksArray, String[][] spretasksArray,
<span class="fc" id="L265">                String[][] sposttasksArray, String[][] serrortasksArray) {</span>
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">    if (idsArrayRef == null) {</span>
<span class="nc" id="L267">      idsArrayRef = STRING_0_LENGTH;</span>
    }
<span class="fc" id="L269">    pojo =</span>
<span class="fc" id="L270">        new Rule(idrule, mode, Arrays.asList(idsArrayRef), recvpath, sendpath,</span>
<span class="fc" id="L271">                 archivepath, workpath, fromLegacyTasks(rpretasksArray),</span>
<span class="fc" id="L272">                 fromLegacyTasks(rposttasksArray),</span>
<span class="fc" id="L273">                 fromLegacyTasks(rerrortasksArray),</span>
<span class="fc" id="L274">                 fromLegacyTasks(spretasksArray),</span>
<span class="fc" id="L275">                 fromLegacyTasks(sposttasksArray),</span>
<span class="fc" id="L276">                 fromLegacyTasks(serrortasksArray));</span>
<span class="fc" id="L277">    checkPath();</span>
<span class="fc" id="L278">  }</span>

  /**
   * Constructor from Json
   *
   * @param source
   *
   * @throws WaarpDatabaseSqlException
   */
<span class="nc" id="L287">  public DbRule(ObjectNode source) throws WaarpDatabaseSqlException {</span>
<span class="nc" id="L288">    pojo = new Rule();</span>
<span class="nc" id="L289">    setFromJson(source, false);</span>
<span class="nc bnc" id="L290" title="All 4 branches missed.">    if (getIdRule() == null || getIdRule().isEmpty()) {</span>
<span class="nc" id="L291">      throw new WaarpDatabaseSqlException(</span>
          &quot;Not enough argument to create the object&quot;);
    }
<span class="nc" id="L294">    checkPath();</span>
<span class="nc" id="L295">  }</span>

  @Override
  public void setFromJson(ObjectNode node, boolean ignorePrimaryKey)
      throws WaarpDatabaseSqlException {
<span class="nc" id="L300">    super.setFromJson(node, ignorePrimaryKey);</span>
<span class="nc" id="L301">    checkPath();</span>
<span class="nc" id="L302">  }</span>

  @Override
  protected void setFromJson(final String field, final JsonNode value) {
<span class="nc bnc" id="L306" title="All 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L307">      return;</span>
    }
<span class="nc bnc" id="L309" title="All 2 branches missed.">    for (Columns column : Columns.values()) {</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">      if (column.name().equalsIgnoreCase(field)) {</span>
<span class="nc bnc" id="L311" title="All 15 branches missed.">        switch (column) {</span>
          case ARCHIVEPATH:
<span class="nc" id="L313">            pojo.setArchivePath(value.asText());</span>
<span class="nc" id="L314">            break;</span>
          case HOSTIDS:
<span class="nc" id="L316">            pojo.setHostids(Arrays.asList(getIdsRule(value.asText())));</span>
<span class="nc" id="L317">            break;</span>
          case IDRULE:
<span class="nc" id="L319">            pojo.setName(value.asText());</span>
<span class="nc" id="L320">            break;</span>
          case MODETRANS:
<span class="nc" id="L322">            pojo.setMode(value.asInt());</span>
<span class="nc" id="L323">            break;</span>
          case RECVPATH:
<span class="nc" id="L325">            pojo.setRecvPath(value.asText());</span>
<span class="nc" id="L326">            break;</span>
          case RERRORTASKS:
<span class="nc" id="L328">            pojo.setRErrorTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="nc" id="L329">            break;</span>
          case RPOSTTASKS:
<span class="nc" id="L331">            pojo.setRPostTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="nc" id="L332">            break;</span>
          case RPRETASKS:
<span class="nc" id="L334">            pojo.setRPreTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="nc" id="L335">            break;</span>
          case SENDPATH:
<span class="nc" id="L337">            pojo.setSendPath(value.asText());</span>
<span class="nc" id="L338">            break;</span>
          case SERRORTASKS:
<span class="nc" id="L340">            pojo.setSErrorTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="nc" id="L341">            break;</span>
          case SPOSTTASKS:
<span class="nc" id="L343">            pojo.setSPostTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="nc" id="L344">            break;</span>
          case SPRETASKS:
<span class="nc" id="L346">            pojo.setSPreTasks(fromLegacyTasks(getTasksRule(value.asText())));</span>
<span class="nc" id="L347">            break;</span>
          case WORKPATH:
<span class="nc" id="L349">            pojo.setWorkPath(value.asText());</span>
<span class="nc" id="L350">            break;</span>
          case UPDATEDINFO:
<span class="nc" id="L352">            pojo.setUpdatedInfo(</span>
<span class="nc" id="L353">                org.waarp.openr66.pojo.UpdatedInfo.valueOf(value.asInt()));</span>
            break;
        }
      }
    }
<span class="nc" id="L358">    checkPath();</span>
<span class="nc" id="L359">  }</span>

  /**
   * Private constructor for Commander only
   */
<span class="nc" id="L364">  private DbRule() {</span>
<span class="nc" id="L365">    pojo = new Rule();</span>
<span class="nc" id="L366">  }</span>

  /**
   * Delete object from table DbRule only if no DbTaskRunner is using it.
   *
   * @throws WaarpDatabaseException
   */
  @Override
  public void delete() throws WaarpDatabaseException {
<span class="nc" id="L375">    AbstractDAO&lt;Transfer&gt; transferDAO = null;</span>
    try {
<span class="nc" id="L377">      transferDAO = DAOFactory.getInstance().getTransferDAO();</span>
<span class="nc" id="L378">      List&lt;Filter&gt; filters = new ArrayList&lt;Filter&gt;();</span>
<span class="nc" id="L379">      Filter filter =</span>
<span class="nc" id="L380">          new Filter(DbTaskRunner.Columns.IDRULE.name(), &quot;=&quot;, this.getIdRule());</span>
<span class="nc" id="L381">      filters.add(filter);</span>
<span class="nc" id="L382">      List&lt;Transfer&gt; transfers = transferDAO.find(filters);</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">      if (!transfers.isEmpty()) {</span>
<span class="nc" id="L384">        transfers.clear();</span>
<span class="nc" id="L385">        throw new WaarpDatabaseNoDataException(&quot;Rule &quot; + this.getIdRule() +</span>
                                               &quot; is still used by TaskRunner therefore it cannot be deleted.&quot;);
      }
<span class="nc" id="L388">    } catch (DAOConnectionException e) {</span>
<span class="nc" id="L389">      throw new WaarpDatabaseNoConnectionException(e);</span>
    } finally {
<span class="nc bnc" id="L391" title="All 2 branches missed.">      if (transferDAO != null) {</span>
<span class="nc" id="L392">        transferDAO.close();</span>
      }
    }
<span class="nc" id="L395">    super.delete();</span>
<span class="nc" id="L396">  }</span>

  /**
   * Delete all Rules but returns original one, therefore not checking if
   * any TaskRunner are using it (used by reloading rules)
   *
   * @return the previously existing DbRule
   *
   * @throws WaarpDatabaseException
   */
  public static DbRule[] deleteAll() throws WaarpDatabaseException {
<span class="nc" id="L407">    RuleDAO ruleAccess = null;</span>
    List&lt;Rule&gt; rules;
    try {
<span class="nc" id="L410">      ruleAccess = DAOFactory.getInstance().getRuleDAO();</span>
<span class="nc" id="L411">      rules = ruleAccess.getAll();</span>
<span class="nc" id="L412">      ruleAccess.deleteAll();</span>
<span class="nc" id="L413">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L414">      throw new WaarpDatabaseException(e);</span>
    } finally {
<span class="nc" id="L416">      DAOFactory.closeDAO(ruleAccess);</span>
    }
<span class="nc" id="L418">    final DbRule[] res = new DbRule[rules.size()];</span>
<span class="nc" id="L419">    int i = 0;</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">    for (final Rule rule : rules) {</span>
<span class="nc" id="L421">      res[i] = new DbRule(rule);</span>
<span class="nc" id="L422">      i++;</span>
<span class="nc" id="L423">    }</span>
<span class="nc" id="L424">    return res;</span>
  }

  /**
   * Get All DbRule from database or from internal hashMap in case of no
   * database support
   *
   * @return the array of DbRule
   *
   * @throws WaarpDatabaseNoConnectionException
   * @throws WaarpDatabaseSqlException
   */
  public static DbRule[] getAllRules()
      throws WaarpDatabaseNoConnectionException {
<span class="nc" id="L438">    RuleDAO ruleAccess = null;</span>
    List&lt;Rule&gt; rules;
    try {
<span class="nc" id="L441">      ruleAccess = DAOFactory.getInstance().getRuleDAO();</span>
<span class="nc" id="L442">      rules = ruleAccess.getAll();</span>
<span class="nc" id="L443">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L444">      throw new WaarpDatabaseNoConnectionException(e);</span>
    } finally {
<span class="nc" id="L446">      DAOFactory.closeDAO(ruleAccess);</span>
    }
<span class="nc" id="L448">    final DbRule[] res = new DbRule[rules.size()];</span>
<span class="nc" id="L449">    int i = 0;</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">    for (final Rule rule : rules) {</span>
<span class="nc" id="L451">      res[i] = new DbRule(rule);</span>
<span class="nc" id="L452">      i++;</span>
<span class="nc" id="L453">    }</span>
<span class="nc" id="L454">    return res;</span>
  }

  /**
   * For instance from Commander when getting updated information
   *
   * @param preparedStatement
   *
   * @return the next updated DbRule
   *
   * @throws WaarpDatabaseNoConnectionException
   * @throws WaarpDatabaseSqlException
   */
  public static DbRule getFromStatement(DbPreparedStatement preparedStatement)
      throws WaarpDatabaseNoConnectionException, WaarpDatabaseSqlException {
<span class="nc" id="L469">    final DbRule dbRule = new DbRule();</span>
<span class="nc" id="L470">    AbstractDAO&lt;Rule&gt; ruleDAO = null;</span>
    try {
<span class="nc" id="L472">      ruleDAO = dbRule.getDao();</span>
<span class="nc" id="L473">      dbRule.pojo = ((StatementExecutor&lt;Rule&gt;) ruleDAO)</span>
<span class="nc" id="L474">          .getFromResultSet(preparedStatement.getResultSet());</span>
<span class="nc" id="L475">      return dbRule;</span>
<span class="nc" id="L476">    } catch (SQLException e) {</span>
<span class="nc" id="L477">      DbSession.error(e);</span>
<span class="nc" id="L478">      throw new WaarpDatabaseSqlException(&quot;Getting values in error&quot;, e);</span>
<span class="nc" id="L479">    } catch (DAOConnectionException e) {</span>
<span class="nc" id="L480">      throw new WaarpDatabaseSqlException(&quot;Getting values in error&quot;, e);</span>
    } finally {
<span class="nc" id="L482">      DAOFactory.closeDAO(ruleDAO);</span>
    }
  }

  /**
   * @return the DbPreparedStatement for getting Updated Object
   *
   * @throws WaarpDatabaseNoConnectionException
   * @throws WaarpDatabaseSqlException
   */
  public static DbRule[] getUpdatedPrepareStament()
      throws WaarpDatabaseNoConnectionException, WaarpDatabaseSqlException {
<span class="fc" id="L494">    final List&lt;Filter&gt; filters = new ArrayList&lt;Filter&gt;(1);</span>
<span class="fc" id="L495">    filters.add(new Filter(DBRuleDAO.UPDATED_INFO_FIELD, &quot;=&quot;,</span>
<span class="fc" id="L496">                           org.waarp.openr66.pojo.UpdatedInfo</span>
<span class="fc" id="L497">                               .fromLegacy(UpdatedInfo.TOSUBMIT).ordinal()));</span>
<span class="fc" id="L498">    RuleDAO ruleAccess = null;</span>
    List&lt;Rule&gt; rules;
    try {
<span class="fc" id="L501">      ruleAccess = DAOFactory.getInstance().getRuleDAO();</span>
<span class="fc" id="L502">      rules = ruleAccess.find(filters);</span>
<span class="nc" id="L503">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L504">      throw new WaarpDatabaseNoConnectionException(e);</span>
    } finally {
<span class="fc" id="L506">      DAOFactory.closeDAO(ruleAccess);</span>
    }
<span class="fc" id="L508">    final DbRule[] res = new DbRule[rules.size()];</span>
<span class="fc" id="L509">    int i = 0;</span>
<span class="pc bpc" id="L510" title="1 of 2 branches missed.">    for (final Rule rule : rules) {</span>
<span class="nc" id="L511">      res[i] = new DbRule(rule);</span>
<span class="nc" id="L512">      i++;</span>
<span class="nc" id="L513">    }</span>
<span class="fc" id="L514">    return res;</span>
  }

  @Override
  public void changeUpdatedInfo(UpdatedInfo info) {
<span class="nc" id="L519">    pojo.setUpdatedInfo(org.waarp.openr66.pojo.UpdatedInfo.fromLegacy(info));</span>
<span class="nc" id="L520">  }</span>

  /**
   * Get Ids from String. If it is not ok, then it sets the default values and
   * return False, else returns True.
   *
   * @param idsref
   *
   * @return True if ok, else False (default values).
   */
  private String[] getIdsRule(String idsref) {
<span class="nc bnc" id="L531" title="All 2 branches missed.">    if (idsref == null) {</span>
      // No ids so setting to the default!
<span class="nc" id="L533">      return STRING_0_LENGTH;</span>
    }
<span class="nc" id="L535">    final StringReader reader = new StringReader(idsref);</span>
    Document document;
    try {
<span class="nc" id="L538">      document = XmlUtil.getNewSaxReader().read(reader);</span>
<span class="nc" id="L539">      final XmlValue[] values =</span>
<span class="nc" id="L540">          XmlUtil.read(document, RuleFileBasedConfiguration.hostsDecls);</span>
<span class="nc" id="L541">      return RuleFileBasedConfiguration.getHostIds(values[0]);</span>
<span class="nc" id="L542">    } catch (final DocumentException e) {</span>
<span class="nc" id="L543">      logger.warn(&quot;Unable to read the ids for Rule: &quot; + idsref, e);</span>
      // No ids so setting to the default!
<span class="nc" id="L545">      return STRING_0_LENGTH;</span>
    } finally {
<span class="nc" id="L547">      FileUtils.close(reader);</span>
    }
  }

  /**
   * Get Tasks from String. If it is not ok, then it sets the default values
   * and
   * return new array of Tasks or
   * null if in error.
   *
   * @param tasks
   *
   * @return Array of tasks or empty array if in error.
   */
  private String[][] getTasksRule(String tasks) {
<span class="nc bnc" id="L562" title="All 2 branches missed.">    if (tasks == null) {</span>
      // No tasks so setting to the default!
<span class="nc" id="L564">      return STRINGS_0_0_LENGTH;</span>
    }
<span class="nc" id="L566">    final StringReader reader = new StringReader(tasks);</span>
    Document document;
    try {
<span class="nc" id="L569">      document = XmlUtil.getNewSaxReader().read(reader);</span>
<span class="nc" id="L570">    } catch (final DocumentException e) {</span>
<span class="nc" id="L571">      logger.info(&quot;Unable to read the tasks for Rule: &quot; + tasks, e);</span>
      // No tasks so setting to the default!
<span class="nc" id="L573">      FileUtils.close(reader);</span>
<span class="nc" id="L574">      return STRINGS_0_0_LENGTH;</span>
<span class="nc" id="L575">    }</span>
<span class="nc" id="L576">    final XmlValue[] values =</span>
<span class="nc" id="L577">        XmlUtil.read(document, RuleFileBasedConfiguration.tasksDecl);</span>
<span class="nc" id="L578">    final String[][] result =</span>
<span class="nc" id="L579">        RuleFileBasedConfiguration.getTasksRule(values[0]);</span>
<span class="nc" id="L580">    FileUtils.close(reader);</span>
<span class="nc" id="L581">    return result;</span>
  }

  /**
   * Get the full path from RecvPath (used only in copy MODETRANS)
   *
   * @param filename
   *
   * @return the full String path
   *
   * @throws OpenR66ProtocolSystemException
   */
  public String setRecvPath(String filename)
      throws OpenR66ProtocolSystemException {
<span class="pc bpc" id="L595" title="2 of 4 branches missed.">    if (pojo.getRecvPath() != null &amp;&amp; !pojo.getRecvPath().isEmpty()) {</span>
<span class="fc" id="L596">      return pojo.getRecvPath() + DirInterface.SEPARATOR + filename;</span>
    }
<span class="nc" id="L598">    return Configuration.configuration.getInPath() + DirInterface.SEPARATOR +</span>
           filename;
  }

  /**
   * Get the full path from sendPath
   *
   * @param filename
   *
   * @return the full String path
   *
   * @throws OpenR66ProtocolSystemException
   */
  public String setSendPath(String filename)
      throws OpenR66ProtocolSystemException {
<span class="nc bnc" id="L613" title="All 2 branches missed.">    if (pojo.getSendPath() != null) {</span>
<span class="nc" id="L614">      final File file = new File(filename);</span>
<span class="nc" id="L615">      final String basename = file.getName();</span>
<span class="nc" id="L616">      return pojo.getSendPath() + DirInterface.SEPARATOR + basename;</span>
    }
<span class="nc" id="L618">    return Configuration.configuration.getOutPath() + DirInterface.SEPARATOR +</span>
           filename;
  }

  /**
   * Get the full path from archivePath
   *
   * @param filename
   *
   * @return the full String path
   *
   * @throws OpenR66ProtocolSystemException
   */
  public String setArchivePath(String filename)
      throws OpenR66ProtocolSystemException {
<span class="nc bnc" id="L633" title="All 2 branches missed.">    if (pojo.getArchivePath() != null) {</span>
<span class="nc" id="L634">      return pojo.getArchivePath() + DirInterface.SEPARATOR + filename;</span>
    }
<span class="nc" id="L636">    return Configuration.configuration.getArchivePath() +</span>
           DirInterface.SEPARATOR + filename;
  }

  /**
   * Get the full path from workPath
   *
   * @param filename
   *
   * @return the full String path
   *
   * @throws OpenR66ProtocolSystemException
   */
  public String setWorkingPath(String filename)
      throws OpenR66ProtocolSystemException {
<span class="nc bnc" id="L651" title="All 2 branches missed.">    if (pojo.getWorkPath() != null) {</span>
<span class="nc" id="L652">      return pojo.getWorkPath() + DirInterface.SEPARATOR + filename +</span>
             Configuration.EXT_R66;
    }
<span class="nc" id="L655">    return Configuration.configuration.getWorkingPath() +</span>
           DirInterface.SEPARATOR + filename;
  }

  /**
   * Check if the given hostTo is in the allowed list
   *
   * @param hostId
   *
   * @return True if allow, else False
   */
  public boolean checkHostAllow(String hostId) {
<span class="pc bpc" id="L667" title="2 of 4 branches missed.">    if (getIdsArray() == null || getIdsArray().length == 0) {</span>
<span class="fc" id="L668">      return true; // always true in this case</span>
    }
<span class="nc bnc" id="L670" title="All 2 branches missed.">    for (final String element : getIdsArray()) {</span>
<span class="nc bnc" id="L671" title="All 2 branches missed.">      if (element.equalsIgnoreCase(hostId)) {</span>
<span class="nc" id="L672">        return true;</span>
      }
    }
<span class="nc" id="L675">    return false;</span>
  }

  /**
   * @return True if this rule is adapted for SENDMODE
   */
  public boolean isSendMode() {
<span class="pc bpc" id="L682" title="1 of 2 branches missed.">    return !RequestPacket.isRecvMode(getMode());</span>
  }

  /**
   * @return True if this rule is adapted for RECVMODE
   */
  public boolean isRecvMode() {
<span class="fc" id="L689">    return RequestPacket.isRecvMode(getMode());</span>
  }

  /**
   * Object to String
   *
   * @return the string that displays this object
   *
   * @see Object#toString()
   */
  @Override
  public String toString() {
<span class="fc" id="L701">    return &quot;Rule Name:&quot; + getIdRule() + &quot; IDS:&quot; + pojo.getXMLHostids() +</span>
<span class="fc" id="L702">           &quot; MODETRANS: &quot; + RequestPacket.TRANSFERMODE.values()[getMode()] +</span>
<span class="fc" id="L703">           &quot; RECV:&quot; + getRecvPath() + &quot; SEND:&quot; + getSendPath() + &quot; ARCHIVE:&quot; +</span>
<span class="fc" id="L704">           getArchivePath() + &quot; WORK:&quot; + getWorkPath() + &quot; RPRET:{&quot; +</span>
<span class="fc" id="L705">           pojo.getXMLRPreTasks().replace('\n', ' ') + &quot;} RPOST:{&quot; +</span>
<span class="fc" id="L706">           pojo.getXMLRPostTasks().replace('\n', ' ') + &quot;} RERROR:{&quot; +</span>
<span class="fc" id="L707">           pojo.getXMLRErrorTasks().replace('\n', ' ') + &quot;} SPRET:{&quot; +</span>
<span class="fc" id="L708">           pojo.getXMLSPreTasks().replace('\n', ' ') + &quot;} SPOST:{&quot; +</span>
<span class="fc" id="L709">           pojo.getXMLSPostTasks().replace('\n', ' ') + &quot;} SERROR:{&quot; +</span>
<span class="fc" id="L710">           pojo.getXMLSErrorTasks().replace('\n', ' ') + '}';</span>
  }

  /**
   * @param isSender
   * @param step
   *
   * @return a string that prints (debug) the tasks to execute
   */
  public String printTasks(boolean isSender, TASKSTEP step) {
<span class="fc bfc" id="L720" title="All 2 branches covered.">    if (isSender) {</span>
<span class="pc bpc" id="L721" title="2 of 4 branches missed.">      switch (step) {</span>
        case PRETASK:
<span class="fc" id="L723">          return &quot;S:{&quot; + pojo.getXMLRPreTasks().replace('\n', ' ') + '}';</span>
        case POSTTASK:
<span class="fc" id="L725">          return &quot;S:{&quot; + pojo.getXMLRPostTasks().replace('\n', ' ') + '}';</span>
        case ERRORTASK:
<span class="nc" id="L727">          return &quot;S:{&quot; + pojo.getXMLRErrorTasks().replace('\n', ' ') + '}';</span>
        default:
<span class="nc" id="L729">          return &quot;S:{no task}&quot;;</span>
      }
    } else {
<span class="pc bpc" id="L732" title="2 of 4 branches missed.">      switch (step) {</span>
        case PRETASK:
<span class="fc" id="L734">          return &quot;R:{&quot; + pojo.getXMLSPreTasks().replace('\n', ' ') + '}';</span>
        case POSTTASK:
<span class="fc" id="L736">          return &quot;R:{&quot; + pojo.getXMLSPostTasks().replace('\n', ' ') + '}';</span>
        case ERRORTASK:
<span class="nc" id="L738">          return &quot;R:{&quot; + pojo.getXMLSErrorTasks().replace('\n', ' ') + '}';</span>
        default:
<span class="nc" id="L740">          return &quot;R:{no task}&quot;;</span>
      }
    }
  }

  /**
   * Object to String
   *
   * @return the string that displays this object
   *
   * @see Object#toString()
   */
  public String toShortString() {
<span class="nc" id="L753">    return &quot;Rule Name:&quot; + getIdRule() + &quot; MODETRANS: &quot; +</span>
<span class="nc" id="L754">           RequestPacket.TRANSFERMODE.values()[getMode()];</span>
  }

  /**
   * @param session
   * @param rule
   * @param mode
   *
   * @return the DbPreparedStatement according to the filter
   *
   * @throws WaarpDatabaseNoConnectionException
   * @throws WaarpDatabaseSqlException
   */
  public static DbPreparedStatement getFilterPrepareStament(DbSession session,
                                                            String rule,
                                                            int mode)
      throws WaarpDatabaseNoConnectionException, WaarpDatabaseSqlException {
<span class="nc" id="L771">    final DbPreparedStatement preparedStatement =</span>
        new DbPreparedStatement(session);
<span class="nc" id="L773">    final String request = &quot;SELECT &quot; + selectAllFields + &quot; FROM &quot; + table;</span>
<span class="nc" id="L774">    String condition = null;</span>
<span class="nc bnc" id="L775" title="All 2 branches missed.">    if (rule != null) {</span>
<span class="nc" id="L776">      condition = &quot; WHERE &quot; + Columns.IDRULE.name() + &quot; LIKE '%&quot; + rule + &quot;%' &quot;;</span>
    }
<span class="nc bnc" id="L778" title="All 2 branches missed.">    if (mode &gt;= 0) {</span>
<span class="nc bnc" id="L779" title="All 2 branches missed.">      if (condition != null) {</span>
<span class="nc" id="L780">        condition += &quot; AND &quot;;</span>
      } else {
<span class="nc" id="L782">        condition = &quot; WHERE &quot;;</span>
      }
<span class="nc" id="L784">      condition += Columns.MODETRANS.name() + &quot; = ?&quot;;</span>
    } else {
<span class="nc" id="L786">      condition = &quot;&quot;;</span>
    }
<span class="nc" id="L788">    preparedStatement.createPrepareStatement(</span>
<span class="nc" id="L789">        request + condition + &quot; ORDER BY &quot; + Columns.IDRULE.name());</span>
<span class="nc bnc" id="L790" title="All 2 branches missed.">    if (mode &gt;= 0) {</span>
      try {
<span class="nc" id="L792">        preparedStatement.getPreparedStatement().setInt(1, mode);</span>
<span class="nc" id="L793">      } catch (final SQLException e) {</span>
<span class="nc" id="L794">        preparedStatement.realClose();</span>
<span class="nc" id="L795">        throw new WaarpDatabaseSqlException(e);</span>
<span class="nc" id="L796">      }</span>
    }
<span class="nc" id="L798">    return preparedStatement;</span>
  }

  /**
   * Write selected DbRule to a Json String
   *
   * @param preparedStatement
   *
   * @return the associated Json String
   *
   * @throws WaarpDatabaseNoConnectionException
   * @throws WaarpDatabaseSqlException
   * @throws OpenR66ProtocolBusinessException
   */
  public static String getJson(DbPreparedStatement preparedStatement, int limit)
      throws WaarpDatabaseNoConnectionException, WaarpDatabaseSqlException,
             OpenR66ProtocolBusinessException {
<span class="nc" id="L815">    final ArrayNode arrayNode = JsonHandler.createArrayNode();</span>
    try {
<span class="nc" id="L817">      preparedStatement.executeQuery();</span>
<span class="nc" id="L818">      int nb = 0;</span>
<span class="nc bnc" id="L819" title="All 2 branches missed.">      while (preparedStatement.getNext()) {</span>
<span class="nc" id="L820">        final DbRule rule = getFromStatement(preparedStatement);</span>
<span class="nc" id="L821">        final ObjectNode node = rule.getInternalJson();</span>
<span class="nc" id="L822">        arrayNode.add(node);</span>
<span class="nc" id="L823">        nb++;</span>
<span class="nc bnc" id="L824" title="All 2 branches missed.">        if (nb &gt;= limit) {</span>
<span class="nc" id="L825">          break;</span>
        }
<span class="nc" id="L827">      }</span>
    } finally {
<span class="nc" id="L829">      preparedStatement.realClose();</span>
    }
    // \n is not correctly parsed within HTML so put double \\n in fine
<span class="nc" id="L832">    return WaarpStringUtils.cleanJsonForHtml(arrayNode.toString());</span>
  }

  private ObjectNode getInternalJson() {
<span class="nc" id="L836">    final ObjectNode node = getJson();</span>
<span class="nc bnc" id="L837" title="All 2 branches missed.">    if (pojo.getHostids().isEmpty()) {</span>
<span class="nc" id="L838">      node.put(Columns.HOSTIDS.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L840" title="All 2 branches missed.">    if (pojo.getRecvPath() == null) {</span>
<span class="nc" id="L841">      node.put(Columns.RECVPATH.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L843" title="All 2 branches missed.">    if (pojo.getSendPath() == null) {</span>
<span class="nc" id="L844">      node.put(Columns.SENDPATH.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L846" title="All 2 branches missed.">    if (pojo.getArchivePath() == null) {</span>
<span class="nc" id="L847">      node.put(Columns.ARCHIVEPATH.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L849" title="All 2 branches missed.">    if (pojo.getWorkPath() == null) {</span>
<span class="nc" id="L850">      node.put(Columns.WORKPATH.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L852" title="All 2 branches missed.">    if (pojo.getRPreTasks().isEmpty()) {</span>
<span class="nc" id="L853">      node.put(Columns.RPRETASKS.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L855" title="All 2 branches missed.">    if (pojo.getRPostTasks().isEmpty()) {</span>
<span class="nc" id="L856">      node.put(Columns.RPOSTTASKS.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L858" title="All 2 branches missed.">    if (pojo.getRErrorTasks().isEmpty()) {</span>
<span class="nc" id="L859">      node.put(Columns.RERRORTASKS.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L861" title="All 2 branches missed.">    if (pojo.getSPreTasks().isEmpty()) {</span>
<span class="nc" id="L862">      node.put(Columns.SPRETASKS.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L864" title="All 2 branches missed.">    if (pojo.getSPostTasks().isEmpty()) {</span>
<span class="nc" id="L865">      node.put(Columns.SPOSTTASKS.name(), &quot;&quot;);</span>
    }
<span class="nc bnc" id="L867" title="All 2 branches missed.">    if (pojo.getSErrorTasks().isEmpty()) {</span>
<span class="nc" id="L868">      node.put(Columns.SERRORTASKS.name(), &quot;&quot;);</span>
    }
<span class="nc" id="L870">    return node;</span>
  }

  /**
   * @return the Json string for this
   */
  public String getJsonAsString() {
<span class="nc" id="L877">    final ObjectNode node = getInternalJson();</span>
<span class="nc" id="L878">    return JsonHandler.writeAsString(node).replaceAll(&quot;([^\\\\])\\\\n&quot;, &quot;$1&quot;)</span>
<span class="nc" id="L879">                      .replaceAll(&quot;([^\\\\])\\\\r&quot;, &quot;$1&quot;)</span>
<span class="nc" id="L880">                      .replace(&quot;\\\\&quot;, &quot;\\\\\\\\&quot;);</span>
  }

  /**
   * @param session
   * @param body
   *
   * @return the runner in Html format specified by body by replacing all
   *     instance of fields
   */
  public String toSpecializedHtml(R66Session session, String body) {
<span class="nc" id="L891">    final StringBuilder builder = new StringBuilder(body);</span>
<span class="nc" id="L892">    WaarpStringUtils.replace(builder, &quot;XXXRULEXXX&quot;, getIdRule());</span>
<span class="nc" id="L893">    WaarpStringUtils.replace(builder, &quot;XXXIDSXXX&quot;,</span>
<span class="nc bnc" id="L894" title="All 2 branches missed.">                             pojo.getXMLHostids() == null? &quot;&quot; :</span>
<span class="nc" id="L895">                                 pojo.getXMLHostids());</span>
<span class="nc bnc" id="L896" title="All 2 branches missed.">    if (getMode() == RequestPacket.TRANSFERMODE.RECVMODE.ordinal()) {</span>
<span class="nc" id="L897">      WaarpStringUtils.replace(builder, &quot;XXXRECVXXX&quot;, &quot;checked&quot;);</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">    } else if (getMode() == RequestPacket.TRANSFERMODE.SENDMODE.ordinal()) {</span>
<span class="nc" id="L899">      WaarpStringUtils.replace(builder, &quot;XXXSENDXXX&quot;, &quot;checked&quot;);</span>
<span class="nc bnc" id="L900" title="All 2 branches missed.">    } else if (getMode() == RequestPacket.TRANSFERMODE.RECVMD5MODE.ordinal()) {</span>
<span class="nc" id="L901">      WaarpStringUtils.replace(builder, &quot;XXXRECVMXXX&quot;, &quot;checked&quot;);</span>
<span class="nc bnc" id="L902" title="All 2 branches missed.">    } else if (getMode() == RequestPacket.TRANSFERMODE.SENDMD5MODE.ordinal()) {</span>
<span class="nc" id="L903">      WaarpStringUtils.replace(builder, &quot;XXXSENDMXXX&quot;, &quot;checked&quot;);</span>
<span class="nc" id="L904">    } else if (getMode() ==</span>
<span class="nc bnc" id="L905" title="All 2 branches missed.">               RequestPacket.TRANSFERMODE.RECVTHROUGHMODE.ordinal()) {</span>
<span class="nc" id="L906">      WaarpStringUtils.replace(builder, &quot;XXXRECVTXXX&quot;, &quot;checked&quot;);</span>
<span class="nc" id="L907">    } else if (getMode() ==</span>
<span class="nc bnc" id="L908" title="All 2 branches missed.">               RequestPacket.TRANSFERMODE.SENDTHROUGHMODE.ordinal()) {</span>
<span class="nc" id="L909">      WaarpStringUtils.replace(builder, &quot;XXXSENDTXXX&quot;, &quot;checked&quot;);</span>
<span class="nc" id="L910">    } else if (getMode() ==</span>
<span class="nc bnc" id="L911" title="All 2 branches missed.">               RequestPacket.TRANSFERMODE.RECVMD5THROUGHMODE.ordinal()) {</span>
<span class="nc" id="L912">      WaarpStringUtils.replace(builder, &quot;XXXRECVMTXXX&quot;, &quot;checked&quot;);</span>
<span class="nc" id="L913">    } else if (getMode() ==</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">               RequestPacket.TRANSFERMODE.SENDMD5THROUGHMODE.ordinal()) {</span>
<span class="nc" id="L915">      WaarpStringUtils.replace(builder, &quot;XXXSENDMTXXX&quot;, &quot;checked&quot;);</span>
    }
<span class="nc" id="L917">    WaarpStringUtils.replace(builder, &quot;XXXRPXXX&quot;,</span>
<span class="nc bnc" id="L918" title="All 2 branches missed.">                             pojo.getRecvPath() == null? &quot;&quot; :</span>
<span class="nc" id="L919">                                 pojo.getRecvPath());</span>
<span class="nc" id="L920">    WaarpStringUtils.replace(builder, &quot;XXXSPXXX&quot;,</span>
<span class="nc bnc" id="L921" title="All 2 branches missed.">                             pojo.getSendPath() == null? &quot;&quot; :</span>
<span class="nc" id="L922">                                 pojo.getSendPath());</span>
<span class="nc" id="L923">    WaarpStringUtils.replace(builder, &quot;XXXAPXXX&quot;,</span>
<span class="nc bnc" id="L924" title="All 2 branches missed.">                             pojo.getArchivePath() == null? &quot;&quot; :</span>
<span class="nc" id="L925">                                 pojo.getArchivePath());</span>
<span class="nc" id="L926">    WaarpStringUtils.replace(builder, &quot;XXXWPXXX&quot;,</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">                             pojo.getWorkPath() == null? &quot;&quot; :</span>
<span class="nc" id="L928">                                 pojo.getWorkPath());</span>
<span class="nc" id="L929">    WaarpStringUtils.replace(builder, &quot;XXXRPTXXX&quot;,</span>
<span class="nc bnc" id="L930" title="All 2 branches missed.">                             pojo.getXMLRPreTasks() == null? &quot;&quot; :</span>
<span class="nc" id="L931">                                 pojo.getXMLRPreTasks());</span>
<span class="nc" id="L932">    WaarpStringUtils.replace(builder, &quot;XXXRSTXXX&quot;,</span>
<span class="nc bnc" id="L933" title="All 2 branches missed.">                             pojo.getXMLRPostTasks() == null? &quot;&quot; :</span>
<span class="nc" id="L934">                                 pojo.getXMLRPostTasks());</span>
<span class="nc" id="L935">    WaarpStringUtils.replace(builder, &quot;XXXRETXXX&quot;,</span>
<span class="nc bnc" id="L936" title="All 2 branches missed.">                             pojo.getXMLRErrorTasks() == null? &quot;&quot; :</span>
<span class="nc" id="L937">                                 pojo.getXMLRErrorTasks());</span>
<span class="nc" id="L938">    WaarpStringUtils.replace(builder, &quot;XXXSPTXXX&quot;,</span>
<span class="nc bnc" id="L939" title="All 2 branches missed.">                             pojo.getXMLSPreTasks() == null? &quot;&quot; :</span>
<span class="nc" id="L940">                                 pojo.getXMLSPreTasks());</span>
<span class="nc" id="L941">    WaarpStringUtils.replace(builder, &quot;XXXSSTXXX&quot;,</span>
<span class="nc bnc" id="L942" title="All 2 branches missed.">                             pojo.getXMLSPostTasks() == null? &quot;&quot; :</span>
<span class="nc" id="L943">                                 pojo.getXMLSPostTasks());</span>
<span class="nc" id="L944">    WaarpStringUtils.replace(builder, &quot;XXXSETXXX&quot;,</span>
<span class="nc bnc" id="L945" title="All 2 branches missed.">                             pojo.getXMLSErrorTasks() == null? &quot;&quot; :</span>
<span class="nc" id="L946">                                 pojo.getXMLSErrorTasks());</span>
<span class="nc" id="L947">    return builder.toString();</span>
  }

  /**
   * @return the recvPath
   */
  public String getRecvPath() {
<span class="pc bpc" id="L954" title="2 of 4 branches missed.">    if (getRuleRecvPath() == null || getRuleRecvPath().trim().isEmpty()) {</span>
<span class="nc" id="L955">      return Configuration.configuration.getInPath();</span>
    }
<span class="fc" id="L957">    return getRuleRecvPath();</span>
  }

  /**
   * @return the sendPath
   */
  public String getSendPath() {
<span class="pc bpc" id="L964" title="2 of 4 branches missed.">    if (getRuleSendPath() == null || getRuleSendPath().trim().isEmpty()) {</span>
<span class="nc" id="L965">      return Configuration.configuration.getOutPath();</span>
    }
<span class="fc" id="L967">    return getRuleSendPath();</span>
  }

  /**
   * @return the archivePath
   */
  public String getArchivePath() {
<span class="pc bpc" id="L974" title="2 of 4 branches missed.">    if (getRuleArchivePath() == null || getRuleArchivePath().trim().isEmpty()) {</span>
<span class="nc" id="L975">      return Configuration.configuration.getArchivePath();</span>
    }
<span class="fc" id="L977">    return getRuleArchivePath();</span>
  }

  /**
   * @return the workPath
   */
  public String getWorkPath() {
<span class="pc bpc" id="L984" title="2 of 4 branches missed.">    if (getRuleWorkPath() == null || getRuleWorkPath().trim().isEmpty()) {</span>
<span class="nc" id="L985">      return Configuration.configuration.getWorkingPath();</span>
    }
<span class="fc" id="L987">    return getRuleWorkPath();</span>
  }

  /**
   * @return the Rule recvPath
   */
  public String getRuleRecvPath() {
<span class="fc" id="L994">    return pojo.getRecvPath();</span>
  }

  /**
   * @return the Rule sendPath
   */
  public String getRuleSendPath() {
<span class="fc" id="L1001">    return pojo.getSendPath();</span>
  }

  /**
   * @return the Rule archivePath
   */
  public String getRuleArchivePath() {
<span class="fc" id="L1008">    return pojo.getArchivePath();</span>
  }

  /**
   * @return the Rule workPath
   */
  public String getRuleWorkPath() {
<span class="fc" id="L1015">    return pojo.getWorkPath();</span>
  }

  /**
   * @return the idRule
   */
  public String getIdRule() {
<span class="fc" id="L1022">    return pojo.getName();</span>
  }

  /**
   * @return the mode
   */
  public int getMode() {
<span class="fc" id="L1029">    return pojo.getMode();</span>
  }

  /**
   * @return the idsArray
   */
  public String[] getIdsArray() {
<span class="fc" id="L1036">    return pojo.getHostids().toArray(STRING_0_LENGTH);</span>
  }

  /**
   * @return the rpreTasksArray
   */
  public String[][] getRpreTasksArray() {
<span class="fc" id="L1043">    return toLegacyTasks(pojo.getRPreTasks());</span>
  }

  /**
   * @return the rpostTasksArray
   */
  public String[][] getRpostTasksArray() {
<span class="fc" id="L1050">    return toLegacyTasks(pojo.getRPostTasks());</span>
  }

  /**
   * @return the rerrorTasksArray
   */
  public String[][] getRerrorTasksArray() {
<span class="nc" id="L1057">    return toLegacyTasks(pojo.getRErrorTasks());</span>
  }

  /**
   * @return the spreTasksArray
   */
  public String[][] getSpreTasksArray() {
<span class="fc" id="L1064">    return toLegacyTasks(pojo.getSPreTasks());</span>
  }

  /**
   * @return the spostTasksArray
   */
  public String[][] getSpostTasksArray() {
<span class="fc" id="L1071">    return toLegacyTasks(pojo.getSPostTasks());</span>
  }

  /**
   * @return the serrorTasksArray
   */
  public String[][] getSerrorTasksArray() {
<span class="nc" id="L1078">    return toLegacyTasks(pojo.getSErrorTasks());</span>
  }

  private List&lt;RuleTask&gt; fromLegacyTasks(String[][] tasks) {
<span class="fc" id="L1082">    final int size = tasks.length;</span>
<span class="fc" id="L1083">    final List&lt;RuleTask&gt; res = new ArrayList&lt;RuleTask&gt;(size);</span>
<span class="fc bfc" id="L1084" title="All 2 branches covered.">    for (final String[] task : tasks) {</span>
<span class="fc" id="L1085">      res.add(new RuleTask(task[0], task[1], Integer.parseInt(task[2])));</span>
    }
<span class="fc" id="L1087">    return res;</span>
  }

  private String[][] toLegacyTasks(List&lt;RuleTask&gt; tasks) {
<span class="fc" id="L1091">    final int size = tasks.size();</span>
<span class="fc" id="L1092">    final String[][] res = new String[size][];</span>
<span class="fc" id="L1093">    int i = 0;</span>
<span class="fc bfc" id="L1094" title="All 2 branches covered.">    for (final RuleTask task : tasks) {</span>
<span class="fc" id="L1095">      res[i] = new String[3];</span>
<span class="fc" id="L1096">      res[i][0] = task.getType();</span>
<span class="fc" id="L1097">      res[i][1] = task.getPath();</span>
<span class="fc" id="L1098">      res[i][2] = String.valueOf(task.getDelay());</span>
<span class="fc" id="L1099">      i++;</span>
<span class="fc" id="L1100">    }</span>
<span class="fc" id="L1101">    return res;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>