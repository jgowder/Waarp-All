<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DbConfiguration.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Waarp OpenR66</a> &gt; <a href="index.source.html" class="el_package">org.waarp.openr66.database.data</a> &gt; <span class="el_source">DbConfiguration.java</span></div><h1>DbConfiguration.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.openr66.database.data;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.node.ObjectNode;
import org.waarp.common.database.DbPreparedStatement;
import org.waarp.common.database.DbSession;
import org.waarp.common.database.exception.WaarpDatabaseException;
import org.waarp.common.database.exception.WaarpDatabaseNoConnectionException;
import org.waarp.common.database.exception.WaarpDatabaseSqlException;
import org.waarp.openr66.dao.AbstractDAO;
import org.waarp.openr66.dao.DAOFactory;
import org.waarp.openr66.dao.Filter;
import org.waarp.openr66.dao.LimitDAO;
import org.waarp.openr66.dao.database.DBLimitDAO;
import org.waarp.openr66.dao.database.StatementExecutor;
import org.waarp.openr66.dao.exception.DAOConnectionException;
import org.waarp.openr66.dao.exception.DAONoDataException;
import org.waarp.openr66.pojo.Limit;
import org.waarp.openr66.protocol.configuration.Configuration;

import java.sql.SQLException;
import java.sql.Types;
import java.util.ArrayList;
import java.util.List;

/**
 * Configuration Table object
 */
public class DbConfiguration extends AbstractDbDataDao&lt;Limit&gt; {

<span class="fc" id="L50">  public enum Columns {</span>
<span class="fc" id="L51">    READGLOBALLIMIT, WRITEGLOBALLIMIT, READSESSIONLIMIT, WRITESESSIONLIMIT,</span>
<span class="fc" id="L52">    DELAYLIMIT, UPDATEDINFO, HOSTID</span>
  }

<span class="fc" id="L55">  public static final int[] dbTypes = {</span>
      Types.BIGINT, Types.BIGINT, Types.BIGINT, Types.BIGINT, Types.BIGINT,
      Types.INTEGER, Types.NVARCHAR
  };

  public static final String table = &quot; CONFIGURATION &quot;;

  // ALL TABLE SHOULD IMPLEMENT THIS
  public static final int NBPRKEY = 1;

<span class="fc" id="L65">  protected static final String selectAllFields =</span>
<span class="fc" id="L66">      Columns.READGLOBALLIMIT.name() + ',' + Columns.WRITEGLOBALLIMIT.name() +</span>
<span class="fc" id="L67">      ',' + Columns.READSESSIONLIMIT.name() + ',' +</span>
<span class="fc" id="L68">      Columns.WRITESESSIONLIMIT.name() + ',' + Columns.DELAYLIMIT.name() + ',' +</span>
<span class="fc" id="L69">      Columns.UPDATEDINFO.name() + ',' + Columns.HOSTID.name();</span>

<span class="fc" id="L71">  protected static final String updateAllFields =</span>
<span class="fc" id="L72">      Columns.READGLOBALLIMIT.name() + &quot;=?,&quot; + Columns.WRITEGLOBALLIMIT.name() +</span>
<span class="fc" id="L73">      &quot;=?,&quot; + Columns.READSESSIONLIMIT.name() + &quot;=?,&quot; +</span>
<span class="fc" id="L74">      Columns.WRITESESSIONLIMIT.name() + &quot;=?,&quot; + Columns.DELAYLIMIT.name() +</span>
<span class="fc" id="L75">      &quot;=?,&quot; + Columns.UPDATEDINFO.name() + &quot;=?&quot;;</span>

  protected static final String insertAllValues = &quot; (?,?,?,?,?,?,?) &quot;;

  @Override
  protected String getTable() {
<span class="nc" id="L81">    return table;</span>
  }

  @Override
  protected AbstractDAO&lt;Limit&gt; getDao() throws DAOConnectionException {
<span class="nc" id="L86">    return DAOFactory.getInstance().getLimitDAO();</span>
  }

  @Override
  protected String getPrimaryKey() {
<span class="nc bnc" id="L91" title="All 2 branches missed.">    if (pojo != null) {</span>
<span class="nc" id="L92">      return pojo.getHostid();</span>
    }
<span class="nc" id="L94">    throw new IllegalArgumentException(&quot;pojo is null&quot;);</span>
  }

  @Override
  protected String getPrimaryField() {
<span class="nc" id="L99">    return Columns.HOSTID.name();</span>
  }


  /**
   * @param hostid
   * @param rg Read Global Limit
   * @param wg Write Global Limit
   * @param rs Read Session Limit
   * @param ws Write Session Limit
   * @param del Delay Limit
   */
  public DbConfiguration(String hostid, long rg, long wg, long rs, long ws,
<span class="nc" id="L112">                         long del) {</span>
<span class="nc" id="L113">    pojo = new Limit(hostid, rg, wg, rs, ws, del);</span>
<span class="nc" id="L114">  }</span>

<span class="nc" id="L116">  public DbConfiguration(Limit limit) {</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">    if (limit == null) {</span>
<span class="nc" id="L118">      throw new IllegalArgumentException(</span>
          &quot;Argument in constructor cannot be null&quot;);
    }
<span class="nc" id="L121">    this.pojo = limit;</span>
<span class="nc" id="L122">  }</span>

  /**
   * Constructor from Json
   *
   * @param source
   *
   * @throws WaarpDatabaseSqlException
   */
<span class="nc" id="L131">  public DbConfiguration(ObjectNode source) throws WaarpDatabaseSqlException {</span>
<span class="nc" id="L132">    pojo = new Limit();</span>
<span class="nc" id="L133">    setFromJson(source, false);</span>
<span class="nc bnc" id="L134" title="All 4 branches missed.">    if (pojo.getHostid() == null || pojo.getHostid().isEmpty()) {</span>
<span class="nc" id="L135">      throw new WaarpDatabaseSqlException(</span>
          &quot;Not enough argument to create the object&quot;);
    }
<span class="nc" id="L138">  }</span>

  /**
   * Read json object into Array then setFromArray
   *
   * @param node
   * @param ignorePrimaryKey
   *
   * @throws WaarpDatabaseSqlException
   */
  @Override
  public void setFromJson(ObjectNode node, boolean ignorePrimaryKey)
      throws WaarpDatabaseSqlException {
<span class="nc" id="L151">    super.setFromJson(node, ignorePrimaryKey);</span>
<span class="nc bnc" id="L152" title="All 4 branches missed.">    if (pojo.getHostid() == null || pojo.getHostid().isEmpty()) {</span>
<span class="nc" id="L153">      throw new WaarpDatabaseSqlException(</span>
          &quot;Not enough argument to create the object&quot;);
    }
<span class="nc" id="L156">  }</span>

  /**
   * @param hostid
   *
   * @throws WaarpDatabaseException
   */
<span class="fc" id="L163">  public DbConfiguration(String hostid) throws WaarpDatabaseException {</span>
<span class="fc" id="L164">    LimitDAO limitAccess = null;</span>
    try {
<span class="fc" id="L166">      limitAccess = DAOFactory.getInstance().getLimitDAO();</span>
<span class="nc" id="L167">      pojo = limitAccess.select(hostid);</span>
<span class="nc" id="L168">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L169">      throw new WaarpDatabaseException(e);</span>
<span class="fc" id="L170">    } catch (final DAONoDataException e) {</span>
<span class="fc" id="L171">      pojo = new Limit(hostid, 0L);</span>
    } finally {
<span class="fc" id="L173">      DAOFactory.closeDAO(limitAccess);</span>
    }
<span class="fc" id="L175">  }</span>

  /**
   * Private constructor for Commander only
   */
<span class="nc" id="L180">  private DbConfiguration() {</span>
<span class="nc" id="L181">    pojo = new Limit();</span>
<span class="nc" id="L182">  }</span>

  @Override
  protected void setFromJson(final String field, final JsonNode value) {
<span class="nc bnc" id="L186" title="All 2 branches missed.">    if (value == null) {</span>
<span class="nc" id="L187">      return;</span>
    }
<span class="nc bnc" id="L189" title="All 2 branches missed.">    for (Columns column : Columns.values()) {</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">      if (column.name().equalsIgnoreCase(field)) {</span>
<span class="nc bnc" id="L191" title="All 8 branches missed.">        switch (column) {</span>
          case READGLOBALLIMIT:
<span class="nc" id="L193">            pojo.setReadGlobalLimit(value.asLong());</span>
<span class="nc" id="L194">            break;</span>
          case WRITEGLOBALLIMIT:
<span class="nc" id="L196">            pojo.setWriteGlobalLimit(value.asLong());</span>
<span class="nc" id="L197">            break;</span>
          case READSESSIONLIMIT:
<span class="nc" id="L199">            pojo.setReadSessionLimit(value.asLong());</span>
<span class="nc" id="L200">            break;</span>
          case WRITESESSIONLIMIT:
<span class="nc" id="L202">            pojo.setWriteSessionLimit(value.asLong());</span>
<span class="nc" id="L203">            break;</span>
          case DELAYLIMIT:
<span class="nc" id="L205">            pojo.setDelayLimit(value.asLong());</span>
<span class="nc" id="L206">            break;</span>
          case UPDATEDINFO:
<span class="nc" id="L208">            pojo.setUpdatedInfo(</span>
<span class="nc" id="L209">                org.waarp.openr66.pojo.UpdatedInfo.valueOf(value.asInt()));</span>
<span class="nc" id="L210">            break;</span>
          case HOSTID:
<span class="nc" id="L212">            pojo.setHostid(value.asText());</span>
            break;
        }
      }
    }
<span class="nc" id="L217">  }</span>

  /**
   * @return the array of DbConfiguration from Updated status
   *
   * @throws WaarpDatabaseNoConnectionException
   * @throws WaarpDatabaseSqlException
   */
  public static DbConfiguration[] getUpdatedPrepareStament()
      throws WaarpDatabaseNoConnectionException, WaarpDatabaseSqlException {
<span class="fc" id="L227">    final List&lt;Filter&gt; filters = new ArrayList&lt;Filter&gt;();</span>
<span class="fc" id="L228">    filters.add(new Filter(DBLimitDAO.HOSTID_FIELD, &quot;=&quot;,</span>
<span class="fc" id="L229">                           Configuration.configuration.getHostId()));</span>
<span class="fc" id="L230">    filters.add(new Filter(DBLimitDAO.UPDATED_INFO_FIELD, &quot;=&quot;,</span>
<span class="fc" id="L231">                           UpdatedInfo.TOSUBMIT.ordinal()));</span>

<span class="fc" id="L233">    LimitDAO limitAccess = null;</span>
    List&lt;Limit&gt; limits;
    try {
<span class="fc" id="L236">      limitAccess = DAOFactory.getInstance().getLimitDAO();</span>
<span class="fc" id="L237">      limits = limitAccess.find(filters);</span>
<span class="nc" id="L238">    } catch (final DAOConnectionException e) {</span>
<span class="nc" id="L239">      throw new WaarpDatabaseNoConnectionException(e);</span>
    } finally {
<span class="fc" id="L241">      DAOFactory.closeDAO(limitAccess);</span>
    }
<span class="fc" id="L243">    final DbConfiguration[] res = new DbConfiguration[limits.size()];</span>
<span class="fc" id="L244">    int i = 0;</span>
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">    for (final Limit limit : limits) {</span>
<span class="nc" id="L246">      res[i] = new DbConfiguration(limit);</span>
<span class="nc" id="L247">      i++;</span>
<span class="nc" id="L248">    }</span>
<span class="fc" id="L249">    return res;</span>
  }

  /**
   * @param session
   * @param hostid
   * @param limitBandwith 0 for no limit, &gt; 0 for one limit, &lt; 0 for
   *     no
   *     filter
   *
   * @return the preparedStatement with the filter
   *
   * @throws WaarpDatabaseNoConnectionException
   * @throws WaarpDatabaseSqlException
   */
  public static DbPreparedStatement getFilterPrepareStament(DbSession session,
                                                            String hostid,
                                                            long limitBandwith)
      throws WaarpDatabaseNoConnectionException, WaarpDatabaseSqlException {
<span class="nc" id="L268">    final DbPreparedStatement preparedStatement =</span>
        new DbPreparedStatement(session);
<span class="nc" id="L270">    final String request = &quot;SELECT &quot; + selectAllFields + &quot; FROM &quot; + table;</span>
<span class="nc" id="L271">    String condition = null;</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">    if (hostid != null) {</span>
<span class="nc" id="L273">      condition =</span>
<span class="nc" id="L274">          &quot; WHERE &quot; + Columns.HOSTID.name() + &quot; LIKE '%&quot; + hostid + &quot;%' &quot;;</span>
    }
<span class="nc bnc" id="L276" title="All 2 branches missed.">    if (limitBandwith &gt;= 0) {</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">      if (condition == null) {</span>
<span class="nc" id="L278">        condition = &quot; WHERE &quot;;</span>
      } else {
<span class="nc" id="L280">        condition += &quot; AND &quot;;</span>
      }
<span class="nc bnc" id="L282" title="All 2 branches missed.">      if (limitBandwith == 0) {</span>
<span class="nc" id="L283">        condition += &quot;(&quot; + Columns.READGLOBALLIMIT + &quot; == 0 AND &quot; +</span>
                     Columns.READSESSIONLIMIT + &quot; == 0 AND &quot; +
                     Columns.WRITEGLOBALLIMIT + &quot; == 0 AND &quot; +
                     Columns.WRITESESSIONLIMIT + &quot; == 0)&quot;;
      } else {
<span class="nc" id="L288">        condition +=</span>
            &quot;(&quot; + Columns.READGLOBALLIMIT + &quot; &gt; &quot; + limitBandwith + &quot; OR &quot; +
            Columns.READSESSIONLIMIT + &quot; &gt; &quot; + limitBandwith + &quot; OR &quot; +
            Columns.WRITEGLOBALLIMIT + &quot; &gt; &quot; + limitBandwith + &quot; OR &quot; +
            Columns.WRITESESSIONLIMIT + &quot; &gt; &quot; + limitBandwith + ')';
      }
    }
<span class="nc bnc" id="L295" title="All 2 branches missed.">    if (condition != null) {</span>
<span class="nc" id="L296">      preparedStatement.createPrepareStatement(</span>
<span class="nc" id="L297">          request + condition + &quot; ORDER BY &quot; + Columns.HOSTID.name());</span>
    } else {
<span class="nc" id="L299">      preparedStatement.createPrepareStatement(</span>
<span class="nc" id="L300">          request + &quot; ORDER BY &quot; + Columns.HOSTID.name());</span>
    }
<span class="nc" id="L302">    return preparedStatement;</span>
  }

  public static DbConfiguration getFromStatement(
      final DbPreparedStatement statement)
      throws WaarpDatabaseNoConnectionException, WaarpDatabaseSqlException {
<span class="nc" id="L308">    final DbConfiguration dbConfiguration = new DbConfiguration();</span>
<span class="nc" id="L309">    AbstractDAO&lt;Limit&gt; limitDAO = null;</span>
    try {
<span class="nc" id="L311">      limitDAO = dbConfiguration.getDao();</span>
<span class="nc" id="L312">      dbConfiguration.pojo = ((StatementExecutor&lt;Limit&gt;) limitDAO)</span>
<span class="nc" id="L313">          .getFromResultSet(statement.getResultSet());</span>
<span class="nc" id="L314">      return dbConfiguration;</span>
<span class="nc" id="L315">    } catch (SQLException e) {</span>
<span class="nc" id="L316">      DbSession.error(e);</span>
<span class="nc" id="L317">      throw new WaarpDatabaseSqlException(&quot;Getting values in error&quot;, e);</span>
<span class="nc" id="L318">    } catch (DAOConnectionException e) {</span>
<span class="nc" id="L319">      throw new WaarpDatabaseSqlException(&quot;Getting values in error&quot;, e);</span>
    } finally {
<span class="nc" id="L321">      DAOFactory.closeDAO(limitDAO);</span>
    }
  }

  @Override
  public void changeUpdatedInfo(UpdatedInfo info) {
<span class="nc" id="L327">    pojo.setUpdatedInfo(org.waarp.openr66.pojo.UpdatedInfo.fromLegacy(info));</span>
<span class="nc" id="L328">  }</span>

  /**
   * Update configuration according to new value of limits
   */
  public void updateConfiguration() {
<span class="fc" id="L334">    Configuration.configuration.changeNetworkLimit(pojo.getWriteGlobalLimit(),</span>
<span class="fc" id="L335">                                                   pojo.getReadGlobalLimit(),</span>
<span class="fc" id="L336">                                                   pojo.getWriteSessionLimit(),</span>
<span class="fc" id="L337">                                                   pojo.getReadSessionLimit(),</span>
<span class="fc" id="L338">                                                   pojo.getDelayLimit());</span>
<span class="fc" id="L339">  }</span>

  /**
   * @return True if this Configuration refers to the current host
   */
  public boolean isOwnConfiguration() {
<span class="nc" id="L345">    return pojo.getHostid().equals(Configuration.configuration.getHostId());</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>