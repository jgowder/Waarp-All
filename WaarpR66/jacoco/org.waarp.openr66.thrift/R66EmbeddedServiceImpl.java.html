<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>R66EmbeddedServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Waarp OpenR66</a> &gt; <a href="index.source.html" class="el_package">org.waarp.openr66.thrift</a> &gt; <span class="el_source">R66EmbeddedServiceImpl.java</span></div><h1>R66EmbeddedServiceImpl.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.openr66.thrift;

import org.apache.thrift.TException;
import org.waarp.common.command.exception.CommandAbstractException;
import org.waarp.common.database.data.AbstractDbData;
import org.waarp.common.database.exception.WaarpDatabaseException;
import org.waarp.common.logging.SysErrLogger;
import org.waarp.common.logging.WaarpLogger;
import org.waarp.common.logging.WaarpLoggerFactory;
import org.waarp.openr66.commander.ClientRunner;
import org.waarp.openr66.context.R66Session;
import org.waarp.openr66.context.filesystem.R66File;
import org.waarp.openr66.database.data.DbRule;
import org.waarp.openr66.database.data.DbTaskRunner;
import org.waarp.openr66.protocol.configuration.Configuration;
import org.waarp.openr66.protocol.configuration.PartnerConfiguration;
import org.waarp.openr66.protocol.localhandler.LocalChannelReference;
import org.waarp.openr66.protocol.localhandler.LocalServerHandler;
import org.waarp.openr66.protocol.localhandler.packet.ErrorPacket;
import org.waarp.openr66.protocol.localhandler.packet.RequestPacket;
import org.waarp.openr66.protocol.utils.TransferUtils;
import org.waarp.thrift.r66.Action;
import org.waarp.thrift.r66.ErrorCode;
import org.waarp.thrift.r66.R66Request;
import org.waarp.thrift.r66.R66Result;
import org.waarp.thrift.r66.R66Service;
import org.waarp.thrift.r66.RequestMode;

import java.sql.Timestamp;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import static org.waarp.common.database.DbConstant.*;

/**
 * Embedded service attached with the Thrift service
 */
<span class="nc" id="L60">public class R66EmbeddedServiceImpl implements R66Service.Iface {</span>
  /**
   * Internal Logger
   */
<span class="nc" id="L64">  private static final WaarpLogger logger =</span>
<span class="nc" id="L65">      WaarpLoggerFactory.getLogger(R66EmbeddedServiceImpl.class);</span>

  private DbTaskRunner initRequest(R66Request request) {
<span class="nc" id="L68">    Timestamp ttimestart = null;</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">    if (request.isSetStart()) {</span>
      Date date;
      try {
<span class="nc" id="L72">        final SimpleDateFormat dateFormat =</span>
            new SimpleDateFormat(&quot;yyyyMMddHHmmss&quot;);
<span class="nc" id="L74">        date = dateFormat.parse(request.getStart());</span>
<span class="nc" id="L75">        ttimestart = new Timestamp(date.getTime());</span>
<span class="nc" id="L76">      } catch (final ParseException ignored) {</span>
        // nothing
<span class="nc" id="L78">      }</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">    } else if (request.isSetDelay()) {</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">      if (request.getDelay().charAt(0) == '+') {</span>
<span class="nc" id="L81">        ttimestart = new Timestamp(System.currentTimeMillis() + Long.parseLong(</span>
<span class="nc" id="L82">            request.getDelay().substring(1)));</span>
      } else {
<span class="nc" id="L84">        ttimestart = new Timestamp(Long.parseLong(request.getDelay()));</span>
      }
    }
    DbRule rule;
    try {
<span class="nc" id="L89">      rule = new DbRule(request.getRule());</span>
<span class="nc" id="L90">    } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L91">      logger.warn(&quot;Cannot get Rule: &quot; + request.getRule(), e);</span>
<span class="nc" id="L92">      return null;</span>
<span class="nc" id="L93">    }</span>
<span class="nc" id="L94">    int mode = rule.getMode();</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">    if (request.isMd5()) {</span>
<span class="nc" id="L96">      mode = RequestPacket.getModeMD5(mode);</span>
    }
    DbTaskRunner taskRunner;
<span class="nc" id="L99">    long tid = ILLEGALVALUE;</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">    if (request.isSetTid()) {</span>
<span class="nc" id="L101">      tid = request.getTid();</span>
    }
<span class="nc bnc" id="L103" title="All 2 branches missed.">    if (tid != ILLEGALVALUE) {</span>
      try {
<span class="nc" id="L105">        taskRunner = new DbTaskRunner(tid, request.getDestuid());</span>
        // requested
<span class="nc" id="L107">        taskRunner.setSenderByRequestToValidate(true);</span>
<span class="nc" id="L108">      } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L109">        logger.warn(&quot;Cannot get task&quot;, e);</span>
<span class="nc" id="L110">        return null;</span>
<span class="nc" id="L111">      }</span>
    } else {
<span class="nc" id="L113">      final String sep =</span>
<span class="nc" id="L114">          PartnerConfiguration.getSeparator(request.getDestuid());</span>
<span class="nc" id="L115">      final RequestPacket requestPacket =</span>
<span class="nc" id="L116">          new RequestPacket(request.getRule(), mode, request.getFile(),</span>
<span class="nc" id="L117">                            request.getBlocksize(), 0, tid, request.getInfo(),</span>
                            -1, sep);
      // Not isRecv since it is the requester, so send =&gt; isRetrieve is true
<span class="nc" id="L120">      final boolean isRetrieve =</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">          !RequestPacket.isRecvMode(requestPacket.getMode());</span>
      try {
<span class="nc" id="L123">        taskRunner = new DbTaskRunner(rule, isRetrieve, requestPacket,</span>
<span class="nc" id="L124">                                      request.getDestuid(), ttimestart);</span>
<span class="nc" id="L125">      } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L126">        logger.warn(&quot;Cannot get task&quot;, e);</span>
<span class="nc" id="L127">        return null;</span>
<span class="nc" id="L128">      }</span>
    }
<span class="nc" id="L130">    return taskRunner;</span>
  }

  @Override
  public R66Result transferRequestQuery(R66Request request) throws TException {
<span class="nc" id="L135">    final DbTaskRunner runner = initRequest(request);</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">    if (runner != null) {</span>
<span class="nc" id="L137">      runner.changeUpdatedInfo(AbstractDbData.UpdatedInfo.TOSUBMIT);</span>
<span class="nc" id="L138">      final boolean isSender = runner.isSender();</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">      if (!runner.forceSaveStatus()) {</span>
<span class="nc" id="L140">        logger.warn(&quot;Cannot prepare task&quot;);</span>
<span class="nc" id="L141">        return new R66Result(request.getMode(), ErrorCode.CommandNotFound,</span>
                             &quot;ERROR: Cannot prepare transfer&quot;);
      }
<span class="nc" id="L144">      final R66Result result =</span>
<span class="nc" id="L145">          new R66Result(request.getMode(), ErrorCode.InitOk,</span>
                        &quot;Transfer Scheduled&quot;);
<span class="nc bnc" id="L147" title="All 2 branches missed.">      if (request.getMode() == RequestMode.SYNCTRANSFER) {</span>
        // now need to wait but first, reload the runner
        try {
<span class="nc" id="L150">          runner.select();</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">          while (!runner.isFinished()) {</span>
            try {
<span class="nc" id="L153">              Thread.sleep(1000);</span>
<span class="nc" id="L154">              runner.select();</span>
<span class="nc" id="L155">            } catch (final InterruptedException e) {//NOSONAR</span>
<span class="nc" id="L156">              SysErrLogger.FAKE_LOGGER.ignoreLog(e);</span>
<span class="nc" id="L157">              break;</span>
<span class="nc" id="L158">            }</span>
          }
<span class="nc" id="L160">          runner.setSender(isSender);</span>
<span class="nc" id="L161">        } catch (final WaarpDatabaseException ignored) {</span>
          // nothing
<span class="nc" id="L163">        }</span>
<span class="nc" id="L164">        setResultFromRunner(runner, result);</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (runner.isAllDone()) {</span>
<span class="nc" id="L166">          result.setCode(ErrorCode.CompleteOk);</span>
<span class="nc" id="L167">          result.setResultinfo(&quot;Transfer Done&quot;);</span>
        } else {
<span class="nc" id="L169">          result.setCode(ErrorCode.valueOf(runner.getErrorInfo().name()));</span>
<span class="nc" id="L170">          result.setResultinfo(runner.getErrorInfo().getMesg());</span>
        }
      } else {
        try {
<span class="nc" id="L174">          runner.select();</span>
<span class="nc" id="L175">        } catch (final WaarpDatabaseException ignored) {</span>
          // nothing
<span class="nc" id="L177">        }</span>
<span class="nc" id="L178">        runner.setSender(isSender);</span>
<span class="nc" id="L179">        setResultFromRunner(runner, result);</span>
      }
<span class="nc" id="L181">      return result;</span>
    } else {
<span class="nc" id="L183">      logger.warn(&quot;ERROR: Transfer NOT scheduled&quot;);</span>
<span class="nc" id="L184">      return new R66Result(request.getMode(), ErrorCode.Internal,</span>
                           &quot;ERROR: Transfer NOT scheduled&quot;);
    }
  }

  private void setResultFromRunner(DbTaskRunner runner, R66Result result) {
<span class="nc" id="L190">    result.setDestuid(runner.getRequested());</span>
<span class="nc" id="L191">    result.setFromuid(runner.getRequester());</span>
<span class="nc" id="L192">    result.setTid(runner.getSpecialId());</span>
<span class="nc" id="L193">    result.setRule(runner.getRuleId());</span>
<span class="nc" id="L194">    result.setBlocksize(runner.getBlocksize());</span>
<span class="nc" id="L195">    result.setFile(runner.getFilename());</span>
<span class="nc" id="L196">    result.setOriginalfilename(runner.getOriginalFilename());</span>
<span class="nc" id="L197">    result.setIsmoved(runner.isFileMoved());</span>
<span class="nc" id="L198">    result.setModetransfer(runner.getMode());</span>
<span class="nc" id="L199">    result.setRetrievemode(runner.isSender());</span>
<span class="nc" id="L200">    result.setStep(runner.getStep());</span>
<span class="nc" id="L201">    result.setGloballaststep(runner.getGloballaststep());</span>
<span class="nc" id="L202">    result.setRank(runner.getRank());</span>
<span class="nc" id="L203">    result.setStart(runner.getStart().toString());</span>
<span class="nc" id="L204">    result.setStop(runner.getStop().toString());</span>
<span class="nc" id="L205">    result.setResultinfo(runner.getFileInformation());</span>
<span class="nc" id="L206">  }</span>

  private void setResultFromLCR(LocalChannelReference lcr, R66Result result) {
<span class="nc" id="L209">    final R66Session session = lcr.getSession();</span>
<span class="nc" id="L210">    DbTaskRunner runner = null;</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">    if (session != null) {</span>
<span class="nc" id="L212">      runner = session.getRunner();</span>
    } else {
<span class="nc" id="L214">      final ClientRunner run = lcr.getClientRunner();</span>
<span class="nc bnc" id="L215" title="All 2 branches missed.">      if (run != null) {</span>
<span class="nc" id="L216">        runner = run.getTaskRunner();</span>
      }
    }
<span class="nc bnc" id="L219" title="All 2 branches missed.">    if (runner != null) {</span>
<span class="nc" id="L220">      setResultFromRunner(runner, result);</span>
    }
<span class="nc" id="L222">  }</span>

  private int stopOrCancelRunner(long id, String reqd, String reqr,
                                 org.waarp.openr66.context.ErrorCode code) {
    try {
<span class="nc" id="L227">      final DbTaskRunner taskRunner =</span>
          new DbTaskRunner(null, null, id, reqr, reqd);
<span class="nc bnc" id="L229" title="All 2 branches missed.">      return taskRunner.stopOrCancelRunner(code)? 1 : 0;</span>
<span class="nc" id="L230">    } catch (final WaarpDatabaseException ignored) {</span>
      // nothing
    }
<span class="nc" id="L233">    logger</span>
<span class="nc" id="L234">        .warn(&quot;Cannot accomplished action on task: &quot; + id + ' ' + code.name());</span>
<span class="nc" id="L235">    return -1;</span>
  }

  private R66Result stopOrCancel(R66Request request, LocalChannelReference lcr,
                                 org.waarp.openr66.context.ErrorCode r66code) {
    // stop the current transfer
    R66Result resulttest;
<span class="nc bnc" id="L242" title="All 2 branches missed.">    if (lcr != null) {</span>
<span class="nc" id="L243">      int rank = 0;</span>
<span class="nc bnc" id="L244" title="All 2 branches missed.">      if (r66code == org.waarp.openr66.context.ErrorCode.StoppedTransfer &amp;&amp;</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">          lcr.getSession() != null) {</span>
<span class="nc" id="L246">        final DbTaskRunner taskRunner = lcr.getSession().getRunner();</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">        if (taskRunner != null) {</span>
<span class="nc" id="L248">          rank = taskRunner.getRank();</span>
        }
      }
<span class="nc" id="L251">      final ErrorPacket error =</span>
<span class="nc" id="L252">          new ErrorPacket(r66code.name() + ' ' + rank, r66code.getCode(),</span>
                          ErrorPacket.FORWARDCLOSECODE);
      try {
        // inform local instead of remote
<span class="nc" id="L256">        LocalServerHandler.channelRead0(lcr, error);</span>
<span class="nc" id="L257">      } catch (final Exception ignored) {</span>
        // nothing
<span class="nc" id="L259">      }</span>
<span class="nc" id="L260">      resulttest = new R66Result(request.getMode(), ErrorCode.CompleteOk,</span>
<span class="nc" id="L261">                                 r66code.name());</span>
<span class="nc" id="L262">      setResultFromLCR(lcr, resulttest);</span>
<span class="nc" id="L263">    } else {</span>
      // Transfer is not running
      // but maybe need action on database
<span class="nc" id="L266">      final int test =</span>
<span class="nc" id="L267">          stopOrCancelRunner(request.getTid(), request.getDestuid(),</span>
<span class="nc" id="L268">                             request.getFromuid(), r66code);</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">      if (test &gt; 0) {</span>
<span class="nc" id="L270">        resulttest = new R66Result(request.getMode(), ErrorCode.CompleteOk,</span>
<span class="nc" id="L271">                                   r66code.name());</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">      } else if (test == 0) {</span>
<span class="nc" id="L273">        resulttest = new R66Result(request.getMode(), ErrorCode.TransferOk,</span>
<span class="nc" id="L274">                                   r66code.name());</span>
      } else {
<span class="nc" id="L276">        resulttest = new R66Result(request.getMode(), ErrorCode.CommandNotFound,</span>
                                   &quot;Error: cannot accomplished task on transfer&quot;);
      }
    }
<span class="nc" id="L280">    return resulttest;</span>
  }

  private R66Result restart(R66Request request, LocalChannelReference lcr) {
    // Try to validate a restarting transfer
    // validLimit on requested side
<span class="nc" id="L286">    if (Configuration.configuration.getConstraintLimitHandler()</span>
<span class="nc bnc" id="L287" title="All 2 branches missed.">                                   .checkConstraints()) {</span>
<span class="nc" id="L288">      logger</span>
<span class="nc" id="L289">          .warn(&quot;Limit exceeded {} while asking to relaunch a task &quot; + request,</span>
                Configuration.configuration
<span class="nc" id="L291">                    .getConstraintLimitHandler().lastAlert);</span>
<span class="nc" id="L292">      return new R66Result(request.getMode(), ErrorCode.ServerOverloaded,</span>
                           &quot;Limit exceeded while asking to relaunch a task&quot;);
    }
    // Try to validate a restarting transfer
    // header = ?; middle = requested+blank+requester+blank+specialId
    DbTaskRunner taskRunner;
    try {
<span class="nc" id="L299">      taskRunner =</span>
<span class="nc" id="L300">          new DbTaskRunner(null, null, request.getTid(), request.getFromuid(),</span>
<span class="nc" id="L301">                           request.getDestuid());</span>
<span class="nc" id="L302">      final org.waarp.openr66.context.R66Result resulttest =</span>
<span class="nc" id="L303">          TransferUtils.restartTransfer(taskRunner, lcr);</span>
<span class="nc" id="L304">      return new R66Result(request.getMode(),</span>
<span class="nc" id="L305">                           ErrorCode.valueOf(resulttest.getCode().name()),</span>
<span class="nc" id="L306">                           resulttest.getMessage());</span>
<span class="nc" id="L307">    } catch (final WaarpDatabaseException e1) {</span>
<span class="nc" id="L308">      logger.warn(&quot;Exception while trying to restart transfer&quot;, e1);</span>
<span class="nc" id="L309">      return new R66Result(request.getMode(), ErrorCode.Internal,</span>
                           &quot;Exception while trying to restart transfer&quot;);
    }
  }

  @Override
  public R66Result infoTransferQuery(R66Request request) throws TException {
<span class="nc" id="L316">    final RequestMode mode = request.getMode();</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">    if (mode != RequestMode.INFOREQUEST) {</span>
      // error
<span class="nc" id="L319">      logger.warn(&quot;Mode is uncompatible with infoTransferQuery&quot;);</span>
<span class="nc" id="L320">      return new R66Result(request.getMode(), ErrorCode.Unimplemented,</span>
                           &quot;Mode is uncompatible with infoTransferQuery&quot;);
    }
    // now check if enough arguments are provided
<span class="nc bnc" id="L324" title="All 2 branches missed.">    if (!request.isSetTid() ||</span>
<span class="nc bnc" id="L325" title="All 4 branches missed.">        !request.isSetDestuid() &amp;&amp; !request.isSetFromuid() ||</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">        !request.isSetAction()) {</span>
      // error
<span class="nc" id="L328">      logger.warn(&quot;Not enough arguments&quot;);</span>
<span class="nc" id="L329">      return new R66Result(request.getMode(), ErrorCode.RemoteError,</span>
                           &quot;Not enough arguments&quot;);
    }
    // requested+blank+requester+blank+specialId
<span class="nc" id="L333">    final LocalChannelReference lcr =</span>
<span class="nc" id="L334">        Configuration.configuration.getLocalTransaction().getFromRequest(</span>
<span class="nc" id="L335">            request.getDestuid() + ' ' + request.getFromuid() + ' ' +</span>
<span class="nc" id="L336">            request.getTid());</span>
    org.waarp.openr66.context.ErrorCode r66code;
<span class="nc bnc" id="L338" title="All 5 branches missed.">    switch (request.getAction()) {</span>
      case Detail: {
<span class="nc" id="L340">        final R66Result result =</span>
<span class="nc" id="L341">            new R66Result(request.getMode(), ErrorCode.CompleteOk,</span>
                          &quot;Existence test OK&quot;);
<span class="nc" id="L343">        result.setAction(Action.Exist);</span>
<span class="nc" id="L344">        result.setDestuid(request.getDestuid());</span>
<span class="nc" id="L345">        result.setFromuid(request.getFromuid());</span>
<span class="nc" id="L346">        result.setTid(request.getTid());</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">        if (lcr != null) {</span>
<span class="nc" id="L348">          setResultFromLCR(lcr, result);</span>
        } else {
          try {
<span class="nc" id="L351">            final DbTaskRunner runner =</span>
<span class="nc" id="L352">                new DbTaskRunner(null, null, request.getTid(),</span>
<span class="nc" id="L353">                                 request.getFromuid(), request.getDestuid());</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">            if (runner != null) {</span>
<span class="nc" id="L355">              setResultFromRunner(runner, result);</span>
            }
<span class="nc" id="L357">          } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L358">            result.setCode(ErrorCode.FileNotFound);</span>
<span class="nc" id="L359">          }</span>
        }
<span class="nc" id="L361">        return result;</span>
      }
      case Restart:
<span class="nc" id="L364">        return restart(request, lcr);</span>
      case Cancel:
<span class="nc" id="L366">        r66code = org.waarp.openr66.context.ErrorCode.CanceledTransfer;</span>
<span class="nc" id="L367">        return stopOrCancel(request, lcr, r66code);</span>
      case Stop:
<span class="nc" id="L369">        r66code = org.waarp.openr66.context.ErrorCode.StoppedTransfer;</span>
<span class="nc" id="L370">        return stopOrCancel(request, lcr, r66code);</span>
      default:
<span class="nc" id="L372">        logger.warn(&quot;Uncompatible with &quot; + request.getAction().name());</span>
<span class="nc" id="L373">        return new R66Result(request.getMode(), ErrorCode.Unimplemented,</span>
<span class="nc" id="L374">                             &quot;Uncompatible with &quot; + request.getAction().name());</span>
    }
  }

  @Override
  public boolean isStillRunning(String fromuid, String touid, long tid)
      throws TException {
    // now check if enough arguments are provided
<span class="nc bnc" id="L382" title="All 6 branches missed.">    if (fromuid == null || touid == null || tid == ILLEGALVALUE) {</span>
      // error
<span class="nc" id="L384">      logger.warn(&quot;Not enough arguments&quot;);</span>
<span class="nc" id="L385">      return false;</span>
    }
    // header = ?; middle = requested+blank+requester+blank+specialId
<span class="nc" id="L388">    final LocalChannelReference lcr =</span>
<span class="nc" id="L389">        Configuration.configuration.getLocalTransaction().getFromRequest(</span>
            touid + ' ' + fromuid + ' ' + tid);
<span class="nc bnc" id="L391" title="All 2 branches missed.">    return lcr != null;</span>
  }

  @Override
  public List&lt;String&gt; infoListQuery(R66Request request) throws TException {
<span class="nc" id="L396">    List&lt;String&gt; list = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L397">    final RequestMode mode = request.getMode();</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">    if (mode != RequestMode.INFOFILE) {</span>
      // error
<span class="nc" id="L400">      logger.warn(&quot;Not correct mode for infoListQuery&quot;);</span>
<span class="nc" id="L401">      list.add(&quot;Not correct mode for infoListQuery&quot;);</span>
<span class="nc" id="L402">      return list;</span>
    }
    // now check if enough arguments are provided
<span class="nc bnc" id="L405" title="All 4 branches missed.">    if (!request.isSetRule() || !request.isSetAction()) {</span>
      // error
<span class="nc" id="L407">      logger.warn(&quot;Not enough arguments&quot;);</span>
<span class="nc" id="L408">      list.add(&quot;Not enough arguments&quot;);</span>
<span class="nc" id="L409">      return list;</span>
    }
<span class="nc" id="L411">    final R66Session session = new R66Session();</span>
<span class="nc" id="L412">    session.getAuth().specialNoSessionAuth(false, Configuration.configuration</span>
<span class="nc" id="L413">        .getHostId());</span>
    DbRule rule;
    try {
<span class="nc" id="L416">      rule = new DbRule(request.getRule());</span>
<span class="nc" id="L417">    } catch (final WaarpDatabaseException e) {</span>
<span class="nc" id="L418">      logger.warn(&quot;Rule is unknown: &quot; + request.getRule());</span>
<span class="nc" id="L419">      list.add(&quot;Rule is unknown: &quot; + request.getRule());</span>
<span class="nc" id="L420">      return list;</span>
<span class="nc" id="L421">    }</span>
    try {
<span class="nc bnc" id="L423" title="All 2 branches missed.">      if (RequestPacket.isRecvMode(rule.getMode())) {</span>
<span class="nc" id="L424">        session.getDir().changeDirectory(rule.getWorkPath());</span>
      } else {
<span class="nc" id="L426">        session.getDir().changeDirectory(rule.getSendPath());</span>
      }

<span class="nc bnc" id="L429" title="All 2 branches missed.">      if (request.getAction() == Action.List ||</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">          request.getAction() == Action.Mlsx) {</span>
        // ls or mls from current directory
<span class="nc bnc" id="L432" title="All 2 branches missed.">        if (request.getAction() == Action.List) {</span>
<span class="nc" id="L433">          list = session.getDir().list(request.getFile());</span>
        } else {
<span class="nc" id="L435">          list = session.getDir().listFull(request.getFile(), false);</span>
        }
      } else {
        // ls pr mls from current directory and filename
<span class="nc bnc" id="L439" title="All 2 branches missed.">        if (!request.isSetFile()) {</span>
<span class="nc" id="L440">          logger.warn(&quot;File missing&quot;);</span>
<span class="nc" id="L441">          list.add(&quot;File missing&quot;);</span>
<span class="nc" id="L442">          return list;</span>
        }
<span class="nc" id="L444">        final R66File file =</span>
<span class="nc" id="L445">            (R66File) session.getDir().setFile(request.getFile(), false);</span>
        String sresult;
<span class="nc bnc" id="L447" title="All 2 branches missed.">        if (request.getAction() == Action.Exist) {</span>
<span class="nc" id="L448">          sresult = String.valueOf(file.exists());</span>
<span class="nc" id="L449">          list.add(sresult);</span>
<span class="nc bnc" id="L450" title="All 2 branches missed.">        } else if (request.getAction() == Action.Detail) {</span>
<span class="nc" id="L451">          sresult = session.getDir().fileFull(request.getFile(), false);</span>
<span class="nc" id="L452">          final String[] slist = sresult.split(&quot;\n&quot;);</span>
<span class="nc" id="L453">          sresult = slist[1];</span>
<span class="nc" id="L454">          list.add(sresult);</span>
        }
      }
<span class="nc" id="L457">      return list;</span>
<span class="nc" id="L458">    } catch (final CommandAbstractException e) {</span>
<span class="nc" id="L459">      logger.warn(&quot;Error occurs during: &quot; + request, e);</span>
<span class="nc" id="L460">      list.add(&quot;Error occurs during: &quot; + request);</span>
<span class="nc" id="L461">      return list;</span>
    }
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>