<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WaarpPassword.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Waarp Password Management GUI and Console</a> &gt; <a href="index.source.html" class="el_package">org.waarp.uip</a> &gt; <span class="el_source">WaarpPassword.java</span></div><h1>WaarpPassword.java</h1><pre class="source lang-java linenums">/*
 * This file is part of Waarp Project (named also Waarp or GG).
 *
 *  Copyright (c) 2019, Waarp SAS, and individual contributors by the @author
 *  tags. See the COPYRIGHT.txt in the distribution for a full listing of
 * individual contributors.
 *
 *  All Waarp Project is free software: you can redistribute it and/or
 * modify it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or (at your
 * option) any later version.
 *
 * Waarp is distributed in the hope that it will be useful, but WITHOUT ANY
 * WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 * A PARTICULAR PURPOSE. See the GNU General Public License for more details.
 *
 *  You should have received a copy of the GNU General Public License along with
 * Waarp . If not, see &lt;http://www.gnu.org/licenses/&gt;.
 */
package org.waarp.uip;

import org.waarp.common.crypto.Blowfish;
import org.waarp.common.crypto.Des;
import org.waarp.common.crypto.KeyObject;
import org.waarp.common.exception.CryptoException;
import org.waarp.common.file.FileUtils;
import org.waarp.common.logging.SysErrLogger;
import org.waarp.common.utility.SystemPropertyUtil;
import org.waarp.common.utility.WaarpStringUtils;
import org.waarp.common.utility.WaarpSystemUtil;

import java.io.BufferedReader;
import java.io.DataInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStreamReader;

/**
 * Console Command Line Main class to provide Password Management for GoldenGate
 * Products.
 */
public class WaarpPassword {
<span class="fc" id="L45">  static boolean desModel = true;</span>
  static boolean clearPasswordView;
  static final String HELPOPTIONS = &quot;Options available\r\n&quot; +
                                    &quot;* -ki file to specify the Key File by default\r\n&quot; +
                                    &quot;* -ko file to specify a new Key File to build and save\r\n\r\n&quot; +
                                    &quot;* -des to specify DES format (default)\r\n&quot; +
                                    &quot;* -blf to specify BlowFish format\r\n\r\n&quot; +
                                    &quot;* -pi file to specify a GGP File by default(password)\r\n&quot; +
                                    &quot;* -pwd to specify a clear ggp password as entry\r\n&quot; +
                                    &quot;* -cpwd to specify a crypted ggp password as entry\r\n&quot; +
                                    &quot;* -po file to specify a GGP File as output for the password\r\n&quot; +
                                    &quot;* -clear to specify uncrypted password shown as clear text&quot;;
  static final String GGPEXTENSION = &quot;ggp&quot;;
  static String ki;
  static String ko;
  static String pi;
  static String po;
  static String pwd;
  static String cpwd;

  private File keyFile;
  private File passwordFile;
  private String clearPassword;
  private String cryptedPassword;

  private final KeyObject currentKey;

  /**
   * @param args
   *
   * @throws Exception
   */
  public static void main(final String[] args) throws Exception {
<span class="fc bfc" id="L78" title="All 2 branches covered.">    if (!loadOptions(args)) {</span>
      // Bad options
<span class="fc" id="L80">      WaarpSystemUtil.systemExit(2);</span>
<span class="fc" id="L81">      return;</span>
    }
<span class="fc" id="L83">    final WaarpPassword waarpPassword = new WaarpPassword();</span>
<span class="fc bfc" id="L84" title="All 4 branches covered.">    if (po == null &amp;&amp; pi == null) {</span>
      // stop
<span class="fc" id="L86">      SysErrLogger.FAKE_LOGGER.sysout(&quot;Key written&quot;);</span>
<span class="fc" id="L87">      WaarpSystemUtil.systemExit(0);</span>
<span class="fc" id="L88">      return;</span>
    }
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">    if (waarpPassword.clearPassword == null ||</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">        waarpPassword.clearPassword.length() == 0) {</span>
<span class="nc" id="L92">      SysErrLogger.FAKE_LOGGER.sysout(&quot;Password to crypt:&quot;);</span>
<span class="nc" id="L93">      final String newp = waarpPassword.readString();</span>
<span class="nc bnc" id="L94" title="All 4 branches missed.">      if (newp == null || newp.length() == 0) {</span>
<span class="nc" id="L95">        SysErrLogger.FAKE_LOGGER.syserr(&quot;No password as input&quot;);</span>
<span class="nc" id="L96">        WaarpSystemUtil.systemExit(4);</span>
<span class="nc" id="L97">        return;</span>
      }
<span class="nc" id="L99">      waarpPassword.setClearPassword(newp);</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">      if (po != null) {</span>
<span class="nc" id="L101">        waarpPassword.setPasswordFile(new File(po));</span>
<span class="nc" id="L102">        waarpPassword.savePasswordFile();</span>
      }
<span class="nc bnc" id="L104" title="All 2 branches missed.">      if (clearPasswordView) {</span>
<span class="nc" id="L105">        SysErrLogger.FAKE_LOGGER.sysout(</span>
<span class="nc" id="L106">            &quot;ClearPwd: &quot; + waarpPassword.getClearPassword());</span>
<span class="nc" id="L107">        SysErrLogger.FAKE_LOGGER.sysout(</span>
<span class="nc" id="L108">            &quot;CryptedPwd: &quot; + waarpPassword.getCryptedPassword());</span>
      }
    }
<span class="fc" id="L111">  }</span>

  public static boolean loadOptions(final String[] args) {
<span class="fc" id="L114">    desModel = true;</span>
<span class="fc" id="L115">    clearPasswordView = false;</span>
<span class="fc" id="L116">    ki = null;</span>
<span class="fc" id="L117">    ko = null;</span>
<span class="fc" id="L118">    pi = null;</span>
<span class="fc" id="L119">    po = null;</span>
<span class="fc" id="L120">    pwd = null;</span>
<span class="fc" id="L121">    cpwd = null;</span>

    int i;
<span class="fc bfc" id="L124" title="All 2 branches covered.">    if (args.length == 0) {</span>
<span class="fc" id="L125">      SysErrLogger.FAKE_LOGGER.syserr(HELPOPTIONS);</span>
<span class="fc" id="L126">      return false;</span>
    }
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">    if (!SystemPropertyUtil.isFileEncodingCorrect()) {</span>
<span class="nc" id="L129">      SysErrLogger.FAKE_LOGGER.syserr(</span>
          &quot;Issue while trying to set UTF-8 as default file encoding: use -Dfile.encoding=UTF-8 as java command argument\n&quot; +
          &quot;Currently file.encoding is: &quot; +
<span class="nc" id="L132">          SystemPropertyUtil.get(SystemPropertyUtil.FILE_ENCODING));</span>
<span class="nc" id="L133">      return false;</span>
    }
<span class="fc bfc" id="L135" title="All 2 branches covered.">    for (i = 0; i &lt; args.length; i++) {</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">      if (&quot;-ki&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L137">        i++;</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">        if (i &lt; args.length) {</span>
<span class="fc" id="L139">          ki = args[i];</span>
        } else {
<span class="nc" id="L141">          SysErrLogger.FAKE_LOGGER.syserr(&quot;-ki needs a file as argument&quot;);</span>
<span class="nc" id="L142">          return false;</span>
        }
<span class="fc bfc" id="L144" title="All 2 branches covered.">      } else if (&quot;-ko&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L145">        i++;</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">        if (i &lt; args.length) {</span>
<span class="fc" id="L147">          ko = args[i];</span>
        } else {
<span class="nc" id="L149">          SysErrLogger.FAKE_LOGGER.syserr(&quot;-ko needs a file as argument&quot;);</span>
<span class="nc" id="L150">          return false;</span>
        }
<span class="fc bfc" id="L152" title="All 2 branches covered.">      } else if (&quot;-pi&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L153">        i++;</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        if (i &lt; args.length) {</span>
<span class="fc" id="L155">          pi = args[i];</span>
        } else {
<span class="nc" id="L157">          SysErrLogger.FAKE_LOGGER.syserr(&quot;-pi needs a file as argument&quot;);</span>
<span class="nc" id="L158">          return false;</span>
        }
<span class="fc bfc" id="L160" title="All 2 branches covered.">      } else if (&quot;-po&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L161">        i++;</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">        if (i &lt; args.length) {</span>
<span class="fc" id="L163">          po = args[i];</span>
        } else {
<span class="nc" id="L165">          SysErrLogger.FAKE_LOGGER.syserr(&quot;-po needs a file as argument&quot;);</span>
<span class="nc" id="L166">          return false;</span>
        }
<span class="fc bfc" id="L168" title="All 2 branches covered.">      } else if (&quot;-des&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L169">        desModel = true;</span>
<span class="fc bfc" id="L170" title="All 2 branches covered.">      } else if (&quot;-blf&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L171">        desModel = false;</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">      } else if (&quot;-pwd&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L173">        i++;</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">        if (i &lt; args.length) {</span>
<span class="fc" id="L175">          pwd = args[i];</span>
        } else {
<span class="nc" id="L177">          SysErrLogger.FAKE_LOGGER.syserr(&quot;-pwd needs a password as argument&quot;);</span>
<span class="nc" id="L178">          return false;</span>
        }
<span class="fc bfc" id="L180" title="All 2 branches covered.">      } else if (&quot;-cpwd&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L181">        i++;</span>
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">        if (i &lt; args.length) {</span>
<span class="fc" id="L183">          cpwd = args[i];</span>
        } else {
<span class="nc" id="L185">          SysErrLogger.FAKE_LOGGER.syserr(</span>
              &quot;-cpwd needs a crypted password as argument&quot;);
<span class="nc" id="L187">          return false;</span>
        }
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">      } else if (&quot;-clear&quot;.equalsIgnoreCase(args[i])) {</span>
<span class="fc" id="L190">        clearPasswordView = true;</span>
      } else {
<span class="nc" id="L192">        SysErrLogger.FAKE_LOGGER.syserr(&quot;Unknown option: &quot; + args[i]);</span>
<span class="nc" id="L193">        return false;</span>
      }
    }
<span class="pc bpc" id="L196" title="1 of 4 branches missed.">    if (ki == null &amp;&amp; ko == null) {</span>
<span class="nc" id="L197">      SysErrLogger.FAKE_LOGGER.syserr(</span>
          &quot;You must specify one of ki or ko options&quot;);
<span class="nc" id="L199">      return false;</span>
    }
<span class="fc bfc" id="L201" title="All 2 branches covered.">    if (ki == null) {</span>
<span class="fc" id="L202">      ki = ko;</span>
    }
<span class="pc bpc" id="L204" title="5 of 6 branches missed.">    if (ki == null &amp;&amp; (po != null || pi != null)) {</span>
<span class="nc" id="L205">      SysErrLogger.FAKE_LOGGER.syserr(</span>
          &quot;If pi or po options are set, ki or ko options must be set also!\n&quot;);
<span class="nc" id="L207">      return false;</span>
    }
<span class="pc bpc" id="L209" title="2 of 8 branches missed.">    if (pi == null &amp;&amp; po == null &amp;&amp; (pwd != null || cpwd != null)) {</span>
<span class="nc" id="L210">      SysErrLogger.FAKE_LOGGER.syserr(</span>
          &quot;Cannot create a password if no password GGP file is specified with pi or po options&quot;);
<span class="nc" id="L212">      return false;</span>
    }
<span class="fc" id="L214">    return true;</span>
  }

<span class="fc" id="L217">  public WaarpPassword() throws Exception {</span>
<span class="fc bfc" id="L218" title="All 2 branches covered.">    if (desModel) {</span>
<span class="fc" id="L219">      currentKey = new Des();</span>
    } else {
<span class="fc" id="L221">      currentKey = new Blowfish();</span>
    }
<span class="fc bfc" id="L223" title="All 2 branches covered.">    if (ko != null) {</span>
<span class="fc" id="L224">      createNewKey();</span>
<span class="fc" id="L225">      saveKey(new File(ko));</span>
    }
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">    if (ki != null) {</span>
<span class="fc" id="L228">      loadKey(new File(ki));</span>
    }
<span class="fc bfc" id="L230" title="All 2 branches covered.">    if (pi != null) {</span>
<span class="fc" id="L231">      setPasswordFile(new File(pi));</span>
<span class="fc" id="L232">      loadPasswordFile();</span>
    }
<span class="fc bfc" id="L234" title="All 2 branches covered.">    if (pwd != null) {</span>
<span class="fc" id="L235">      setClearPassword(pwd);</span>
    }
<span class="fc bfc" id="L237" title="All 2 branches covered.">    if (cpwd != null) {</span>
<span class="fc" id="L238">      setCryptedPassword(cpwd);</span>
    }
<span class="fc bfc" id="L240" title="All 2 branches covered.">    if (po != null) {</span>
<span class="fc" id="L241">      setPasswordFile(new File(po));</span>
<span class="fc" id="L242">      savePasswordFile();</span>
    }
<span class="fc bfc" id="L244" title="All 2 branches covered.">    if (clearPassword != null) {</span>
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">      if (clearPasswordView) {</span>
<span class="fc" id="L246">        SysErrLogger.FAKE_LOGGER.sysout(&quot;ClearPwd: &quot; + getClearPassword());</span>
      }
<span class="fc" id="L248">      SysErrLogger.FAKE_LOGGER.sysout(&quot;CryptedPwd: &quot; + getCryptedPassword());</span>
    }
<span class="fc" id="L250">  }</span>

  private String readString() {
<span class="nc" id="L253">    String read = &quot;&quot;;</span>
<span class="nc" id="L254">    final InputStreamReader input =</span>
        new InputStreamReader(System.in, WaarpStringUtils.UTF8);
<span class="nc" id="L256">    final BufferedReader reader = new BufferedReader(input);</span>
    try {
<span class="nc" id="L258">      read = reader.readLine();</span>
<span class="nc" id="L259">    } catch (final IOException e) {</span>
<span class="nc" id="L260">      SysErrLogger.FAKE_LOGGER.syserr(e);</span>
<span class="nc" id="L261">    }</span>
<span class="nc" id="L262">    return read;</span>
  }

  /**
   * Create a new Key but do not save it on file
   *
   * @throws Exception
   */
  public final void createNewKey() throws Exception {
    try {
<span class="fc" id="L272">      currentKey.generateKey();</span>
<span class="nc" id="L273">    } catch (final Exception e) {</span>
<span class="nc" id="L274">      throw new CryptoException(&quot;Create New Key in error&quot;, e);</span>
<span class="fc" id="L275">    }</span>
<span class="pc bpc" id="L276" title="1 of 2 branches missed.">    if (clearPassword != null) {</span>
<span class="nc" id="L277">      setClearPassword(clearPassword);</span>
    }
<span class="fc" id="L279">  }</span>

  /**
   * @param file source file
   *
   * @throws CryptoException
   */
  public final void loadKey(final File file) throws CryptoException {
<span class="fc" id="L287">    keyFile = file;</span>
    try {
<span class="fc" id="L289">      currentKey.setSecretKey(file);</span>
<span class="nc" id="L290">    } catch (final IOException e) {</span>
<span class="nc" id="L291">      throw new CryptoException(&quot;Load Key in error&quot;, e);</span>
<span class="fc" id="L292">    }</span>
<span class="fc" id="L293">  }</span>

  /**
   * @param file destination file, if null previously set file is used
   *
   * @throws CryptoException
   */
  public final void saveKey(final File file) throws CryptoException {
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">    if (file != null) {</span>
<span class="fc" id="L302">      keyFile = file;</span>
    }
    try {
<span class="fc" id="L305">      currentKey.saveSecretKey(keyFile);</span>
<span class="nc" id="L306">    } catch (final IOException e) {</span>
<span class="nc" id="L307">      throw new CryptoException(&quot;Save Key in error&quot;, e);</span>
<span class="fc" id="L308">    }</span>
<span class="fc" id="L309">  }</span>

  /**
   * @return True if the associated key is ready
   */
  public final boolean keyReady() {
<span class="nc" id="L315">    return currentKey.keyReady();</span>
  }

  /**
   * @return The File associated with the current Key
   */
  public final File getKeyFile() {
<span class="nc" id="L322">    return keyFile;</span>
  }

  /**
   * Set the new password and its crypted value
   *
   * @param passwd
   *
   * @throws Exception
   */
  public final void setClearPassword(final String passwd) throws Exception {
<span class="fc" id="L333">    clearPassword = passwd;</span>
<span class="fc" id="L334">    cryptedPassword = currentKey.cryptToHex(clearPassword);</span>
<span class="fc" id="L335">  }</span>

  /**
   * @return the passwordFile
   */
  public final File getPasswordFile() {
<span class="nc" id="L341">    return passwordFile;</span>
  }

  /**
   * @param passwordFile the passwordFile to set
   *
   * @throws IOException
   */
  public final void setPasswordFile(final File passwordFile) {
<span class="fc" id="L350">    this.passwordFile = passwordFile;</span>
<span class="fc" id="L351">  }</span>

  /**
   * Save the Crypted Paswword to the File
   *
   * @throws IOException
   */
  public final void savePasswordFile() throws IOException {
<span class="fc" id="L359">    final FileOutputStream outputStream = new FileOutputStream(passwordFile);</span>
    try {
<span class="fc" id="L361">      outputStream.write(cryptedPassword.getBytes(WaarpStringUtils.UTF8));</span>
    } finally {
<span class="fc" id="L363">      FileUtils.close(outputStream);</span>
    }
<span class="fc" id="L365">  }</span>

  /**
   * Load the crypted password from the file
   *
   * @throws Exception
   */
  public final void loadPasswordFile() throws Exception {
<span class="pc bpc" id="L373" title="1 of 2 branches missed.">    if (passwordFile.canRead()) {</span>
<span class="fc" id="L374">      final int len = (int) passwordFile.length();</span>
<span class="fc" id="L375">      final byte[] key = new byte[len];</span>
      final FileInputStream inputStream;
<span class="fc" id="L377">      inputStream = new FileInputStream(passwordFile);</span>
<span class="fc" id="L378">      DataInputStream dis = null;</span>
      try {
<span class="fc" id="L380">        dis = new DataInputStream(inputStream);</span>
<span class="fc" id="L381">        dis.readFully(key);</span>
      } finally {
<span class="pc bpc" id="L383" title="1 of 2 branches missed.">        if (dis != null) {</span>
<span class="fc" id="L384">          FileUtils.close(dis);</span>
        } else {
<span class="nc" id="L386">          FileUtils.close(inputStream);</span>
        }
      }
<span class="fc" id="L389">      setCryptedPassword(new String(key, WaarpStringUtils.UTF8));</span>
<span class="fc" id="L390">    } else {</span>
<span class="nc" id="L391">      throw new CryptoException(&quot;Cannot read crypto file&quot;);</span>
    }
<span class="fc" id="L393">  }</span>

  /**
   * @return the cryptedPassword
   */
  public final String getCryptedPassword() {
<span class="fc" id="L399">    return cryptedPassword;</span>
  }

  /**
   * @param cryptedPassword the cryptedPassword to set
   *
   * @throws Exception
   */
  public final void setCryptedPassword(final String cryptedPassword)
      throws Exception {
<span class="fc" id="L409">    this.cryptedPassword = cryptedPassword;</span>
<span class="fc" id="L410">    clearPassword = currentKey.decryptHexInString(cryptedPassword);</span>
<span class="fc" id="L411">  }</span>

  /**
   * @return the clearPassword
   */
  public final String getClearPassword() {
<span class="fc" id="L417">    return clearPassword;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>